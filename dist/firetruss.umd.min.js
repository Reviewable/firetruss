!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("lodash"),require("vue")):"function"==typeof define&&define.amd?define(["lodash","vue"],b):a.Truss=b(a._,a.Vue)}(this,function(a,b){"use strict";function c(a){var c=a.get;a.get=function(){try{return c.call(this)}catch(a){if(this.vm._watcher!==this||!b.config.errorHandler)throw a;b.config.errorHandler(a,this.vm,"uncaught render error")}}}function d(a){return a?a.toString().replace(/[\\.$#[\]\/]/g,function(a){return"\\"+a.charCodeAt(0).toString(16)}):a}function e(a){return a?a.toString().replace(/\\[0-9a-f]{2}/gi,function(a){return String.fromCharCode(parseInt(a.slice(1),16))}):a}function f(b){if(!a.isObject(b)||!Object.isExtensible(b))return b;var c=b;for(var e in b)if(b.hasOwnProperty(e)){var g=b[e],h=d(e),i=f(g);h===e&&i===g||(c===b&&(c=a.clone(b)),c[h]=i,c[e]===g&&delete c[e])}return c}function g(){for(var b=[],c=0,d=arguments;c<d.length;c+=1){var e=d[c];a.isString(e)||(e=""+e),"/"===e.charAt(0)&&b.splice(0,b.length),b.push(e)}return"/"===b[0]&&(b[0]=""),b.join("/")}function h(b,c){var d=(c?"esc:":"")+b,f=G.get(d);return f||(f=b.split("/"),c||(f=a.map(f,e)),G.set(d,f)),f}function i(b){var c=H[b];return c||(c=new J(b),a.size(H)===I&&delete H[a.keys(H)[0]],H[b]=c),c}function j(b,c){if(!b||a.isError(b))return b;var d=new Error(b.message);d.params=c;for(var e in b)if("message"!==e&&b.hasOwnProperty(e))try{d[e]=b[e]}catch(a){d.extra=d.extra||{},d.extra[e]=b[e]}return d}function k(b,c){return a.isEqual(b,c,l)}function l(a,b){return a===b||void 0===a||null===a||void 0===b||null===b||a.$truss||b.$truss?a===b:a.isEqual?a.isEqual(b):void 0}function m(a,b){for(var c=0,d=Object.getOwnPropertyNames(a.prototype);c<d.length;c+=1){var e=d[c];"constructor"!==e&&Object.defineProperty(b.prototype,e,Object.getOwnPropertyDescriptor(a.prototype,e))}}function n(b){if(b)return b instanceof P?b.toString():a.mapValues(b,n)}function o(a){return function(){try{return Promise.resolve(a.apply(this,arguments))}catch(a){return Promise.reject(a)}}}function p(a,b){return a=r(a,function(){b=null}),a.cancel=function(){b&&(b(),b=null)},q(a,"cancel"),a}function q(a,b){var c=a.then,d=a.catch;return a.then=function(d,e){var f=c.call(a,d,e);return f[b]=a[b],q(f,b),f},a.catch=function(c){var e=d.call(a,c);return e[b]=a[b],q(e,b),e},a}function r(a,b){return b?(b=o(b),a.then(function(a){return b().then(function(){return a})},function(a){return b().then(function(){return Promise.reject(a)})})):a}function s(a,b){if(!this.$destroyed){this.$$touchThis();var c=na;na=!1;var d,e=V();try{try{d=a.get.call(this)}catch(a){d=new ta(a)}finally{b.runtime+=V()-e,b.numRecomputes+=1}return na&&(d=new ua(d)),d}finally{na=c}}}function t(b,c){return!c||c instanceof P?c:a.mapValues(c,function(c){if(c instanceof P)return c;if(a.isFunction(c)){var d=function(){return b.$$touchThis(),t(b,c.call(this))};return d.angularWatchSuppressed=!0,d}return t(b,c)})}function u(b){return null===b||void 0===b||!a.isObject(b)||Object.isFrozen(b)||b.$truss?b:(b=Object.freeze(b),a.isArray(b)?a.map(b,function(a){return u(a)}):a.mapValues(b,function(a){return u(a)}))}function v(b,c){a.forEach(a.keys(c),function(e){if("/"===e.charAt(0)){if(!(e===b||"/"===b||a.startsWith(e,b+"/")&&e.length>b.length+1))throw new Error("Update item is not a descendant of target ref: "+e)}else{if(a.includes(e,"/"))throw new Error("Update item deep path must be absolute, taken from a reference: "+e);var f=g(b,d(e));if(c.hasOwnProperty(f))throw new Error("Update items overlap: "+e+" and "+f);c[f]=c[e],delete c[e]}});var e=a(c).keys().map(function(a){return g(a,"")}).sortBy("length").value();a.forEach(c,function(b,c){for(var d=0,f=e;d<f.length;d+=1){var g=f[d];if(g.length>c.length)break;if(c!==g&&a.startsWith(c,g))throw new Error("Update items overlap: "+g+" and "+c)}})}function w(b){var c;return a.forEach(b,function(a,b){var d="/"===b?[""]:h(b,!0);if(c){for(var e=0,f=Math.min(c.length,d.length);e<f&&c[e]===d[e];)e++;if(c=c.slice(0,e),!c.length)return!1}else c=d}),1===c.length?"/":c.join("/")}function x(b,c){var d="/"===b?1:b.length+1;a.forEach(a.keys(c),function(a){c[a.slice(d)]=c[a],delete c[a]})}function y(b){if(!a.isObject(b))return b;var c={},e=b.$data;for(var f in e)e.hasOwnProperty(f)&&(c[d(f)]=y(e[f]));return c}a="default"in a?a.default:a,b="default"in b?b.default:b;var z,A=0,B=!1,C=function(){z.digestRequest>A||(z.digestRequest=A+1)},D={active:"undefined"!=typeof window&&window.angular};D.active?function(){var d=window.angular.module("firetruss",[]);D.digest=C,D.watch=function(){throw new Error("Angular watch proxy not yet initialized")},D.defineModule=function(a){d.constant("Truss",a)},D.debounceDigest=function(b){if(b){var c=a.debounce(C,b);D.digest=function(){z.digestRequest>A||(B?C():c())}}else D.digest=C},d.config(["$provide",function(d){d.decorator("$rootScope",["$delegate","$exceptionHandler",function(d,e){var f=d;D.watch=f.$watch.bind(f);var g=Object.getPrototypeOf(f),h=g.$digest;return g.$digest=C,g.$digest.original=h,z=new b({data:{digestRequest:0}}),z.$watch(function(){return z.digestRequest},function(){z.digestRequest>A?b.nextTick(function(){z.digestRequest<=A||(B=!0,f.$digest.original.call(f),A=z.digestRequest=z.digestRequest+1)}):B=!1}),a.last(z._watchers).id=1/0,c(Object.getPrototypeOf(a.last(z._watchers))),f}])}])}():a.forEach(["digest","watch","defineModule","debounceDigest"],function(b){D[b]=a.noop});var E=function(a,b){this.key=a,this.value=b,this.touch()};E.prototype.touch=function(){this.timestamp=Date.now()};var F=function(a,b){this._items=Object.create(null),this._size=0,this._maxSize=a,this._pruningSize=b||Math.ceil(.1*a)};F.prototype.has=function(a){return Boolean(this._items[a])},F.prototype.get=function(a){var b=this._items[a];if(b)return b.touch(),b.value},F.prototype.set=function(a,b){var c=this._items[a];c?c.value=b:(this._size>=this._maxSize&&this._prune(),this._items[a]=new E(a,b),this._size+=1)},F.prototype.delete=function(a){this._items[a]&&(delete this._items[a],this._size-=1)},F.prototype._prune=function(){for(var b=this,c=a(this._items).toArray().sortBy("timestamp").take(this._pruningSize).value(),d=0,e=c;d<e.length;d+=1){var f=e[d];b.delete(f.key)}};var G=new F(1e3),H={},I=1e3,J=function(b){var c=this;this.variables=[];var d=a.endsWith(b,"/$*");d&&(b=b.slice(0,-3));var e=b.replace(/\/\$[^\/]*/g,function(a){return a.length>1&&c.variables.push(a.slice(1)),""});if(Object.freeze(this.variables),/[.$#[\]]|\\(?![0-9a-f][0-9a-f])/i.test(e))throw new Error("Path pattern has unescaped keys: "+b);this._regex=new RegExp("^"+e.replace(/\u0001/g,"/([^/]+)")+(d?"($|/)":"$"))};J.prototype.match=function(a){var b=this;this._regex.lastIndex=0;var c=this._regex.exec(a);if(c){for(var d={},f=0;f<this.variables.length;f++)d[b.variables[f]]=e(c[f+1]);return d}},J.prototype.test=function(a){return this._regex.test(a)},J.prototype.toString=function(){return this._regex.toString()};var K="1.0.0",L=function(a){var b=a.path,c=a.value,d=a.exists,e=a.writeSerial;this._path=b,this._value=c,this._exists=void 0===c?d||!1:null!==c,this._writeSerial=e},M={path:{},exists:{},value:{},key:{},writeSerial:{}};M.path.get=function(){return this._path},M.exists.get=function(){return this._exists},M.value.get=function(){if(void 0===this._value)throw new Error("Value omitted from snapshot");return this._value},M.key.get=function(){return void 0===this._key&&(this._key=e(this._path.replace(/.*\//,""))),this._key},M.writeSerial.get=function(){return this._writeSerial},Object.defineProperties(L.prototype,M);var N=function(b){var c=this;this._idCounter=0,this._deferreds={},this._suspended=!1,this._servers={},this._callbacks={},this._log=a.noop,this._inboundMessages=[],this._outboundMessages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),this._port=b.port||b,this._shared=!!b.port,Object.seal(this),this._port.onmessage=this._receive.bind(this),window.addEventListener("unload",function(){c._send({msg:"destroy"})})};N.prototype.init=function(a,b){var c=[];try{var d=window.localStorage||window.sessionStorage;if(!d)throw new Error("localStorage and sessionStorage not available");for(var e=0;e<d.length;e++){var f=d.key(e);c.push({key:f,value:d.getItem(f)})}}catch(a){}return this._send({msg:"init",storage:c,config:b}).then(function(a){var b=a.version.match(/^(\d+)\.(\d+)\.(\d+)(-.*)?$/);if(b){var c=K.match(/^(\d+)\.(\d+)\.(\d+)(-.*)?$/);if(!(b[1]===c[1]&&(b[2]>c[2]||b[2]===c[2]&&b[3]>=c[3])))return Promise.reject(new Error("Incompatible Firetruss worker version: "+a.version+" ("+K+" or better required)"))}return a})},N.prototype.suspend=function(a){void 0===a&&(a=!0),this._suspended!==a&&(this._suspended=a,a||(this._receiveMessages(this._inboundMessages),this._inboundMessages=[],this._outboundMessages.length&&Promise.resolve().then(this._flushMessageQueue)))},N.prototype.enableLogging=function(b){b?(!0===b&&(b=console.log.bind(console)),this._log=b):this._log=a.noop},N.prototype._send=function(a){var b=this;a.id=++this._idCounter;var c;if(a.oneWay)c=Promise.resolve();else{c=new Promise(function(c,d){b._deferreds[a.id]={resolve:c,reject:d}});var d=this._deferreds[a.id];d.promise=c,c.sent=new Promise(function(a){d.resolveSent=a}),d.params=a}return this._outboundMessages.length||this._suspended||Promise.resolve().then(this._flushMessageQueue),this._log("send:",a),this._outboundMessages.push(a),c},N.prototype._flushMessageQueue=function(){try{this._port.postMessage(this._outboundMessages),this._outboundMessages=[]}catch(a){throw a.extra={messages:this._outboundMessages},a}},N.prototype._receive=function(a){this._suspended?this._inboundMessages=this._inboundMessages.concat(a.data):this._receiveMessages(a.data)},N.prototype._receiveMessages=function(b){for(var c=this,d=0,e=b;d<e.length;d+=1){var f=e[d];c._log("recv:",f);var g=c[f.msg];if(!a.isFunction(g))throw new Error("Unknown message: "+f.msg);g.call(c,f)}},N.prototype.bindExposedFunction=function(a){return function(){return this._send({msg:"call",name:a,args:Array.prototype.slice.call(arguments)})}.bind(this)},N.prototype.resolve=function(a){var b=this._deferreds[a.id];if(!b)throw new Error("Received resolution to inexistent Firebase call");delete this._deferreds[a.id],b.resolve(a.result)},N.prototype.reject=function(a){var b=this._deferreds[a.id];if(!b)throw new Error("Received rejection of inexistent Firebase call");delete this._deferreds[a.id],b.reject(j(a.error,b.params))},N.prototype.updateLocalStorage=function(a){var b=a.items;try{for(var c=window.localStorage||window.sessionStorage,d=0,e=b;d<e.length;d+=1){var f=e[d];null===f.value?c.removeItem(f.key):c.setItem(f.key,f.value)}}catch(a){}},N.prototype.trackServer=function(a){if(this._servers.hasOwnProperty(a))return Promise.resolve();var b=this._servers[a]={authListeners:[]},c=this._registerCallback(this._authCallback.bind(this,b));this._send({msg:"onAuth",url:a,callbackId:c})},N.prototype._authCallback=function(a,b){a.auth=b;for(var c=0,d=a.authListeners;c<d.length;c+=1){(0,d[c])(b)}},N.prototype.onAuth=function(a,b,c){var d=b.bind(c);d.callback=b,d.context=c,this._servers[a].authListeners.push(d),d(this.getAuth(a))},N.prototype.offAuth=function(a,b,c){for(var d=this._servers[a].authListeners,e=0;e<d.length;e++){var f=d[e];if(f.callback===b&&f.context===c){d.splice(e,1);break}}},N.prototype.getAuth=function(a){return this._servers[a].auth},N.prototype.authWithCustomToken=function(a,b){return this._send({msg:"authWithCustomToken",url:a,authToken:b})},N.prototype.unauth=function(a){return this._send({msg:"unauth",url:a})},N.prototype.set=function(a,b,c){return this._send({msg:"set",url:a,value:b,writeSerial:c})},N.prototype.update=function(a,b,c){return this._send({msg:"update",url:a,value:b,writeSerial:c})},N.prototype.once=function(a,b){return this._send({msg:"once",url:a,writeSerial:b}).then(function(a){return new L(a)})},N.prototype.on=function(a,b,c,d,e,f,g,h){var i={listenerKey:a,eventType:d,snapshotCallback:e,cancelCallback:f,context:g,params:{msg:"on",listenerKey:a,url:b,spec:c,eventType:d,options:h}},j=this._onCallback.bind(this,i);this._registerCallback(j,i),e.__callbackIds=e.__callbackIds||[],e.__callbackIds.push(i.id),this._send({msg:"on",listenerKey:a,url:b,spec:c,eventType:d,callbackId:i.id,options:h}).catch(function(a){j(a)})},N.prototype.off=function(b,c,d,e,f,g){var h,i=this,j=[];if(f){if(!(h=this._findAndRemoveCallbackId(f,function(c){return a.isMatch(c,{listenerKey:b,eventType:e,context:g})})))return Promise.resolve();j.push(h)}else for(var k=0,l=a.keys(i._callbacks);k<l.length;k+=1){var m=l[k],n=i._callbacks[m];n.listenerKey!==b||e&&n.eventType!==e||j.push(m)}for(var o=0,p=j;o<p.length;o+=1){var q=p[o];i._nullifyCallback(q)}return this._send({msg:"off",listenerKey:b,url:c,spec:d,eventType:e,callbackId:h}).then(function(){for(var a=0,b=j;a<b.length;a+=1){var c=b[a];i._deregisterCallback(c)}})},N.prototype._onCallback=function(a,b,c){if(b){this._deregisterCallback(a.id);var d=j(b,a.params);a.cancelCallback?a.cancelCallback.call(a.context,d):console.error(d)}else a.snapshotCallback.call(a.context,new L(c))},N.prototype.transaction=function(b,c,d,e){return this._send({msg:"transaction",url:b,oldValue:c,relativeUpdates:d,writeSerial:e}).then(function(b){return b.snapshots&&(b.snapshots=a.map(b.snapshots,function(a){return new L(a)})),b})},N.prototype.onDisconnect=function(a,b,c){return this._send({msg:"onDisconnect",url:a,method:b,value:c})},N.prototype.bounceConnection=function(){return this._send({msg:"bounceConnection"})},N.prototype.callback=function(a){var b=a.id,c=a.args,d=this._callbacks[b];if(!d)throw new Error("Unregistered callback: "+b);d.callback.apply(null,c)},N.prototype._registerCallback=function(a,b){return b=b||{},b.callback=a,b.id="cb"+ ++this._idCounter,this._callbacks[b.id]=b,b.id},N.prototype._nullifyCallback=function(b){this._callbacks[b].callback=a.noop},N.prototype._deregisterCallback=function(a){delete this._callbacks[a]},N.prototype._findAndRemoveCallbackId=function(a,b){var c=this;if(a.__callbackIds)for(var d=0;d<a.__callbackIds.length;){var e=a.__callbackIds[d],f=c._callbacks[e];if(f){if(b(f))return a.__callbackIds.splice(d,1),e;d+=1}else a.__callbackIds.splice(d,1)}};var O={};Object.freeze(O);var P=function(a,b,c){this._tree=a,this._path=b.replace(/^\/*/,"/").replace(/\/$/,"")||"/",c&&(this._annotations=c,Object.freeze(c))},Q={$ref:{},key:{},path:{},_pathPrefix:{},parent:{},annotations:{}};Q.$ref.get=function(){return this},Q.key.get=function(){return this._key||(this._key=e(this._path.replace(/.*\//,""))),this._key},Q.path.get=function(){return this._path},Q._pathPrefix.get=function(){return"/"===this._path?"":this._path},Q.parent.get=function(){return new S(this._tree,this._path.replace(/\/[^\/]*$/,""),this._annotations)},Q.annotations.get=function(){return this._annotations||O},P.prototype.child=function(){if(!arguments.length)return this;for(var a=[],b=0,c=arguments;b<c.length;b+=1){var e=c[b];if(void 0===e||null===e)return;a.push(d(e))}return new S(this._tree,this._pathPrefix+"/"+a.join("/"),this._annotations)},P.prototype.children=function(){var b=arguments,c=this;if(!arguments.length)return this;for(var e=[],f=0;f<arguments.length;f++){var g=b[f];if(a.isArray(g)){for(var h={},i=c._pathPrefix+(e.length?"/"+e.join("/"):""),j=a.slice(b,f+1),k=0,l=g;k<l.length;k+=1){var m=l[k],n=new S(c._tree,i+"/"+d(m),c._annotations),o=n.children.apply(n,j);o&&(h[m]=o)}return h}if(void 0===g||null===g)return;e.push(d(g))}return new S(this._tree,this._pathPrefix+"/"+e.join("/"),this._annotations)},P.prototype.peek=function(a){return this._tree.truss.peek(this,a)},P.prototype.match=function(a){return i(a).match(this.path)},P.prototype.test=function(a){return i(a).test(this.path)},P.prototype.isEqual=function(b){return b instanceof P&&(this._tree===b._tree&&this.toString()===b.toString()&&a.isEqual(this._annotations,b._annotations))},P.prototype.belongsTo=function(a){return this._tree.truss===a},Object.defineProperties(P.prototype,Q);var R=function(b){function c(c,d,e,f){b.call(this,c,d,f),this._spec=this._copyAndValidateSpec(e);var g=a(this._spec).map(function(a,b){return b+"="+encodeURIComponent(JSON.stringify(a))}).sortBy().join("&");this._string=this._path+"?"+g,Object.freeze(this)}b&&(c.__proto__=b),c.prototype=Object.create(b&&b.prototype),c.prototype.constructor=c;var d={ready:{},constraints:{}};return d.ready.get=function(){return this._tree.isQueryReady(this)},d.constraints.get=function(){return this._spec},c.prototype.annotate=function(b){return new c(this._tree,this._path,this._spec,a.assign({},this._annotations,b))},c.prototype._copyAndValidateSpec=function(b){if(!b.by)throw new Error('Query needs "by" clause: '+JSON.stringify(b));if(("at"in b)+("from"in b)+("to"in b)>1)throw new Error('Query must contain at most one of "at", "from", or "to" clauses: '+JSON.stringify(b));if(("first"in b)+("last"in b)>1)throw new Error('Query must contain at most one of "first" or "last" clauses: '+JSON.stringify(b));if(!a.some(["at","from","to","first","last"],function(a){return a in b}))throw new Error('Query must contain at least one of "at", "from", "to", "first", or "last" clauses: '+JSON.stringify(b));if(b=a.clone(b),"$key"!==b.by&&"$value"!==b.by){if(!(b.by instanceof S))throw new Error('Query "by" value must be a reference: '+b.by);var c=b.by.toString();if(!a.startsWith(c,this._path))throw new Error('Query "by" value must be a descendant of target reference: '+b.by);if(c=c.slice(this._path.length).replace(/^\/?/,""),!a.includes(c,"/"))throw new Error('Query "by" value must not be a direct child of target reference: '+b.by);b.by=c.replace(/.*?\//,"")}return Object.freeze(b),b},c.prototype.toString=function(){return this._string},Object.defineProperties(c.prototype,d),c}(P),S=function(b){function c(a,c,d){b.call(this,a,c,d),Object.freeze(this)}b&&(c.__proto__=b),c.prototype=Object.create(b&&b.prototype),c.prototype.constructor=c;var d={ready:{},value:{}};return d.ready.get=function(){return this._tree.isReferenceReady(this)},d.value.get=function(){return this._tree.getObject(this.path)},c.prototype.toString=function(){return this._path},c.prototype.annotate=function(b){return new c(this._tree,this._path,a.assign({},this._annotations,b))},c.prototype.query=function(a){return new R(this._tree,this._path,a,this._annotations)},c.prototype.set=function(a){return this._tree.update(this,"set",(b={},b[this.path]=a,b));var b},c.prototype.update=function(a){return this._tree.update(this,"update",a)},c.prototype.override=function(a){return this._tree.update(this,"override",(b={},b[this.path]=a,b));var b},c.prototype.commit=function(a){return this._tree.commit(this,a)},Object.defineProperties(c.prototype,d),c}(P),T=Object.freeze({".sv":"timestamp"}),U="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},V=function(a,b){return b={exports:{}},a(b,b.exports),b.exports}(function(a){(function(){var b,c,d;"undefined"!=typeof performance&&null!==performance&&performance.now?a.exports=function(){return performance.now()}:"undefined"!=typeof process&&null!==process&&process.hrtime?(a.exports=function(){return(b()-d)/1e6},c=process.hrtime,b=function(){var a;return a=c(),1e9*a[0]+a[1]},d=b()):Date.now?(a.exports=function(){return Date.now()-d},d=Date.now()):(a.exports=function(){return(new Date).getTime()-d},d=(new Date).getTime())}).call(U)}),W=function(b){a.assign(this,{name:b,numRecomputes:0,numUpdates:0,runtime:0})},X={runtimePerRecompute:{}};W.prototype.add=function(a){this.runtime+=a.runtime,this.numUpdates+=a.numUpdates,this.numRecomputes+=a.numRecomputes},X.runtimePerRecompute.get=function(){return this.numRecomputes?this.runtime/this.numRecomputes:0},W.prototype.toLogParts=function(a){return[this.name+":"," "+(this.runtime/1e3).toFixed(2)+"s","("+(this.runtime/a.runtime*100).toFixed(1)+"%)"," "+this.numUpdates+" upd /",this.numRecomputes+" runs","("+(this.numUpdates/this.numRecomputes*100).toFixed(1)+"%)"," "+this.runtimePerRecompute.toFixed(2)+"ms / run"]},Object.defineProperties(W.prototype,X);var Y=function(){this._items={}},Z={list:{}};Y.prototype.for=function(a){return this._items[a]||(this._items[a]=new W(a)),this._items[a]},Z.list.get=function(){return a(this._items).values().sortBy(function(a){return-a.runtime}).value()},Y.prototype.log=function(b){void 0===b&&(b=10);var c=this.list;if(c.length){var d=new W("=== Total");a.forEach(c,function(a){d.add(a)}),c=a.take(c,b);var e=new W("--- Above");a.forEach(c,function(a){e.add(a)});var f=a.map(c,function(a){return a.toLogParts(d)});f.push(e.toLogParts(d)),f.push(d.toLogParts(d));var g=a.map(a.range(f[0].length),function(b){return a(f).map(function(a){return a[b].length}).max()});a.forEach(f,function(b){console.log(a.map(b,function(b,c){return a.padLeft(b,g[c])}).join(" "))})}},Y.prototype.wrap=function(a,b,c){var d=this.for(b+"."+c);return function(){var b=V(),e=this._computedWatchers&&this._computedWatchers[c].value;try{var f=a.call(this);return k(e,f)||(d.numUpdates+=1),f}finally{d.runtime+=V()-b,d.numRecomputes+=1}}},Object.defineProperties(Y.prototype,Z);var $=new Y,_=function(c,d,e,f,g){var h=this;Object.freeze(d),this._scope=c,this._connections=d,this._tree=e,this._method=f,this._subConnectors={},this._disconnects={},this._angularUnwatches=void 0,this._data={},this._vue=new b({data:{descriptors:{},refs:g||{},values:a.mapValues(d,a.constant(void 0))}}),this.destroy=this.destroy,Object.seal(this),this._linkScopeProperties(),a.forEach(d,function(b,c){a.isFunction(b)?h._bindComputedConnection(c,b):h._connect(c,b)}),D.active&&c&&c.$on&&c.$id&&c.$on("$destroy",function(){h.destroy()})},aa={ready:{},at:{},data:{}};aa.ready.get=function(){var b=this;return a.every(this._connections,function(a,c){var d=b._vue.descriptors[c];return!!d&&(d instanceof P?d.ready:b._subConnectors[c].ready)})},aa.at.get=function(){return this._vue.refs},aa.data.get=function(){return this._data},_.prototype.destroy=function(){var b=this;this._unlinkScopeProperties(),a.forEach(this._angularUnwatches,function(a){a()}),a.forEach(this._connections,function(a,c){b._disconnect(c)}),this._vue.$destroy()},_.prototype._linkScopeProperties=function(){var b=this,c=a.mapValues(this._connections,function(a,c){return{configurable:!0,enumerable:!1,get:function(){var a=b._vue.descriptors[c];return a instanceof S?a.value:b._vue.values[c]}}});if(Object.defineProperties(this._data,c),this._scope){for(var d in b._connections)if(d in b._scope)throw new Error("Property already defined on connection target: "+d);Object.defineProperties(this._scope,c),this._scope.__ob__&&this._scope.__ob__.dep.notify()}},_.prototype._unlinkScopeProperties=function(){var b=this;this._scope&&a.forEach(this._connections,function(a,c){delete b._scope[c]})},_.prototype._bindComputedConnection=function(a,b){var c=$.for("connection.at."+a),d=this._computeConnection.bind(this,b,c),e=this._updateComputedConnection.bind(this,a,b,c),f=D.active&&!b.angularWatchSuppressed;this._vue.$watch(d,e,{immediate:!f}),f&&(this._angularUnwatches||(this._angularUnwatches=[]),this._angularUnwatches.push(D.watch(d,e,!0)))},_.prototype._computeConnection=function(a,b){var c=V();try{return n(a.call(this._scope))}finally{b.runtime+=V()-c,b.numRecomputes+=1}},_.prototype._updateComputedConnection=function(c,d,e){var f=a.isFunction(d)?d(this._scope):d,g=this._vue.descriptors[c],h=!k(g,f);if(h){if(e&&h&&(e.numUpdates+=1),!f)return void this._disconnect(c);f instanceof P||!a.has(this._subConnectors,c)?(this._disconnect(c),this._connect(c,f)):this._subConnectors[c]._updateConnections(f),b.set(this._vue.descriptors,c,f),D.digest()}},_.prototype._updateConnections=function(b){var c=this;a.forEach(b,function(a,b){c._updateComputedConnection(b,a)}),a.forEach(this._connections,function(d,e){a.has(b,e)||c._updateComputedConnection(e)}),this._connections=b},_.prototype._connect=function(a,c){var d=this;if(b.set(this._vue.descriptors,a,c),D.digest(),c)if(b.set(this._vue.values,a,void 0),c instanceof S)b.set(this._vue.refs,a,c),this._disconnects[a]=this._tree.connectReference(c,this._method);else if(c instanceof R){b.set(this._vue.refs,a,c);var e=this._updateQueryValue.bind(this,a);this._disconnects[a]=this._tree.connectQuery(c,e,this._method)}else{var f={},g={};b.set(this._vue.refs,a,g);var h=this._subConnectors[a]=new _(f,c,this._tree,this._method,g),i=this._disconnects[a]=this._tree.truss.observe(function(){return h.ready},function(c){c&&(i(),delete d._disconnects[a],b.set(d._vue.values,a,f),D.digest())})}},_.prototype._disconnect=function(c){b.delete(this._vue.refs,c),this._updateRefValue(c,void 0),a.has(this._subConnectors,c)&&(this._subConnectors[c].destroy(),delete this._subConnectors[c]),this._disconnects[c]&&this._disconnects[c](),delete this._disconnects[c],b.delete(this._vue.descriptors,c),D.digest()},_.prototype._updateRefValue=function(a,c){this._vue.values[a]!==c&&(b.set(this._vue.values,a,c),D.digest())},_.prototype._updateQueryValue=function(c,d){this._vue.values[c]||(b.set(this._vue.values,c,{}),D.digest());var e=this._vue.values[c];for(var f in e)e.hasOwnProperty(f)&&(a.includes(d,f)||(b.delete(e,f),D.digest()));for(var g=this._tree.getObject(this._vue.descriptors[c].path),h=0,i=d;h<i.length;h+=1){var j=i[h];e.hasOwnProperty(j)||(b.set(e,j,g[j]),D.digest())}},Object.defineProperties(_.prototype,aa);var ba=["read","write","auth","set","update","commit","connect","peek","authenticate","unathenticate","certify","all"],ca=[],da=function(a,b,c){this._operation=a,this._delay=b,this._callback=c,this._fired=!1};da.prototype.initiate=function(){var a=this;this.cancel(),this._fired=!1;var b=Date.now()-this._operation._startTimestamp;this._timeoutId=setTimeout(function(){a._fired=!0,a._callback(a._operation)},this._delay-b)},da.prototype.cancel=function(){this._fired&&this._callback(this._operation),this._timeoutId&&clearTimeout(this._timeoutId)};var ea=function(a,b,c,d){this._type=a,this._method=b,this._target=c,this._operand=d,this._ready=!1,this._running=!1,this._ended=!1,this._tries=0,this._startTimestamp=Date.now(),this._slowHandles=[]},fa={type:{},method:{},target:{},targets:{},operand:{},ready:{},running:{},ended:{},tries:{},error:{}};fa.type.get=function(){return this._type},fa.method.get=function(){return this._method},fa.target.get=function(){return this._target},fa.targets.get=function(){var b=this;return"update"!==this._method?[this._target]:a.map(this._operand,function(a,c){return new S(b._target._tree,g(b._target.path,c),b._target._annotations)})},fa.operand.get=function(){return this._operand},fa.ready.get=function(){return this._ready},fa.running.get=function(){return this._running},fa.ended.get=function(){return this._ended},fa.tries.get=function(){return this._tries},fa.error.get=function(){return this._error},ea.prototype.onSlow=function(a,b){var c=new da(this,a,b);this._slowHandles.push(c),c.initiate()},ea.prototype._setRunning=function(a){this._running=a},ea.prototype._setEnded=function(a){this._ended=a},ea.prototype._markReady=function(b){this._ready=!0,b||(this._tries=0),a.forEach(this._slowHandles,function(a){return a.cancel()})},ea.prototype._clearReady=function(){this._ready=!1,this._startTimestamp=Date.now(),a.forEach(this._slowHandles,function(a){return a.initiate()})},ea.prototype._incrementTries=function(){this._tries++},Object.defineProperties(ea.prototype,fa);var ga=function(a){this._bridge=a,this._callbacks={},Object.freeze(this)};ga.prototype.intercept=function(b,c){if(!a.includes(ba,b))throw new Error("Unknown intercept operation type: "+b);var d=a.difference(a.keys(c),["onBefore","onAfter","onError","onFailure"]);if(d.length)throw new Error("Unknown intercept callback types: "+d.join(", "));var e={onBefore:this._addCallback("onBefore",b,c.onBefore),onAfter:this._addCallback("onAfter",b,c.onAfter),onError:this._addCallback("onError",b,c.onError),onFailure:this._addCallback("onFailure",b,c.onFailure)};return this._removeCallbacks.bind(this,b,e)},ga.prototype._addCallback=function(a,b,c){if(c){var d=this._getCallbacksKey(a,b),e=o(c);return(this._callbacks[d]||(this._callbacks[d]=[])).push(e),e}},ga.prototype._removeCallback=function(b,c,d){if(d){var e=this._getCallbacksKey(b,c);this._callbacks[e]&&a.pull(this._callbacks[e],d)}},ga.prototype._removeCallbacks=function(b,c){var d=this;a.forEach(c,function(a,c){d._removeCallback(c,b,a)})},ga.prototype._getCallbacks=function(a,b,c){return[].concat(this._callbacks[this._getCallbacksKey(a,c)]||ca,this._callbacks[this._getCallbacksKey(a,b)]||ca,this._callbacks[this._getCallbacksKey(a,"all")]||ca)},ga.prototype._getCallbacksKey=function(a,b){return a+"_"+b},ga.prototype.execute=function(a,b,c,d,e){var f=this;e=o(e);var g=this.createOperation(a,b,c,d);return this.begin(g).then(function(){var a=function(){return e().catch(function(b){return f._retryOrEnd(g,b).then(a)})};return a()}).then(function(a){return f.end(g).then(function(){return a})})},ga.prototype.createOperation=function(a,b,c,d){return new ea(a,b,c,d)},ga.prototype.begin=function(b){var c=this;return Promise.all(a.map(this._getCallbacks("onBefore",b.type,b.method),function(a){return a(b)})).then(function(){b.ended||b._setRunning(!0)},function(a){return c.end(b,a)})},ga.prototype.markReady=function(a){a._markReady()},ga.prototype.clearReady=function(a){a._clearReady()},ga.prototype.retry=function(b,c){return b._incrementTries(),b._error=c,Promise.all(a.map(this._getCallbacks("onError",b.type,b.method),function(a){return a(b,c)})).then(function(c){if(!b.ended){var d=a.some(c);return d&&delete b._error,d}})},ga.prototype._retryOrEnd=function(a,b){var c=this;return this.retry(a,b).then(function(d){if(!d)return c.end(a,b)},function(b){return c.end(a,b)})},ga.prototype.end=function(b,c){var d=this;return b.ended?Promise.resolve():(b._setRunning(!1),b._setEnded(!0),c?b._error=c:delete b._error,Promise.all(a.map(this._getCallbacks("onAfter",b.type,b.method),function(a){return a(b)})).then(function(){return d._afterEnd(b)},function(a){return b._error=a,d._afterEnd(b)}))},ga.prototype._afterEnd=function(b){if(b._markReady(!0),!b.error)return Promise.resolve();var c=this._getCallbacks("onFailure",b.type,b.method);return c&&setTimeout(function(){a.forEach(c,function(a){return a(b)})},0),Promise.reject(b.error)};var ha="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",ia=window.crypto&&window.crypto.getRandomValues&&window.crypto.getRandomValues.bind(window.crypto),ja=function(){this._lastUniqueKeyTime=0,this._lastRandomValues=[]};ja.prototype.generateUniqueKey=function(a){var b=this;a=a||Date.now();for(var c=new Array(20),d=a,e=7;e>=0;e--)c[e]=ha.charAt(63&d),d=Math.floor(d/64);if(a===this._lastUniqueKeyTime){for(var f=11;f>=0&&63===this._lastRandomValues[f];)b._lastRandomValues[f]=0,f-=1;if(-1===f)throw new Error("Internal assertion failure: ran out of unique IDs for this millisecond");this._lastRandomValues[f]+=1}else if(this._lastUniqueKeyTime=a,ia){var g=new Uint8Array(12);ia(g);for(var h=0;h<12;h++)b._lastRandomValues[h]=g[h]&(h?63:15)}else for(var i=0;i<12;i++)b._lastRandomValues[i]=Math.floor(Math.random()*(i?64:16));for(var j=0;j<12;j++)c[j+8]=ha[b._lastRandomValues[j]];return c.join("")};var ka=function(a,c,d,e){this._rootUrl=a,this._tree=c,this._dispatcher=e,this._bridge=d,this._vue=new b({data:{$root:{connected:void 0,timeOffset:0,user:void 0,userid:void 0,nowAtInterval:function(a){var c=this,d="now"+a;if(!this.hasOwnProperty(d)){var e=function(){b.set(c,d,Date.now()+c.timeOffset),D.digest()};e(),setInterval(e,a)}return this[d]}}}}),this._auth={serial:0,initialAuthChangeReceived:!1},d.onAuth(a,this._handleAuthChange,this),this._connectInfoProperty("serverTimeOffset","timeOffset"),this._connectInfoProperty("connected","connected"),Object.freeze(this)},la={root:{}};la.root.get=function(){return this._vue.$data.$root},ka.prototype.destroy=function(){this._bridge.offAuth(this._rootUrl,this._handleAuthChange,this),this._vue.$destroy()},ka.prototype.authenticate=function(a){var b=this;return this._auth.serial++,
this._dispatcher.execute("auth","authenticate",new S(this._tree,"/"),a,function(){return b._bridge.authWithCustomToken(b._rootUrl,a)})},ka.prototype.unauthenticate=function(){var a=this;return this._auth.serial++,this._handleAuthChange(null).then(function(b){if(b)return a._dispatcher.execute("auth","unauthenticate",new S(a._tree,"/"),void 0,function(){return a._bridge.unauth(a._rootUrl)})})},ka.prototype._handleAuthChange=function(a){var b=this,c=!this._auth.initialAuthChangeReceived&&this._auth.serial;if(void 0!==a&&(this._auth.initialAuthChangeReceived=!0),!c){var d=this._auth.serial;return this.root.user===a?Promise.resolve(!1):this._dispatcher.execute("auth","certify",new S(this._tree,"/"),a,function(){return b.root.user!==a&&d===b._auth.serial&&(a&&Object.freeze(a),b.root.user=a,b.root.userid=a&&a.uid,D.digest(),!0)})}},ka.prototype._isAuthChangeStale=function(a){return this.root.user===a},ka.prototype._connectInfoProperty=function(a,b){var c=this,d=this._rootUrl+"/.info/"+a;this._bridge.on(d,d,null,"value",function(a){c.root[b]=a.value,D.digest()})},Object.defineProperties(ka.prototype,la);var ma,na,oa={$$$trussCheck:!0,__ob__:!0},pa=function(){},qa={$meta:{},$store:{},$now:{},$$finalizers:{}};qa.$meta.get=function(){return this.$truss.meta},qa.$store.get=function(){return this.$truss.store},qa.$now.get=function(){return this.$truss.now},pa.prototype.$newKey=function(){return this.$truss.newKey()},pa.prototype.$intercept=function(b,c){var d=this;if(this.$destroyed)throw new Error("Object already destroyed");var e=this.$truss.intercept(b,c),f=function(){e(),a.pull(d.$$finalizers,f)};return this.$$finalizers.push(f),f},pa.prototype.$connect=function(b,c){var d=this;if(this.$destroyed)throw new Error("Object already destroyed");c||(c=b,b=void 0);var e=this.$truss.connect(b,t(this,c)),f=e.destroy,g=function(){return a.pull(d.$$finalizers,g),f.call(e)};return this.$$finalizers.push(g),e.destroy=g,e},pa.prototype.$peek=function(b,c){var d=this;if(this.$destroyed)throw new Error("Object already destroyed");var e=r(this.$truss.peek(b,c),function(){a.pull(d.$$finalizers,e.cancel)});return this.$$finalizers.push(e.cancel),e},pa.prototype.$observe=function(b,c,d){var e=this;if(this.$destroyed)throw new Error("Object already destroyed");var f,g=this.$truss.observe(function(){return e.$$touchThis(),b.call(e)},c.bind(this),d);return f=function(){g(),a.pull(e.$$finalizers,f)},this.$$finalizers.push(f),f},pa.prototype.$when=function(b,c){var d=this;if(this.$destroyed)throw new Error("Object already destroyed");var e=this.$truss.when(function(){return d.$$touchThis(),b.call(d)},c);return r(e,function(){a.pull(d.$$finalizers,e.cancel)}),this.$$finalizers.push(e.cancel),e},qa.$$finalizers.get=function(){return Object.defineProperty(this,"$$finalizers",{value:[],writable:!1,enumerable:!1,configurable:!1}),this.$$finalizers},Object.defineProperties(pa.prototype,qa);var ra=function(){},sa={$parent:{},$path:{},$truss:{},$ref:{},$refs:{},$key:{},$data:{},$hidden:{},$empty:{},$keys:{},$values:{},$ready:{},$overridden:{},$$initializers:{},$destroyed:{}};sa.$parent.get=function(){return ma.$parent.value},sa.$path.get=function(){return ma.$path.value},sa.$truss.get=function(){return Object.defineProperty(this,"$truss",{value:this.$parent.$truss}),this.$truss},sa.$ref.get=function(){return Object.defineProperty(this,"$ref",{value:new S(this.$truss._tree,this.$path)}),this.$ref},sa.$refs.get=function(){return this.$ref},sa.$key.get=function(){return Object.defineProperty(this,"$key",{value:e(this.$path.slice(this.$path.lastIndexOf("/")+1))}),this.$key},sa.$data.get=function(){return this},sa.$hidden.get=function(){return!1},sa.$empty.get=function(){return a.isEmpty(this.$data)},sa.$keys.get=function(){return a.keys(this.$data)},sa.$values.get=function(){return a.values(this.$data)},sa.$ready.get=function(){return this.$ref.ready},sa.$overridden.get=function(){return!1},ra.prototype.$nextTick=function(){var b=this;if(this.$destroyed)throw new Error("Object already destroyed");var c=this.$truss.nextTick();return r(c,function(){a.pull(b.$$finalizers,c.cancel)}),this.$$finalizers.push(c.cancel),c},ra.prototype.$freezeComputedProperty=function(){if(!a.isBoolean(na))throw new Error("Cannot freeze a computed property outside of its getter function");na=!0},ra.prototype.$set=function(a){return this.$ref.set(a)},ra.prototype.$update=function(a){return this.$ref.update(a)},ra.prototype.$override=function(a){return this.$ref.override(a)},ra.prototype.$commit=function(a,b){return this.$ref.commit(a,b)},ra.prototype.$$touchThis=function(){this.__ob__?this.__ob__.dep.depend():this.$parent?(this.$parent.hasOwnProperty("$data")?this.$parent.$data:this.$parent)[this.$key]:this.$store},sa.$$initializers.get=function(){return Object.defineProperty(this,"$$initializers",{value:[],writable:!1,enumerable:!1,configurable:!0}),this.$$initializers},sa.$destroyed.get=function(){return!1},Object.defineProperties(ra.prototype,sa),m(pa,ra),a.forEach(ra.prototype,function(a,b){Object.defineProperty(ra.prototype,b,{value:a,enumerable:!1,configurable:!1,writable:!1})});var ta=function(a){this.error=a},ua=function(a){this.value=a},va=function(a){this._trie={Class:ra},this._debug=a,Object.freeze(this)};va.prototype.init=function(b,c){var d=this;a.isPlainObject(b)&&(a.forEach(b,function(a,b){a.$trussMount||(a.$$trussMount=a.$$trussMount||[],a.$$trussMount.push(b))}),b=a.values(b),a.forEach(b,function(a){!a.$trussMount&&a.$$trussMount&&(a.$trussMount=a.$$trussMount,delete a.$$trussMount)})),b=a.uniq(b),a.forEach(b,function(a){return d._mountClass(a,c)}),this._decorateTrie(this._trie)},va.prototype.destroy=function(){},va.prototype._getMount=function(a,b,c){for(var d,e=this,f=h(a,!0),g=0,i=f;g<i.length;g+=1){var j=i[g],k=j?d.children&&(d.children[j]||!b&&d.children.$):e._trie;if(!k){if(!b)return;d.children=d.children||{},k=d.children[j]={Class:ra}}if(d=k,c&&c(d))break}return d},va.prototype._findMount=function(b,c){var d=this;if(c||(c=this._trie),b(c))return c;for(var e=0,f=a.keys(c.children);e<f.length;e+=1){var g=f[e],h=d._findMount(b,c.children[g]);if(h)return h}},va.prototype._decorateTrie=function(b){var c=this;a.forEach(b.children,function(a){c._decorateTrie(a),(a.local||a.localDescendants)&&(b.localDescendants=!0)})},va.prototype._augmentClass=function(b){for(var c,d=b.prototype;d&&d.constructor!==Object;){for(var e=0,f=Object.getOwnPropertyNames(d);e<f.length;e+=1){var g=f[e],h=Object.getOwnPropertyDescriptor(d,g);if("$"===g.charAt(0)){if("$finalize"===g)continue;if(a.isEqual(h,Object.getOwnPropertyDescriptor(ra.prototype,g)))continue;throw new Error('Property names starting with "$" are reserved: '+b.name+"."+g)}!h.get||c&&c[g]||((c||(c={}))[g]={name:g,fullName:d.constructor.name+"."+g,get:h.get,set:h.set})}d=Object.getPrototypeOf(d)}for(var i=0,j=Object.getOwnPropertyNames(ra.prototype);i<j.length;i+=1){var k=j[i];"constructor"===k||b.prototype.hasOwnProperty(k)||Object.defineProperty(b.prototype,k,Object.getOwnPropertyDescriptor(ra.prototype,k))}return c},va.prototype._mountClass=function(b,c){var d=this,e=this._augmentClass(b),f=[],g=b.$trussMount;if(!g)throw new Error("Class "+b.name+" lacks a $trussMount static property");a.isArray(g)||(g=[g]),a.forEach(g,function(g){if(a.isString(g)&&(g={path:g}),!c&&"/"===g.path)throw new Error("Data root already accessed, too late to mount class");for(var h=i(g.path),j=0,k=h.variables;j<k.length;j+=1){var l=k[j];if("$"===l||"$"===l.charAt(1))throw new Error("Invalid variable name: "+l);if("$"===l.charAt(0)&&(a.has(ra.prototype,l)||oa[l]))throw new Error("Variable name conflicts with built-in property or method: "+l);f.push(l)}var m=g.path.match(/\/([^\/]*)$/)[1];if("$"===m.charAt(0)){if(g.placeholder)throw new Error("Class "+b.name+" mounted at wildcard "+m+" cannot be a placeholder")}else a.has(g,"placeholder")||(g.placeholder={});var n=d._getMount(g.path.replace(/\$[^\/]*/g,"$"),!0);if(n.matcher&&(n.escapedKey===m||"$"===n.escapedKey.charAt(0)&&"$"===m.charAt(0)))throw new Error("Multiple classes mounted at "+g.path+": "+n.Class.name+", "+b.name);a.assign(n,{Class:b,matcher:h,computedProperties:e,escapedKey:m},a.pick(g,"placeholder","local","keysUnsafe","hidden"))}),a.forEach(f,function(a){b.prototype[a]||Object.defineProperty(b.prototype,a,{get:function(){return ma?ma[a]&&ma[a].value:void 0}})})},va.prototype.createObject=function(b,c){var d=this,e=this._getMount(b)||{Class:ra};if(e.matcher){var f=e.matcher.match(b);for(var g in f)c[g]={value:f[g]}}ma=c;var h=new e.Class;return ma=null,D.active&&this._wrapProperties(h),e.keysUnsafe&&(c.$data={value:Object.create(null),configurable:!0,enumerable:!0}),e.hidden&&(c.$hidden={value:!0}),e.computedProperties&&a.forEach(e.computedProperties,function(a){c[a.name]=d._buildComputedPropertyDescriptor(h,a)}),h},va.prototype._wrapProperties=function(b){a.forEach(b,function(a,c){var d="$_"+c;Object.defineProperties(b,(e={},e[d]={value:a,writable:!0},e[c]={get:function(){return b[d]},set:function(a){b[d]=a,D.digest()},enumerable:!0,configurable:!0},e));var e})},va.prototype._buildComputedPropertyDescriptor=function(b,c){var d,e,f=this,g=$.for(c.fullName),h=!1;return b.$$initializers.push(function(i){function j(e){if(e instanceof ua&&(e=e.value,n(),a.pull(b.$$finalizers,n)),!k(d,e))return g.numUpdates+=1,h=!0,b[c.name]=e,h=!1,u(e),!0}var l=!1,m=s.bind(b,c,g);f._debug&&(m.toString=function(){return c.fullName});var n=function(){l=!0};n=i.$watch(m,function(c){if(b.$destroyed)return void n();if(e&&(e.cancel&&e.cancel(),e=void 0),a.isObject(c)&&a.isFunction(c.then)){var d=c.then(function(a){d===e&&j(a)},function(a){if(d===e&&j(new ta(a))&&!a.trussExpectedException)throw a});e=d}else if(j(c)&&(D.digest(),c instanceof ta&&!c.error.trussExpectedException))throw c.error},{immediate:!0});var o=a.last(i._watchers);o.id=-o.id,l?n():b.$$finalizers.push(n)}),{enumerable:!0,configurable:!0,get:function(){if(!h&&d instanceof ta)throw d.error;return d},set:function(a){if(h)d=a;else{if(!c.set)throw new Error("You cannot set a computed property: "+c.name);c.set.call(this,a)}}}},va.prototype.destroyObject=function(b){if(a.has(b,"$$finalizers"))for(var c=0,d=a.clone(b.$$finalizers);c<d.length;c+=1){var e=d[c];e()}a.isFunction(b.$finalize)&&b.$finalize(),Object.defineProperty(b,"$destroyed",{value:!0,enumerable:!1,configurable:!1})},va.prototype.isPlaceholder=function(a){var b=this._getMount(a);return b&&b.placeholder},va.prototype.isLocal=function(a,b){var c=this._getMount(a,!1,function(a){return a.local});if(c&&c.local)return!0;if(this._hasLocalProperties(c,b))throw new Error("Write on a mix of local and remote tree paths.");return!1},va.prototype._hasLocalProperties=function(b,c){var e=this;if(!b)return!1;if(b.local)return!0;if(!b.localDescendants||!a.isObject(c))return!1;for(var f in c){if(e._hasLocalProperties(b.children[d(f)]||b.children.$,c[f]))return!0}return!1},va.prototype.forEachPlaceholderChild=function(b,c){var d=this._getMount(b);a.forEach(d&&d.children,function(a){a.placeholder&&c(a)})},va.prototype.checkVueObject=function(b,c,e){var f=this,h=!e;h&&(e=[]);try{for(var i=0,j=Object.getOwnPropertyNames(b);i<j.length;i+=1){var k=j[i];if(!(oa[k]||ra.prototype.hasOwnProperty(k)||/^\$_/.test(k))){var l=f._findMount(function(a){return a.Class===b.constructor});if(!(l&&l.matcher&&a.includes(l.matcher.variables,k))){var m=void 0;try{m=b[k]}catch(a){continue}if(!a.isArray(b)||!/\d+/.test(k)&&"length"!==k){var n=Object.getOwnPropertyDescriptor(b,k);if("value"in n||!n.get)throw new Error("Value at "+c+", contained in a Firetruss object, has a rogue property: "+k);if(b.$truss&&n.enumerable)try{throw b[k]=m,new Error("Firetruss object at "+c+" has an enumerable non-Firebase property: "+k)}catch(a){if("firebase_overwrite"!==a.trussCode)throw a}}a.isObject(m)&&!m.$$$trussCheck&&Object.isExtensible(m)&&!(a.isFunction(m)||m instanceof Promise)&&(m.$$$trussCheck=!0,e.push(m),f.checkVueObject(m,g(c,d(k)),e))}}}}finally{if(h)for(var o=0,p=e;o<p.length;o+=1){var q=p[o];delete q.$$$trussCheck}}};var wa=function(a,b){this._coupler=a,this._query=b,this._listeners=[],this._keys=[],this._url=this._coupler._rootUrl+b.path,this._segments=h(b.path,!0),this._listening=!1,this.ready=!1};wa.prototype.attach=function(a,b){this._listen(),this._listeners.push({operation:a,keysCallback:b}),b&&b(this._keys)},wa.prototype.detach=function(b){var c=a.findIndex(this._listeners,{operation:b});return c>=0&&this._listeners.splice(c,1),this._listeners.length},wa.prototype._listen=function(){this._listening||(this._coupler._bridge.on(this._query.toString(),this._url,this._query.constraints,"value",this._handleSnapshot,this._handleError,this,{sync:!0}),this._listening=!0)},wa.prototype.destroy=function(){var a=this;this._coupler._bridge.off(this._query.toString(),this._url,this._query.constraints,"value",this._handleSnapshot,this),this._listening=!1,this.ready=!1,D.digest();for(var b=0,c=a._keys;b<c.length;b+=1){var d=c[b];a._coupler._decoupleSegments(a._segments.concat(d))}},wa.prototype._handleSnapshot=function(a){var b=this;this._coupler._queueSnapshotCallback(function(){if(b._listeners.length&&b._listening){var c=b._updateKeys(a);if(b._coupler._applySnapshot(a),!b.ready){b.ready=!0,D.digest();for(var d=0,e=b._listeners;d<e.length;d+=1){var f=e[d];b._coupler._dispatcher.markReady(f.operation)}}if(c)for(var g=0,h=b._listeners;g<h.length;g+=1){var i=h[g];i.keysCallback&&i.keysCallback(c)}}})},wa.prototype._updateKeys=function(b){var c,d=this;if(b.path===this._query.path)if(c=a.keys(b.value),c.sort(),a.isEqual(this._keys,c))c=null;else{for(var e=0,f=a.difference(c,d._keys);e<f.length;e+=1){var g=f[e];d._coupler._coupleSegments(d._segments.concat(g))}for(var h=0,i=a.difference(d._keys,c);h<i.length;h+=1){var j=i[h];d._coupler._decoupleSegments(d._segments.concat(j))}this._keys=c}else if(b.path.replace(/\/[^\/]+/,"")===this._query.path){var k=a.includes(this._keys,b.key);b.value?k||(this._coupler._coupleSegments(this._segments.concat(b.key)),this._keys.push(b.key),this._keys.sort(),c=this._keys):k&&(this._coupler._decoupleSegments(this._segments.concat(b.key)),a.pull(this._keys,b.key),this._keys.sort(),c=this._keys)}return c},wa.prototype._handleError=function(b){var c=this;this._listeners.length&&this._listening&&(this._listening=!1,this.ready=!1,D.digest(),Promise.all(a.map(this._listeners,function(a){return c._coupler._dispatcher.clearReady(a.operation),c._coupler._dispatcher.retry(a.operation,b).catch(function(b){return a.operation._disconnect(b),!1})})).then(function(d){if(a.some(d))c._listeners.length&&c._listen();else for(var e=0,f=c._listeners;e<f.length;e+=1){var g=f[e];g.operation._disconnect(b)}}))};var xa=function(a,b,c){this._coupler=a,this.path=b,this.parent=c,this.url=this._coupler._rootUrl+b,this.operations=[],this.queryCount=0,this.listening=!1,this.ready=!1,this.children={}},ya={active:{},count:{}};ya.active.get=function(){return this.count||this.queryCount},ya.count.get=function(){return this.operations.length},xa.prototype.listen=function(b){var c=this;if(!b&&this.count){if(this.listening)return;a.forEach(this.operations,function(a){c._coupler._dispatcher.clearReady(a)}),this._coupler._bridge.on(this.url,this.url,null,"value",this._handleSnapshot,this._handleError,this,{sync:!0}),this.listening=!0}else a.forEach(this.children,function(a){a.listen()})},xa.prototype.unlisten=function(b){!b&&this.listening?(this._coupler._bridge.off(this.url,this.url,null,"value",this._handleSnapshot,this),this.listening=!1,this._forAllDescendants(function(a){if(a.listening)return!1;a.ready&&(a.ready=!1,D.digest())})):a.forEach(this.children,function(a){a.unlisten()})},xa.prototype._handleSnapshot=function(a){var b=this;this._coupler._queueSnapshotCallback(function(){b.listening&&b._coupler.isTrunkCoupled(a.path)&&(b._coupler._applySnapshot(a),b.ready||a.path!==b.path||(b.ready=!0,D.digest(),b.unlisten(!0),b._forAllDescendants(function(a){for(var c=0,d=a.operations;c<d.length;c+=1){var e=d[c];b._coupler._dispatcher.markReady(e)}})))})},xa.prototype._handleError=function(b){var c=this;if(this.count&&this.listening)return this.listening=!1,this._forAllDescendants(function(a){if(a.listening)return!1;a.ready&&(a.ready=!1,D.digest());for(var b=0,d=a.operations;b<d.length;b+=1){var e=d[b];c._coupler._dispatcher.clearReady(e)}}),Promise.all(a.map(this.operations,function(a){return c._coupler._dispatcher.retry(a,b).catch(function(b){return a._disconnect(b),!1})})).then(function(d){if(a.some(d))c.count&&c.listen();else for(var e=0,f=c.operations;e<f.length;e+=1){var g=f[e];g._disconnect(b)}})},xa.prototype._forAllDescendants=function(b){!1!==b(this)&&a.forEach(this.children,function(a){return a._forAllDescendants(b)})},xa.prototype.collectCoupledDescendantPaths=function(b){return b||(b={}),b[this.path]=this.active,this.active||a.forEach(this.children,function(a){a.collectCoupledDescendantPaths(b)}),b},Object.defineProperties(xa.prototype,ya);var za=function(a,c,d,e,f){this._rootUrl=a,this._bridge=c,this._dispatcher=d,this._applySnapshot=e,this._pendingSnapshotCallbacks=[],this._throttled={processPendingSnapshots:this._processPendingSnapshots},this._prunePath=f,this._vue=new b({data:{root:void 0,queryHandlers:{}}}),this._nodeIndex=Object.create(null),Object.freeze(this),this._vue.$data.root=new xa(this,"/"),this._nodeIndex["/"]=this._root},Aa={_root:{},_queryHandlers:{}};Aa._root.get=function(){return this._vue.$data.root},Aa._queryHandlers.get=function(){return this._vue.$data.queryHandlers},za.prototype.destroy=function(){a.forEach(this._queryHandlers,function(a){a.destroy()}),this._root.unlisten(),this._vue.$destroy()},za.prototype.couple=function(a,b){return this._coupleSegments(h(a,!0),b)},za.prototype._coupleSegments=function(a,c){for(var d,e=this,f=!c,g=!1,h=0,i=a;h<i.length;h+=1){var j=i[h],k=j?d.children&&d.children[j]:e._root;k||(k=new xa(e,("/"===d.path?"":d.path)+"/"+j,d),b.set(d.children,j,k),e._nodeIndex[k.path]=k),f=f||k.listening,g=g||k.ready,d=k}c?d.operations.push(c):d.queryCount++,f?c&&g&&this._dispatcher.markReady(c):d.listen()},za.prototype.decouple=function(a,b){return this._decoupleSegments(h(a,!0),b)},za.prototype._decoupleSegments=function(c,d){for(var e,f=this,g=[],h=0,i=c;h<i.length;h+=1){var j=i[h];if(!(e=j?e.children&&e.children[j]:f._root))break;g.push(e)}if(!e||!(d?e.count:e.queryCount))throw new Error("Path not coupled: "+(c.join("/")||"/"));if(d?a.pull(e.operations,d):e.queryCount--,d&&!e.count&&(e.listen(),e.listening&&e.unlisten()),!e.active){for(var k=g.length-1;k>0&&((e=g[k])!==f._root&&!e.active&&a.isEmpty(e.children));k--)b.delete(g[k-1].children,c[k]),e.ready=void 0,delete f._nodeIndex[e.path];var l=c.join("/")||"/";this._prunePath(l,this.findCoupledDescendantPaths(l))}},za.prototype.subscribe=function(a,c,d){var e=this._queryHandlers[a.toString()];e||(e=new wa(this,a),b.set(this._queryHandlers,a.toString(),e)),e.attach(c,d)},za.prototype.unsubscribe=function(a,c){var d=this._queryHandlers[a.toString()];d&&!d.detach(c)&&(d.destroy(),b.delete(this._queryHandlers,a.toString()))},za.prototype.isTrunkCoupled=function(a){for(var b,c=this,d=h(a,!0),e=0,f=d;e<f.length;e+=1){var g=f[e];if(!(b=g?b.children&&b.children[g]:c._root))return!1;if(b.active)return!0}return!1},za.prototype.findCoupledDescendantPaths=function(a){for(var b,c=this,d=0,e=h(a,!0);d<e.length;d+=1){var f=e[d];if((b=f?b.children&&b.children[f]:c._root)&&b.active){return g={},g[a]=b.active,g;var g}if(!b)break}return b&&b.collectCoupledDescendantPaths()},za.prototype.isSubtreeReady=function(a){function b(a){return d=a.slice(1),""}for(var c,d;!(c=this._nodeIndex[a]);)a=a.replace(/\/[^\/]*$/,b)||"/";for(d&&c.children;c;){if(c.ready)return!0;c=c.parent}return!1},za.prototype.isQueryReady=function(a){var b=this._queryHandlers[a.toString()];return b&&b.ready},za.prototype._queueSnapshotCallback=function(a){this._pendingSnapshotCallbacks.push(a),this._throttled.processPendingSnapshots.call(this)},za.prototype._processPendingSnapshots=function(){for(var a=this,b=0,c=a._pendingSnapshotCallbacks;b<c.length;b+=1){(0,c[b])()}this._pendingSnapshotCallbacks.splice(0,1/0)},za.prototype.throttleSnapshots=function(b){this._throttled.processPendingSnapshots=b?a.throttle(this._processPendingSnapshots,b):this._processPendingSnapshots},Object.defineProperties(za.prototype,Aa);var Ba=function(a){this._ref=a,this._outcome=void 0,this._values=void 0},Ca={currentValue:{},outcome:{},values:{}};Ca.currentValue.get=function(){return this._ref.value},Ca.outcome.get=function(){return this._outcome},Ca.values.get=function(){return this._values},Ba.prototype._setOutcome=function(a){if(this._outcome)throw new Error("Transaction already resolved with "+this._outcome);this._outcome=a},Ba.prototype.abort=function(){this._setOutcome("abort")},Ba.prototype.cancel=function(){this._setOutcome("cancel")},Ba.prototype.set=function(a){if(void 0===a)throw new Error("Invalid argument: undefined");this._setOutcome("set"),this._values={"":a}},Ba.prototype.update=function(b){if(void 0===b)throw new Error("Invalid argument: undefined");if(a.isEmpty(b))return this.cancel();this._setOutcome("update"),this._values=b},Object.defineProperties(Ba.prototype,Ca);var Da=function(a,c,d,e){this._truss=a,this._rootUrl=c,this._bridge=d,this._dispatcher=e,this._firebasePropertyEditAllowed=!1,this._writeSerial=0,this._localWrites={},this._localWriteTimestamp=null,this._initialized=!1,this._modeler=new va("dev"===a.constructor.VERSION),this._coupler=new za(c,d,e,this._integrateSnapshot.bind(this),this._prune.bind(this)),this._vue=new b({data:{$root:void 0}}),Object.seal(this)},Ea={root:{},truss:{}};Ea.root.get=function(){return this._vue.$data.$root||(this._vue.$data.$root=this._createObject("/"),this._fixObject(this._vue.$data.$root),this._completeCreateObject(this._vue.$data.$root),D.digest()),this._vue.$data.$root},Ea.truss.get=function(){return this._truss},Da.prototype.init=function(a){var b=this;if(this._initialized)throw new Error("Data objects already created, too late to mount classes");this._initialized=!0,this._modeler.init(a,!this._vue.$data.$root);var c=[];this._plantPlaceholders(this.root,"/",void 0,c);for(var d=0,e=c;d<e.length;d+=1){var f=e[d];b._completeCreateObject(f)}},Da.prototype.destroy=function(){this._coupler.destroy(),this._modeler&&this._modeler.destroy(),this._vue.$destroy()},Da.prototype.connectReference=function(b,c){var d=this;this._checkHandle(b);var e=this._dispatcher.createOperation("read",c,b);return e._disconnect=this._disconnectReference.bind(this,b,e,void 0),this._dispatcher.begin(e).then(function(){e.running&&!e._disconnected&&(d._coupler.couple(b.path,e),e._coupled=!0)}).catch(a.noop),e._disconnect},Da.prototype._disconnectReference=function(b,c,d,e){c._disconnected||(c._disconnected=!0,d&&d(),c._coupled&&(this._coupler.decouple(b.path,c),c._coupled=!1),this._dispatcher.end(c,e).catch(a.noop))},Da.prototype.isReferenceReady=function(a){return this._checkHandle(a),this._coupler.isSubtreeReady(a.path)},Da.prototype.connectQuery=function(b,c,d){var e=this;this._checkHandle(b);var f=this._dispatcher.createOperation("read",d,b);return f._disconnect=this._disconnectQuery.bind(this,b,f),this._dispatcher.begin(f).then(function(){f.running&&!f._disconnected&&(e._coupler.subscribe(b,f,c),f._coupled=!0)}).catch(a.noop),f._disconnect},Da.prototype._disconnectQuery=function(b,c,d){c._disconnected||(c._disconnected=!0,c._coupled&&(this._coupler.unsubscribe(b,c),c._coupled=!1),this._dispatcher.end(c,d).catch(a.noop))},Da.prototype.isQueryReady=function(a){return this._coupler.isQueryReady(a)},Da.prototype._checkHandle=function(a){if(!a.belongsTo(this._truss))throw new Error("Reference belongs to another Truss instance")},Da.prototype.throttleRemoteDataUpdates=function(a){this._coupler.throttleSnapshots(a)},Da.prototype.update=function(b,c,d){var e=this;d=a.mapValues(d,function(a){return f(a)});var g=a.size(d);if(!g)return Promise.resolve();if("update"!==c&&"override"!==c||v(b.path,d),this._applyLocalWrite(d,"override"===c))return Promise.resolve();var h=w(d);x(h,d),h!==b.path&&(b=new S(b._tree,h,b._annotations));var i=this._rootUrl+h,j=this._writeSerial,k=1===g,l=k?d[""]:d;return this._dispatcher.execute("write",k?"set":"update",b,l,function(){return e._bridge[k?"set":"update"](i,l,j).catch(function(a){return a.immediateFailure?r(e._repair(b,d),function(){return Promise.reject(a)}):Promise.reject(a)})})},Da.prototype.commit=function(c,d){var e=this,g=0;d=o(d);var h=function(){if(g++>=25)return Promise.reject(new Error("Transaction needed too many retries, giving up"));var i,j=new Ba(c);return b.nextTick().then(function(){return i=y(j.currentValue),d(j)}).then(function(){if(!a.isEqual(i,y(j.currentValue)))return h();if("abort"===j.outcome)return j;var b=a.mapValues(j.values,function(a){return f(a)});switch(j.outcome){case"cancel":break;case"set":if(e._applyLocalWrite((d={},d[c.path]=b[""],d))){return Promise.resolve();var d}break;case"update":if(v(c.path,b),e._applyLocalWrite(b))return Promise.resolve();x(c.path,b);break;default:throw new Error("Invalid transaction outcome: "+(j.outcome||"none"))}return e._bridge.transaction(e._rootUrl+c.path,i,b,e._writeSerial).then(function(b){return a.forEach(b.snapshots,function(a){return e._integrateSnapshot(a)}),b.committed?j:h()},function(a){return!a.immediateFailure||"set"!==j.outcome&&"update"!==j.outcome?Promise.reject(a):r(e._repair(c,b),function(){return Promise.reject(a)})})})};return this._truss.peek(c,function(){return e._dispatcher.execute("write","commit",c,void 0,h)})},Da.prototype._repair=function(b,c){var d=this,e=b.path,f=a(c).keys().map(function(b){var c=e;return b&&(c=g(c,b)),a.keys(d._coupler.findCoupledDescendantPaths(c))}).flatten().value();return Promise.all(a.map(f,function(a){return d._bridge.once(d._rootUrl+a).then(function(a){d._integrateSnapshot(a)})}))},Da.prototype._applyLocalWrite=function(b,c){var d=this;this._writeSerial++,this._localWriteTimestamp=this._truss.now;var e=[],f=0;a.forEach(b,function(b,g){var i=d._modeler.isLocal(g,b);i&&f++;var j,k=i?(j={},j[g]=!0,j):d._coupler.findCoupledDescendantPaths(g);if(!a.isEmpty(k)){var l=("/"===g?0:g.length)+1;for(var m in k){var n=m.slice(l),o=b;if(n&&null!==b&&void 0!==b)for(var p=0,q=h(n);p<q.length;p+=1){var r=q[p];if(void 0===(o=o.$data[r]))break}if(void 0===o||null===o)d._prune(m);else{var s=a.last(h(m));d._plantValue(m,s,o,d._scaffoldAncestors(m,!1,e),!1,c,i,e)}c||i||(d._localWrites[m]=d._writeSerial)}}});for(var g=0,i=e;g<i.length;g+=1){var j=i[g];d._completeCreateObject(j)}if(f&&f<a.size(b))throw new Error("Write on a mix of local and remote tree paths.");return c||!!f},Da.prototype._createObject=function(a,b){this._initialized||"/"===a||this.init();var c={$parent:{value:b,configurable:!0,enumerable:!0},$path:{value:a}};"/"===a&&(c.$truss={value:this._truss});var d=this._modeler.createObject(a,c);return Object.defineProperties(d,c),d},Da.prototype._fixObject=function(b){for(var c=0,d=Object.getOwnPropertyNames(b);c<d.length;c+=1){var e=d[c],f=Object.getOwnPropertyDescriptor(b,e);f.configurable&&f.enumerable&&(f.enumerable=!1,a.startsWith(e,"$")&&(f.configurable=!1),Object.defineProperty(b,e,f))}},Da.prototype._completeCreateObject=function(a){var b=this;if(a.hasOwnProperty("$$initializers")){for(var c=0,d=a.$$initializers;c<d.length;c+=1){(0,d[c])(b._vue)}delete a.$$initializers}},Da.prototype._destroyObject=function(a){var b=this;if(a&&a.$truss&&!a.$destroyed){this._modeler.destroyObject(a);for(var c=0,d=Object.getOwnPropertyNames(a.$data);c<d.length;c+=1){var e=d[c],f=a.$data[e];f&&f.$parent===a&&b._destroyObject(f)}}},Da.prototype._integrateSnapshot=function(b){var c=this;if(a.forEach(this._localWrites,function(a,d){b.writeSerial>=a&&delete c._localWrites[d]}),b.exists){var d=[],e=this._scaffoldAncestors(b.path,!0,d);e&&this._plantValue(b.path,b.key,b.value,e,!0,!1,!1,d);for(var f=0,g=d;f<g.length;f+=1){var h=g[f];c._completeCreateObject(h)}}else this._prune(b.path,null,!0)},Da.prototype._scaffoldAncestors=function(b,c,d){for(var f,g=this,i=a.dropRight(h(b,!0)),j="/",k=0;k<i.length;k++){var l=i[k],m=e(l),n=l?f.$data[m]:g.root;if(l&&(j+=("/"===j?"":"/")+l),n){if(c&&g._localWrites[j])return}else if(!(n=g._plantValue(j,m,{},f,c,!1,!1,d)))return;f=n}return f},Da.prototype._plantValue=function(b,c,f,h,i,j,k,l){var m=this;if(i&&(null===f||void 0===f))throw new Error("Snapshot includes invalid value at "+b+": "+f);if(!i||!this._localWrites[b||"/"]){a.isEqual(f,T)&&(f=this._localWriteTimestamp);var n=h.$data[c];if(!a.isArray(f)&&!(k?a.isPlainObject(f):a.isObject(f)))return this._destroyObject(n),void this._setFirebaseProperty(h,c,f);var o=!1;return a.isObject(n)||(this._setFirebaseProperty(h,c,null),n=this._createObject(b,h),this._setFirebaseProperty(h,c,n,n.$hidden),this._fixObject(n),l.push(n),o=!0),j?Object.defineProperty(n,"$overridden",{get:a.constant(!0),configurable:!0}):n.$overridden&&delete n.$overridden,o&&this._plantPlaceholders(n,b,!0,l),a.forEach(f,function(a,c){m._plantValue(g(b,c),e(c),a,n,i,j,k,l)}),o?this._plantPlaceholders(n,b,!1,l):a.forEach(n.$data,function(a,c){var e=d(c);f.hasOwnProperty(e)||m._prune(g(b,e),null,i)}),n}},Da.prototype._plantPlaceholders=function(a,b,c,d){var f=this;this._modeler.forEachPlaceholderChild(b,function(h){if(void 0===c||c===!!h.hidden){var i=e(h.escapedKey);a.$data.hasOwnProperty(i)||f._plantValue(g(b,h.escapedKey),i,h.placeholder,a,!1,!1,!1,d)}})},Da.prototype._prune=function(b,c,d){c=c||{};var e=this.getObject(b);void 0!==e&&(d&&this._avoidLocalWritePaths(b,c)||a.isEmpty(c)&&this._pruneAncestors(b,e)||!a.isObject(e)||this._pruneDescendants(e,c))},Da.prototype._avoidLocalWritePaths=function(b,c){var d=this;for(var e in d._localWrites)if(d._localWrites.hasOwnProperty(e)){if(b===e||"/"===e||a.startsWith(b,e+"/"))return!0;if("/"===b||a.startsWith(e,b+"/"))for(var f=h(e,!0),g=f.length;g>0;g--){var i=f.slice(0,g).join("/"),j=g===f.length;if(c[i]||c[i]===j)break;if(c[i]=j,i===b)break}}},Da.prototype._pruneAncestors=function(a,b){for(var c,d=this,f=!1,g=b,h=a.replace(/\/[^\/]+$/,function(a){return c=e(a.slice(1)),""});void 0!==g&&g!==this.root;){var i=g&&g.$parent||g===b&&d.getObject(h);if(!d._modeler.isPlaceholder(g&&g.$path||a)){var j=f?null:[b];d._holdsConcreteData(g,j)||(f=!0,d._deleteFirebaseProperty(i,g&&g.$key||g===b&&c))}g=i}return f},Da.prototype._holdsConcreteData=function(b,c){var d=this;return void 0!==b&&null!==b&&((!c||!a.includes(c,b))&&(!a.isObject(b)||!b.$truss||a.some(b.$data,function(a){return d._holdsConcreteData(a,c)})))},Da.prototype._pruneDescendants=function(b,c){var e=this;if(c[b.$path])return!0;b.$overridden&&delete b.$overridden;var f=!1;return a.forEach(b.$data,function(h,i){var j,k=!0;if(c[g(b.$path,d(i))])k=!1,j=!0;else if(h.$truss){var l=e._modeler.isPlaceholder(h.$path);(l||a.has(c,h.$path))&&(j=e._pruneDescendants(h,c),k=!l&&!j)}k&&e._deleteFirebaseProperty(b,i),f=f||j}),f},Da.prototype.getObject=function(a){for(var b,c=this,d=h(a),e=0,f=d;e<f.length;e+=1){var g=f[e];if(void 0===(b=g?b.$data[g]:c.root))return}return b},Da.prototype._getFirebasePropertyDescriptor=function(a,b,c){var d=Object.getOwnPropertyDescriptor(b,c);if(d){if(!d.enumerable){var e=b[c];if(!e||e.$parent!==a)throw new Error("Key conflict between Firebase and instance or computed properties at "+a.$path+": "+c)}if(!d.get||!d.set)throw new Error("Unbound property at "+a.$path+": "+c)}else if(c in b)throw new Error("Key conflict between Firebase and inherited property at "+a.$path+": "+c);return d},Da.prototype._setFirebaseProperty=function(a,c,d,e){var f=a.hasOwnProperty("$data")?a.$data:a,g=this._getFirebasePropertyDescriptor(a,f,c);if(g){if(e&&Object.defineProperty(f,c,{get:g.get,set:g.set,configurable:!0,enumerable:!1}),f[c]===d)return;this._firebasePropertyEditAllowed=!0,f[c]=d,this._firebasePropertyEditAllowed=!1}else b.set(f,c,d),g=Object.getOwnPropertyDescriptor(f,c),Object.defineProperty(f,c,{get:g.get,set:this._overwriteFirebaseProperty.bind(this,g,c),configurable:!0,enumerable:!e});D.digest()},
Da.prototype._overwriteFirebaseProperty=function(a,b,c){if(!this._firebasePropertyEditAllowed){var d=new Error("Firebase data cannot be mutated directly: "+b);throw d.trussCode="firebase_overwrite",d}a.set.call(this,c)},Da.prototype._deleteFirebaseProperty=function(a,c){var d=a.hasOwnProperty("$data")?a.$data:a;this._getFirebasePropertyDescriptor(a,d,c),this._destroyObject(d[c]),b.delete(d,c),D.digest()},Da.prototype.checkVueObject=function(a,b){this._modeler.checkVueObject(a,b)},Object.defineProperties(Da.prototype,Ea);var Fa,Ga,Ha={},Ia=function(a){if(!Fa)throw new Error("Truss worker not connected, please call Truss.connectWorker first");this._rootUrl=a.replace(/\/$/,""),this._keyGenerator=new ja,this._dispatcher=new ga(Fa),this._vue=new b,Fa.trackServer(this._rootUrl),this._tree=new Da(this,this._rootUrl,Fa,this._dispatcher),this._metaTree=new ka(this._rootUrl,this._tree,Fa,this._dispatcher),Object.freeze(this)},Ja={meta:{},store:{},now:{},SERVER_TIMESTAMP:{},VERSION:{},FIREBASE_SDK_VERSION:{}},Ka={computedPropertyStats:{},worker:{}};return Ja.meta.get=function(){return this._metaTree.root},Ja.store.get=function(){return this._tree.root},Ia.prototype.mount=function(a){this._tree.init(a)},Ia.prototype.destroy=function(){this._vue.$destroy(),this._tree.destroy(),this._metaTree.destroy()},Ja.now.get=function(){return Date.now()+this.meta.timeOffset},Ia.prototype.newKey=function(){return this._keyGenerator.generateUniqueKey(this.now)},Ia.prototype.authenticate=function(a){return this._metaTree.authenticate(a)},Ia.prototype.unauthenticate=function(){return this._metaTree.unauthenticate()},Ia.prototype.intercept=function(a,b){return this._dispatcher.intercept(a,b)},Ia.prototype.connect=function(a,b){return b||(b=a,a=void 0),b instanceof P&&(b={_:b}),new _(a,b,this._tree,"connect")},Ia.prototype.peek=function(b,c){var d=this;c=o(c||a.identity);var e,f;return p(Promise.resolve().then(function(){return new Promise(function(g,h){var i,j={},k=new _(j,{result:b},d._tree,"peek"),l=d.intercept("peek",{onFailure:function(b){function c(d){if(d)return d instanceof P?b.target.isEqual(d):a.some(d,function(a){return c(a)})}c(k.at)&&(h(b.error),e())}}),m=d.observe(function(){return k.ready},function(a){a&&(m(),m=null,i=r(c(j.result),function(){D.digest(),i=null,e()}).then(function(a){g(a)},function(a){h(a)}))});e=function(){m&&(m(),m=null),l&&(l(),l=null),k&&(k.destroy(),k=null),i&&i.cancel&&i.cancel()},f=function(){h(new Error("Canceled")),e()}})}),f)},Ia.prototype.observe=function(b,c,d){var e,f=a.isObject(d&&d.precise),g=0;f&&(e=a.clone(d.precise,d.deep));var h=this._vue.$watch(b,function(b,i){if(d&&d.precise){var j=f?d.deep?a.defaultsDeep({},b,d.precise):a.defaults({},b,d.precise):a.clone(b,d.deep);if(a.isEqual(j,e))return;e=j}g++,h?(c(b,i),D.digest()):Promise.resolve().then(function(){g>1||c(b,i)})},{immediate:!0,deep:d&&d.deep});return d&&d.scope&&d.scope.$on("$destroy",h),h},Ia.prototype.when=function(c,d){var e,f,g=this,h=new Promise(function(h,i){var j=g.observe(c,function(a){a&&b.nextTick(function(){(a=c())&&(h(a),e())})});a.has(d,"timeout")&&(f=setTimeout(function(){f=null,i(new Error(d.timeoutMessage||"Timeout")),e()},d.timeout)),e=function(){j&&(j(),j=null),f&&(clearTimeout(f),f=null),i(new Error("Canceled"))}});return h=p(r(h,e),e),d&&d.scope&&d.scope.$on("$destroy",function(){h.cancel()}),h},Ia.prototype.nextTick=function(){var a,c=new Promise(function(c,d){b.nextTick(c),a=function(){d(new Error("Canceled"))}});return c=p(c,a)},Ia.prototype.throttleRemoteDataUpdates=function(a){this._tree.throttleRemoteDataUpdates(a)},Ia.prototype.checkObjectsForRogueProperties=function(){this._tree.checkVueObject(this._tree.root,"/")},Ka.computedPropertyStats.get=function(){return $},Ia.connectWorker=function(b,c){if(Fa)throw new Error("Worker already connected");if(a.isString(b)){var d=window.SharedWorker||window.Worker;if(!d)throw new Error("Browser does not implement Web Workers");b=new d(b)}return Fa=new N(b),Ga&&Fa.enableLogging(Ga),Fa.init(b,c).then(function(a){var b=a.exposedFunctionNames,c=a.firebaseSdkVersion;Object.defineProperty(Ia,"FIREBASE_SDK_VERSION",{value:c});for(var d=0,e=b;d<e.length;d+=1){var f=e[d];Ia.worker[f]=Fa.bindExposedFunction(f)}})},Ka.worker.get=function(){return Ha},Ia.preExpose=function(a){Ia.worker[a]=Fa.bindExposedFunction(a)},Ia.bounceConnection=function(){return Fa.bounceConnection()},Ia.suspend=function(){return Fa.suspend()},Ia.debugPermissionDeniedErrors=function(a,b,c){return Fa.debugPermissionDeniedErrors(a,b,c)},Ia.debounceAngularDigest=function(a){D.debounceDigest(a)},Ia.escapeKey=function(a){return d(a)},Ia.unescapeKey=function(a){return e(a)},Ia.enableLogging=function(a){Ga=a,Fa&&Fa.enableLogging(a)},Ja.SERVER_TIMESTAMP.get=function(){return Ia.SERVER_TIMESTAMP},Ja.VERSION.get=function(){return Ia.VERSION},Ja.FIREBASE_SDK_VERSION.get=function(){return Ia.FIREBASE_SDK_VERSION},Object.defineProperties(Ia.prototype,Ja),Object.defineProperties(Ia,Ka),Object.defineProperties(Ia,{SERVER_TIMESTAMP:{value:T},VERSION:{value:"dev"},ComponentPlugin:{value:{install:function(c,d){if(b!==c)throw new Error("Multiple versions of Vue detected");if(!d.truss)throw new Error("Need to pass `truss` instance as an option to use the ComponentPlugin");var e={$truss:{value:d.truss},$destroyed:{get:function(){return this._isBeingDestroyed||this._isDestroyed}},$$touchThis:{value:function(){this.__ob__&&this.__ob__.dep.depend()}}},f=a(e).keys().union(a.keys(pa.prototype)).intersection(a.keys(b.prototype)).value();if(f.length)throw new Error("Truss extension properties conflict with Vue properties: "+f.join(", "));Object.defineProperties(b.prototype,e),m(pa,b),b.mixin({destroyed:function(){var b=this;if(a.has(this,"$$trussFinalizers"))for(var c=0,d=a.clone(b.$$trussFinalizers);c<d.length;c+=1){var e=d[c];e()}}})}}}}),D.defineModule(Ia),Ia});
//# sourceMappingURL=firetruss.umd.min.js.map