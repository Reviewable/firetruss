!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("lodash"),require("vue")):"function"==typeof define&&define.amd?define(["lodash","vue"],b):a.Truss=b(a._,a.Vue)}(this,function(a,b){"use strict";function c(){var b=window.angular.module("firetruss",[]);B.digest=A,B.watch=function(){throw new Error("Angular watch proxy not yet initialized")},B.defineModule=function(a){b.constant("Truss",a)},B.debounceDigest=function(b){if(b){var c=a.debounce(A,b);B.digest=function(){x.digestRequest>y||(z?A():c())}}else B.digest=A},b.config(function(b){b.decorator("$rootScope",["$delegate","$exceptionHandler",function(b,c){var d=b;B.watch=d.$watch.bind(d);var e=Object.getPrototypeOf(d),f=e.$digest;return e.$digest=A,e.$digest.original=f,x.$watch(function(){return x.digestRequest},function(){x.digestRequest>y?(z=!0,d.$digest.original.call(d),y=x.digestRequest=x.digestRequest+1):z=!1}),a.last(x._watchers).id=1/0,d}])})}function d(){}function e(a){return a?a.toString().replace(/[\\\.\$\#\[\]\/]/g,function(a){return"\\"+a.charCodeAt(0).toString(16)}):a}function f(a){return a?a.toString().replace(/\\[0-9a-f]{2}/gi,function(a){return String.fromCharCode(parseInt(a.slice(1),16))}):a}function g(a){return function(){try{return Promise.resolve(a.apply(this,arguments))}catch(a){return Promise.reject(a)}}}function h(a,b){return a=j(a,function(){b=null}),a.cancel=function(){b&&(b(),b=null)},i(a,"cancel"),a}function i(a,b){var c=a.then,d=a.catch;return a.then=function(d,e){var f=c.call(a,d,e);return f[b]=a[b],i(f,b),f},a.catch=function(c){var e=d.call(a,c);return e[b]=a[b],i(e,b),e},a}function j(a,b){return b?(b=g(b),a.then(function(a){return b().then(function(){return a})},function(a){return b().then(function(){return Promise.reject(a)})})):a}function k(){for(var b=[],c=0,d=arguments;c<d.length;c+=1){var e=d[c];a.isString(e)||(e=""+e),"/"===e.charAt(0)&&b.splice(0,b.length),b.push(e)}return"/"===b[0]&&(b[0]=""),b.join("/")}function l(b){var c=D[b];return c||(c=new F(b),a.size(D)===E&&delete D[a.keys(D)[0]],D[b]=c),c}function m(){}function n(a,b){if(!a||a instanceof Error)return a;var c=new Error(a.message);c.params=b;for(var d in a)if("message"!==d&&a.hasOwnProperty(d))try{c[d]=a[d]}catch(a){throw a.extra={propertyName:d},a}return c}function o(a){var b=a.indexOf("/",8);return b>=8?a.slice(0,b):a}function p(a,b){return b={exports:{}},a(b,b.exports),b.exports}function q(b){if(b)return b instanceof L?b.toString():a.mapValues(b,q)}function r(a,b){this.$$touchThis(),ma=!1;var c,d=V();try{try{c=a.get.call(this)}catch(a){c=new qa(a)}finally{b.runtime+=V()-d,b.numRecomputes+=1}return ma&&(c=new ra(c)),c}finally{ma=void 0}}function s(b,c){return!c||c instanceof L?c:a.mapValues(c,function(c){return c instanceof L?c:a.isFunction(c)?function(){return b.$$touchThis(),s(b,c.call(this))}:s(b,c)})}function t(a,b){if(a&&a.$truss||b&&b.$truss)return a===b}function u(b,c){a.each(a.keys(c),function(d){if("/"===d.charAt(0)){if(!(d===b||"/"===b||a.startsWith(d,b+"/")&&d.length>b.length+1))throw new Error("Update item is not a descendant of target ref: "+d)}else{if(d.indexOf("/")>=0)throw new Error("Update item deep path must be absolute, taken from a reference: "+d);var f=k(b,e(d));if(c.hasOwnProperty(f))throw new Error("Update items overlap: "+d+" and "+f);c[f]=c[d],delete c[d]}});var d=a(c).keys().map(function(a){return k(a,"")}).sortBy("length").value();a.each(c,function(b,c){for(var e=0,f=d;e<f.length;e+=1){var g=f[e];if(g.length>c.length)break;if(c!==g&&a.startsWith(c,g))throw new Error("Update items overlap: "+g+" and "+c)}})}function v(b,c){a.each(a.keys(c),function(a){c[a.slice("/"===b?1:b.length+1)]=c[a],delete c[a]})}function w(a){if("object"==typeof a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[e(c)]=w(a[c]));return b}return a}a="default"in a?a.default:a,b="default"in b?b.default:b;var x=new b({data:{digestRequest:0}}),y=0,z=!1,A=function(){x.digestRequest>y||(x.digestRequest=y+1)},B={active:"undefined"!=typeof window&&window.angular};B.active?c():["digest","watch","defineModule","debounceDigest"].forEach(function(a){B[a]=d});var C=Object.freeze({".sv":"timestamp"}),D={},E=1e3,F=function(b){var c=this;this.variables=[];var d=a.endsWith(b,"/$*");d&&(b=b.slice(0,-3));var e=b.replace(/\/\$[^\/]*/g,function(a){return a.length>1&&c.variables.push(a.slice(1)),""});if(Object.freeze(this.variables),/[$-.?[-^{|}]/.test(e))throw new Error("Path pattern has unescaped keys: "+b);this._regex=new RegExp("^"+e.replace(/\u0001/g,"/([^/]+)")+(d?"($|/)":"$"))};F.prototype.match=function a(b){var c=this;this._regex.lastIndex=0;var a=this._regex.exec(b);if(a){for(var d={},e=0;e<this.variables.length;e++)d[c.variables[e]]=f(a[e+1]);return d}},F.prototype.test=function(a){return this._regex.test(a)},F.prototype.toString=function(){return this._regex.toString()};var G="0.4.0",H=function(a){var b=a.path,c=a.value,d=a.valueError,e=a.exists;this._path=b,this._value=c,this._valueError=n(d),this._exists=void 0===c?e||!1:null!==c},I={path:{},exists:{},value:{},key:{}};I.path.get=function(){return this._path},I.exists.get=function(){return this._exists},I.value.get=function(){return this._checkValue(),this._value},I.key.get=function(){return void 0===this._key&&(this._key=f(this._path.replace(/.*\//,""))),this._key},H.prototype._checkValue=function(){if(this._valueError)throw this._valueError;if(void 0===this._value)throw new Error("Value omitted from snapshot")},Object.defineProperties(H.prototype,I);var J=function(b){var c=this;this._idCounter=0,this._deferreds={},this._suspended=!1,this._servers={},this._callbacks={},this._log=a.noop,this._simulatedTokenGenerator=null,this._maxSimulationDuration=5e3,this._simulatedCallFilter=null,this._inboundMessages=[],this._outboundMessages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),this._port=b.port||b,this._shared=!!b.port,this._port.onmessage=this._receive.bind(this),window.addEventListener("unload",function(){c._send({msg:"destroy"})}),setInterval(function(){c._send({msg:"ping"})},6e4)};J.prototype.init=function(a){var b=[];try{var c=window.localStorage||window.sessionStorage;if(!c)return;for(var d=0;d<c.length;d++){var e=c.key(d);b.push({key:e,value:c.getItem(e)})}}catch(a){}return this._send({msg:"init",storage:b}).then(function(a){var b=a.version.match(/^(\d+)\.(\d+)\.(\d+)(-.*)?$/);if(b){var c=G.match(/^(\d+)\.(\d+)\.(\d+)(-.*)?$/),d=b[1]===c[1]&&(b[2]>c[2]||b[2]===c[2]&&b[3]>=c[3]);if(!d)return Promise.reject(new Error("Incompatible Firetruss worker version: "+a.version+" ("+G+" or better required)"))}return a})},J.prototype.suspend=function(a){void 0===a&&(a=!0),this._suspended!==a&&(this._suspended=a,a||(this._receiveMessages(this._inboundMessages),this._inboundMessages=[],this._outboundMessages.length&&Promise.resolve().then(this._flushMessageQueue)))},J.prototype.debugPermissionDeniedErrors=function(a,b,c){this._simulatedTokenGenerator=a,void 0!==b&&(this._maxSimulationDuration=b),this._simulatedCallFilter=c||function(){return!0}},J.prototype.enableLogging=function(b){b?(b===!0&&(b=console.log.bind(console)),this._log=b):this._log=a.noop},J.prototype._send=function(a){var b=this;a.id=++this._idCounter;var c;if(a.oneWay)c=Promise.resolve();else{c=new Promise(function(c,d){b._deferreds[a.id]={resolve:c,reject:d}});var d=this._deferreds[a.id];d.promise=c,c.sent=new Promise(function(a){d.resolveSent=a}),d.params=a}return this._outboundMessages.length||this._suspended||Promise.resolve().then(this._flushMessageQueue),this._log("send:",a),this._outboundMessages.push(a),c},J.prototype._flushMessageQueue=function(){this._port.postMessage(this._outboundMessages),this._outboundMessages=[]},J.prototype._receive=function(a){this._suspended?this._inboundMessages=this._inboundMessages.concat(a.data):this._receiveMessages(a.data)},J.prototype._receiveMessages=function(a){for(var b=this,c=0,d=a;c<d.length;c+=1){var e=d[c];b._log("recv:",e);var f=b[e.msg];if("function"!=typeof f)throw new Error("Unknown message: "+e.msg);f.call(b,e)}},J.prototype.bindExposedFunction=function(a){return function(){return this._send({msg:"call",name:a,args:Array.prototype.slice.call(arguments)})}.bind(this)},J.prototype.resolve=function(a){var b=this._deferreds[a.id];if(!b)throw new Error("Received resolution to inexistent Firebase call");delete this._deferreds[a.id],b.resolve(a.result)},J.prototype.reject=function(a){var b=this._deferreds[a.id];if(!b)throw new Error("Received rejection of inexistent Firebase call");delete this._deferreds[a.id],b.reject(n(a.error,b.params))},J.prototype.probeError=function(a){var b=a.code||a.message;return a.params&&b&&"permission_denied"===b.toLowerCase()?this._simulateCall(a.params).then(function(b){b&&(a.permissionDeniedDetails=b)}):Promise.resolve()},J.prototype._simulateCall=function(a){var b=this;if(!(this._simulatedTokenGenerator&&this._maxSimulationDuration>0))return Promise.resolve();var c=[];switch(a.msg){case"set":c.push({method:"set",url:a.url,args:[a.value]});break;case"update":c.push({method:"update",url:a.url,args:[a.value]});break;case"on":c.push({method:"once",url:a.url,spec:a.spec,args:["value"]});break;case"transaction":c.push({method:"once",url:a.url,args:["value"]}),c.push({method:"set",url:a.url,args:[a.newValue]})}if(!c.length||!this._simulatedCallFilter(a.msg,a.url))return Promise.resolve();var d=this.getAuth(o(a.url)),e=this._simulatedTokenGenerator(d&&d.uid).then(function(a){return Promise.all(c.map(function(c){return c.msg="simulate",c.token=a,b._send(c)}))}).then(function(a){return a.every(function(a){return null===a})?"Unable to reproduce error in simulation":a.filter(function(a){return a}).join("\n\n")}).catch(function(a){return"Error running simulation: "+a}),f=new Promise(function(a){setTimeout(a.bind(null,"Simulated call timed out"),b._maxSimulationDuration)});return Promise.race([e,f])},J.prototype.updateLocalStorage=function(a){try{var b=window.localStorage||window.sessionStorage;for(var c in a)null===c.value?b.removeItem(c.key):b.setItem(c.key,c.value)}catch(a){}},J.prototype.trackServer=function(a){if(!this._servers.hasOwnProperty(a)){var b=this._servers[a]={authListeners:[]},c=this._registerCallback(this._authCallback.bind(this,b));this._send({msg:"onAuth",url:a,callbackId:c})}},J.prototype._authCallback=function(a,b){a.auth=b;for(var c=0,d=a.authListeners;c<d.length;c+=1){var e=d[c];e(b)}},J.prototype.onAuth=function(a,b,c){var d=b.bind(c);d.callback=b,d.context=c,this._servers[a].authListeners.push(d),d(this.getAuth(a))},J.prototype.offAuth=function(a,b,c){for(var d=this._servers[a].authListeners,e=0;e<d.length;e++){var f=d[e];if(f.callback===b&&f.context===c){d.splice(e,1);break}}},J.prototype.getAuth=function(a){return this._servers[a].auth},J.prototype.authWithCustomToken=function(a,b,c){return this._send({msg:"authWithCustomToken",url:a,authToken:b,options:c})},J.prototype.unauth=function(a){return this._send({msg:"unauth",url:a})},J.prototype.set=function(a,b,c){return this._send({msg:"set",url:a,value:b,writeSerial:c})},J.prototype.update=function(a,b,c){return this._send({msg:"update",url:a,value:b,writeSerial:c})},J.prototype.on=function(a,b,c,d,e,f,g,h){var i={listenerKey:a,eventType:d,snapshotCallback:e,cancelCallback:f,context:g,params:{msg:"on",listenerKey:a,url:b,spec:c,eventType:d,options:h}},j=this._onCallback.bind(this,i);this._registerCallback(j,i),e.__callbackIds=e.__callbackIds||[],e.__callbackIds.push(i.id),this._send({msg:"on",listenerKey:a,url:b,spec:c,eventType:d,callbackId:i.id,options:h}).catch(function(a){j(a)})},J.prototype.off=function(a,b,c,d,e,f){var g,h=this,i=[];if(e){if(g=this._findAndRemoveCallbackId(e,function(b){return b.listenerKey===a&&b.eventType===d&&b.context===f}),!g)return Promise.resolve();i.push(g)}else for(var j=0,k=Object.keys(this._callbacks);j<k.length;j+=1){var l=k[j],m=h._callbacks[l];m.listenerKey!==a||d&&m.eventType!==d||i.push(l)}for(var n=0,o=i;n<o.length;n+=1){var p=o[n];h._nullifyCallback(p)}return this._send({msg:"off",listenerKey:a,url:b,spec:c,eventType:d,callbackId:g}).then(function(){for(var a=0,b=i;a<b.length;a+=1){var c=b[a];h._deregisterCallback(c)}})},J.prototype._onCallback=function(a,b,c){if(b){this._deregisterCallback(a.id);var d=n(b,a.params);a.cancelCallback?a.cancelCallback.call(a.context,d):console.error(d)}else a.snapshotCallback.call(a.context,new H(c))},J.prototype.transaction=function(a,b,c){return this._send({msg:"transaction",url:a,oldValue:b,relativeUpdates:c})},J.prototype.onDisconnect=function(a,b,c){return this._send({msg:"onDisconnect",url:a,method:b,value:c})},J.prototype.bounceConnection=function(){return this._send({msg:"bounceConnection"})},J.prototype.callback=function(a){var b=a.id,c=a.args,d=this._callbacks[b];if(!d)throw new Error("Unregistered callback: "+b);d.callback.apply(null,c)},J.prototype._registerCallback=function(a,b){return b=b||{},b.callback=a,b.id="cb"+ ++this._idCounter,this._callbacks[b.id]=b,b.id},J.prototype._nullifyCallback=function(a){this._callbacks[a].callback=m},J.prototype._deregisterCallback=function(a){delete this._callbacks[a]},J.prototype._findAndRemoveCallbackId=function(a,b){var c=this;if(a.__callbackIds)for(var d=0;d<a.__callbackIds.length;){var e=a.__callbackIds[d],f=c._callbacks[e];if(f){if(b(f))return a.__callbackIds.splice(d,1),e;d+=1}else a.__callbackIds.splice(d,1)}};var K={};Object.freeze(K);var L=function(a,b,c){this._tree=a,this._path=b.replace(/^\/*/,"/").replace(/\/$/,""),c&&(this._annotations=c,Object.freeze(c))},M={$ref:{},key:{},path:{},_pathPrefix:{},parent:{},annotations:{}};M.$ref.get=function(){return this},M.key.get=function(){return this._key||(this._key=f(this._path.replace(/.*\//,""))),this._key},M.path.get=function(){return this._path},M._pathPrefix.get=function(){return"/"===this._path?"":this._path},M.parent.get=function(){return new O(this._tree,this._path.replace(/\/[^\/]*$/,""),this._annotations)},M.annotations.get=function(){return this._annotations||K},L.prototype.child=function(){if(!arguments.length)return this;for(var a=[],b=0,c=arguments;b<c.length;b+=1){var d=c[b];if(void 0===d||null===d)return;a.push(e(d))}return new O(this._tree,this._pathPrefix+"/"+a.join("/"),this._annotations)},L.prototype.children=function(){var b=arguments,c=this;if(!arguments.length)return this;for(var d=[],f=0;f<arguments.length;f++){var g=b[f];if(a.isArray(g)){for(var h={},i=c._pathPrefix+(d.length?"/"+d.join("/"):""),j=a.slice(b,f+1),k=0,l=g;k<l.length;k+=1){var m=l[k],n=new O(c._tree,i+"/"+e(m),c._annotations),o=n.children.apply(n,j);o&&(h[m]=o)}if(a.isEmpty(h))return;return h}if(void 0===g||null===g)return;d.push(e(g))}return new O(this._tree,this._pathPrefix+"/"+d.join("/"),this._annotations)},L.prototype.peek=function(a){return this._tree.truss.peek(this,a)},L.prototype.match=function(a){return l(a).match(this.path)},L.prototype.isEqual=function(a){return a instanceof L&&(this._tree===a._tree&&this.toString()===a.toString())},L.prototype.belongsTo=function(a){return this._tree.truss===a},Object.defineProperties(L.prototype,M);var N=function(b){function c(c,d,e,f){b.call(this,c,d,f),this._spec=this._copyAndValidateSpec(e);var g=a(this._spec).map(function(a,b){return b+"="+encodeURIComponent(JSON.stringify(a))}).sortBy().join("&");this._string=this._path+"?"+g,Object.freeze(this)}b&&(c.__proto__=b),c.prototype=Object.create(b&&b.prototype),c.prototype.constructor=c;var d={ready:{},constraints:{}};return d.ready.get=function(){return this._tree.isQueryReady(this)},d.constraints.get=function(){return this._spec},c.prototype.annotate=function(b){return new c(this._tree,this._path,this._spec,a.extend({},this._annotations,b))},c.prototype._copyAndValidateSpec=function(b){if(!b.by)throw new Error('Query needs "by" clause: '+JSON.stringify(b));if(("at"in b)+("from"in b)+("to"in b)>1)throw new Error('Query must contain at most one of "at", "from", or "to" clauses: '+JSON.stringify(b));if(("first"in b)+("last"in b)>1)throw new Error('Query must contain at most one of "first" or "last" clauses: '+JSON.stringify(b));if(!a.some(["at","from","to","first","last"],function(a){return a in b}))throw new Error('Query must contain at least one of "at", "from", "to", "first", or "last" clauses: '+JSON.stringify(b));if(b=a.clone(b),"$key"!==b.by&&"$value"!==b.by){if(!(b.by instanceof O))throw new Error('Query "by" value must be a reference: '+b.by);var c=b.by.toString();if(!a.startsWith(c,this._path))throw new Error('Query "by" value must be a descendant of target reference: '+b.by);if(c=c.slice(this._path.length).replace(/^\/?/,""),c.indexOf("/")===-1)throw new Error('Query "by" value must not be a direct child of target reference: '+b.by);b.by=c.replace(/.*?\//,"")}return Object.freeze(b),b},c.prototype.toString=function(){return this._string},Object.defineProperties(c.prototype,d),c}(L),O=function(b){function c(a,c,d){b.call(this,a,c,d),Object.freeze(this)}b&&(c.__proto__=b),c.prototype=Object.create(b&&b.prototype),c.prototype.constructor=c;var d={ready:{},value:{}};return d.ready.get=function(){return this._tree.isReferenceReady(this)},d.value.get=function(){return this._tree.getObject(this.path)},c.prototype.toString=function(){return this._path},c.prototype.annotate=function(b){return new c(this._tree,this._path,a.extend({},this._annotations,b))},c.prototype.query=function(a){return new N(this._tree,this._path,a)},c.prototype.set=function(a){return this._tree.update(this,"set",(b={},b[this.path]=a,b));var b},c.prototype.update=function(a){return this._tree.update(this,"update",a)},c.prototype.override=function(a){return this._tree.update(this,"override",(b={},b[this.path]=a,b));var b},c.prototype.commit=function(a){return this._tree.commit(this,a)},Object.defineProperties(c.prototype,d),c}(L),P=function(b){a.extend(this,{name:b,numRecomputes:0,numUpdates:0,runtime:0})},Q={runtimePerRecompute:{}};Q.runtimePerRecompute.get=function(){return this.numRecomputes?this.runtime/this.numRecomputes:0},P.prototype.toLogParts=function(a){return[this.name+":"," "+(this.runtime/1e3).toFixed(2)+"s","("+(this.runtime/a.runtime*100).toFixed(1)+"%)"," "+this.numUpdates+" upd /",this.numRecomputes+" runs","("+(this.numUpdates/this.numRecomputes*100).toFixed(1)+"%)"," "+this.runtimePerRecompute.toFixed(2)+"ms / run"]},Object.defineProperties(P.prototype,Q);var R=function(){this._items={}},S={list:{}};R.prototype.for=function(a){return this._items[a]||(this._items[a]=new P(a)),this._items[a]},S.list.get=function(){return a(this._items).values().sortBy(function(a){return-a.runtime}).value()},R.prototype.log=function(b){void 0===b&&(b=10);var c=this.list;if(c.length){var d=new P("--- Total");a.each(c,function(a){d.runtime+=a.runtime,d.numUpdates+=a.numUpdates,d.numRecomputes+=a.numRecomputes}),c=a.take(c,b);var e=a.map(c,function(a){return a.toLogParts(d)});e.unshift(d.toLogParts(d));var f=a.map(a.range(e[0].length),function(b){return a(e).map(function(a){return a[b].length}).max()});a.each(e,function(b){console.log(a.map(b,function(b,c){return a.padLeft(b,f[c])}).join(" "))})}},Object.defineProperties(R.prototype,S);var T=new R,U="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},V=p(function(a){(function(){var b,c,d;"undefined"!=typeof performance&&null!==performance&&performance.now?a.exports=function(){return performance.now()}:"undefined"!=typeof process&&null!==process&&process.hrtime?(a.exports=function(){return(b()-d)/1e6},c=process.hrtime,b=function(){var a;return a=c(),1e9*a[0]+a[1]},d=b()):Date.now?(a.exports=function(){return Date.now()-d},d=Date.now()):(a.exports=function(){return(new Date).getTime()-d},d=(new Date).getTime())}).call(U)}),W=function(c,d,e,f,g){var h=this;Object.freeze(d),this._scope=c,this._connections=d,this._tree=e,this._method=f,this._subConnectors={},this._disconnects={},this._angularUnwatches=void 0,this._data={},this._values=new b({data:a.mapValues(d,a.constant(void 0))}),this._vue=new b({data:{descriptors:{},refs:g||{}}}),this.destroy=this.destroy,Object.seal(this),this._linkScopeProperties(),a.each(d,function(b,c){a.isFunction(b)?h._bindComputedConnection(c,b):h._connect(c,b)}),B.active&&c&&c.$on&&c.$id&&c.$on("$destroy",function(){h.destroy()})},X={ready:{},at:{},data:{}};X.ready.get=function(){var b=this;return a.every(this._connections,function(a,c){var d=b._vue.descriptors[c];return!!d&&(d instanceof L?d.ready:b._subConnectors[c].ready)})},X.at.get=function(){return this._vue.refs},X.data.get=function(){return this._data},W.prototype.destroy=function(){var b=this;this._unlinkScopeProperties(),a.each(this._angularUnwatches,function(a){a()}),a.each(this._connections,function(a,c){b._disconnect(c)}),this._values.$destroy(),this._vue.$destroy()},W.prototype._linkScopeProperties=function(){var b=this,c=a.mapValues(this._connections,function(a,c){return{configurable:!0,enumerable:!0,get:function(){return b._values.$data[c]}}});if(Object.defineProperties(this._data,c),this._scope){for(var d in this._connections)if(d in b._scope)throw new Error("Property already defined on connection target: "+d);this._scope.__ob__||Object.defineProperties(this._scope,c)}},W.prototype._unlinkScopeProperties=function(){var b=this;this._scope&&a.each(this._connections,function(a,c){delete b._scope[c]})},W.prototype._bindComputedConnection=function(a,b){var c=T.for("connection.at."+a),d=this._computeConnection.bind(this,b,c),e=this._updateComputedConnection.bind(this,a,b,c);this._vue.$watch(d,e,{immediate:!B.active}),B.active&&(this._angularUnwatches||(this._angularUnwatches=[]),this._angularUnwatches.push(B.watch(d,e,!0)))},W.prototype._computeConnection=function(a,b){var c=V();try{return q(a.call(this._scope))}finally{b.runtime+=V()-c,b.numRecomputes+=1}},W.prototype._updateComputedConnection=function(c,d,e){var f=a.isFunction(d)?d(this._scope):d,g=this._vue.descriptors[c];if(e&&!a.isEqual(g,f)&&(e.numUpdates+=1),!(g===f||f instanceof L&&f.isEqual(g))){if(!f)return void this._disconnect(c);f instanceof L||!a.has(this._subConnectors,c)?(this._disconnect(c),this._connect(c,f)):this._subConnectors[c]._updateConnections(f),b.set(this._vue.descriptors,c,f),B.digest()}},W.prototype._updateConnections=function(b){var c=this;a.each(b,function(a,b){c._updateComputedConnection(b,a)}),a.each(this._connections,function(d,e){a.has(b,e)||c._updateComputedConnection(e)}),this._connections=b},W.prototype._connect=function(a,c){var d=this;if(b.set(this._vue.descriptors,a,c),B.digest(),c)if(c instanceof O){b.set(this._vue.refs,a,c);var e=this._updateRefValue.bind(this,a);this._disconnects[a]=this._tree.connectReference(c,e,this._method)}else if(c instanceof N){b.set(this._vue.refs,a,c);var f=this._updateQueryValue.bind(this,a);this._disconnects[a]=this._tree.connectQuery(c,f,this._method)}else{var g={},h={};b.set(this._vue.refs,a,h);var i=this._subConnectors[a]=new W(g,c,this._tree,this._method,h),j=this._disconnects[a]=this._tree.truss.watch(function(){return i.ready},function(c){c&&(j(),delete d._disconnects[a],b.set(d._values.$data,a,g),d._scope.__ob__&&b.set(d._scope,a,g),B.digest())})}},W.prototype._disconnect=function(c){b.delete(this._vue.refs,c),this._updateRefValue(c,void 0),a.has(this._subConnectors,c)&&(this._subConnectors[c].destroy(),delete this._subConnectors[c]),this._disconnects[c]&&this._disconnects[c](),delete this._disconnects[c],b.delete(this._vue.descriptors,c),B.digest()},W.prototype._updateRefValue=function(a,c){this._values.$data[a]!==c&&(b.set(this._values.$data,a,c),this._scope&&this._scope.__ob__&&b.set(this._scope,a,c),B.digest())},W.prototype._updateQueryValue=function(c,d){var e=this;this._values.$data[c]||(b.set(this._values.$data,c,{}),this._scope&&this._scope.__ob__&&b.set(this._scope,c,this._values.$data[c]),B.digest());var f=this._values.$data[c];for(var g in f)f.hasOwnProperty(g)&&(a.contains(d,g)||(b.delete(f,g),B.digest()));for(var h,i=0,j=this._vue.descriptors[c].path.split("/");i<j.length;i+=1){var k=j[i];h=k?h[k]:e._tree.root}for(var l=0,m=d;l<m.length;l+=1){var n=m[l];f.hasOwnProperty(n)||(b.set(f,n,h[n]),B.digest())}},Object.defineProperties(W.prototype,X);var Y=["read","write","auth","set","update","commit","connect","peek","all"],Z=[],$=function(a,b,c){this._operation=a,this._delay=b,this._callback=c,this._fired=!1};$.prototype.initiate=function(){var a=this;this.cancel(),this._fired=!1;var b=Date.now()-this._operation._startTimestamp;this._timeoutId=setTimeout(this._delay-b,function(){a._fired=!0,a._callback(a._operation)})},$.prototype.cancel=function(){this._fired&&this._callback(this._operation),this._timeoutId&&clearTimeout(this._timeoutId)};var _=function(a,b,c){this._type=a,this._method=b,this._target=c,this._ready=!1,this._running=!1,this._ended=!1,this._tries=0,this._startTimestamp=Date.now(),this._slowHandles=[]},aa={type:{},method:{},target:{},ready:{},running:{},ended:{},tries:{},error:{}};aa.type.get=function(){return this._type},aa.method.get=function(){return this._method},aa.target.get=function(){return this._target},aa.ready.get=function(){return this._ready},aa.running.get=function(){return this._running},aa.ended.get=function(){return this._ended},aa.tries.get=function(){return this._tries},aa.error.get=function(){return this._error},_.prototype.onSlow=function(a,b){var c=new $(this,a,b);this._slowHandles.push(c),c.initiate()},_.prototype._setRunning=function(a){this._running=a},_.prototype._setEnded=function(a){this._ended=a},_.prototype._markReady=function(){this._ready=!0,this._tries=0,a.each(this._slowHandles,function(a){return a.cancel()})},_.prototype._clearReady=function(){this._ready=!1,this._startTimestamp=Date.now(),a.each(this._slowHandles,function(a){return a.initiate()})},_.prototype._incrementTries=function(){this._tries++},Object.defineProperties(_.prototype,aa);var ba=function(a){this._bridge=a,this._callbacks={},Object.freeze(this)};ba.prototype.intercept=function(b,c){if(!a.contains(Y,b))throw new Error("Unknown intercept operation type: "+b);var d=a.difference(a.keys(c),["onBefore","onAfter","onError","onFailure"]);if(d.length)throw new Error("Unknown intercept callback types: "+d.join(", "));var e={onBefore:this._addCallback("onBefore",b,c.onBefore),onAfter:this._addCallback("onAfter",b,c.onAfter),onError:this._addCallback("onError",b,c.onError),onFailure:this._addCallback("onFailure",b,c.onFailure)};return this._removeCallbacks.bind(this,b,e)},ba.prototype._addCallback=function(a,b,c){if(c){var d=this._getCallbacksKey(a,b),e=g(c);return(this._callbacks[d]||(this._callbacks[d]=[])).push(e),e}},ba.prototype._removeCallback=function(b,c,d){if(d){var e=this._getCallbacksKey(b,c);this._callbacks[e]&&a.pull(this._callbacks[e],d)}},ba.prototype._removeCallbacks=function(b,c){var d=this;a.each(c,function(a,c){d._removeCallback(c,b,a)})},ba.prototype._getCallbacks=function(a,b,c){return[].concat(this._callbacks[this._getCallbacksKey(a,c)]||Z,this._callbacks[this._getCallbacksKey(a,b)]||Z,this._callbacks[this._getCallbacksKey(a,"all")]||Z)},ba.prototype._getCallbacksKey=function(a,b){return a+"_"+b},ba.prototype.execute=function(a,b,c,d){var e=this;d=g(d);var f=this.createOperation(a,b,c);return this.begin(f).then(function(){var a=function(){return d().catch(function(b){return e._retryOrEnd(f,b).then(a)})};return a()}).then(function(a){return e.end(f).then(function(){return a})})},ba.prototype.createOperation=function(a,b,c){return new _(a,b,c)},ba.prototype.begin=function(b){var c=this;return Promise.all(a.map(this._getCallbacks("onBefore",b.type,b.method),function(a){return a(b)})).then(function(){b.ended||b._setRunning(!0)},function(a){return c.end(b,a)})},ba.prototype.markReady=function(a){a._markReady()},ba.prototype.clearReady=function(a){a._clearReady()},ba.prototype.retry=function(b,c){return b._incrementTries(),b._error=c,Promise.all(a.map(this._getCallbacks("onError",b.type,b.method),function(a){return a(b,c)})).then(function(c){var d=a.some(c);return d&&delete b._error,d})},ba.prototype._retryOrEnd=function(a,b){var c=this;return this.retry(a,b).then(function(d){if(!d)return c.end(a,b)},function(b){return c.end(a,b)})},ba.prototype.end=function(b,c){var d=this;if(!b.ended)return b._setRunning(!1),b._setEnded(!0),c&&(b._error=c),Promise.all(a.map(this._getCallbacks("onAfter",b.type,b.method),function(a){return a(b)})).then(function(){return d._afterEnd(b)},function(a){return b._error=a,d._afterEnd(b)})},ba.prototype._afterEnd=function(b){if(this.markReady(b),b.error){var c=this._getCallbacks("onFailure",b.type,b.method);return this._bridge.probeError(b.error).then(function(){return c&&setTimeout(function(){a.each(c,function(a){return a(b)})},0),Promise.reject(b.error)})}};var ca="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",da=function(){this._lastUniqueKeyTime=0,this._lastRandomValues=[]};da.prototype.generateUniqueKey=function(a){var b=this;a=a||Date.now();for(var c=new Array(20),d=a,e=7;e>=0;e--)c[e]=ca.charAt(63&d),d=Math.floor(d/64);if(a===this._lastUniqueKeyTime){for(var f=11;f>=0&&63===this._lastRandomValues[f];)b._lastRandomValues[f]=0,f-=1;if(f===-1)throw new Error("Internal assertion failure: ran out of unique IDs for this millisecond");this._lastRandomValues[f]+=1}else{this._lastUniqueKeyTime=a;for(var g=0;g<12;g++)b._lastRandomValues[g]=Math.floor(Math.random()*(g?64:16))}for(var h=0;h<12;h++)c[h+8]=ca[b._lastRandomValues[h]];return c.join("")};var ea=function(a,c){this._rootUrl=a,this._bridge=c,this._vue=new b({data:{$root:{connected:void 0,timeOffset:0,user:void 0,userid:void 0,nowAtInterval:function(a){var b=this,c="now"+a;if(!this.hasOwnProperty(c)){var d=function(){b[c]=Date.now()+b.timeOffset,B.digest()};d(),setInterval(function(){return d},a)}return this[c]}}}}),c.onAuth(a,this._handleAuthChange,this),this._connectInfoProperty("serverTimeOffset","timeOffset"),this._connectInfoProperty("connected","connected"),Object.freeze(this)},fa={root:{}};fa.root.get=function(){return this._vue.$data.$root},ea.prototype.destroy=function(){this._bridge.offAuth(this._rootUrl,this._handleAuthChange,this),this._vue.$destroy()},ea.prototype._handleAuthChange=function(a){this.root.user=a,this.root.userid=a&&a.uid,B.digest()},ea.prototype._connectInfoProperty=function(a,b){var c=this,d=this._rootUrl+"/.info/"+a;this._bridge.on(d,d,null,"value",function(a){c.root[b]=a.value,B.digest()})},Object.defineProperties(ea.prototype,fa);var ga=function(a,b){this._coupler=a,this._query=b,this._listeners=[],this._keys=[],this._url=this._coupler._rootUrl+b.path,this._segments=b.path.split("/"),this._listening=!1,this.ready=!1};ga.prototype.attach=function(a,b){this._listen(),this._listeners.push({operation:a,keysCallback:b}),b&&b(this._keys)},ga.prototype.detach=function(b){var c=a.findIndex(this._listeners,{operation:b});return c>=0&&this._listeners.splice(c,1),this._listeners.length},ga.prototype._listen=function(){this._listening||(this._coupler._bridge.on(this._query.toString(),this._url,this._query.constraints,"value",this._handleSnapshot,this._handleError.bind(this._query.path),this,{sync:!0}),this._listening=!0)},ga.prototype.destroy=function(){var a=this;this._coupler._bridge.off(this._query.toString(),this._url,this._query.constraints,"value",this._handleSnapshot,this),this._listening=!1,this.ready=!1,B.digest();for(var b=0,c=this._keys;b<c.length;b+=1){var d=c[b];a._coupler._decoupleSegments(a._segments.concat(d))}},ga.prototype._handleSnapshot=function(a){var b=this;if(this._listeners.length&&this._listening){var c=this._updateKeys(a);if(this._coupler._applySnapshot(a),!this.ready){this.ready=!0,B.digest();for(var d=0,e=this._listeners;d<e.length;d+=1){var f=e[d];b._coupler._dispatcher.markReady(f.operation)}}if(c)for(var g=0,h=this._listeners;g<h.length;g+=1){var i=h[g];i.keysCallback&&i.keysCallback(c)}}},ga.prototype._updateKeys=function(b){var c,d=this;if(b.path===this._query.path)if(c=a.keys(b.value),c.sort(),a.isEqual(this._keys,c))c=null;else{for(var e=0,f=a.difference(c,this._keys);e<f.length;e+=1){var g=f[e];d._coupler._coupleSegments(d._segments.concat(g));
}for(var h=0,i=a.difference(this._keys,c);h<i.length;h+=1){var j=i[h];d._coupler._decoupleSegments(d._segments.concat(j))}this._keys=c}else if(b.path.replace(/\/[^\/]+/,"")===this._query.path){var k=a.contains(this._keys,b.key);b.value?k||(this._coupler._coupleSegments(this._segments.concat(b.key)),this._keys.push(b.key),this._keys.sort(),c=this._keys):k&&(this._coupler._decoupleSegments(this._segments.concat(b.key)),a.pull(this._keys,b.key),this._keys.sort(),c=this._keys)}return c},ga.prototype._handleError=function(b){var c=this;this._listeners.length&&this._listening&&(this._listening=!1,Promise.all(a.map(this._listeners,function(a){return c._coupler._dispatcher.clearReady(a.operation),c._coupler._dispatcher.retry(a.operation,b).catch(function(b){return a.operation._disconnect(b),!1})})).then(function(d){if(a.some(d))c._listeners.length&&c._listen();else for(var e=0,f=c._listeners;e<f.length;e+=1){var g=f[e];g.operation._disconnect(b)}}))};var ha=function(a,b){this._coupler=a,this.path=b,this.url=this._coupler._rootUrl+b,this.operations=[],this.queryCount=0,this.listening=!1,this.ready=!1,this.children={}},ia={active:{},count:{}};ia.active.get=function(){return this.count||this.queryCount},ia.count.get=function(){return this.operations.length},ha.prototype.listen=function(b){var c=this;if(!b&&this.count){if(this.listening)return;a.each(this.operations,function(a){c._coupler._dispatcher.clearReady(a)}),this._coupler._bridge.on(this.url,this.url,null,"value",this._handleSnapshot,this._handleError.bind(this),this,{sync:!0}),this.listening=!0}else a.each(this.children,function(a){a.listen()})},ha.prototype.unlisten=function(b){!b&&this.listening?(this._coupler._bridge.off(this.url,this.url,null,"value",this._handleSnapshot,this),this.listening=!1,this._forAllDescendants(function(a){a.ready&&(a.ready=!1,B.digest())})):a.each(this.children,function(a){a.unlisten()})},ha.prototype._handleSnapshot=function(a){var b=this;this.listening&&this._coupler.isTrunkCoupled(a.path)&&(this._coupler._applySnapshot(a),this.ready||a.path!==this.path||(this.ready=!0,B.digest(),this.unlisten(!0),this._forAllDescendants(function(a){for(var c=0,d=b.operations;c<d.length;c+=1){var e=d[c];b._coupler._dispatcher.markReady(e)}})))},ha.prototype._handleError=function(b){var c=this;if(this.count&&this.listening)return this.listening=!1,this._forAllDescendants(function(a){a.ready&&(a.ready=!1,B.digest());for(var b=0,d=c.operations;b<d.length;b+=1){var e=d[b];c._coupler._dispatcher.clearReady(e)}}),Promise.all(a.map(this.operations,function(a){return c._coupler._dispatcher.retry(a,b).catch(function(b){return a._disconnect(b),!1})})).then(function(d){if(a.some(d))c.count&&c.listen();else for(var e=0,f=c.operations;e<f.length;e+=1){var g=f[e];g._disconnect(b)}})},ha.prototype._forAllDescendants=function(b){b(this),a.each(this.children,function(a){return a._forAllDescendants(b)})},ha.prototype.collectCoupledDescendantPaths=function(b){return b||(b={}),b[this.path]=this.active,this.active||a.each(this.children,function(a){a.collectCoupledDescendantPaths(b)}),b},Object.defineProperties(ha.prototype,ia);var ja=function(a,c,d,e,f){this._rootUrl=a,this._bridge=c,this._dispatcher=d,this._applySnapshot=e,this._prunePath=f,this._vue=new b({data:{root:new ha(this,"/"),queryHandlers:{}}}),Object.freeze(this)},ka={_root:{},_queryHandlers:{}};ka._root.get=function(){return this._vue.root},ka._queryHandlers.get=function(){return this._vue.queryHandlers},ja.prototype.destroy=function(){a.each(this._queryHandlers,function(a){a.destroy()}),this._root.unlisten(),this._vue.$destroy()},ja.prototype.couple=function(a,b){return this._coupleSegments(a.split("/"),b)},ja.prototype._coupleSegments=function(a,c){for(var d,e=this,f=!c,g=!1,h=0,i=a;h<i.length;h+=1){var j=i[h],k=j?d.children&&d.children[j]:e._root;k||(k=new ha(e,("/"===d.path?"":d.path)+"/"+j),b.set(d.children,j,k)),f=f||k.listening,g=g||k.ready,d=k}c?d.operations.push(c):d.queryCount++,f?c&&g&&this._dispatcher.markReady(c):d.listen()},ja.prototype.decouple=function(a,b){return this._decoupleSegments(a.split("/"),b)},ja.prototype._decoupleSegments=function(c,d){for(var e,f=this,g=[],h=0,i=c;h<i.length;h+=1){var j=i[h];if(e=j?e.children&&e.children[j]:f._root,!e)break;g.push(e)}if(!e||!(d?e.count:e.queryCount))throw new Error("Path not coupled: "+c.join("/"));if(d?a.pull(e.operations,d):e.queryCount--,d&&!e.count&&(e.listen(),e.listening&&e.unlisten()),!e.active){for(var k=g.length-1;k>0&&(e=g[k],e!==f._root&&!e.active&&a.isEmpty(e.children));k--)b.delete(g[k-1].children,c[k]);this._prunePath(c.join("/"),this.findCoupledDescendantPaths(c))}},ja.prototype.subscribe=function(a,c,d){var e=this._queryHandlers[a.toString()];e||(e=new ga(this,a),b.set(this._queryHandlers,a.toString(),e)),e.attach(c,d)},ja.prototype.unsubscribe=function(a,c){var d=this._queryHandlers[a.toString()];d&&!d.detach(c)&&(d.destroy(),b.delete(this._queryHandlers,a.toString()))},ja.prototype.isTrunkCoupled=function(a){for(var b,c=this,d=a.split("/"),e=0,f=d;e<f.length;e+=1){var g=f[e];if(b=g?b.children&&b.children[g]:c._root,!b)return!1;if(b.active)return!0}return!1},ja.prototype.findCoupledDescendantPaths=function(b){for(var c,d=this,e=a.isString(b)?b.split("/"):b,f=0,g=e;f<g.length;f+=1){var h=g[f];if(c=h?c.children&&c.children[h]:d._root,!c)break}return c&&c.collectCoupledDescendantPaths()},ja.prototype.isSubtreeReady=function(a){for(var b,c=this,d=a.split("/"),e=0,f=d;e<f.length;e+=1){var g=f[e];if(b=g?b.children&&b.children[g]:c._root,!b)return!1;if(b.ready)return!0}return!1},ja.prototype.isQueryReady=function(a){var b=this._queryHandlers[a.toString()];return b&&b.ready},Object.defineProperties(ja.prototype,ka);var la,ma,na={$truss:!0,$parent:!0,$key:!0,$path:!0,$ref:!0,$$touchThis:!0,$$initializers:!0,$$finalizers:!0,$$$trussCheck:!0,__ob__:!0},oa=function(){},pa={$parent:{},$path:{},$truss:{},$ref:{},$refs:{},$key:{},$data:{},$empty:{},$keys:{},$values:{},$meta:{},$root:{},$now:{},$ready:{},$overridden:{},$$initializers:{},$$finalizers:{}};pa.$parent.get=function(){return la.$parent.value},pa.$path.get=function(){return la.$path.value},pa.$truss.get=function(){return Object.defineProperty(this,"$truss",{value:this.$parent.$truss}),this.$truss},pa.$ref.get=function(){return Object.defineProperty(this,"$ref",{value:new O(this.$truss._tree,this.$path)}),this.$ref},pa.$refs.get=function(){return this.$ref},pa.$key.get=function(){return Object.defineProperty(this,"$key",{value:f(this.$path.slice(this.$path.lastIndexOf("/")+1))}),this.$key},pa.$data.get=function(){return this},pa.$empty.get=function(){return a.isEmpty(this.$data)},pa.$keys.get=function(){return a.keys(this.$data)},pa.$values.get=function(){return a.values(this.$data)},pa.$meta.get=function(){return this.$truss.meta},pa.$root.get=function(){return this.$truss.root},pa.$now.get=function(){return this.$truss.now},pa.$ready.get=function(){return this.$ref.ready},pa.$overridden.get=function(){return!1},oa.prototype.$intercept=function(b,c){var d=this,e=this.$truss.intercept(b,c),f=function(){e(),a.pull(d.$$finalizers,f)};return this.$$finalizers.push(f),f},oa.prototype.$connect=function(b,c){var d=this;c||(c=b,b=void 0);var e=this.$truss.connect(b,s(this,c)),f=e.destroy,g=function(){return a.pull(d.$$finalizers,g),f.call(e)};return this.$$finalizers.push(g),e.destroy=g,e},oa.prototype.$peek=function(b,c){var d=this,e=j(this.$truss.peek(b,c),function(){a.pull(d.$$finalizers,e.cancel)});return this.$$finalizers.push(e.cancel),e},oa.prototype.$watch=function(b,c,d){var e,f=this,g=this.$truss.watch(function(){return f.$$touchThis(),b.call(f)},c.bind(this),d);return e=function(){g(),a.pull(f.$$finalizers,e)},this.$$finalizers.push(e),e},oa.prototype.$when=function(b,c){var d=this,e=this.$truss.when(function(){return d.$$touchThis(),b.call(d)},c);return j(e,function(){a.pull(d.$$finalizers,e.cancel)}),this.$$finalizers.push(e.cancel),e},oa.prototype.$freezeComputedProperty=function(){if(!a.isBoolean(ma))throw new Error("Cannot freeze a computed property outside of its getter function");ma=!0},oa.prototype.$set=function(a){return this.$ref.set(a)},oa.prototype.$update=function(a){return this.$ref.update(a)},oa.prototype.$override=function(a){return this.$ref.override(a)},oa.prototype.$commit=function(a,b){return this.$ref.commit(a,b)},oa.prototype.$$touchThis=function(){this.$parent?(this.$parent.hasOwnProperty("$data")?this.$parent.$data:this.$parent)[this.$key]:this.$root},pa.$$initializers.get=function(){return Object.defineProperty(this,"$$initializers",{value:[],writable:!1,enumerable:!1,configurable:!0}),this.$$initializers},pa.$$finalizers.get=function(){return Object.defineProperty(this,"$$finalizers",{value:[],writable:!1,enumerable:!1,configurable:!1}),this.$$finalizers},Object.defineProperties(oa.prototype,pa);var qa=function(a){this.error=a},ra=function(a){this.value=a},sa=function(){this._trie={Class:oa},Object.freeze(this)};sa.prototype.init=function(b,c){var d=this;a.isPlainObject(b)&&(a.each(b,function(a,b){a.$trussMount||(a.$$trussMount=a.$$trussMount||[],a.$$trussMount.push(b))}),b=a.values(b),a.each(b,function(a){!a.$trussMount&&a.$$trussMount&&(a.$trussMount=a.$$trussMount,delete a.$$trussMount)})),b=a.uniq(b),a.each(b,function(a){return d._mountClass(a,c)}),this._decorateTrie(this._trie)},sa.prototype.destroy=function(){},sa.prototype._getMount=function(a,b,c){for(var d,e=this,f=a.split("/"),g=0,h=f;g<h.length;g+=1){var i=h[g],j=i?d.children&&(d.children[i]||d.children.$):e._trie;if(!j){if(!b)return;d.children=d.children||{},j=d.children[i]={Class:oa}}if(d=j,c&&c(d))break}return d},sa.prototype._findMount=function(b,c){var d=this;if(c||(c=this._trie),b(c))return c;for(var e=0,f=a.keys(c.children);e<f.length;e+=1){var g=f[e],h=d._findMount(b,c.children[g]);if(h)return h}},sa.prototype._decorateTrie=function(b){var c=this;a.each(b.children,function(a){c._decorateTrie(a),(a.local||a.localDescendants)&&(b.localDescendants=!0)})},sa.prototype._augmentClass=function(b){for(var c,d=b.prototype;d&&d.constructor!==Object;){for(var e=0,f=Object.getOwnPropertyNames(d);e<f.length;e+=1){var g=f[e],h=Object.getOwnPropertyDescriptor(d,g);if("$"===g.charAt(0)){if(a.isEqual(h,Object.getOwnPropertyDescriptor(oa.prototype,g)))continue;throw new Error('Property names starting with "$" are reserved: '+b.name+"."+g)}if(h.set)throw new Error("Computed properties must not have a setter: "+b.name+"."+g);!h.get||c&&c[g]||((c||(c={}))[g]={name:g,fullName:d.constructor.name+"."+g,get:h.get})}d=Object.getPrototypeOf(d)}for(var i=0,j=Object.getOwnPropertyNames(oa.prototype);i<j.length;i+=1){var k=j[i];"constructor"===k||b.prototype.hasOwnProperty(k)||Object.defineProperty(b.prototype,k,Object.getOwnPropertyDescriptor(oa.prototype,k))}return c},sa.prototype._mountClass=function(b,c){var d=this,e=this._augmentClass(b),f=b.$trussMount;if(!f)throw new Error("Class "+b.name+" lacks a $trussMount static property");a.isArray(f)||(f=[f]),a.each(f,function(f){if(a.isString(f)&&(f={path:f}),!c&&"/"===f.path)throw new Error("Data root already accessed, too late to mount class");for(var g=l(f.path),h=0,i=g.variables;h<i.length;h+=1){var j=i[h];if("$"===j||"$"===j.charAt(1))throw new Error("Invalid variable name: "+j);if("$"===j.charAt(0)&&(a.has(oa.prototype,j)||na[j]))throw new Error("Variable name conflicts with built-in property or method: "+j)}var k=f.path.match(/\/([^\/]*)$/)[1];if("$"===k.charAt(0)){if(f.placeholder)throw new Error("Class "+b.name+" mounted at wildcard "+k+" cannot be a placeholder")}else a.has(f,"placeholder")||(f.placeholder={});var m=d._getMount(f.path.replace(/\$[^\/]*/g,"$"),!0);if(m.matcher)throw new Error("Multiple classes mounted at "+f.path+": "+m.Class.name+", "+b.name);a.extend(m,{Class:b,matcher:g,computedProperties:e,escapedKey:k,placeholder:f.placeholder,local:f.local})})},sa.prototype.createObject=function(b,c){var d=this,e=this._getMount(b)||{Class:oa};if(e.matcher){var f=e.matcher.match(b);for(var g in f)c[g]={value:f[g]}}la=c;var h=new e.Class;return la=null,e.keysUnsafe&&(c.$data={value:Object.create(null)}),e.computedProperties&&a.each(e.computedProperties,function(a){c[a.name]=d._buildComputedPropertyDescriptor(h,a)}),h},sa.prototype._buildComputedPropertyDescriptor=function(b,c){var d,e=T.for(c.fullName),f=!1;return b.$$initializers.push(function(g){var h=g.$watch(r.bind(b,c,e),function(g){if(g instanceof ra&&(g=g.value,h(),a.pull(b.$$finalizers,h)),!a.isEqual(d,g,t)&&(e.numUpdates+=1,f=!0,b[c.name]=g,f=!1,B.digest(),g instanceof qa))throw g.error},{immediate:!0});b.$$finalizers.push(h)}),{enumerable:!0,configurable:!0,get:function(){if(d instanceof qa)throw d.error;return d},set:function(a){if(!f)throw new Error("You cannot set a computed property: "+c.name);d=a}}},sa.prototype.destroyObject=function(b){if(a.has(b,"$$finalizers"))for(var c=0,d=a.clone(b.$$finalizers);c<d.length;c+=1){var e=d[c];e()}},sa.prototype.isPlaceholder=function(a){var b=this._getMount(a);return b&&b.placeholder},sa.prototype.isLocal=function(a){var b=this._getMount(a,!1,function(a){return a.local});if(!b)return!1;if(b.local)return!0;if(b.localDescendants)throw new Error("Subtree mixes local and remote data: "+a);return!1},sa.prototype.forEachPlaceholderChild=function(b,c){var d=this._getMount(b);a.each(d&&d.children,function(a){a.placeholder&&c(a.escapedKey,a.placeholder)})},sa.prototype.checkVueObject=function(b,c,d){var f=this,g=!d;g&&(d=[]);try{for(var h=0,i=Object.getOwnPropertyNames(b);h<i.length;h+=1){var j=i[h];if(!na[j]){var l=f._findMount(function(a){return a.Class===b.constructor});if(!(l&&l.matcher&&a.includes(l.matcher.variables,j))){if(!Array.isArray(b)||!/\d+/.test(j)&&"length"!==j){var m=Object.getOwnPropertyDescriptor(b,j);if("value"in m||!m.get)throw new Error("Value at "+c+", contained in a Firetruss object, has a rogue property: "+j);if(b.$truss&&m.enumerable)try{throw b[j]=b[j],new Error("Firetruss object at "+c+" has an enumerable non-Firebase property: "+j)}catch(a){if("firebase_overwrite"!==a.trussCode)throw a}}var n=b[j];!a.isObject(n)||n.$$$trussCheck||!Object.isExtensible(n)||n instanceof Function||(n.$$$trussCheck=!0,d.push(n),f.checkVueObject(n,k(c,e(j)),d))}}}}finally{if(g)for(var o=0,p=d;o<p.length;o+=1){var q=p[o];delete q.$$$trussCheck}}};var ta=function(a,b){this._path=a,this._tree=b},ua={currentValue:{},outcome:{},values:{}};ua.currentValue.get=function(){return this._tree.getObject(this._path)},ua.outcome.get=function(){return this._outcome},ua.values.get=function(){return this._values},ta.prototype._setOutcome=function(a){if(this._outcome)throw new Error("Transaction already resolved with "+this._outcome);this._outcome=a},ta.prototype.abort=function(){this._setOutcome("abort")},ta.prototype.cancel=function(){this._setOutcome("cancel")},ta.prototype.set=function(a){if(void 0===a)throw new Error("Invalid argument: undefined");this._setOutcome("set"),this._values={"":a}},ta.prototype.update=function(b){if(void 0===b)throw new Error("Invalid argument: undefined");return a.isEmpty(b)?this.cancel():(this._setOutcome("update"),void(this._values=b))},Object.defineProperties(ta.prototype,ua);var va=function(a,c,d,e){this._truss=a,this._rootUrl=c,this._bridge=d,this._dispatcher=e,this._firebasePropertyEditAllowed=!1,this._writeSerial=0,this._localWrites={},this._localWriteTimestamp=null,this._initialized=!1,this._modeler=new sa,this._coupler=new ja(c,d,e,this._integrateSnapshot.bind(this),this._prune.bind(this)),this._vue=new b({data:{$root:void 0}}),Object.seal(this)},wa={root:{},truss:{}};wa.root.get=function(){return this._vue.$data.$root||(this._vue.$data.$root=this._createObject("/",""),this._fixObject(this._vue.$data.$root),this._completeCreateObject(this._vue.$data.$root),B.digest()),this._vue.$data.$root},wa.truss.get=function(){return this._truss},va.prototype.init=function(a){if(this._initialized)throw new Error("Data objects already created, too late to mount classes");this._initialized=!0,this._modeler.init(a,!this._vue.$data.$root),this._plantPlaceholders(this.root,"/")},va.prototype.destroy=function(){this._coupler.destroy(),this._modeler&&this._modeler.destroy(),this._vue.$destroy()},va.prototype.connectReference=function(b,c,d){var e=this;this._checkHandle(b);var g,h=this._dispatcher.createOperation("read",d,b);if(c){var i=a(b.path).split("/").map(function(a){return f(a)}).value();g=this._vue.$watch(this.getObject.bind(this,i),c,{immediate:!0})}return h._disconnect=this._disconnectReference.bind(this,b,h,g),this._dispatcher.begin(h).then(function(){h.running&&!h._disconnected&&(e._coupler.couple(b.path,h),h._coupled=!0)}).catch(function(a){}),h._disconnect},va.prototype._disconnectReference=function(a,b,c,d){b._disconnected||(b._disconnected=!0,c&&c(),b._coupled&&(this._coupler.decouple(a.path,b),b._coupled=!1),this._dispatcher.end(b,d).catch(function(a){}))},va.prototype.isReferenceReady=function(a){return this._checkHandle(a),this._coupler.isSubtreeReady(a.path)},va.prototype.connectQuery=function(a,b,c){var d=this;this._checkHandle(a);var e=this._dispatcher.createOperation("read",c,a);return e._disconnect=this._disconnectQuery.bind(this,a,e),this._dispatcher.begin(e).then(function(){e.running&&!e._disconnected&&(d._coupler.subscribe(a,e,b),e._coupled=!0)}).catch(function(a){}),e._disconnect},va.prototype._disconnectQuery=function(a,b,c){b._disconnected||(b._disconnected=!0,b._coupled&&(this._coupler.unsubscribe(a,b),b._coupled=!1),this._dispatcher.end(b,c).catch(function(a){}))},va.prototype.isQueryReady=function(a){return this._coupler.isQueryReady(a)},va.prototype._checkHandle=function(a){if(!a.belongsTo(this._truss))throw new Error("Reference belongs to another Truss instance")},va.prototype.update=function(b,c,d){var e=this;d=a.clone(d);var f=a.size(d);if(!f)return Promise.resolve();if("update"!==c&&"override"!==c||u(b.path,d),this._applyLocalWrite(d,"override"===c),"override"===c)return Promise.resolve();for(var g=0,h=a.keys(d);g<h.length;g+=1){var i=h[g];e._modeler.isLocal(i)&&delete d[i]}if(f=a.size(d),!f)return Promise.resolve();var j=this._rootUrl+this._extractCommonPathPrefix(d);return this._dispatcher.execute("write",c,b,function(){return 1===f?e._bridge.set(j,d[""],e._writeSerial):e._bridge.update(j,d,e._writeSerial)})},va.prototype.commit=function(b,c){var d=this,e=0,f=function(){if(e++>=25)return Promise.reject(new Error("maxretry"));var g=new ta;try{c(g)}catch(a){return Promise.reject(a)}var h=a.clone(g.values),i=w(d.getObject(b.path));switch(g.outcome){case"abort":return;case"cancel":break;case"set":if(d._modeler.isLocal(b.path))throw new Error("Commit in local subtree: "+b.path);d._applyLocalWrite((j={},j[b.path]=h[""],j));var j;break;case"update":u(b.path,h),a(h).keys().each(function(a){if(d._modeler.isLocal(a))throw new Error("Commit in local subtree: "+a)}),d._applyLocalWrite(h),v(b.path,h);break;default:throw new Error("Invalid transaction outcome: "+(g.outcome||"none"))}return d._bridge.transaction(d._rootUrl+b.path,i,h).then(function(a){return a?g:f()})};return this._truss.peek(b,function(){return d._dispatcher.execute("write","commit",b,f)})},va.prototype._applyLocalWrite=function(b,c){var d=this;this._writeSerial++,this._localWriteTimestamp=this._truss.now,a.each(b,function(b,e){var g=d._modeler.isLocal(e),h=g?[e]:d._coupler.findCoupledDescendantPaths(e);if(!a.isEmpty(h))for(var i=("/"===e?0:e.length)+1,j=0,k=h;j<k.length;j+=1){var l=k[j],m=l.slice(i),n=b;if(m)for(var o=m.split("/"),p=0,q=o;p<q.length;p+=1){var r=q[p];if(n=n[f(r)],void 0===n)break}if(void 0===n||null===n)d._prune(l);else{var s=f(a.last(l.split("/")));d._plantValue(l,s,n,d._scaffoldAncestors(l),!1,c)}c||g||(d._localWrites[l]=d._writeSerial)}})},va.prototype._extractCommonPathPrefix=function(b){var c;a.each(b,function(a,b){var d="/"===b?[""]:b.split("/");if(c){for(var e=0,f=Math.min(c.length,d.length);e<f&&c[e]===d[e];)e++;if(c=c.slice(0,e),!c.length)return!1}else c=d});var d=1===c.length?"/":c.join("/");return a.each(a.keys(b),function(a){b[a.slice(d.length+1)]=b[a],delete b[a]}),d},va.prototype._createObject=function(a,b,c){this._initialized||"/"===a||this.init();var d={$parent:{value:c,configurable:!0,enumerable:!0},$path:{value:a}};"/"===a&&(d.$truss={value:this._truss});var e=this._modeler.createObject(a,d);return Object.defineProperties(e,d),e},va.prototype._fixObject=function(a){for(var b=0,c=Object.getOwnPropertyNames(a);b<c.length;b+=1){var d=c[b],e=Object.getOwnPropertyDescriptor(a,d);e.configurable&&e.enumerable&&(e.enumerable=!1,"$parent"===d&&(e.configurable=!1),Object.defineProperty(a,d,e))}},va.prototype._completeCreateObject=function(a){var b=this;if(a.hasOwnProperty("$$initializers")){for(var c=0,d=a.$$initializers;c<d.length;c+=1){var e=d[c];e(b._vue)}delete a.$$initializers}},va.prototype._destroyObject=function(a){var b=this;if(a&&a.$truss){this._modeler.destroyObject(a);for(var c in a)Object.hasOwnProperty(a,c)&&b._destroyObject(a[c])}},va.prototype._integrateSnapshot=function(b){var c=this;if(a.each(a.keys(this._localWrites),function(a,d){b.writeSerial>=a&&delete c._localWrites[d]}),b.exists){var d=this._scaffoldAncestors(b.path,!0);d&&this._plantValue(b.path,b.key,b.value,d,!0,!1)}else this._prune(b.path,null,!0)},va.prototype._scaffoldAncestors=function(b,c){var d,e=this,g=a(b).split("/").dropRight().value();return a.each(g,function(a,b){var h=f(a),i=h?d[h]:e.root;if(!i){var j=g.slice(0,b+1).join("/");if(c&&e._localWrites[j||"/"])return;i=e._plantValue(j,h,{},d)}d=i}),d},va.prototype._plantValue=function(b,c,d,g,h,i,j){var l=this,m=!j;if(j=j||[],h&&(null===d||void 0===d))throw new Error("Snapshot includes invalid value at "+b+": "+d);if(!h||!this._localWrites[b]){if(d===C&&(d=this._localWriteTimestamp),!(a.isArray(d)||a.isObject(d)&&d.constructor===Object))return void this._setFirebaseProperty(g,c,d);var n=!1,o=g[c];if(a.isObject(o)||(this._setFirebaseProperty(g,c,null),o=this._createObject(b,c,g),this._setFirebaseProperty(g,c,o),this._fixObject(o),j.push(o),n=!0),i?Object.defineProperty(o,"$overridden",{get:a.constant(!0),configurable:!0}):o.$overridden&&delete o.$overridden,a.each(d,function(a,c){l._plantValue(k(b,c),f(c),a,o,h,i)}),n?this._plantPlaceholders(o,b):a.each(o,function(a,c){var f=e(c);d.hasOwnProperty(f)||l._prune(k(b,f),null,h)}),m)for(var p=0,q=j;p<q.length;p+=1){var r=q[p];l._completeCreateObject(r)}return o}},va.prototype._plantPlaceholders=function(a,b){var c=this;this._modeler.forEachPlaceholderChild(b,function(d,e){var g=f(d);a.hasOwnProperty(g)||c._plantValue(k(b,d),g,e,a)})},va.prototype._prune=function(b,c,d){c=c||{};var e=this.getObject(b);void 0!==e&&(d&&this._avoidLocalWritePaths(b,c)||a.isEmpty(c)&&this._pruneAncestors(b,e)||!a.isObject(e)||this._pruneDescendants(e,c))},va.prototype._avoidLocalWritePaths=function(b,c){var d=this;for(var e in this._localWrites)if(d._localWrites.hasOwnProperty(e)){if(b===e||"/"===e||a.startsWith(b,e+"/"))return!0;if("/"===b||a.startsWith(e,b+"/"))for(var f=e.split("/"),g=f.length;g>0;g--){var h=f.slice(0,g).join("/"),i=g===f.length;if(c[h]||c[h]===i)break;if(c[h]=i,h===b)break}}},va.prototype._pruneAncestors=function(b,c){for(var d=this,e=!1,g=c,h=a(b).split("/").map(f).value();g&&g!==this.root;){var i=g.$parent||g===c&&d.getObject(h.slice(0,-1));if(!d._modeler.isPlaceholder(g.$path||b)){var j=e?null:[c];d._holdsConcreteData(g,j)||(e=!0,d._deleteFirebaseProperty(i,g.$key||g===c&&a.last(h)))}g=i}return e},va.prototype._holdsConcreteData=function(b,c){var d=this;return(!c||!a.includes(c,b))&&(!!a.some(b,function(a){return!a.$truss})||a.some(b,function(a){return d._holdsConcreteData(a,c)}))},va.prototype._pruneDescendants=function(b,c){var d=this;if(c[b.$path])return!0;b.$overridden&&delete b.$overridden;var f=!1;return a.each(b,function(g,h){var i,j=!0;if(c[k(b.$path,e(h))])j=!1,i=!0;else if(g.$truss){var l=d._modeler.isPlaceholder(g.$path);(l||a.has(c,g.$path))&&(i=d._pruneDescendants(g,c),j=!l&&!i)}j&&d._deleteFirebaseProperty(b,h),f=f||i}),f},va.prototype.getObject=function(b){for(var c,d=this,e=a.isString(b)?a(b).split("/").map(f).value():b,g=0,h=e;g<h.length;g+=1){var i=h[g];if(c=i?c[i]:d.root,void 0===c)return}return c},va.prototype._getFirebasePropertyDescriptor=function(a,b){var c=Object.getOwnPropertyDescriptor(a,b);if(c){if(!c.enumerable)throw new Error("Key conflict between Firebase and instance or computed properties at "+a.$path+": "+b);if(!c.get||!c.set)throw new Error("Unbound property at "+a.$path+": "+b)}else if(b in a)throw new Error("Key conflict between Firebase and inherited property at "+a.$path+": "+b);return c},va.prototype._setFirebaseProperty=function(a,c,d){a.hasOwnProperty("$data")&&(a=a.$data);var e=this._getFirebasePropertyDescriptor(a,c);e?(this._firebasePropertyEditAllowed=!0,a[c]=d,this._firebasePropertyEditAllowed=!1):(b.set(a,c,d),e=Object.getOwnPropertyDescriptor(a,c),Object.defineProperty(a,c,{get:e.get,set:this._overwriteFirebaseProperty.bind(this,e,c),configurable:!0,enumerable:!0})),B.digest()},va.prototype._overwriteFirebaseProperty=function(a,b,c){if(!this._firebasePropertyEditAllowed){var d=new Error("Firebase data cannot be mutated directly: "+b);throw d.trussCode="firebase_overwrite",d}a.set.call(this,c)},va.prototype._deleteFirebaseProperty=function(a,c){a.hasOwnProperty("$data")&&(a=a.$data),this._getFirebasePropertyDescriptor(a,c),this._destroyObject(a[c]),b.delete(a,c),B.digest()},va.prototype.checkVueObject=function(a,b){this._modeler.checkVueObject(a,b)},Object.defineProperties(va.prototype,wa);var xa,ya,za={},Aa="dev",Ba=function(a){if(!xa)throw new Error("Truss worker not connected, please call Truss.connectWorker first");this._rootUrl=a.replace(/\/$/,""),this._keyGenerator=new da,this._dispatcher=new ba(xa),this._vue=new b,xa.trackServer(this._rootUrl),this._metaTree=new ea(this._rootUrl,xa),this._tree=new va(this,this._rootUrl,xa,this._dispatcher),Object.freeze(this)},Ca={meta:{},root:{},now:{},SERVER_TIMESTAMP:{},VERSION:{},FIREBASE_SDK_VERSION:{}},Da={computedPropertyStats:{},worker:{}};return Ca.meta.get=function(){return this._metaTree.root},Ca.root.get=function(){return this._tree.root},Ba.prototype.mount=function(a){this._tree.init(a)},Ba.prototype.destroy=function(){this._vue.$destroy(),this._tree.destroy(),this._metaTree.destroy()},Ca.now.get=function(){return Date.now()+this.meta.timeOffset},Ba.prototype.newKey=function(){return this._keyGenerator.generateUniqueKey(this.now)},Ba.prototype.authenticate=function(a){var b=this;return this._dispatcher.execute("auth","authenticate",new O(this._tree,"/"),function(){return xa.authWithCustomToken(b._rootUrl,a,{rememberMe:!0})})},Ba.prototype.unauthenticate=function(){var a=this;return this._dispatcher.execute("auth","unauthenticate",new O(this._tree,"/"),function(){return xa.unauth(a._rootUrl)})},Ba.prototype.intercept=function(a,b){return this._dispatcher.intercept(a,b)},Ba.prototype.connect=function(a,b){return b||(b=a,a=void 0),b instanceof L&&(b={_:b}),new W(a,b,this._tree,"connect")},Ba.prototype.peek=function(b,c){var d=this;c=g(c);var e,f,i=new Promise(function(g,h){var i,k={},l=new W(k,{result:b},d._tree,"peek"),m=d.intercept("peek",{onFailure:function(b){function c(d){if(d)return d instanceof L?b.target.isEqual(d):a.some(d,function(a){return c(a)})}c(l.at)&&(h(b.error),e())}}),n=d.watch(function(){return l.ready},function(a){a&&(n(),n=null,i=j(c(k.result),function(){B.digest(),i=null,e()}).then(function(a){g(a)},function(a){h(a)}))});e=function(){n&&(n(),n=null),m&&(m(),m=null),l&&(l.destroy(),l=null),i&&i.cancel&&i.cancel()},f=function(){h(new Error("Canceled")),e()}});return h(i,f)},Ba.prototype.watch=function(a,b,c){var d=0,e=this._vue.$watch(a,function(c,e){d++,1===d?Promise.resolve().then(function(){d>1||a()!==c||(b(c,e),B.digest())}):(b(c,e),B.digest())},{immediate:!0,deep:c&&c.deep});return e},Ba.prototype.when=function(c,d){var e,f,g=this,i=new Promise(function(h,i){var j=g.watch(c,function(a){a&&b.nextTick(function(){a=c(),a&&(h(a),e())})});a.has(d,"timeout")&&(f=setTimeout(function(){f=null,i(new Error(d.timeoutMessage||"Timeout")),e()},d.timeout)),e=function(){j&&(j(),j=null),f&&(clearTimeout(f),f=null),i(new Error("Canceled"))}});return i=h(j(i,e)),d&&d.scope&&d.scope.$on("$destroy",function(){i.cancel()}),i},Ba.prototype.checkObjectsForRogueProperties=function(){this._tree.checkVueObject(this._tree.root,"/")},Da.computedPropertyStats.get=function(){return T.list},Ba.logComputedPropertyStats=function(a){return void 0===a&&(a=10),T.log(a)},Ba.connectWorker=function(b){if(xa)throw new Error("Worker already connected");if(a.isString(b)){var c=window.SharedWorker||window.Worker;if(!c)throw new Error("Browser does not implement Web Workers");b=new c(b)}return xa=new J(b),ya&&xa.enableLogging(ya),xa.init(b).then(function(a){var b=a.exposedFunctionNames,c=a.firebaseSdkVersion;Object.defineProperty(Ba,"FIREBASE_SDK_VERSION",{value:c});for(var d=0,e=b;d<e.length;d+=1){var f=e[d];Ba.worker[f]=xa.bindExposedFunction(f)}})},Da.worker.get=function(){return za},Ba.preExpose=function(a){Ba.worker[a]=xa.bindExposedFunction(a)},Ba.bounceConnection=function(){return xa.bounceConnection()},Ba.suspend=function(){return xa.suspend()},Ba.debugPermissionDeniedErrors=function(a,b,c){return xa.debugPermissionDeniedErrors(a,b,c)},Ba.debounceAngularDigest=function(a){B.debounceDigest(a)},Ba.escapeKey=function a(b){return a(b)},Ba.unescapeKey=function a(b){return a(b)},Ba.enableLogging=function(a){ya=a,xa&&xa.enableLogging(a)},Ca.SERVER_TIMESTAMP.get=function(){return Ba.SERVER_TIMESTAMP},Ca.VERSION.get=function(){return Ba.VERSION},Ca.FIREBASE_SDK_VERSION.get=function(){return Ba.FIREBASE_SDK_VERSION},Object.defineProperties(Ba.prototype,Ca),Object.defineProperties(Ba,Da),Object.defineProperties(Ba,{SERVER_TIMESTAMP:{value:C},VERSION:{value:Aa}}),B.defineModule(Ba),Ba});
//# sourceMappingURL=firetruss.umd.min.js.map