{"version":3,"sources":["../src/client/angularCompatibility.js","../src/client/utils.js","../src/client/Bridge.js","../src/client/Modeler.js","../src/client/Tree.js","../src/client/Reference.js","../src/client/Connector.js","../src/client/Dispatcher.js","../src/client/KeyGenerator.js","../src/client/MetaTree.js","../src/client/Coupler.js","../node_modules/performance-now/lib/performance-now.js","../src/client/Truss.js"],"names":["noop","escapeKey","key","toString","replace","char","charCodeAt","unescapeKey","code","String","fromCharCode","parseInt","slice","wrapPromiseCallback","callback","Promise","resolve","apply","this","arguments","e","reject","errorFromJson","json","params","Error","const","error","message","let","propertyName","hasOwnProperty","extra","getUrlRoot","url","k","indexOf","computeValue","prop","stats","$$touchThis","startTime","performanceNow","result","get","call","runtime","numRecomputes","isTrussValueEqual","a","b","$truss","throwReadOnlyError","joinPath","segments","i","list","length","segment","charAt","splice","push","join","checkUpdateHasOnlyDescendantsWithNoOverlap","rootPath","values","relativizePaths","_","each","keys","path","startsWith","absolutePath","allPaths","map","sortBy","value","otherPath","toFirebaseJson","object","earlyDigestPending","bareDigest","angularProxy","active","window","angular","debounceDigest","wait","digest","debounce","forEach","method","module","run","$rootScope","$evalAsync","bind","defineModule","Truss","constant","bridge","SERVER_TIMESTAMP","Object","freeze",".sv","Snapshot","ref","valueError","exists","_path","_value","_valueError","_exists","undefined","prototypeAccessors","_checkValue","_key","prototype","Bridge","webWorker","_idCounter","_deferreds","_suspended","_servers","_callbacks","_simulatedTokenGenerator","_maxSimulationDuration","_simulatedCallFilter","_inboundMessages","_outboundMessages","_flushMessageQueue","_port","port","_shared","onmessage","_receive","addEventListener","_send","msg","setInterval","init","items","storage","localStorage","sessionStorage","getItem","staticAccessors","instance","suspend","suspended","_receiveMessages","setImmediate","debugPermissionDeniedErrors","simulatedTokenGenerator","maxSimulationDuration","callFilter","id","promise","oneWay","this$1","deferred","sent","resolveSent","postMessage","event","concat","data","messages","fn","bindExposedFunction","name","args","Array","probeError","toLowerCase","_simulateCall","then","securityTrace","permissionDeniedDetails","props","simulatedCalls","spec","newValue","auth","getAuth","simulationPromise","uid","token","all","securityTraces","every","trace","filter","catch","timeoutPromise","setTimeout","race","updateLocalStorage","item","removeItem","setItem","trackServer","rootUrl","server","authListeners","authCallbackId","_registerCallback","_authCallback","callbackId","listener","onAuth","context","offAuth","authWithCustomToken","authToken","options","unauth","set","writeSerial","update","on","listenerKey","eventType","snapshotCallback","cancelCallback","handle","_onCallback","__callbackIds","off","idsToDeregister","_findAndRemoveCallbackId","i$1","list$1","_nullifyCallback","_deregisterCallback","snapshotJson","console","transaction","oldValue","relativeUpdates","onDisconnect","bounceConnection","predicate","EMPTY_ANNOTATIONS","Handle","tree","annotations","_tree","_annotations","$ref","_pathPrefix","parent","Reference","child","children","escapedKeys","arg","isArray","mapping","subPath","rest","subRef","peek","truss","isEqual","that","belongsTo","Query","super","_spec","_copyAndValidateSpec","prototypeAccessors$1","ready","isQueryReady","constraints","annotate","extend","by","JSON","stringify","some","clause","clone","childPath","_string","queryTerms","encodeURIComponent","prototypeAccessors$2","isReferenceReady","query","obj","commit","updateFunction","Connector","scope","connections","_scope","_connections","_method","_subConnectors","_currentDescriptors","_disconnects","_vue","Vue","mapValues","_linkScopeProperties","descriptor","isFunction","_bindComputedConnection","_connect","$on","$$id","destroy","_unlinkScopeProperties","_angularUnwatches","unwatch","_disconnect","duplicateKey","find","defineProperties","configurable","enumerable","$data","_updateComputedConnection","$watch","immediate","watch","newDescriptor","oldDescriptor","has","_updateConnections","updateFn","_updateScopeRef","connectReference","_updateScopeQuery","connectQuery","subScope","subConnector","subReady","delete","childKeys","changed","childKey","contains","split","root","INTERCEPT_KEYS","SlowHandle","operation","delay","_operation","_delay","_callback","_fired","initiate","cancel","elapsed","Date","now","_startTimestamp","_timeoutId","clearTimeout","Operation","type","target","_type","_target","_ready","_running","_slowHandles","running","_error","onSlow","_setRunning","_markReady","_clearReady","Dispatcher","_bridge","intercept","interceptKey","callbacks","badCallbackKeys","difference","wrappedCallbacks","onBefore","_addCallback","onAfter","onError","onFailure","_removeCallbacks","stage","_getCallbacksKey","wrappedCallback","_removeCallback","pull","_getCallbacks","operationType","execute","executor","createOperation","begin","executeWithRetries","_retryOrEnd","end","markReady","clearReady","retry","results","_afterEnd","onFailureCallbacks","ALPHABET","KeyGenerator","_lastUniqueKeyTime","_lastRandomValues","generateUniqueKey","chars","prefix","Math","floor","random","MetaTree","_rootUrl","$root","connected","timeOffset","user","updateNowAtIntervals","intervalMillis","angularCompatibility","deep","trackAuth","_handleAuthChange","_connectInfoProperty","$destroy","property","attribute","propertyUrl","snap","QueryHandler","coupler","_coupler","_query","_listeners","_keys","_url","_segments","_listening","attach","keysCallback","_listen","detach","findIndex","_handleSnapshot","_handleError","sync","_decoupleSegments","updatedKeys","_updateKeys","_applySnapshot","_dispatcher","sort","_coupleSegments","hasKey","Node","operations","queryCount","listening","count","listen","skip","op","unlisten","_forAllDescendants","node","isTrunkCoupled","iteratee","collectCoupledDescendantPaths","paths","Coupler","dispatcher","applySnapshot","prunePath","_prunePath","queryHandlers","_root","_queryHandlers","queryHandler","couple","superseded","decouple","ancestors","coupledDescendantPaths","isEmpty","subscribe","unsubscribe","findCoupledDescendantPaths","isSubtreeReady","getNanoSeconds","hrtime","loadTime","performance","exports","process","hr","getTime","RESERVED_VALUE_PROPERTY_NAMES","$parent","$key","$path","computedPropertyStats","Value","defineProperty","$refs","$keys","$values","subjectFn","callbackFn","done","unwatchAndRemoveDestructor","$$finalizers","writable","$set","$update","$commit","ComputedPropertyStats","numUpdates","Modeler","classes","_mounts","uniq","Class","_mountClass","flatten","patterns","mount","regex","badPaths","groupBy","group","compact","_augmentClass","computedProperties","proto","constructor","getOwnPropertyNames","getOwnPropertyDescriptor","fullName","getPrototypeOf","mounts","$trussMount","isString","variables","pathTemplate","match","variable","klass","escapedKey","placeholder","RegExp","parentRegex","createObject","properties","lastIndex","exec","_buildComputedPropertyDescriptor","writeAllowed","firstCallback","$$initializers","vue","isPlaceholder","test","forEachPlaceholderChild","Transaction","currentValue","_getObject","outcome","_outcome","_values","_setOutcome","abort","","Tree","_truss","_firebasePropertyEditAllowed","_writeSerial","_localWrites","_localWriteTimestamp","_integrateSnapshot","_prune","_modeler","_createObject","_completeCreateObject","_plantPlaceholders","valueCallback","_checkHandle","_disconnectReference","_disconnected","_disconnectQuery","numValues","size","_applyLocalWrite","_extractCommonPathPrefix","tries","attemptTransaction","txn","committed","offset","descendantPath","subValue","last","_plantValue","_scaffoldAncestors","prefixSegments","firstMismatchIndex","maxIndex","min","pathPrefix","_destroyObject","remoteWrite","dropRight","ancestorPath","isObject","_setFirebaseProperty","escapedChildKey","lockedDescendantPaths","_avoidLocalWritePaths","_pruneAncestors","_pruneDescendants","localWritePath","targetObject","deleted","ghostObjects","_holdsConcreteData","_deleteFirebaseProperty","coupledDescendantFound","valueLocked","shouldDelete","pathOrSegments","_getFirebasePropertyDescriptor","workerFunctions","_keyGenerator","_metaTree","meta","newKey","authenticate","unauthenticate","actionType","connect","connector","connectWorker","Worker","SharedWorker","exposedFunctionNames","firebaseSdkVersion","FIREBASE_SDK_VERSION","worker","preExpose","functionName","debounceAngularDigest"],"mappings":"6OAiCA,SAASA,MCjCF,QAASC,GAAUC,GACxB,MAAKA,GACEA,EAAIC,WAAWC,QAAQ,oBAAqB,SAASC,GAC1D,MAAO,KAAOA,EAAKC,WAAW,GAAGH,SAAS,MAF3BD,EAMZ,QAASK,GAAYL,GAC1B,MAAKA,GACEA,EAAIC,WAAWC,QAAQ,kBAAmB,SAASI,GACxD,MAAOC,QAAOC,aAAaC,SAASH,EAAKI,MAAM,GAAI,OAFpCV,EAMZ,QAASW,GAAoBC,GAClC,MAAO,YACL,IACE,MAAOC,SAAQC,QAAQF,EAASG,MAAMC,KAAMC,YAC5C,MAAOC,GACP,MAAOL,SAAQM,OAAOD,KCoX5B,QAASpB,MAET,QAASsB,GAAcC,EAAMC,GAC3B,IAAKD,GAAQA,YAAgBE,OAAO,MAAOF,EAC3CG,IAAMC,GAAQ,GAAIF,OAAMF,EAAKK,QAC7BD,GAAMH,OAASA,CACf,KAAKK,GAAIC,KAAgBP,GACvB,GAAqB,YAAjBO,GAA+BP,EAAKQ,eAAeD,GACvD,IACEH,EAAMG,GAAgBP,EAAKO,GAC3B,MAAOV,GAEP,KADAA,GAAEY,OAASF,aAAAA,GACLV,EAGV,MAAOO,GAGT,QAASM,GAAWC,GAClBR,GAAMS,GAAID,EAAIE,QAAQ,IAAK,EAC3B,OAAOD,IAAK,EAAID,EAAItB,MAAM,EAAGuB,GAAKD,iEC7JpC,QAASG,GAAaC,EAAMC,GAI1BrB,KAAKsB,aAELd,IAAMe,GAAYC,IACZC,EAASL,EAAKM,IAAIC,KAAK3B,KAG7B,OAFAqB,GAAMO,SAAWJ,IAAmBD,EACpCF,EAAMQ,eAAiB,EAChBJ,EAIT,QAASK,GAAkBC,EAAGC,GAC5B,GAAID,GAAKA,EAAEE,QAAUD,GAAKA,EAAEC,OAAQ,MAAOF,KAAMC,ECgPnD,QAASE,KAAsB,KAAM,IAAI3B,OAAM,sBAExC,QAAS4B,KAEd,IAAgB,GADVC,MACUC,EAAA,EAAAC,EAAIrC,UAASoC,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAA1B1B,GAAI6B,GAAOF,EAAAD,EACY,OAAtBG,EAAQC,OAAO,IAAYL,EAASM,OAAO,EAAGN,EAASG,QAC3DH,EAASO,KAAKH,GAGhB,MADoB,MAAhBJ,EAAS,KAAYA,EAAS,GAAK,IAChCA,EAASQ,KAAK,KAGhB,QAASC,GAA2CC,EAAUC,EAAQC,GAG3EC,EAAEC,KAAKD,EAAEE,KAAKJ,GAAS,SAAAK,GACrB,GAAuB,MAAnBA,EAAKX,OAAO,IACd,KAAMW,IAASN,GAAyB,MAAbA,GACrBG,EAAEI,WAAWD,EAAMN,EAAW,MAAQM,EAAKb,OAASO,EAASP,OAAS,GAC1E,KAAM,IAAIhC,OAAM,kDAAkD6C,OAE/D,CACL,GAAIA,EAAKlC,QAAQ,MAAQ,EACvB,KAAM,IAAIX,OAAM,mEAAmE6C,EAErF5C,IAAM8C,GAAenB,EAASW,EAAU/D,EAAUqE,GAClD,IAAIL,EAAOlC,eAAeyC,GACxB,KAAM,IAAI/C,OAAM,yBAAyB6C,EAAI,QAAQE,EAEvDP,GAAOO,GAAgBP,EAAOK,SACvBL,GAAOK,KAIlB5C,IAAM+C,GAAWN,EAAEF,GAAQI,OAAOK,IAAI,SAAAJ,GAAK,MAAGjB,GAASiB,EAAM,MAAKK,OAAO,UAAUC,OACnFT,GAAEC,KAAKD,EAAEE,KAAKJ,GAAS,SAAAK,GACrB,IAAkB,GAAAf,GAAA,EAAAC,EAAIiB,EAAQlB,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAA3B1B,GAAIgD,GAASrB,EAAAD,EAChB,IAAIsB,EAAUpB,OAASa,EAAKb,OAAQ,KACpC,IAAIa,IAASO,GAAaV,EAAEI,WAAWD,EAAMO,GAC3C,KAAM,IAAIpD,OAAM,yBAAyBoD,EAAS,QAAQP,GAG1DJ,IACFD,EAAOK,EAAK1D,MAAmB,MAAboD,EAAmB,EAAIA,EAASP,OAAS,IAAMQ,EAAOK,SACjEL,GAAOK,MAKb,QAASQ,GAAeC,GAC7B,GAAsB,gBAAXA,GAAqB,CAC9BrD,GAAMiB,KACN,KAAKd,GAAI3B,KAAO6E,GACTA,EAAOhD,eAAe7B,KAC3ByC,EAAO1C,EAAUC,IAAQ4E,EAAeC,EAAO7E,IAEjD,OAAOyC,GAEP,MAAOoC,0DJrjBX,IAGIC,GACAC,EAAa,WACfD,GAAqB,GAGjBE,GACJC,OAA0B,mBAAXC,SAA0BA,OAAOC,QAChDC,eAAc,SAACC,GACTA,EACFL,EAAaM,OAASrB,EAAEsB,SAASR,EAAYM,GAE7CL,EAAaM,OAASP,KAI3B,SAAU,gBAAgBS,QAAQ,SAAAC,GAAWT,EAAaS,GAAU3F,IAEjEkF,EAAaC,SACfD,EAAaM,OAASP,EACtBG,OAAOC,QAAQO,OAAO,gBAAiBC,KAAK,aAAc,SAASC,GACjEb,EAAaa,EAAWC,WAAWC,KAAKF,GACpCd,GAAoBC,OAE1BC,EAAae,aAAe,SAASC,GACnCd,OAAOC,QAAQO,OAAO,aAAaO,SAAS,QAASD,ICLzD,IClBIE,GDkBSC,EAAmBC,OAAOC,QAAQC,MAAO,cCfhDC,EAAS,SACDC,MAACpC,GAAIoC,EAAApC,KAAEM,EAAK8B,EAAA9B,MAAE+B,EAAUD,EAAAC,WAAEC,EAAMF,EAAAE,MAC5C1F,MAAO2F,MAAQvC,EACfpD,KAAO4F,OAASlC,EAChB1D,KAAO6F,YAAczF,EAAcqF,GACnCzF,KAAO8F,QAAoBC,SAAVrC,EAAsBgC,IAAU,EAAkB,OAAVhC,wCAG3DsC,GAAE5C,KAAQ1B,IAAA,WACR,MAAS1B,MAAK2F,OAGhBK,EAAEN,OAAUhE,IAAA,WACV,MAAS1B,MAAK8F,SAGhBE,EAAEtC,MAAShC,IAAA,WAET,MADA1B,MAAOiG,cACEjG,KAAK4F,QAGhBI,EAAEhH,IAAO0C,IAAA,WAEP,MADoBqE,UAAd/F,KAAKkG,OAAoBlG,KAAKkG,KAAO7G,EAAYW,KAAK2F,MAAMzG,QAAQ,OAAQ,MACzEc,KAAKkG,MAGhBX,EAAAY,UAAEF,YAAW,WACX,GAAMjG,KAAK6F,YAAa,KAAM7F,MAAK6F,WACnC,IAAsBE,SAAhB/F,KAAK4F,OAAsB,KAAM,IAAIrF,OAAM,sEAKnD,IAAqB6F,GAAO,SACdC,aACZrG,MAAOsG,WAAa,EACpBtG,KAAOuG,cACPvG,KAAOwG,YAAa,EACpBxG,KAAOyG,YACPzG,KAAO0G,cACP1G,KAAO2G,yBAA2B,KAClC3G,KAAO4G,uBAAyB,IAChC5G,KAAO6G,qBAAuB,KAC9B7G,KAAO8G,oBACP9G,KAAO+G,qBACP/G,KAAOgH,mBAAqBhH,KAAKgH,mBAAmBlC,KAAK9E,MACzDA,KAAOiH,MAAQZ,EAAUa,MAAQb,EACjCrG,KAAOmH,UAAYd,EAAUa,KAC7BlH,KAAOiH,MAAMG,UAAYpH,KAAKqH,SAASvC,KAAK9E,MAC5CkE,OAASoD,iBAAiB,SAAU,WAAOtH,EAAKuH,OAAOC,IAAK,cAC5DC,YAAc,WAAOzH,EAAKuH,OAAOC,IAAK,UAAY,qBAGpDpB,GAAEsB,KAAW,SAACrB,GACZ,GAAQsB,KACR,KACE,GAAQC,GAAU1D,OAAO2D,cAAgB3D,OAAO4D,cAChD,KAAOF,EAAS,MAChB,KAAOjH,GAAI0B,GAAI,EAAGA,EAAIuF,EAAQrF,OAAQF,IAAK,CACzC,GAAQrD,GAAM4I,EAAQ5I,IAAIqD,EAC1BsF,GAAQhF,MAAM3D,IAAAA,EAAK0E,MAAOkE,EAAQG,QAAQ/I,MAE1C,MAAOkB,IAGX,MAASF,MAAKuH,OAAOC,IAAK,OAAQI,QAASD,KAG7CK,EAAEC,SAAmBvG,IAAA,WACnB,IAAOwD,EAAQ,KAAM,IAAI3E,OAAM,iEAC/B,OAAS2E,IAGXkB,EAAAD,UAAE+B,QAAO,SAACC,GACYpC,SAAdoC,IAAyBA,GAAY,GACrCnI,KAAKwG,aAAe2B,IAC1BnI,KAAOwG,WAAa2B,EACbA,IACLnI,KAAOoI,iBAAiBpI,KAAK8G,kBAC7B9G,KAAO8G,oBACD9G,KAAK+G,kBAAkBxE,QAAQ8F,aAAarI,KAAKgH,uBAI3DZ,EAAAD,UAAEmC,4BAA2B,SAACC,EAAyBC,EAAuBC,GAC5EzI,KAAO2G,yBAA2B4B,EACFxC,SAA1ByC,IAAqCxI,KAAK4G,uBAAyB4B,GACzExI,KAAO6G,qBAAuB4B,GAAc,WAAY,OAAO,IAGjErC,EAAAD,UAAEoB,MAAK,SAAC7G,aACNA,GAAUgI,KAAO1I,KAAKsG,UACtB,IAAMqC,EACN,IAAMjI,EAAQkI,OACZD,EAAY9I,QAAQC,cACb,CACP6I,EAAY,GAAI9I,SAAQ,SAACC,EAASK,GAChC0I,EAAOtC,WAAW7F,EAAQgI,KAAO5I,QAAAA,EAASK,OAAAA,IAE5C,IAAQ2I,GAAW9I,KAAKuG,WAAW7F,EAAQgI,GAC3CI,GAAWH,QAAUA,EACrBA,EAAUI,KAAO,GAAIlJ,SAAQ,SAAAC,GAC3BgJ,EAAWE,YAAclJ,IAE3BgJ,EAAWxI,OAASI,EAItB,MAFOV,MAAK+G,kBAAkBxE,QAAWvC,KAAKwG,YAAY6B,aAAarI,KAAKgH,oBAC5EhH,KAAO+G,kBAAkBpE,KAAKjC,GACrBiI,GAGXvC,EAAAD,UAAEa,mBAAkB,WAClBhH,KAAOiH,MAAMgC,YAAYjJ,KAAK+G,mBAC9B/G,KAAO+G,sBAGTX,EAAAD,UAAEkB,SAAQ,SAAC6B,GACHlJ,KAAKwG,WACTxG,KAAO8G,iBAAmB9G,KAAK8G,iBAAiBqC,OAAOD,EAAME,MAE7DpJ,KAAOoI,iBAAiBc,EAAME,OAIlChD,EAAAD,UAAEiC,iBAAgB,SAACiB,GACjB,IAAkB,WAAAhH,EAAA,EAAAC,EAAI+G,EAAQhH,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAC9B,GADS3B,GAAO4B,EAAAD,GACRiH,EAAKtJ,EAAKU,EAAQ8G,IAC1B,IAAoB,kBAAP8B,GAAmB,KAAM,IAAI/I,OAAM,oBAAsBG,EAAQ8G,IAC9E8B,GAAK3H,KAAK3B,EAAMU,KAIpB0F,EAAAD,UAAEoD,oBAAmB,SAACC,GACpB,MAAS,YACP,MAASxJ,MAAKuH,OAAOC,IAAK,OAAQgC,KAAAA,EAAMC,KAAMC,MAAMvD,UAAUzG,MAAMiC,KAAK1B,cACtE6E,KAAK9E,OAGZoG,EAAAD,UAAErG,QAAO,SAACY,GACR,GAAQoI,GAAW9I,KAAKuG,WAAW7F,EAAQgI,GAC3C,KAAOI,EAAU,KAAM,IAAIvI,OAAM,yDACxBP,MAAKuG,WAAW7F,EAAQgI,IACjCI,EAAWhJ,QAAQY,EAAQe,SAG7B2E,EAAAD,UAAEhG,OAAM,SAACO,GACP,GAAQoI,GAAW9I,KAAKuG,WAAW7F,EAAQgI,GAC3C,KAAOI,EAAU,KAAM,IAAIvI,OAAM,wDACxBP,MAAKuG,WAAW7F,EAAQgI,IACjCI,EAAW3I,OAAOC,EAAcM,EAAQD,MAAOqI,EAASxI,UAG1D8F,EAAAD,UAAEwD,WAAU,SAAClJ,GACX,GAAQnB,GAAOmB,EAAMnB,MAAQmB,EAAMC,OACnC,OAAMD,GAAMH,QAAUhB,GAA+B,sBAAvBA,EAAKsK,cACxB5J,KAAK6J,cAAcpJ,EAAMH,QAAQwJ,KAAK,SAAAC,GACvCA,IAAetJ,EAAMuJ,wBAA0BD,KAG9ClK,QAAQC,WAIrBsG,EAAAD,UAAE0D,cAAa,SAACI,aACd,MAAQjK,KAAK2G,0BAA4B3G,KAAK4G,uBAAyB,GACrE,MAAS/G,SAAQC,SAEnB,IAAMoK,KACN,QAAUD,EAAMzC,KACd,IAAO,MACL0C,EAAiBvH,MAAM8B,OAAQ,MAAOzD,IAAKiJ,EAAMjJ,IAAKyI,MAAOQ,EAAMvG,QACnE,MACF,KAAO,SACLwG,EAAiBvH,MAAM8B,OAAQ,SAAUzD,IAAKiJ,EAAMjJ,IAAKyI,MAAOQ,EAAMvG,QACtE,MACF,KAAO,KACLwG,EAAiBvH,MAAM8B,OAAQ,OAAQzD,IAAKiJ,EAAMjJ,IAAKmJ,KAAMF,EAAME,KAAMV,MAAO,UAChF,MACF,KAAO,cACLS,EAAiBvH,MAAM8B,OAAQ,OAAQzD,IAAKiJ,EAAMjJ,IAAKyI,MAAO,WAC9DS,EAAiBvH,MAAM8B,OAAQ,MAAOzD,IAAKiJ,EAAMjJ,IAAKyI,MAAOQ,EAAMG,YAGvE,IAAOF,EAAe3H,SAAWvC,KAAK6G,qBAAqBoD,EAAMzC,IAAKyC,EAAMjJ,KAC1E,MAASnB,SAAQC,SAEnB,IAAQuK,GAAOrK,KAAKsK,QAAQvJ,EAAWkJ,EAAMjJ,MACrCuJ,EAAoBvK,KAAK2G,yBAAyB0D,GAAQA,EAAKG,KAAKV,KAAK,SAAAW,GAC/E,MAAS5K,SAAQ6K,IAAIR,EAAe1G,IAAI,SAAA9C,GAGtC,MAFAA,GAAU8G,IAAM,WAChB9G,EAAU+J,MAAQA,EACTzK,EAAKuH,MAAM7G,QAEnBoJ,KAAK,SAAAa,GACR,MAAMA,GAAeC,MAAM,SAAAC,GAAM,MAAa,QAAVA,IACzB,0CAEFF,EAAeG,OAAO,SAAAD,GAAM,MAAGA,KAAOjI,KAAK,UACjDmI,MAAM,SAAA7K,GACT,MAAS,6BAA+BA,IAElC8K,EAAiB,GAAInL,SAAQ,SAAAC,GACnCmL,WAAanL,EAAQgF,KAAK,KAAM,4BAA6B9E,EAAK4G,yBAEpE,OAAS/G,SAAQqL,MAAMX,EAAmBS,KAG5C5E,EAAAD,UAAEgF,mBAAkB,SAACxD,GACnB,IACE,GAAQC,GAAU1D,OAAO2D,cAAgB3D,OAAO4D,cAChD,KAAOnH,GAAIyK,KAAQzD,GACI,OAAfyD,EAAK1H,MACTkE,EAAUyD,WAAWD,EAAKpM,KAE1B4I,EAAU0D,QAAQF,EAAKpM,IAAKoM,EAAK1H,OAGnC,MAAOxD,MAKbkG,EAAAD,UAAEoF,YAAW,SAACC,GACZ,IAAMxL,KAAKyG,SAAS5F,eAAe2K,GAAnC,CACA,GAAQC,GAASzL,KAAKyG,SAAS+E,IAAYE,kBACnCC,EAAiB3L,KAAK4L,kBAAkB5L,KAAK6L,cAAc/G,KAAK9E,KAAMyL,GAC9EzL,MAAOuH,OAAOC,IAAK,SAAUxG,IAAKwK,EAASM,WAAYH,MAGzDvF,EAAAD,UAAE0F,cAAa,SAACJ,EAAQpB,GACtBoB,EAASpB,KAAOA,CAChB,KAAmB,GAAAhI,GAAA,EAAAC,EAAImJ,EAAOC,cAAarJ,EAAAC,EAAAC,OAAAF,GAAA,EAApC,CAAA1B,GAAIoL,GAAQzJ,EAAAD,EAA0B0J,GAAS1B,KAGxDjE,EAAAD,UAAE6F,OAAM,SAACR,EAAS5L,EAAUqM,GAC1B,GAAQF,GAAWnM,EAASkF,KAAKmH,EACjCF,GAAWnM,SAAWA,EACtBmM,EAAWE,QAAUA,EACrBjM,KAAOyG,SAAS+E,GAASE,cAAc/I,KAAKoJ,GAC5CA,EAAW/L,KAAKsK,QAAQkB,KAG1BpF,EAAAD,UAAE+F,QAAO,SAACV,EAAS5L,EAAUqM,GAE3B,IAAOtL,GADC+K,GAAgB1L,KAAKyG,SAAS+E,GAASE,cACpCrJ,EAAI,EAAGA,EAAIqJ,EAAcnJ,OAAQF,IAAK,CAC/C,GAAQ0J,GAAWL,EAAcrJ,EACjC,IAAM0J,EAASnM,WAAaA,GAAYmM,EAASE,UAAYA,EAAS,CACpEP,EAAgBhJ,OAAOL,EAAG,EAC1B,UAKN+D,EAAAD,UAAEmE,QAAO,SAACkB,GACR,MAASxL,MAAKyG,SAAS+E,GAASnB,MAGlCjE,EAAAD,UAAEgG,oBAAmB,SAACnL,EAAKoL,EAAWC,GACpC,MAASrM,MAAKuH,OAAOC,IAAK,sBAAuBxG,IAAAA,EAAKoL,UAAAA,EAAWC,QAAAA,KAGnEjG,EAAAD,UAAEmG,OAAM,SAACtL,GACP,MAAShB,MAAKuH,OAAOC,IAAK,SAAUxG,IAAAA,KAGtCoF,EAAAD,UAAEoG,IAAG,SAACvL,EAAK0C,EAAO8I,GAAc,MAAOxM,MAAKuH,OAAOC,IAAK,MAAOxG,IAAAA,EAAK0C,MAAAA,EAAO8I,YAAAA,KAC3EpG,EAAAD,UAAEsG,OAAM,SAACzL,EAAK0C,EAAO8I,GAAc,MAAOxM,MAAKuH,OAAOC,IAAK,SAAUxG,IAAAA,EAAK0C,MAAAA,EAAO8I,YAAAA,KAEjFpG,EAAAD,UAAEuG,GAAE,SAACC,EAAa3L,EAAKmJ,EAAMyC,EAAWC,EAAkBC,EAAgBb,EAASI,GACjF,GAAQU,IACNJ,YAAEA,EAAaC,UAAAA,EAAWC,iBAAAA,EAAkBC,eAAAA,EAAgBb,QAAAA,EAC5D3L,QAAWkH,IAAK,KAAMmF,YAAAA,EAAa3L,IAAAA,EAAKmJ,KAAAA,EAAMyC,UAAAA,EAAWP,QAAAA,IAEnDzM,EAAWI,KAAKgN,YAAYlI,KAAK9E,KAAM+M,EAC/C/M,MAAO4L,kBAAkBhM,EAAUmN,GAEnCF,EAAmBI,cAAgBJ,EAAiBI,kBACpDJ,EAAmBI,cAActK,KAAKoK,EAAOrE,IAC7C1I,KAAOuH,OACLC,IAAO,KAAMmF,YAAAA,EAAa3L,IAAAA,EAAKmJ,KAAAA,EAAMyC,UAAAA,EAAWd,WAAYiB,EAAOrE,GAAI2D,QAAAA,IACpEtB,MAAM,SAAAtK,GACTb,EAAWa,MAIf2F,EAAAD,UAAE+G,IAAG,SAACP,EAAa3L,EAAKmJ,EAAMyC,EAAWC,EAAkBZ,MAEnDH,UADEqB,IAER,IAAMN,EAAkB,CAOtB,GANAf,EAAe9L,KAAKoN,yBAClBP,EACA,SAAEE,GAAO,MACLA,GAAOJ,cAAgBA,GAAeI,EAAOH,YAAcA,GAC7DG,EAASd,UAAYA,KAElBH,EAAY,MAAOjM,SAAQC,SAClCqN,GAAkBxK,KAAKmJ,OAEvB,KAAa,GAAAzJ,GAAA,EAAAC,EAAI8C,OAAOjC,KAAKnD,KAAK0G,YAAWrE,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAC7C,GADSqG,GAAEpG,EAAAD,GACH0K,EAAS/M,EAAK0G,WAAWgC,EAC3BqE,GAAOJ,cAAgBA,GAAiBC,GAAaG,EAAOH,YAAcA,GAC9EO,EAAkBxK,KAAK+F,GAO7B,IAAa,GAAA2E,GAAA,EAAAC,EAAIH,EAAeE,EAAAC,EAAA/K,OAAA8K,GAAA,EAAzB,CAAA1M,GAAI+H,GAAE4E,EAAAD,EAAqBrN,GAAKuN,iBAAiB7E,GACxD,MAAS1I,MAAKuH,OAAOC,IAAK,MAAOmF,YAAAA,EAAa3L,IAAAA,EAAKmJ,KAAAA,EAAMyC,UAAAA,EAAWd,WAAAA,IAAahC,KAAK,WACpF,IAAa,GAAAzH,GAAA,EAAAC,EAAI6K,EAAe9K,EAAAC,EAAAC,OAAAF,GAAA,EAAzB,CAAA1B,GAAI+H,GAAEpG,EAAAD,EAAqBrC,GAAKwN,oBAAoB9E,OAI/DtC,EAAAD,UAAE6G,YAAW,SAACD,EAAQtM,EAAOgN,GAC3B,GAAMhN,EAAO,CACXT,KAAOwN,oBAAoBT,EAAOrE,GAClC,IAAQxI,GAAIE,EAAcK,EAAOsM,EAAOzM,OAClCyM,GAAOD,eACXC,EAASD,eAAenL,KAAKoL,EAAOd,QAAS/L,GAE7CwN,QAAUjN,MAAMP,OAGlB6M,GAASF,iBAAiBlL,KAAKoL,EAAOd,QAAS,GAAI1G,GAASkI,KAIhErH,EAAAD,UAAEwH,YAAW,SAAC3M,EAAK4M,EAAUC,GAC3B,MAAS7N,MAAKuH,OAAOC,IAAK,cAAexG,IAAAA,EAAK4M,SAAAA,EAAUC,gBAAAA,KAG1DzH,EAAAD,UAAE2H,aAAY,SAAC9M,EAAKyD,EAAQf,GAC1B,MAAS1D,MAAKuH,OAAOC,IAAK,eAAgBxG,IAAAA,EAAKyD,OAAAA,EAAQf,MAAAA,KAGzD0C,EAAAD,UAAE4H,iBAAgB,WAChB,MAAS/N,MAAKuH,OAAOC,IAAK,sBAG5BpB,EAAAD,UAAEvG,SAAQ,SAAC4F,MAACkD,GAAElD,EAAAkD,GAAEe,EAAIjE,EAAAiE,KACVsD,EAAS/M,KAAK0G,WAAWgC,EACjC,KAAOqE,EAAQ,KAAM,IAAIxM,OAAM,0BAA4BmI,EAC3DqE,GAASnN,SAASG,MAAM,KAAM0J,IAGhCrD,EAAAD,UAAEyF,kBAAiB,SAAChM,EAAUmN,GAK5B,MAJAA,GAAWA,MACXA,EAASnN,SAAWA,EACpBmN,EAASrE,GAAK,QAAO1I,KAAKsG,WAC1BtG,KAAO0G,WAAWqG,EAAOrE,IAAMqE,EACtBA,EAAOrE,IAGlBtC,EAAAD,UAAEoH,iBAAgB,SAAC7E,GACjB1I,KAAO0G,WAAWgC,GAAI9I,SAAWd,GAGnCsH,EAAAD,UAAEqH,oBAAmB,SAAC9E,SACX1I,MAAK0G,WAAWgC,IAG3BtC,EAAAD,UAAEiH,yBAAwB,SAACxN,EAAUoO,aACnC,IAAOpO,EAASqN,cAEhB,IADA,GAAM5K,GAAI,EACDA,EAAIzC,EAASqN,cAAc1K,QAAQ,CAC1C,GAAQmG,GAAK9I,EAASqN,cAAc5K,GAC5B0K,EAAS/M,EAAK0G,WAAWgC,EACjC,IAAOqE,EAAP,CAIA,GAAMiB,EAAUjB,GAEd,MADAnN,GAAWqN,cAAcvK,OAAOL,EAAG,GAC1BqG,CAEXrG,IAAO,MAPLzC,GAAWqN,cAAcvK,OAAOL,EAAG,iCGrXzC7B,IAAMyN,KACN7I,QAAOC,OAAO4I,EAGd,IAAaC,GAAO,SACNC,EAAM/K,EAAMgL,GACxBpO,KAAOqO,MAAQF,EACfnO,KAAO2F,MAAQvC,EAAKlE,QAAQ,OAAQ,KAAKA,QAAQ,MAAO,IAClDkP,IACJpO,KAAOsO,aAAeF,EACtBhJ,OAASC,OAAO+I,uEAIpBpI,GAAEuI,KAAQ7M,IAAA,WAAI,MAAO1B,OACrBgG,EAAEhH,IAAO0C,IAAA,WAEP,MADO1B,MAAKkG,OAAMlG,KAAKkG,KAAO7G,EAAYW,KAAK2F,MAAMzG,QAAQ,OAAQ,MAC5Dc,KAAKkG,MAEhBF,EAAE5C,KAAQ1B,IAAA,WAAI,MAAO1B,MAAK2F,OAC1BK,EAAEwI,YAAe9M,IAAA,WAAI,MAAsB,MAAf1B,KAAK2F,MAAgB,GAAK3F,KAAK2F,OAC3DK,EAAEyI,OAAU/M,IAAA,WACV,MAAS,IAAIgN,GAAU1O,KAAKqO,MAAOrO,KAAK2F,MAAMzG,QAAQ,YAAY,IAAKc,KAAKsO,eAG9EtI,EAAEoI,YAAe1M,IAAA,WACf,MAAS1B,MAAKsO,cAAgBL,GAGhCC,EAAA/H,UAAEwI,MAAK,WACL,MAAO1O,WAAUsC,OACR,GAAImM,GACX1O,KAAOqO,MAAUrO,KAAgB,YAAA,IAAIiD,EAAEO,IAAIvD,UAAW,SAAAjB,GAAI,MAAGD,GAAUC,KAAM4D,KAAK,KAClF5C,KAAOsO,cAHuBtO,MAOlCkO,EAAA/H,UAAEyI,SAAQ,iCACR,KAAO3O,UAAUsC,OAAQ,MAAOvC,KAEhC,KAAOW,GADCkO,MACGxM,EAAI,EAAGA,EAAIpC,UAAUsC,OAAQF,IAAK,CAC3C,GAAQyM,GAAM7O,EAAUoC,EACxB,IAAMY,EAAE8L,QAAQD,GAAM,CAIpB,IAAc,GAHNE,MACAC,EAAajP,EAAgB,YAAA,IAAI6O,EAAYjM,KAAK,KAClDsM,EAAOjM,EAAEvD,MAAMO,EAAWoC,EAAI,GACxBgL,EAAA,EAAA/K,EAAIwM,EAAGzB,EAAA/K,EAAAC,OAAA8K,GAAA,EAAE,CACrB,GADSrO,GAAGsD,EAAA+K,GACJ8B,EACN,GAAMT,GAAU1O,EAAKqO,MAAOY,EAAU,IAAIlQ,EAAUC,GAAQgB,EAAKsO,aACnEU,GAAUhQ,GAAOmQ,EAAOP,SAAS7O,MAAMoP,EAAQD,GAEjD,MAASF,GAETH,EAAclM,KAAK5D,EAAU+P,IAGjC,MAAS,IAAIJ,GACX1O,KAAOqO,MAAUrO,KAAgB,YAAA,IAAI6O,EAAYjM,KAAK,KAAQ5C,KAAKsO,eAGvEJ,EAAA/H,UAAEiJ,KAAI,SAACxP,GACL,MAASI,MAAKqO,MAAMgB,MAAMD,KAAKpP,KAAMJ,IAGvCsO,EAAA/H,UAAEmJ,QAAO,SAACC,GACR,MAAQA,aAAgBrB,KACflO,KAAKqO,QAAUkB,EAAKlB,OAASrO,KAAKf,aAAesQ,EAAKtQ,aAGjEiP,EAAA/H,UAAEqJ,UAAS,SAACH,GACV,MAASrP,MAAKqO,MAAMgB,QAAUA,yCAKhC,IAAaI,GAAK,SAAAvB,GAAgB,QAAAuB,GACpBtB,EAAM/K,EAAM+G,EAAMiE,GAC5BsB,EAAK/N,KAAC3B,KAAAmO,EAAM/K,EAAMgL,GAClBpO,KAAK2P,MAAQ3P,KAAK4P,qBAAqBzF,gIAIzC0F,GAAAC,MAASpO,IAAA,WACP,MAAO1B,MAAKqO,MAAM0B,aAAa/P,OAGjC6P,EAAAG,YAAetO,IAAA,WACb,MAAO1B,MAAK2P,OAGdF,EAAAtJ,UAAA8J,SAAQ,SAAC7B,GACP,MAAO,IAAIqB,GACTzP,KAAKqO,MAAOrO,KAAK2F,MAAO3F,KAAK2P,MAAO1M,EAAEiN,UAAWlQ,KAAKsO,aAAcF,KAGxEqB,EAAAtJ,UAAAyJ,qBAAoB,SAACzF,GACnB,IAAKA,EAAKgG,GAAI,KAAM,IAAI5P,OAAM,4BAA8B6P,KAAKC,UAAUlG,GAC3E,KAAK,MAAQA,KAAS,QAAUA,KAAS,MAAQA,IAAQ,EACvD,KAAM,IAAI5J,OACR,oEAAsE6P,KAAKC,UAAUlG,GAEzF,KAAK,SAAWA,KAAS,QAAUA,IAAQ,EACzC,KAAM,IAAI5J,OACR,gEAAkE6P,KAAKC,UAAUlG,GAErF,KAAKlH,EAAEqN,MAAM,KAAM,OAAQ,KAAM,QAAS,QAAS,SAAAC,GAAO,MAAGA,KAAUpG,KACrE,KAAM,IAAI5J,OACR,sFACA6P,KAAKC,UAAUlG,GAGnB,IADAA,EAAOlH,EAAEuN,MAAMrG,GACC,SAAZA,EAAKgG,IAA6B,WAAZhG,EAAKgG,GAAiB,CAC9C,KAAMhG,EAAKgG,aAAczB,IACvB,KAAM,IAAInO,OAAM,yCAA2C4J,EAAKgG,GAElExP,IAAI8P,GAAYtG,EAAKgG,GAAGlR,UACxB,KAAKgE,EAAEI,WAAWoN,EAAWzQ,KAAK2F,OAChC,KAAM,IAAIpF,OACR,8DAAgE4J,EAAKgG,GAGzE,IADAM,EAAYA,EAAU/Q,MAAMM,KAAK2F,MAAMpD,QAAQrD,QAAQ,OAAQ,IAC3DuR,EAAUvP,QAAQ,QAAS,EAC7B,KAAM,IAAIX,OACR,oEAAsE4J,EAAKgG,GAE/EhG,GAAKgG,GAAKM,EAAUvR,QAAQ,QAAS,IAGvC,MADAkG,QAAOC,OAAO8E,GACPA,GAITsF,EAAAtJ,UAAAlH,SAAQ,WACN,IAAKe,KAAK0Q,QAAS,CACjBlQ,GAAMmQ,GAAa1N,EAAEjD,KAAK2P,OACvBnM,IAAI,SAACE,EAAO1E,GAAK,MAAGA,GAAM,IAAI4R,mBAAmBR,KAAKC,UAAU3M,MAChED,SACAb,KAAK,IACR5C,MAAK0Q,QAAa1Q,KAAU,MAAA,IAAI2Q,EAElC,MAAO3Q,MAAK0Q,mDAjEWxC,GAuEdQ,EAAS,SAAAR,GAAgB,QAAAQ,GAGxBP,EAAM/K,EAAMgL,GACtBsB,EAAK/N,KAAC3B,KAAAmO,EAAM/K,EAAMgL,iHAIpByC,GAAAf,MAASpO,IAAA,WACP,MAAO1B,MAAKqO,MAAMyC,iBAAiB9Q,OAGrC0O,EAAAvI,UAAAlH,SAAQ,WACN,MAAOe,MAAK2F,OAGd+I,EAAAvI,UAAA8J,SAAQ,SAAC7B,GACP,MAAO,IAAIM,GAAU1O,KAAKqO,MAAOrO,KAAK2F,MAAO1C,EAAEiN,UAAWlQ,KAAKsO,aAAcF,KAG/EM,EAAAvI,UAAA4K,MAAK,SAAC5G,GACJ,MAAO,IAAIsF,GAAMzP,KAAKqO,MAAOrO,KAAK2F,MAAOwE,IAG3CuE,EAAAvI,UAAAoG,IAAG,SAAC7I,GACF,MAAO1D,MAAKqO,MAAM5B,OAAOzM,KAAM,OAAKgR,KAAGA,EAAChR,KAAKoD,MAAKM,EAAOsN,WAG3DtC,EAAAvI,UAAAsG,OAAM,SAAC1J,GACL,MAAO/C,MAAKqO,MAAM5B,OAAOzM,KAAM,SAAU+C,IAG3C2L,EAAAvI,UAAA8K,OAAM,SAACC,GACL,MAAOlR,MAAKqO,MAAM4C,OAAOjR,KAAMkR,8CAjCJhD,GChJViD,EAAU,SACjBC,EAAOC,EAAalD,EAAM1J,aACtC4M,GAAchM,SACdrF,KAAOsR,OAASF,EAChBpR,KAAOuR,aAAeF,EACtBrR,KAAOqO,MAAQF,EACfnO,KAAOwR,QAAU/M,EACjBzE,KAAOyR,kBACPzR,KAAO0R,uBACP1R,KAAO2R,gBACP3R,KAAO4R,KAAO,GAAIC,IAAKzI,KAAMnG,EAAE6O,UAAUT,EAAapO,EAAEgC,SAASc,WAEjE/F,KAAO+R,uBAEP9O,EAAIC,KAAKmO,EAAa,SAACW,EAAYhT,GAC3BiE,EAAEgP,WAAWD,GACjBnJ,EAAOqJ,wBAAwBlT,EAAKgT,GAEpCnJ,EAAOsJ,SAASnT,EAAKgT,KAInB7N,EAAQF,QAAUmN,EAAMgB,KAAOhB,EAAMiB,MAAMjB,EAAMgB,IAAI,WAAY,WAAOpS,EAAKsS,yBAGrFtM,GAAE8J,MAASpO,IAAA,qBACT,OAASuB,GAAE2H,MAAM5K,KAAK0R,oBAAqB,SAACM,EAAYhT,GACtD,QAAOgT,IACDA,YAAsB9D,GAAe8D,EAAWlC,MAC7C9P,EAAKyR,eAAezS,GAAK8Q,UAItCqB,EAAAhL,UAAEmM,QAAO,qBACPtS,MAAOuS,yBACPtP,EAAIC,KAAKlD,KAAKwS,kBAAmB,SAAAC,GAAYA,MAC7CxP,EAAIC,KAAKlD,KAAKuR,aAAc,SAACS,EAAYhT,GAASgB,EAAK0S,YAAY1T,MAGrEmS,EAAAhL,UAAE4L,qBAAoB,qBACpB,IAAO/R,KAAKsR,OAAZ,CACA,GAAQqB,GAAe1P,EAAE2P,KAAK5S,KAAKuR,aAAc,SAACS,EAAYhT,GAAK,MAAGA,KAAOgB,GAAKsR,QAClF,IAAMqB,EACJ,KAAQ,IAAIpS,OAAM,kDAAkDoS,EAEtEvN,QAASyN,iBAAiB7S,KAAKsR,OAAQrO,EAAE6O,UAAU9R,KAAKuR,aAAc,SAACS,EAAYhT,GAAK,OACtF8T,cAAgB,EAAMC,YAAY,EAAMrR,IAAK,WAAG,MAAG1B,GAAK4R,KAAKoB,MAAMhU,UAIvEmS,EAAAhL,UAAEoM,uBAAsB,qBACfvS,MAAKsR,QACZrO,EAAIC,KAAKlD,KAAKuR,aAAc,SAACS,EAAYhT,SAC9BgB,GAAKsR,OAAOtS,MAIzBmS,EAAAhL,UAAE+L,wBAAuB,SAAClT,EAAKsK,GAC7BA,EAAOA,EAAGxE,KAAK9E,KAAKsR,OACpB,IAAQ7E,GAASzM,KAAKiT,0BAA0BnO,KAAK9E,KAAMhB,EAC3DgB,MAAO4R,KAAKsB,OAAO5J,EAAImD,GAAS0G,WAAYhP,EAAQF,SAC9CE,EAAQF,SACLjE,KAAKwS,oBAAmBxS,KAAKwS,sBACpCxS,KAAOwS,kBAAkB7P,KAAKwB,EAAQiP,MAAM9J,EAAImD,MAIpD0E,EAAAhL,UAAE8M,0BAAyB,SAACjU,EAAKqU,GAC/B,GAAQC,GAAgBtT,KAAK0R,oBAAoB1S,EACjD,MAAMsU,IAAkBD,GACpBA,YAA2BnF,IAAUmF,EAAc/D,QAAQgE,IAD/D,CAEA,IAAOD,EAEL,WADArT,MAAO0S,YAAY1T,EAGfqU,aAAyBnF,KAAWjL,EAAEsQ,IAAIvT,KAAKyR,eAAgBzS,IACnEgB,KAAO0S,YAAY1T,GACnBgB,KAAOmS,SAASnT,EAAKqU,IAErBrT,KAAOyR,eAAezS,GAAKwU,mBAAmBH,GAEhDrT,KAAO0R,oBAAoB1S,GAAOqU,IAGpClC,EAAAhL,UAAEqN,mBAAkB,SAACnC,aACnBpO,GAAIC,KAAKmO,EAAa,SAACW,EAAYhT,GACjC6J,EAAOoK,0BAA0BjU,EAAKgT,KAExC/O,EAAIC,KAAKlD,KAAKuR,aAAc,SAACS,EAAYhT,GAChCiE,EAAEsQ,IAAIlC,EAAarS,IAAMgB,EAAKiT,0BAA0BjU,KAEjEgB,KAAOuR,aAAeF,GAGxBF,EAAAhL,UAAEgM,SAAQ,SAACnT,EAAKgT,aAEd,IADAhS,KAAO0R,oBAAoB1S,GAAOgT,EAC3BA,EACP,GAAMA,YAAsBtD,GAAW,CACrC,GAAQ+E,GAAWzT,KAAKsR,OAAStR,KAAK0T,gBAAgB5O,KAAK9E,KAAMhB,GAAO,IACxEgB,MAAO2R,aAAa3S,GAAOgB,KAAKqO,MAAMsF,iBAAiB3B,EAAYyB,EAAUzT,KAAKwR,aAC3E,IAAIQ,YAAsBvC,GAAO,CACxC,GAAQgE,GAAWzT,KAAKsR,OAAStR,KAAK4T,kBAAkB9O,KAAK9E,KAAMhB,GAAO,IAC1EgB,MAAO2R,aAAa3S,GAAOgB,KAAKqO,MAAMwF,aAAa7B,EAAYyB,EAAUzT,KAAKwR,aACvE,CACP,GAAQsC,MACAC,EAAe/T,KAAKyR,eAAezS,GACzC,GAAMmS,GAAU2C,EAAU9B,EAAYhS,KAAKqO,MAAOrO,KAAKwR,QACzD,IAAMxR,KAAKsR,OACT,GAAQmB,GAAUzS,KAAK4R,KAAKsB,OAAO,WAAG,MAAGa,GAAajE,OAAO,SAAAkE,GACpDA,IACPvB,IACAZ,EAAMtF,IAAIvM,EAAKsR,OAAQtS,EAAK8U,GAC5B3P,EAAUG,YACN6O,WAAW,MAKvBhC,EAAAhL,UAAEuM,YAAW,SAAC1T,GACNgB,KAAKsR,SACTO,EAAMoC,OAAOjU,KAAKsR,OAAQtS,GAC1BmF,EAAUG,UAENrB,EAAEsQ,IAAIvT,KAAKyR,eAAgBzS,KAC/BgB,KAAOyR,eAAezS,GAAKsT,gBAClBtS,MAAKyR,eAAezS,IAEzBgB,KAAK2R,aAAa3S,IAAMgB,KAAK2R,aAAa3S,WACvCgB,MAAK2R,aAAa3S,SAClBgB,MAAK0R,oBAAoB1S,IAGpCmS,EAAAhL,UAAEuN,gBAAe,SAAC1U,EAAK0E,GACf1D,KAAKsR,OAAOtS,KAAS0E,IACzBmO,EAAMtF,IAAIvM,KAAKsR,OAAQtS,EAAK0E,GAC5BS,EAAUG,WAId6M,EAAAhL,UAAEyN,kBAAiB,SAAC5U,EAAKkV,cACjBC,GAAU,CACTnU,MAAKsR,OAAOtS,KACjB6S,EAAMtF,IAAIvM,KAAKsR,OAAQtS,MACvBmV,GAAY,EAEd,IAAQL,GAAW9T,KAAKsR,OAAOtS,EAC/B,KAAO2B,GAAIyT,KAAYN,GACdA,EAASjT,eAAeuT,KACxBnR,EAAEoR,SAASH,EAAWE,KAC3BvC,EAAMoC,OAAOH,EAAUM,GACvBD,GAAY,GAIhB,KAAkB,GADZtQ,GACYxB,EAAA,EAAAC,EAAItC,KAAK0R,oBAAoB1S,GAAKoE,KAAKkR,MAAM,KAAIjS,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CACnE,GADSG,GAAOF,EAAAD,EACdwB,GAASrB,EAAUqB,EAAOrB,GAAWxC,EAAKqO,MAAMkG,KAEpD,IAAmB,GAAAlH,GAAA,EAAAC,EAAI4G,EAAS7G,EAAAC,EAAA/K,OAAA8K,GAAA,EAAE,CAChC,GADS+G,GAAQ9G,EAAAD,EACXyG,GAASjT,eAAeuT,KAC9BvC,EAAMtF,IAAIuH,EAAUM,EAAUvQ,EAAOuQ,IACrCD,GAAY,GAERA,GAAShQ,EAAQG,gDCrKzB9D,IAAMgU,IACJ,OAAQ,QAAS,OAAQ,MAAO,SAAU,SAAU,UAAW,OAAQ,OAInEC,EAAW,SACHC,EAAWC,EAAO/U,GAC9BI,KAAO4U,WAAaF,EACpB1U,KAAO6U,OAASF,EAChB3U,KAAO8U,UAAYlV,EACnBI,KAAO+U,QAAS,EAGlBN,GAAAtO,UAAE6O,SAAQ,qBACRhV,MAAOiV,SACPjV,KAAO+U,QAAS,CAChB,IAAQG,GAAUC,KAAKC,MAAQpV,KAAK4U,WAAWS,eAC/CrV,MAAOsV,WAAarK,WAAWjL,KAAK6U,OAASK,EAAS,WACpDrM,EAAOkM,QAAS,EAChBlM,EAAOiM,UAAU9U,EAAK4U,eAI1BH,EAAAtO,UAAE8O,OAAM,WACAjV,KAAK+U,QAAQ/U,KAAK8U,UAAU9U,KAAK4U,YACjC5U,KAAKsV,YAAYC,aAAavV,KAAKsV,YAK3C,IAAME,GAAU,SACFC,EAAMhR,EAAQiR,GAC1B1V,KAAO2V,MAAQF,EACfzV,KAAOwR,QAAU/M,EACjBzE,KAAO4V,QAAUF,EACjB1V,KAAO6V,QAAS,EAChB7V,KAAO8V,UAAW,EAClB9V,KAAOqV,gBAAkBF,KAAKC,MAC9BpV,KAAO+V,6EAGT/P,GAAEyP,KAAQ/T,IAAA,WAAI,MAAO1B,MAAK2V,OAC1B3P,EAAEvB,OAAU/C,IAAA,WAAI,MAAO1B,MAAKwR,SAC5BxL,EAAE0P,OAAUhU,IAAA,WAAI,MAAO1B,MAAK4V,SAC5B5P,EAAE8J,MAASpO,IAAA,WAAI,MAAO1B,MAAK6V,QAC3B7P,EAAEgQ,QAAWtU,IAAA,WAAI,MAAO1B,MAAK8V,UAC7B9P,EAAEvF,MAASiB,IAAA,WAAI,MAAO1B,MAAKiW,QAE3BT,EAAArP,UAAE+P,OAAM,SAACvB,EAAO/U,GACd,GAAQmN,GAAS,GAAI0H,GAAWzU,KAAM2U,EAAO/U,EAC7CI,MAAO+V,aAAapT,KAAKoK,GACzBA,EAASiI,YAGXQ,EAAArP,UAAEgQ,YAAW,SAACzS,GACZ1D,KAAO8V,SAAWpS,GAGpB8R,EAAArP,UAAEiQ,WAAU,WACVpW,KAAO6V,QAAS,EAChB5S,EAAIC,KAAKlD,KAAK+V,aAAc,SAAAhJ,GAAO,MAAGA,GAAOkI,YAG/CO,EAAArP,UAAEkQ,YAAW,WACXrW,KAAO6V,QAAS,EAChB7V,KAAOqV,gBAAkBF,KAAKC,MAC9BnS,EAAIC,KAAKlD,KAAK+V,aAAc,SAAAhJ,GAAO,MAAGA,GAAOiI,oDAK/C,IAAqBsB,GAAW,SAClBpR,GACZlF,KAAOuW,QAAUrR,EACjBlF,KAAO0G,cAGT4P,GAAAnQ,UAAEqQ,UAAS,SAACC,EAAcC,GACxB,IAAOzT,EAAEoR,SAASG,EAAgBiC,GAChC,KAAQ,IAAIlW,OAAM,qCAAuCkW,EAE3D,IAAQE,GACN1T,EAAI2T,WAAW3T,EAAEE,KAAKuT,IAAa,WAAY,UAAW,UAAW,aACvE,IAAMC,EAAgBpU,OACpB,KAAQ,IAAIhC,OAAM,qCAAuCoW,EAAgB/T,KAAK,MAEhF,IAAQiU,IACNC,SAAY9W,KAAK+W,aAAa,WAAYN,EAAcC,EAAUI,UAClEE,QAAWhX,KAAK+W,aAAa,UAAWN,EAAcC,EAAUM,SAChEC,QAAWjX,KAAK+W,aAAa,UAAWN,EAAcC,EAAUO,SAChEC,UAAalX,KAAK+W,aAAa,YAAaN,EAAcC,EAAUQ,WAEtE,OAASlX,MAAKmX,iBAAiBrS,KAAK9E,KAAMyW,EAAcI,IAG1DP,EAAAnQ,UAAE4Q,aAAY,SAACK,EAAOX,EAAc7W,GAClC,GAAOA,EAAP,CACA,GAAQZ,GAAMgB,KAAKqX,iBAAiBZ,EAAcW,GAC1CE,EAAkB3X,EAAoBC,EAE9C,QADGI,KAAK0G,WAAW1H,KAASgB,KAAK0G,WAAW1H,QAAY2D,KAAK2U,GACpDA,IAGXhB,EAAAnQ,UAAEoR,gBAAe,SAACH,EAAOX,EAAca,GACrC,GAAOA,EAAP,CACA,GAAQtY,GAAMgB,KAAKqX,iBAAiBZ,EAAcW,EAC5CpX,MAAK0G,WAAW1H,IAAMiE,EAAEuU,KAAKxX,KAAK0G,WAAW1H,GAAMsY,KAG3DhB,EAAAnQ,UAAEgR,iBAAgB,SAACV,EAAcI,aAC/B5T,GAAIC,KAAK2T,EAAkB,SAACS,EAAiBF,GAC3CvO,EAAO0O,gBAAgBH,EAAOX,EAAca,MAIhDhB,EAAAnQ,UAAEsR,cAAa,SAACL,EAAOM,EAAejT,GACpC,SAAY0E,OACVnJ,KAAO0G,WAAW1G,KAAKqX,iBAAiBD,EAAO3S,IAC/CzE,KAAO0G,WAAW1G,KAAKqX,iBAAiBD,EAAOM,IAC/C1X,KAAO0G,WAAW1G,KAAKqX,iBAAiBD,EAAO,UAInDd,EAAAnQ,UAAEkR,iBAAgB,SAACD,EAAOX,GACxB,MAASW,GAAQ,IAAIX,GAGvBH,EAAAnQ,UAAEwR,QAAO,SAACD,EAAejT,EAAQiR,EAAQkC,aACvCA,GAAajY,EAAoBiY,EACjC,IAAQlD,GAAY1U,KAAK6X,gBAAgBH,EAAejT,EAAQiR,EAChE,OAAS1V,MAAK8X,MAAMpD,GAAW5K,KAAK,WAClC,GAAQiO,GAAqB,WAC3B,MAASH,KAAW7M,MAAM,SAAA7K,GAAE,MAAGF,GAAKgY,YAAYtD,EAAWxU,GAAG4J,KAAKiO,KAErE,OAASA,OACNjO,KAAK,SAAArI,GAAO,MAAGzB,GAAKiY,IAAIvD,GAAW5K,KAAK,WAAG,MAAGrI,QAGrD6U,EAAAnQ,UAAE0R,gBAAe,SAACH,EAAejT,EAAQiR,GACvC,MAAS,IAAIF,GAAUkC,EAAejT,EAAQiR,IAGhDY,EAAAnQ,UAAE2R,MAAK,SAACpD,aACN,OAAS7U,SAAQ6K,IACfzH,EAAIO,IAAIxD,KAAKyX,cAAc,WAAY/C,EAAUe,MAAO,SAAAqB,GAAS,MAAGA,GAASpC,MAC3E5K,KAAK,WAAO4K,EAAUyB,aAAY,IAAS,SAAAjW,GAAE,MAAGF,GAAKiY,IAAIvD,EAAWxU,MAG1EoW,EAAAnQ,UAAE+R,UAAS,SAACxD,GACVA,EAAY0B,cAGdE,EAAAnQ,UAAEgS,WAAU,SAACzD,GACXA,EAAY2B,eAGdC,EAAAnQ,UAAEiS,MAAK,SAAC1D,EAAWjU,GACjB,MAASZ,SAAQ6K,IACfzH,EAAIO,IAAIxD,KAAKyX,cAAc,UAAW/C,EAAUe,MAAO,SAAAwB,GACrD,IACE,MAASpX,SAAQC,QAAQmX,EAAQvC,EAAWjU,IAC1C,MAAOP,GACT,MAASL,SAAQM,OAAOD,OAG1B4J,KAAK,SAAAuO,GAAQ,MAAGpV,GAAEqN,KAAK+H,MAG7B/B,EAAAnQ,UAAE6R,YAAW,SAACtD,EAAWjU,aACvB,OAAST,MAAKoY,MAAM1D,EAAWjU,GAAOqJ,KAAK,SAAArI,GACzC,IAAOA,EAAQ,MAAOzB,GAAKiY,IAAIvD,EAAWjU,IACvC,SAAAP,GAAE,MAAGF,GAAKiY,IAAIvD,EAAWxU,MAGhCoW,EAAAnQ,UAAE8R,IAAG,SAACvD,EAAWjU,aAGf,OAFAiU,GAAYyB,aAAY,GAClB1V,IAAOiU,EAAUuB,OAASxV,GACvBZ,QAAQ6K,IACfzH,EAAIO,IAAIxD,KAAKyX,cAAc,UAAW/C,EAAUe,MAAO,SAAAuB,GAAQ,MAAGA,GAAQtC,MACxE5K,KACF,WAAK,MAAG9J,GAAKsY,UAAU5D,IACvB,SAAExU,GAEA,MADAwU,GAAYuB,OAAS/V,EACZF,EAAKsY,UAAU5D,MAK9B4B,EAAAnQ,UAAEmS,UAAS,SAAC5D,GAEV,GADA1U,KAAOkY,UAAUxD,GACXA,EAAUjU,MAAO,CACrB,GAAQ8X,GAAqBvY,KAAKyX,cAAc,YAAa/C,EAAUe,KACvE,OAASzV,MAAKuW,QAAQ5M,WAAW+K,EAAUjU,OAAOqJ,KAAK,WAMrD,MALMyO,IACJtN,WAAa,EAAG,WACdhI,EAAIC,KAAKqV,EAAoB,SAAArB,GAAU,MAAGA,GAAUxC,OAG/C7U,QAAQM,OAAOuU,EAAUjU,UCxMxCD,IAAMgY,GAAW,mEAEIC,EAAa,WAEhCzY,KAAO0Y,mBAAqB,EAC5B1Y,KAAO2Y,qBAGTF,GAAAtS,UAAEyS,kBAAiB,SAACxD,aAClBA,GAAQA,GAAOD,KAAKC,KAGpB,KAAOzU,GAFCkY,GAAQ,GAAInP,OAAM,IACpBoP,EAAS1D,EACJ/S,EAAI,EAAGA,GAAK,EAAGA,IACxBwW,EAAQxW,GAAKmW,EAAS/V,OAAgB,GAATqW,GAC7BA,EAAWC,KAAKC,MAAMF,EAAS,GAEjC,IAAM1D,IAAQpV,KAAK0Y,mBAAoB,CAErC,IADA,GAAMrW,GAAI,GACDA,GAAK,GAAmC,KAA9BrC,KAAK2Y,kBAAkBtW,IACxCwG,EAAO8P,kBAAkBtW,GAAK,EAC9BgL,GAAO,CAET,IAAMhL,KAAM,EACV,KAAQ,IAAI9B,OAAM,yEAEpBP,MAAO2Y,kBAAkBtW,IAAM,MACxB,CACPrC,KAAO0Y,mBAAqBtD,CAC5B,KAAOzU,GAAI0B,GAAI,EAAGA,EAAI,GAAIA,IAExBwG,EAAO8P,kBAAkBtW,GAAK0W,KAAKC,MAAMD,KAAKE,UAAY5W,EAAI,GAAK,KAGvE,IAAO1B,GAAI0B,GAAI,EAAGA,EAAI,GAAIA,IACxBwW,EAAQxW,EAAI,GAAKmW,EAASxY,EAAK2Y,kBAAkBtW,GAEnD,OAASwW,GAAMjW,KAAK,ICnCtB,IAAqBsW,GAAS,SAChB1N,EAAStG,GACrBlF,KAAOmZ,SAAW3N,EAClBxL,KAAOuW,QAAUrR,EACjBlF,KAAO4R,KAAO,GAAIC,IAAKzI,MAAOgQ,OAC5BC,UAAatT,OAAWuT,WAAY,EAAGC,KAAMxT,OAAWyE,IAAKzE,OAC7DyT,qBAAsB,SAAChQ,EAAMiQ,aAC3B,IAAMzZ,KAAKa,eAAe2I,GAAO,KAAM,IAAIjJ,OAAM,aAAaiJ,EAAI,oBAClEqI,GAAMtF,IAAIvM,KAAMwJ,EAAM2L,KAAKC,MAAQpV,KAAKsZ,YACxC7R,YAAc,WACZoB,EAAOW,GAAQ2L,KAAKC,MAAQpV,EAAKsZ,YAC9BG,QAIHC,EAAqBzV,QACzBjE,KAAO4R,KAAKsB,OAAO,QAASwG,EAAqBpV,QAASqV,MAAM,IAGlEzU,EAAS0U,UAAUpO,GACnBtG,EAAS8G,OAAOR,EAASxL,KAAK6Z,kBAAmB7Z,MAEjDA,KAAO8Z,qBAAqB,mBAAoB,cAChD9Z,KAAO8Z,qBAAqB,YAAa,yBAG3C9T,GAAEuO,KAAQ7S,IAAA,WACR,MAAS1B,MAAK4R,KAAKoB,MAAMoG,OAG3BF,EAAA/S,UAAEmM,QAAO,WACPtS,KAAOuW,QAAQrK,QAAQlM,KAAKmZ,SAAUnZ,KAAK6Z,kBAAmB7Z,MAC9DA,KAAO4R,KAAKmI,YAGdb,EAAA/S,UAAE0T,kBAAiB,SAACN,GAClBvZ,KAAOuU,KAAKgF,KAAOA,EACnBvZ,KAAOuU,KAAK/J,IAAM+O,GAAQA,EAAK/O,KAGjC0O,EAAA/S,UAAE2T,qBAAoB,SAACE,EAAUC,cACvBC,EAAiBla,KAAa,SAAA,mBACtCA,MAAOuW,QAAQ7J,GAAGwN,EAAaA,EAAa,KAAM,QAAS,SAAAC,GACzDtR,EAAO0L,KAAK0F,GAAaE,EAAKzW,+CCzClC,IAAM0W,GAAa,SACLC,EAAStJ,GACrB/Q,KAAOsa,SAAWD,EAClBra,KAAOua,OAASxJ,EAChB/Q,KAAOwa,cACPxa,KAAOya,SACPza,KAAO0a,KAAO1a,KAAKsa,SAASnB,SAAWpI,EAAM3N,KAC7CpD,KAAO2a,UAAY5J,EAAM3N,KAAKkR,MAAM,KACpCtU,KAAO4a,YAAa,EACpB5a,KAAO8P,OAAQ,EAGjBsK,GAAAjU,UAAE0U,OAAM,SAACnG,EAAWoG,GAClB9a,KAAO+a,UACP/a,KAAOwa,WAAW7X,MAAM+R,UAAAA,EAAWoG,aAAAA,IACnCA,EAAe9a,KAAKya,QAGtBL,EAAAjU,UAAE6U,OAAM,SAACtG,GACP,GAAQzT,GAAIgC,EAAEgY,UAAUjb,KAAKwa,YAAa9F,UAAAA,GAE1C,OADMzT,IAAK,GAAGjB,KAAKwa,WAAW9X,OAAOzB,EAAG,GAC/BjB,KAAKwa,WAAWjY,QAG3B6X,EAAAjU,UAAE4U,QAAO,WACD/a,KAAK4a,aACX5a,KAAOsa,SAAS/D,QAAQ7J,GACtB1M,KAAOua,OAAOtb,WAAYe,KAAK0a,KAAM1a,KAAKua,OAAOvK,YAAa,QAC9DhQ,KAAOkb,gBAAiBlb,KAAKmb,aAAarW,KAAK9E,KAAKua,OAAOnX,MAAOpD,MAAOob,MAAM,IACjFpb,KAAO4a,YAAa,IAGtBR,EAAAjU,UAAEmM,QAAO,qBACPtS,MAAOsa,SAAS/D,QAAQrJ,IACtBlN,KAAOua,OAAOtb,WAAYe,KAAK0a,KAAM1a,KAAKua,OAAOvK,YAAa,QAAShQ,KAAKkb,gBAC5Elb,MACFA,KAAO4a,YAAa,EACpB5a,KAAO8P,OAAQ,EACf4J,EAAuBpV,QACvB,KAAc,GAAAjC,GAAA,EAAAC,EAAItC,KAAKya,MAAKpY,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAC5B,GADSrD,GAAGsD,EAAAD,EACVrC,GAAKsa,SAASe,kBAAkBrb,EAAK2a,UAAUxR,OAAOnK,MAI5Dob,EAAAjU,UAAE+U,gBAAe,SAACf,aAGhB,IAAOna,KAAKwa,WAAWjY,QAAWvC,KAAK4a,WAAvC,CACA,GAAQU,GAActb,KAAKub,YAAYpB,EAEvC,IADAna,KAAOsa,SAASkB,eAAerB,IACxBna,KAAK8P,MAAO,CACjB9P,KAAO8P,OAAQ,EACf4J,EAAuBpV,QACvB,KAAmB,GAAAjC,GAAA,EAAAC,EAAItC,KAAKwa,WAAUnY,EAAAC,EAAAC,OAAAF,GAAA,EAA/B,CAAA1B,GAAIoL,GAAQzJ,EAAAD,EAAqBrC,GAAKsa,SAASmB,YAAYvD,UAAUnM,EAAS2I,YAEvF,GAAM4G,EACJ,IAAmB,GAAAjO,GAAA,EAAAC,EAAItN,KAAKwa,WAAUnN,EAAAC,EAAA/K,OAAA8K,GAAA,EAA/B,CAAA1M,GAAIoL,GAAQuB,EAAAD,EAAqBtB,GAAS+O,aAAaQ,MAIlElB,EAAAjU,UAAEoV,YAAW,SAACpB,MACNmB,SACN,IAAMnB,EAAK/W,OAASpD,KAAKua,OAAOnX,KAG9B,GAFAkY,EAAgBrY,EAAEE,KAAKgX,EAAKzW,OAC5B4X,EAAcI,OACRzY,EAAEqM,QAAQtP,KAAKya,MAAOa,GAC1BA,EAAgB,SACT,CACP,IAAc,GAAAjZ,GAAA,EAAAC,EAAIW,EAAE2T,WAAW0E,EAAatb,KAAKya,OAAMpY,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CACvD,GADSrD,GAAGsD,EAAAD,EACVrC,GAAKsa,SAASqB,gBAAgB3b,EAAK2a,UAAUxR,OAAOnK,IAExD,IAAc,GAAAqO,GAAA,EAAAC,EAAIrK,EAAE2T,WAAW5W,KAAKya,MAAOa,GAAYjO,EAAAC,EAAA/K,OAAA8K,GAAA,EAAE,CACvD,GADSrO,GAAGsO,EAAAD,EACVrN,GAAKsa,SAASe,kBAAkBrb,EAAK2a,UAAUxR,OAAOnK,IAE1DgB,KAAOya,MAAQa,MAEV,IAAInB,EAAK/W,KAAKlE,QAAQ,WAAW,MAAQc,KAAKua,OAAOnX,KAAM,CAClE,GAAQwY,GAAS3Y,EAAEoR,SAASrU,KAAKya,MAAON,EAAKnb,IACvCmb,GAAKzW,MACFkY,IACL5b,KAAOsa,SAASqB,gBAAgB3b,KAAK2a,UAAUxR,OAAOgR,EAAKnb,MAC3DgB,KAAOya,MAAM9X,KAAKwX,EAAKnb,KACvBgB,KAAOya,MAAMiB,OACbJ,EAAgBtb,KAAKya,OAGjBmB,IACJ5b,KAAOsa,SAASe,kBAAkBrb,KAAK2a,UAAUxR,OAAOgR,EAAKnb,MAC7DiE,EAAIuU,KAAKxX,KAAKya,MAAON,EAAKnb,KAC1BgB,KAAOya,MAAMiB,OACbJ,EAAgBtb,KAAKya,OAI3B,MAASa,IAGXlB,EAAAjU,UAAEgV,aAAY,SAAC1a,aACNT,MAAKwa,WAAWjY,QAAWvC,KAAK4a,aACvC5a,KAAO4a,YAAa,EACpB/a,QAAU6K,IAAIzH,EAAEO,IAAIxD,KAAKwa,WAAY,SAAAzO,GAEnC,MADAlD,GAAOyR,SAASmB,YAAYtD,WAAWpM,EAAS2I,WACvC1U,EAAKsa,SAASmB,YAAYrD,MAAMrM,EAAS2I,UAAWjU,GAAOsK,MAAM,SAAA7K,GAExE,MADA6L,GAAW2I,UAAUhC,YAAYxS,IACxB,OAEP4J,KAAK,SAAAuO,GACT,GAAMpV,EAAEqN,KAAK+H,GACLrY,EAAKwa,WAAWjY,QAAQvC,EAAK+a,cAEnC,KAAmB,GAAA1Y,GAAA,EAAAC,EAAItC,EAAKwa,WAAUnY,EAAAC,EAAAC,OAAAF,GAAA,EAA/B,CAAA1B,GAAIoL,GAAQzJ,EAAAD,EAAqB0J,GAAS2I,UAAUhC,YAAYjS,OAO7E,IAAMob,GAAK,SACGxB,EAASjX,GACrBpD,KAAOsa,SAAWD,EAClBra,KAAOoD,KAAOA,EACdpD,KAAOgB,IAAMhB,KAAKsa,SAASnB,SAAW/V,EACtCpD,KAAO8b,cACP9b,KAAO+b,WAAa,EACpB/b,KAAOgc,WAAY,EACnBhc,KAAO8P,OAAQ,EACf9P,KAAO4O,mCAGT5I,GAAE/B,OAAUvC,IAAA,WACV,MAAS1B,MAAKic,OAASjc,KAAK+b,YAG9B/V,EAAEiW,MAASva,IAAA,WACT,MAAS1B,MAAK8b,WAAWvZ,QAG3BsZ,EAAA1V,UAAE+V,OAAM,SAACC,aACP,KAAOA,GAAQnc,KAAKic,MAAO,CACzB,GAAMjc,KAAKgc,UAAW,MACtB/Y,GAAIC,KAAKlD,KAAK8b,WAAY,SAAAM,GAAOpc,EAAKsa,SAASmB,YAAYtD,WAAWiE,KACtEpc,KAAOsa,SAAS/D,QAAQ7J,GACtB1M,KAAOgB,IAAKhB,KAAKgB,IAAK,KAAM,QAAShB,KAAKkb,gBAAiBlb,KAAKmb,aAAarW,KAAK9E,MAClFA,MAASob,MAAM,IACjBpb,KAAOgc,WAAY,MAEnB/Y,GAAIC,KAAKlD,KAAK4O,SAAU,SAAAD,GAAUA,EAAMuN,YAI5CL,EAAA1V,UAAEkW,SAAQ,SAACF,IACFA,GAAQnc,KAAKgc,WAClBhc,KAAOsa,SAAS/D,QAAQrJ,IAAIlN,KAAKgB,IAAKhB,KAAKgB,IAAK,KAAM,QAAShB,KAAKkb,gBAAiBlb,MACrFA,KAAOgc,WAAY,EACnBhc,KAAOsc,mBAAmB,SAAAC,GAClBA,EAAKzM,QACTyM,EAAOzM,OAAQ,EACf4J,EAAuBpV,aAI3BrB,EAAIC,KAAKlD,KAAK4O,SAAU,SAAAD,GAAUA,EAAM0N,cAI5CR,EAAA1V,UAAE+U,gBAAe,SAACf,aACTna,MAAKgc,WAAchc,KAAKsa,SAASkC,eAAerC,EAAK/W,QAC5DpD,KAAOsa,SAASkB,eAAerB,GACxBna,KAAK8P,OAASqK,EAAK/W,OAASpD,KAAKoD,OACtCpD,KAAO8P,OAAQ,EACf4J,EAAuBpV,SACvBtE,KAAOqc,UAAS,GAChBrc,KAAOsc,mBAAmB,SAAAC,GACxB,IAAa,GAAAla,GAAA,EAAAC,EAAItC,EAAK8b,WAAUzZ,EAAAC,EAAAC,OAAAF,GAAA,EAAzB,CAAA1B,GAAIyb,GAAE9Z,EAAAD,EAAqBrC,GAAKsa,SAASmB,YAAYvD,UAAUkE,SAK5EP,EAAA1V,UAAEgV,aAAY,SAAC1a,aACb,IAAOT,KAAKic,OAAUjc,KAAKgc,UAS3B,MARAhc,MAAOgc,WAAY,EACnBhc,KAAOsc,mBAAmB,SAAAC,GAClBA,EAAKzM,QACTyM,EAAOzM,OAAQ,EACf4J,EAAuBpV,SAEzB,KAAa,GAAAjC,GAAA,EAAAC,EAAItC,EAAK8b,WAAUzZ,EAAAC,EAAAC,OAAAF,GAAA,EAAzB,CAAA1B,GAAIyb,GAAE9Z,EAAAD,EAAqBrC,GAAKsa,SAASmB,YAAYtD,WAAWiE,MAEhEvc,QAAQ6K,IAAIzH,EAAEO,IAAIxD,KAAK8b,WAAY,SAAAM,GAC1C,MAASpc,GAAKsa,SAASmB,YAAYrD,MAAMgE,EAAI3b,GAAOsK,MAAM,SAAA7K,GAExD,MADAkc,GAAK1J,YAAYxS,IACR,OAEP4J,KAAK,SAAAuO,GACT,GAAMpV,EAAEqN,KAAK+H,GACLrY,EAAKic,OAAOjc,EAAKkc,aAEvB,KAAa,GAAA7Z,GAAA,EAAAC,EAAItC,EAAK8b,WAAUzZ,EAAAC,EAAAC,OAAAF,GAAA,EAAzB,CAAA1B,GAAIyb,GAAE9Z,EAAAD,EAAqB+Z,GAAG1J,YAAYjS,OAMvDob,EAAA1V,UAAEmW,mBAAkB,SAACG,GACnBA,EAAWzc,MACXiD,EAAIC,KAAKlD,KAAK4O,SAAU,SAAAD,GAAM,MAAGA,GAAM2N,mBAAmBG,MAG5DZ,EAAA1V,UAAEuW,8BAA6B,SAACC,GAM9B,MALOA,KAAOA,MACdA,EAAQ3c,KAAKoD,MAAQpD,KAAKiE,OACnBjE,KAAKiE,QACVhB,EAAIC,KAAKlD,KAAK4O,SAAU,SAAAD,GAAUA,EAAM+N,8BAA8BC,KAE/DA,yCAKX,IAAqBC,GAAQ,SACfpR,EAAStG,EAAQ2X,EAAYC,EAAeC,GACxD/c,KAAOmZ,SAAW3N,EAClBxL,KAAOuW,QAAUrR,EACjBlF,KAAOyb,YAAcoB,EACrB7c,KAAOwb,eAAiBsB,EACxB9c,KAAOgd,WAAaD,EACpB/c,KAAO4R,KAAO,GAAIC,IAAKzI,MAAOmL,KAAM,GAAIsH,GAAK7b,KAAM,KAAMid,mDAG3DpN,GAAEqN,MAASxb,IAAA,WAAI,MAAO1B,MAAK4R,KAAK2C,MAChC1E,EAAEsN,eAAkBzb,IAAA,WAAI,MAAO1B,MAAK4R,KAAKqL,eAEzCL,EAAAzW,UAAEmM,QAAO,WACPrP,EAAIC,KAAKlD,KAAKmd,eAAgB,SAAAC,GAAiBA,EAAa9K,YAC5DtS,KAAOkd,MAAMb,WACbrc,KAAO4R,KAAKmI,YAGd6C,EAAAzW,UAAEkX,OAAM,SAACja,EAAMsR,GACb,MAAS1U,MAAK2b,gBAAgBvY,EAAKkR,MAAM,KAAMI,IAGjDkI,EAAAzW,UAAEwV,gBAAe,SAACvZ,EAAUsS,GAI1B,IAAkB,GAHZ6H,UACAe,GAAc5I,EACd5E,GAAQ,EACIzN,EAAA,EAAAC,EAAIF,EAAQC,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAC9B,GADSG,GAAOF,EAAAD,GACVsM,EAAQnM,EAAU+Z,EAAK3N,UAAY2N,EAAK3N,SAASpM,GAAWxC,EAAKkd,KAChEvO,KACLA,EAAU,GAAIkN,GAAK7b,GAAuB,MAAduc,EAAKnZ,KAAe,GAAKmZ,EAAKnZ,MAAI,IAAIZ,GAClEqP,EAAMtF,IAAIgQ,EAAK3N,SAAUpM,EAASmM,IAEpC2O,EAAeA,GAAc3O,EAAMqN,UACnClM,EAAUA,GAASnB,EAAMmB,MACzByM,EAAS5N,EAEL+F,EACJ6H,EAAOT,WAAWnZ,KAAK+R,GAEvB6H,EAAOR,aAEHuB,EACE5I,GAAa5E,GAAO9P,KAAKyb,YAAYvD,UAAUxD,GAErD6H,EAAOL,UAIXU,EAAAzW,UAAEoX,SAAQ,SAACna,EAAMsR,GACf,MAAS1U,MAAKqb,kBAAkBjY,EAAKkR,MAAM,KAAMI,IAGnDkI,EAAAzW,UAAEkV,kBAAiB,SAACjZ,EAAUsS,GAG5B,IAAkB,GADZ6H,UADEiB,KAEUnQ,EAAA,EAAA/K,EAAIF,EAAQiL,EAAA/K,EAAAC,OAAA8K,GAAA,EAAE,CAC9B,GADS7K,GAAOF,EAAA+K,EAEhB,IADEkP,EAAO/Z,EAAU+Z,EAAK3N,UAAY2N,EAAK3N,SAASpM,GAAWxC,EAAKkd,OAC3DX,EAAM,KACbiB,GAAY7a,KAAK4Z,GAEnB,IAAOA,KAAU7H,EAAY6H,EAAKN,MAAQM,EAAKR,YAC7C,KAAQ,IAAIxb,OAAM,qBAAqB6B,EAASQ,KAAK,KAgBvD,IAdM8R,EACJzR,EAAIuU,KAAK+E,EAAKT,WAAYpH,GAE1B6H,EAAOR,aAEHrH,IAAc6H,EAAKN,QAMvBM,EAAOL,SACDK,EAAKP,WAAWO,EAAKF,aAEtBE,EAAKtY,OAAQ,CAClB,GAAQwZ,GAAyBlB,EAAKG,+BACtC1c,MAAOgd,WAAW5a,EAASQ,KAAK,KAAM6a,EACtC,KAAO9c,GAAI0B,GAAImb,EAAUjb,OAAS,EAAGF,EAAI,IACvCka,EAASiB,EAAUnb,GACbka,IAASvc,EAAKkd,QAASX,EAAKtY,QAAWhB,EAAEya,QAAQnB,EAAK3N,WAFlBvM,IAG1CwP,EAAMoC,OAAOuJ,EAAUnb,EAAI,GAAGuM,SAAUxM,EAASC,MAKvDua,EAAAzW,UAAEwX,UAAS,SAAC5M,EAAO2D,EAAWoG,GAC5B,GAAMsC,GAAepd,KAAKmd,eAAepM,EAAM9R,WACxCme,KACLA,EAAiB,GAAIhD,GAAapa,KAAM+Q,GACxCc,EAAMtF,IAAIvM,KAAKmd,eAAgBpM,EAAM9R,WAAYme,IAEnDA,EAAevC,OAAOnG,EAAWoG,IAGnC8B,EAAAzW,UAAEyX,YAAW,SAAC7M,EAAO2D,GACnB,GAAQ0I,GAAepd,KAAKmd,eAAepM,EAAM9R,WAC3Cme,KAAiBA,EAAapC,OAAOtG,KACzC0I,EAAe9K,UACfT,EAAMoC,OAAOjU,KAAKmd,eAAgBpM,EAAM9R,cAK5C2d,EAAAzW,UAAEqW,eAAc,SAACpZ,GAGf,IAAkB,GADZmZ,UADEna,EAAWgB,EAAKkR,MAAM,KAEZjS,EAAA,EAAAC,EAAIF,EAAQC,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAC9B,GADSG,GAAOF,EAAAD,EAEhB,IADEka,EAAO/Z,EAAU+Z,EAAK3N,UAAY2N,EAAK3N,SAASpM,GAAWxC,EAAKkd,OAC3DX,EAAM,OAAO,CACpB,IAAMA,EAAKtY,OAAQ,OAAO,EAE5B,OAAS,GAGX2Y,EAAAzW,UAAE0X,2BAA0B,SAACza,GAG3B,IAAkB,GADZmZ,UADEna,EAAWgB,EAAKkR,MAAM,KAEZjS,EAAA,EAAAC,EAAIF,EAAQC,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAC9B,GADSG,GAAOF,EAAAD,EAEhB,IADEka,EAAO/Z,EAAU+Z,EAAK3N,UAAY2N,EAAK3N,SAASpM,GAAWxC,EAAKkd,OAC3DX,EAAM,MAEf,MAASA,GAAOA,EAAKG,oCAGvBE,EAAAzW,UAAE2X,eAAc,SAAC1a,GAGf,IAAkB,GADZmZ,UADEna,EAAWgB,EAAKkR,MAAM,KAEZjS,EAAA,EAAAC,EAAIF,EAAQC,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAC9B,GADSG,GAAOF,EAAAD,EAEhB,IADEka,EAAO/Z,EAAU+Z,EAAK3N,UAAY2N,EAAK3N,SAASpM,GAAWxC,EAAKkd,OAC3DX,EAAM,OAAO,CACpB,IAAMA,EAAKzM,MAAO,OAAO,EAE3B,OAAS,GAGX8M,EAAAzW,UAAE4J,aAAY,SAACgB,GACb,GAAQqM,GAAepd,KAAKmd,eAAepM,EAAM9R,WACjD,OAASme,IAAgBA,EAAatN,0KC5WxC,WACE,GAAIiO,GAAgBC,EAAQC,CAEA,oBAAhBC,cAA+C,OAAhBA,aAAyBA,YAAY9I,IAC9E1Q,EAAAyZ,QAAiB,WACf,MAAOD,aAAY9I,OAEQ,mBAAZgJ,UAAuC,OAAZA,SAAqBA,QAAQJ,QACzEtZ,EAAAyZ,QAAiB,WACf,OAAQJ,IAAmBE,GAAY,KAEzCD,EAASI,QAAQJ,OACjBD,EAAiB,WACf,GAAIM,EAEJ,OADAA,GAAKL,IACU,IAARK,EAAG,GAAWA,EAAG,IAE1BJ,EAAWF,KACF5I,KAAKC,KACd1Q,EAAAyZ,QAAiB;AACf,MAAOhJ,MAAKC,MAAQ6I,GAEtBA,EAAW9I,KAAKC,QAEhB1Q,EAAAyZ,QAAiB,WACf,OAAO,GAAIhJ,OAAOmJ,UAAYL,GAEhCA,GAAW,GAAI9I,OAAOmJ,aAGvB3c,KAAK3B,KRxBFue,GAAiCtc,QAAQ,EAAMuc,SAAS,EAAMC,MAAM,EAAMC,OAAO,GAEjFC,KAGAC,EAAM,8DAAA5Y,GACVuI,KAAQ7M,IAAA,WACR0D,OAASyZ,eAAe7e,KAAM,QAAS0D,MAAO,GAAIgL,GAAU1O,KAAKiC,OAAOoM,MAAOrO,KAAK0e,UAEtF1Y,EAAE8Y,MAASpd,IAAA,WAAI,OAAQ1B,KAAKuO,OAC5BvI,EAAE+Y,MAASrd,IAAA,WAAI,MAAOuB,GAAEE,KAAKnD,OAC7BgG,EAAEgZ,QAAWtd,IAAA,WAAI,MAAOuB,GAAEF,OAAO/C,OACjCgG,EAAEoT,MAAS1X,IAAA,WAAI,MAAO1B,MAAKiC,OAAOsS,MAElCqK,EAAAzY,UAAE+M,OAAM,SAAC+L,EAAWC,cACZC,GAAO,EACPC,EAA6B,WAAOD,GAAO,GAEzC1M,EAAUzS,KAAKiC,OAAOoM,MAAMuD,KAAKsB,OAAO,WAC9C,IAAMiM,EAEN,MADAtW,GAAOvH,cACE2d,KACN,SAAC7U,EAAUwD,GACRuR,GACND,EAAavd,KAAK3B,EAAMoK,EAAUwD,EAAUwR,KACxCjM,WAAW,GAEjB,OAAMgM,IACJ1M,IACSxP,EAAEnE,OAGNkB,KAAKqf,cACVja,OAASyZ,eAAe7e,KAAM,gBAC5B0D,SAAa4b,UAAU,EAAOvM,YAAY,EAAOD,cAAc,IAEnEsM,EAA+B,WACvBD,IACNA,GAAS,EACT1M,IACAxP,EAAIuU,KAAKxX,EAAKqf,aAAcD,KAE9Bpf,KAAOqf,aAAa1c,KAAKyc,GAChBA,IAGXR,EAAAzY,UAAEoZ,KAAI,SAAC7b,GAAQ,MAAO1D,MAAKuO,KAAKhC,IAAI7I,IACpCkb,EAAAzY,UAAEqZ,QAAO,SAACzc,GAAS,MAAO/C,MAAKuO,KAAK9B,OAAO1J,IAC3C6b,EAAAzY,UAAEsZ,QAAO,SAACpT,EAASoH,GAAW,MAAOzT,MAAKuO,KAAK0C,OAAO5E,EAASoH,0CAO/D,IAAMiM,GAAsB,SACdlW,GACZvG,EAAIiN,OAAOlQ,MAAOwJ,KAAAA,EAAM3H,cAAe,EAAG8d,WAAY,EAAG/d,QAAS,KAK/Cge,EAAQ,SACfC,aACZ7f,MAAO8f,QAAU7c,EAAE4c,GAASE,OAAOvc,IAAI,SAAAwc,GAAM,MAAGhgB,GAAKigB,YAAYD,KAAQE,UAAUxc,OACnF,IAAQyc,GAAWld,EAAEO,IAAIxD,KAAK8f,QAAS,SAAAM,GAAM,MAAGA,GAAMC,MAAMphB,YAC5D,IAAMkhB,EAAS5d,SAAWU,EAAE8c,KAAKI,GAAU5d,OAAQ,CACjD,GAAQ+d,GAAWrd,EAAEkd,GAChBI,UACA/c,IAAI,SAACgd,EAAOxhB,GAAK,MACC,KAAjBwhB,EAAMje,OAAe,KAAOvD,EAAIE,QAAQ,kBAAmB,KAAKQ,MAAM,GAAG,KAC1E+gB,UACA/c,OACL,MAAQ,IAAInD,OAAM,wCAA0C+f,EAAS1d,KAAK,sCAI9Egd,GAAAzZ,UAAEmM,QAAO,aAGTsN,EAAAzZ,UAAEua,cAAa,SAACV,GAGd,IAFA,GAAMW,GACAC,EAAQZ,EAAM7Z,UACXya,GAASA,EAAMC,cAAgBzb,QAAQ,CAC9C,IAAe,GAAA/C,GAAA,EAAAC,EAAI8C,OAAO0b,oBAAoBF,GAAMve,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CACpD,GADSmH,GAAIlH,EAAAD,GACL2P,EAAa5M,OAAO2b,yBAAyBH,EAAOpX,EAC5D,IAAyB,MAAnBA,EAAK/G,OAAO,GAAY,CAC5B,GAAMQ,EAAEqM,QAAQ0C,EAAY5M,OAAO2b,yBAAyBnC,EAAMzY,UAAWqD,IAC3E,QAEF,MAAQ,IAAIjJ,OAAM,kDAAkDyf,EAAU,KAAA,IAAIxW,GAEpF,GAAMwI,EAAWzF,IACf,KAAQ,IAAIhM,OAAM,+CAA+Cyf,EAAU,KAAA,IAAIxW,IAE3EwI,EAAWtQ,KAASif,GAAsBA,EAAmBnX,MAC9DmX,IAAuBA,OAA0BnX,IAClDA,KAAEA,EAAMwX,SAAaJ,EAAMC,YAAgB,KAAA,IAAIrX,EAAQ9H,IAAKsQ,EAAWtQ,MAI7Ekf,EAAUxb,OAAO6b,eAAeL,GAElC,IAAe,GAAAvT,GAAA,EAAAC,EAAIlI,OAAO0b,oBAAoBlC,EAAMzY,WAAUkH,EAAAC,EAAA/K,OAAA8K,GAAA,EAAE,CAC9D,GADS7D,GAAI8D,EAAAD,EACE,iBAAT7D,GAA0BwW,EAAM7Z,UAAUtF,eAAe2I,IAC/DpE,OAASyZ,eACPmB,EAAQ7Z,UAAWqD,EAAMpE,OAAO2b,yBAAyBnC,EAAMzY,UAAWqD,IAE9E,MAASmX,IAGXf,EAAAzZ,UAAE8Z,YAAW,SAACD,GACZ,GAAQW,GAAqB3gB,KAAK0gB,cAAcV,GAC1CkB,EAASlB,EAAMmB,WACrB,KAAOD,EAAQ,KAAM,IAAI3gB,OAAM,SAASyf,EAAU,KAAA,uCAElD,OADO/c,GAAE8L,QAAQmS,KAASA,GAAUA,IAC3Bje,EAAEO,IAAI0d,EAAQ,SAAAd,GACfnd,EAAEme,SAAShB,KAAQA,GAAShd,KAAMgd,GAMxC,KAAmB,GALXiB,MACAC,EAAelB,EAAMhd,KAAKlE,QAAQ,cAAe,SAAAqiB,GAEvD,MADAF,GAAY1e,KAAK4e,EAAM7hB,MAAM,IACpB,MACNR,QAAQ,gBAAiB,QACXmD,EAAA,EAAAC,EAAI+e,EAAShf,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAChC,GADSmf,GAAQlf,EAAAD,EACf,IAAiB,MAAbmf,GAA2C,MAAvBA,EAAS/e,OAAO,GACxC,KAAQ,IAAIlC,OAAM,0BAA0BihB,EAE9C,IAA6B,MAAvBA,EAAS/e,OAAO,KAClBQ,EAAIsQ,IAAIqL,EAAMzY,UAAWqb,IAAajD,EAA8BiD,IAEtE,KAAQ,IAAIjhB,OAAM,6DAA6DihB,GAGnF,OACEC,MAASzB,EAAOqB,UAAAA,EAAWV,mBAAAA,EAC3Be,WAActB,EAAMhd,KAAKme,MAAM,eAAc,GAC7CI,YAAevB,EAAMuB,YACrBtB,MAAS,GAAIuB,QAAO,IAAMN,EAAapiB,QAAQ,UAAW,YAAc,KACxE2iB,YAAe,GAAID,QACjB,KAASN,EAAapiB,QAAQ,YAAY,IAAIA,QAAQ,UAAW,aAAe,KAAO,SAW/F0gB,EAAAzZ,UAAE2b,aAAY,SAAC1e,EAAM2e,GAGnB,IAAgB,GADVpB,UADAX,EAAQpB,EAEEvR,EAAA,EAAA/K,EAAItC,KAAK8f,QAAOzS,EAAA/K,EAAAC,OAAA8K,GAAA,EAAE,CAChC,GADS+S,GAAK9d,EAAA+K,EACZ+S,GAAMC,MAAM2B,UAAY,CAC1B,IAAMT,GAAQnB,EAAMC,MAAM4B,KAAK7e,EAC/B,IAAMme,EAAO,CACXvB,EAAUI,EAAMqB,MAChBd,EAAuBP,EAAMO,kBAC7B,KAAOhgB,GAAI0B,GAAI,EAAGA,EAAI+d,EAAMiB,UAAU9e,OAAQF,IAC5C0f,EAAa3B,EAAMiB,UAAUhf,KAC3BqB,MAASrE,EAAYkiB,EAAMlf,EAAI,IAC/Bid,UAAY,EAAOxM,cAAc,EAAOC,YAAY,EAGxD,QAIJ,GAAQlP,GAAS,GAAImc,EAQrB,OANMW,IACJ1d,EAAIC,KAAKyd,EAAoB,SAAAvf,GAC3B2gB,EAAa3gB,EAAKoI,MAAQxJ,EAAKkiB,iCAAiCre,EAAQzC,KAInEyC,GAGX+b,EAAAzZ,UAAE+b,iCAAgC,SAACre,EAAQzC,GAClCud,EAAsBvd,EAAK4f,WAChC5b,OAASyZ,eAAeF,EAAuBvd,EAAK4f,UAClDtd,MAAS,GAAIgc,GAAsBte,EAAK4f,UAAW1B,UAAU,EAAOvM,YAAY,EAChFD,cAAgB,GAGpB,IAEMpP,GAFErC,EAAQsd,EAAsBvd,EAAK4f,UAGrCmB,GAAe,EACfC,GAAgB,CA2BtB,OAzBOve,GAAOwb,cACZja,OAASyZ,eAAehb,EAAQ,gBAC9BH,SAAa4b,UAAU,EAAOvM,YAAY,EAAOD,cAAc,IAE5DjP,EAAOwe,gBACZjd,OAASyZ,eAAehb,EAAQ,kBAC9BH,SAAa4b,UAAU,EAAOvM,YAAY,EAAOD,cAAc,IAEnEjP,EAASwe,eAAe1f,KAAK,SAAA2f,GAC3Bze,EAASwb,aAAa1c,KACpB2f,EAAMpP,OAAO/R,EAAa2D,KAAKjB,EAAQzC,EAAMC,GAAQ,SAAA+I,GACnD,GAAMgY,EACJ/gB,EAAQse,YAAc,EACtBjc,EAAU0G,EACVgY,GAAkB,MACX,CACP,GAAMnf,EAAEqM,QAAQ5L,EAAO0G,EAAUtI,GAAoB,MACrDT,GAAQse,YAAc,EACtBwC,GAAiB,EACjBte,EAASzC,EAAKoI,MAAQY,EACtB+X,GAAiB,KAEfhP,WAAW,QAInBJ,YAAc,EAAMD,cAAc,EAClCpR,IAAO,WAAY,MAAOgC,IAC1B6I,IAAO,SAASnC,GACd,IAAO+X,EAAc,KAAM,IAAI5hB,OAAM,uCAAuCa,EAAS,KACrFsC,GAAU0G,KAKhBwV,EAAAzZ,UAAEoc,cAAa,SAACnf,GAEd,MAASH,GAAEqN,KAAKtQ,KAAK8f,QAAS,SAAAM,GAAM,MAAGA,GAAMuB,aAAevB,EAAMC,MAAMmC,KAAKpf,MAG/Ewc,EAAAzZ,UAAEsc,wBAAuB,SAACrf,EAAMqZ,GAC9BxZ,EAAIC,KAAKlD,KAAK8f,QAAS,SAAAM,GACfA,EAAMuB,aAAevB,EAAMyB,YAAYW,KAAKpf,IAChDqZ,EAAW2D,EAAMsB,WAAYtB,EAAMuB,gBAKzC3Z,GAAE2W,sBAAgCjd,IAAA,WAChC,MAASid,iCChPX,IAAM+D,IAAY,SACJtf,EAAM+K,GAClBnO,KAAO2F,MAAQvC,EACfpD,KAAOqO,MAAQF,4CAGjBnI,IAAE2c,aAAgBjhB,IAAA,WAAI,MAAO1B,MAAKqO,MAAMuU,WAAW5iB,KAAK2F,QACxDK,GAAE6c,QAAWnhB,IAAA,WAAI,MAAO1B,MAAK8iB,UAC7B9c,GAAEjD,OAAUrB,IAAA,WAAI,MAAO1B,MAAK+iB,SAE5BL,GAAAvc,UAAE6c,YAAW,SAACtf,GACZ,GAAM1D,KAAK8iB,SAAU,KAAM,IAAIviB,OAAM,qCAAuCP,KAAK8iB,SACjF9iB,MAAO8iB,SAAWpf,GAGpBgf,GAAAvc,UAAE8c,MAAK,WACLjjB,KAAOgjB,YAAY,UAGrBN,GAAAvc,UAAE8O,OAAM,WACNjV,KAAOgjB,YAAY,WAGrBN,GAAAvc,UAAEoG,IAAG,SAAC7I,GACJ,GAAgBqC,SAAVrC,EAAqB,KAAM,IAAInD,OAAM,8BAC3CP,MAAOgjB,YAAY,OACnBhjB,KAAO+iB,SAAWG,GAAIxf,IAGxBgf,GAAAvc,UAAEsG,OAAM,SAAC1J,GACP,GAAiBgD,SAAXhD,EAAsB,KAAM,IAAIxC,OAAM,8BAC5C,OAAM0C,GAAEya,QAAQ3a,GAAgB/C,KAAKiV,UACrCjV,KAAOgjB,YAAY,eACnBhjB,KAAO+iB,QAAUhgB,6CAKnB,IAAqBogB,IAAK,SACZ9T,EAAO7D,EAAStG,EAAQ2X,EAAYgD,GAChD7f,KAAOojB,OAAS/T,EAChBrP,KAAOmZ,SAAW3N,EAClBxL,KAAOuW,QAAUrR,EACjBlF,KAAOyb,YAAcoB,EACrB7c,KAAOqjB,8BAA+B,EACtCrjB,KAAOsjB,aAAe,EACtBtjB,KAAOujB,gBACPvjB,KAAOwjB,qBAAuB,KAC9BxjB,KAAOsa,SAAW,GAAIsC,GACpBpR,EAAWtG,EAAQ2X,EAAY7c,KAAKyjB,mBAAmB3e,KAAK9E,MAAOA,KAAK0jB,OAAO5e,KAAK9E,OACtFA,KAAO4R,KAAO,GAAIC,IAAKzI,MAAOgQ,MAAOrT,UAC/B2T,EAAqBzV,QACzBjE,KAAO4R,KAAKsB,OAAO,QAASwG,EAAqBpV,QAASqV,MAAM,IAElE3Z,KAAO2jB,SAAW,GAAI/D,GAAQC,GAC9B7f,KAAO4R,KAAKoB,MAAMoG,MAAQpZ,KAAK4jB,cAAc,IAAK,IAClD5jB,KAAO6jB,sBAAsB7jB,KAAKuU,MAClCvU,KAAO8jB,mBAAmB9jB,KAAKuU,KAAM,yDAGvC1E,IAAE0E,KAAQ7S,IAAA,WACR,MAAS1B,MAAK4R,KAAKoB,MAAMoG,OAG3BvJ,GAAER,MAAS3N,IAAA,WACT,MAAS1B,MAAKojB,QAGhBD,GAAAhd,UAAEmM,QAAO,WACPtS,KAAOsa,SAAShI,UAChBtS,KAAO2jB,SAASrR,UAChBtS,KAAO4R,KAAKmI,YAGdoJ,GAAAhd,UAAEwN,iBAAgB,SAACnO,EAAKue,EAAetf,aACrCzE,MAAOgkB,aAAaxe,EACpB,IACMiN,GADEiC,EAAY1U,KAAKyb,YAAY5D,gBAAgB,OAAQpT,EAAQe,EAErE,IAAMue,EAAe,CACnB,GAAQ3hB,GAAWa,EAAEuC,EAAIpC,MAAMkR,MAAM,KAAK9Q,IAAI,SAAAhB,GAAQ,MAAGnD,GAAYmD,KAAUkB,OAC/E+O,GAAYzS,KAAK4R,KAAKsB,OAAOlT,KAAK4iB,WAAW9d,KAAK1C,GAAW2hB,GAM/D,MAJArP,GAAYhC,YAAc1S,KAAKikB,qBAAqBnf,KAAK9E,KAAMwF,EAAKkP,EAAWjC,GAC/EzS,KAAOyb,YAAY3D,MAAMpD,GAAW5K,KAAK,WACjC4K,EAAUsB,SAAShW,EAAKsa,SAAS+C,OAAO7X,EAAIpC,KAAMsR,KACrD3J,MAAM,SAAA7K,MACFwU,EAAUhC,aAGrByQ,GAAAhd,UAAE8d,qBAAoB,SAACze,EAAKkP,EAAWjC,EAAShS,GACxCiU,EAAUwP,gBAChBxP,EAAYwP,eAAgB,EACtBzR,GAASA,IACfzS,KAAOsa,SAASiD,SAAS/X,EAAIpC,KAAMsR,GACnC1U,KAAOyb,YAAYxD,IAAIvD,EAAWjU,GAAOsK,MAAM,SAAA7K,QAGjDijB,GAAAhd,UAAE2K,iBAAgB,SAACtL,GAEjB,MADAxF,MAAOgkB,aAAaxe,GACXxF,KAAKsa,SAASwD,eAAetY,EAAIpC,OAG5C+f,GAAAhd,UAAE0N,aAAY,SAAC9C,EAAO+J,EAAcrW,aAClCzE,MAAOgkB,aAAajT,EACpB,IAAQ2D,GAAY1U,KAAKyb,YAAY5D,gBAAgB,OAAQpT,EAAQsM,EAKrE,OAJA2D,GAAYhC,YAAc1S,KAAKmkB,iBAAiBrf,KAAK9E,KAAM+Q,EAAO2D,GAClE1U,KAAOyb,YAAY3D,MAAMpD,GAAW5K,KAAK,WACjC4K,EAAUsB,SAAShW,EAAKsa,SAASqD,UAAU5M,EAAO2D,EAAWoG,KAChE/P,MAAM,SAAA7K,MACFwU,EAAUhC,aAGrByQ,GAAAhd,UAAEge,iBAAgB,SAACpT,EAAO2D,EAAWjU,GAC7BiU,EAAUwP,gBAChBxP,EAAYwP,eAAgB,EAC5BlkB,KAAOsa,SAASsD,YAAY7M,EAAO2D,GACnC1U,KAAOyb,YAAYxD,IAAIvD,EAAWjU,GAAOsK,MAAM,SAAA7K,QAGjDijB,GAAAhd,UAAE4J,aAAY,SAACgB,GACb,MAAS/Q,MAAKsa,SAASvK,aAAagB,IAGtCoS,GAAAhd,UAAE6d,aAAY,SAACjX,GACb,IAAOA,EAAOyC,UAAUxP,KAAKojB,QAC3B,KAAQ,IAAI7iB,OAAM,gDAItB4iB,GAAAhd,UAAEsG,OAAM,SAACjH,EAAKf,EAAQ1B,cACZqhB,EAAYnhB,EAAEohB,KAAKthB,EAC3B,IAAOqhB,EAAP,CACiB,WAAX3f,GAAqB5B,EAA2C2C,EAAIpC,KAAML,GAChF/C,KAAOskB,iBAAiBvhB,EACxB,IAAQ/B,GAAMhB,KAAKwL,QAAUxL,KAAKukB,yBAAyBxhB,EAC3D,OAAS/C,MAAKyb,YAAY9D,QAAQ,QAASlT,EAAQe,EAAK,WACtD,MAAoB,KAAd4e,EACKpkB,EAAKuW,QAAQhK,IAAIvL,EAAK+B,EAAO,IAAK/C,EAAKsjB,cAEvCtjB,EAAKuW,QAAQ9J,OAAOzL,EAAK+B,EAAQ/C,EAAKsjB,kBAKrDH,GAAAhd,UAAE8K,OAAM,SAACzL,EAAK0L,cACNsT,EAAQ,EAENC,EAAqB,WAC3B,GAAMD,KAAW,GAAI,MAAO3kB,SAAQM,OAAO,GAAII,OAAM,YACrD,IAAQmkB,GAAM,GAAIhC,GAClB,KACExR,EAAiBwT,GACf,MAAOxkB,GACT,MAASL,SAAQM,OAAOD,GAE1B,GAAQ0N,GAAWhK,EAAe5D,EAAK4iB,WAAWpd,EAAIpC,MACtD,QAAUshB,EAAI7B,SACZ,IAAO,QAAS,MAChB,KAAO,SACL,KACF,KAAO,MACLha,EAAOyb,kBAAgBtT,KAAEA,EAACxL,EAAIpC,MAAKshB,EAAM3hB,OAAO,IAAGiO,SACnD,MACF,KAAO,SACLnO,EAA6C2C,EAAIpC,KAAMshB,EAAI3hB,QAAQ,GACnE8F,EAAOyb,iBAAiBI,EAAI3hB,OAC5B,MACF,SACE,KAAQ,IAAIxC,OAAM,iCAAmCmkB,EAAI7B,SAAW,SAExE,MAAS7iB,GAAKuW,QAAQ5I,YACpB9E,EAAOsQ,SAAW3T,EAAIpC,KAAMwK,EAAU8W,EAAI3hB,QACxC+G,KAAK,SAAA6a,GACP,IAAOA,EAAW,MAAOF,OAI7B,OAASzkB,MAAKojB,OAAOhU,KAAK5J,EAAK,WAC7B,MAASxF,GAAKyb,YAAY9D,QAAQ,QAAS,SAAUnS,EAAKif,MAI9DtB,GAAAhd,UAAEme,iBAAgB,SAACvhB,aAGjB/C,MAAOsjB,eACPtjB,KAAOwjB,qBAAuBxjB,KAAKojB,OAAOhO,MAC1CnS,EAAIC,KAAKH,EAAQ,SAACW,EAAON,GACvB,GAAQqa,GAAyBzd,EAAKsa,SAASuD,2BAA2Bza,EAC1E,KAAMH,EAAEya,QAAQD,GAEhB,IAAyB,GADjBmH,IAAmB,MAATxhB,EAAe,EAAIA,EAAKb,QAAU,EAC3BF,EAAA,EAAAC,EAAImb,EAAsBpb,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CACnD,GADSwiB,GAAcviB,EAAAD,GACf4M,EAAU4V,EAAenlB,MAAMklB,GACjCE,EAAWphB,CACjB,IAAMuL,EAEJ,IAAkB,GADV7M,GAAW6M,EAAQqF,MAAM,KACfjH,EAAA,EAAAC,EAAIlL,EAAQiL,EAAAC,EAAA/K,OAAA8K,GAAA,EAAE,CAC9B,GADS7K,GAAO8K,EAAAD,EAEhB,IADEyX,EAAWA,EAASzlB,EAAYmD,IACfuD,SAAb+e,EAAwB,MAGlC,GAAmB/e,SAAb+e,GAAuC,OAAbA,EAC9Bjc,EAAO6a,OAAOzU,OACP,CACP,GAAQjQ,GAAMK,EAAY4D,EAAE8hB,KAAKF,EAAevQ,MAAM,MACtDzL,GAAOmc,YAAYH,EAAgB7lB,EAAK8lB,EAAU9kB,EAAKilB,mBAAmBJ,IAE5Ehc,EAAO0a,aAAasB,GAAkB7kB,EAAKsjB,iBAKjDH,GAAAhd,UAAEoe,yBAAwB,SAACxhB,GACzB,GAAMmiB,EACNjiB,GAAIC,KAAKH,EAAQ,SAACW,EAAON,GACvB,GAAQhB,GAAoB,MAATgB,KAAoBA,EAAKkR,MAAM,IAClD,IAAM4Q,EAAgB,CAGpB,IAFA,GAAMC,GAAqB,EACnBC,EAAWrM,KAAKsM,IAAIH,EAAe3iB,OAAQH,EAASG,QACnD4iB,EAAqBC,GACvBF,EAAiBC,KAAwB/iB,EAAS+iB,IACvDA,GAGF,IADAD,EAAmBA,EAAexlB,MAAM,EAAGylB,IACpCD,EAAe3iB,OAAQ,OAAO,MAErC2iB,GAAmB9iB,GAGvB,IAAQkjB,GAAa,IAAMJ,EAAetiB,KAAK,IAK/C,OAJAK,GAAIC,KAAKD,EAAEE,KAAKJ,GAAS,SAAA/D,GACvB+D,EAAS/D,EAAIU,MAAM4lB,EAAW/iB,OAAS,IAAMQ,EAAO/D,SAC3C+D,GAAO/D,KAETsmB,GASXnC,GAAAhd,UAAEyd,cAAa,SAACxgB,EAAMpE,EAAKyP,aACzB,IAAMA,GAAUxL,EAAEsQ,IAAI9E,EAAQzP,GAAM,KAAM,IAAIuB,OAAM,gCAAgC6C,EACpF,IAAM2e,IACJ9f,QAAWyB,MAAO1D,KAAKojB,OAAQ9D,UAAU,EAAOxM,cAAc,EAAOC,YAAY,GAEjFyL,SAAY9a,MAAO+K,EAAQ6Q,UAAU,EAAOxM,cAAc,EAAMC,YAAY,GAC5E0L,MAAS/a,MAAO1E,EAAKsgB,UAAU,EAAOxM,cAAc,EAAOC,YAAY,GACvE2L,OAAUhb,MAAON,EAAMkc,UAAU,EAAOxM,cAAc,EAAOC,YAAY,GACzEzR,aACEoC,MAAS+K,EAAS,WAAG,MAAGA,GAAOzP,IAAO,WAAG,MAAGgB,GAAK4R,KAAKoB,MAAMoG,OAC5DkG,UAAY,EAAOxM,cAAc,EAAOC,YAAY,IAIhDlP,EAAS7D,KAAK2jB,SAAS7B,aAAa1e,EAAM2e,EAElD,OADA3c,QAASyN,iBAAiBhP,EAAQke,GACzBle,GAKXsf,GAAAhd,UAAE0d,sBAAqB,SAAChgB,GACtB,IAAe,WAAAxB,EAAA,EAAAC,EAAI8C,OAAO0b,oBAAoBjd,GAAOxB,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CACrD,GADSmH,GAAIlH,EAAAD,GACL2P,EAAa5M,OAAO2b,yBAAyBld,EAAQ2F,EACvDwI,GAAWc,cAAgBd,EAAWe,aAC1Cf,EAAae,YAAa,EACX,YAATvJ,IACJwI,EAAac,cAAe,EAC5Bd,EAAazF,IAAMrK,GAErBkD,OAASyZ,eAAehb,EAAQ2F,EAAMwI,IAG1C,GAAMnO,EAAOwe,eAAgB,CAC3B,IAAa,GAAAhV,GAAA,EAAAC,EAAIzJ,EAAOwe,eAAchV,EAAAC,EAAA/K,OAAA8K,GAAA,EAA/B,CAAA1M,GAAI2I,GAAEgE,EAAAD,EAA2B/D,GAAGtJ,EAAK4R,YACvC/N,GAAOwe,iBAIpBc,GAAAhd,UAAEof,eAAc,SAAC1hB,aACf,IAAQA,GAAUA,EAAO5B,OAAzB,CACA,GAAM4B,EAAOwb,aAEX,IAAa,GAAAhd,GAAA,EAAAC,EAAIW,EAAEuN,MAAM3M,EAAOwb,cAAahd,EAAAC,EAAAC,OAAAF,GAAA,EAAtC,CAAA1B,GAAI2I,GAAEhH,EAAAD,EAAkCiH,KAEjD,IAAO3I,GAAI3B,KAAO6E,GACTuB,OAAOvE,eAAegD,EAAQ7E,IACrC6J,EAAO0c,eAAe1hB,EAAO7E,MAIjCmkB,GAAAhd,UAAEsd,mBAAkB,SAACtJ,aAInB,IAHAlX,EAAIC,KAAKD,EAAEE,KAAKnD,KAAKujB,cAAe,SAAC/W,EAAapJ,GAC1C+W,EAAK3N,aAAeA,SAAoBxM,GAAKujB,aAAangB,KAE5D+W,EAAKzU,OAAQ,CACjB,GAAQ+I,GAASzO,KAAKilB,mBAAmB9K,EAAK/W,MAAM,EAC9CqL,IAAQzO,KAAKglB,YAAY7K,EAAK/W,KAAM+W,EAAKnb,IAAKmb,EAAKzW,MAAO+K,GAAQ,OAExEzO,MAAO0jB,OAAOvJ,EAAK/W,KAAM,MAAM,IAInC+f,GAAAhd,UAAE8e,mBAAkB,SAAC7hB,EAAMoiB,MACnB3hB,UACEzB,EAAWa,EAAEG,GAAMkR,MAAM,KAAKmR,YAAY/hB,OAWlD,OAVAT,GAAIC,KAAKd,EAAU,SAACI,EAASH,GAC3B,GAAQ+R,GAAW/U,EAAYmD,GACzBmM,EAAQyF,EAAWvQ,EAAOuQ,GAAYpU,EAAKuU,IACjD,KAAO5F,EAAO,CACZ,GAAQ+W,GAAetjB,EAAS1C,MAAM,EAAG2C,EAAI,GAAGO,KAAK,IACrD,IAAM4iB,GAAexlB,EAAKujB,aAAamC,GAAgB,KAAM,MAC7D/W,GAAU3O,EAAKglB,YAAYU,EAActR,KAAcvQ,GAEzDA,EAAW8K,IAEJ9K,GAGXsf,GAAAhd,UAAE6e,YAAW,SAAC5hB,EAAMpE,EAAK0E,EAAO+K,EAAQ+W,aACtC,IAAgB,OAAV9hB,GAA4BqC,SAAVrC,EACtB,KAAQ,IAAInD,OAAM,oCAAsCmD,EAE1D,KAAM8hB,IAAexlB,KAAKujB,aAAangB,GAAvC,CAEA,GADMM,IAAUyB,IAAkBzB,EAAQ1D,KAAKwjB,uBACxCvgB,EAAE8L,QAAQrL,KAAWT,EAAE0iB,SAASjiB,GAErC,WADA1D,MAAO4lB,qBAAqBnX,EAAQzP,EAAK0E,EAG3C,IAAMG,GAAS4K,EAAOzP,EAiBtB,OAhBiB+G,UAAXlC,IACJA,EAAW7D,KAAK4jB,cAAcxgB,EAAMpE,EAAKyP,GACzCzO,KAAO4lB,qBAAqBnX,EAAQzP,EAAK6E,GACzC7D,KAAO6jB,sBAAsBhgB,IAE/BZ,EAAIC,KAAKQ,EAAO,SAAC0H,EAAMya,GACrBhd,EAAOmc,YACL7iB,EAAWiB,EAAMyiB,GAAkBxmB,EAAYwmB,GAAkBza,EAAMvH,EAAQ2hB,KAEnFviB,EAAIC,KAAKW,EAAQ,SAACuH,EAAMgJ,GACtB,GAAQyR,GAAkB9mB,EAAUqV,EAC7B1Q,GAAM7C,eAAeglB,IAC1Bhd,EAAO6a,OAAOvhB,EAASiB,EAAMyiB,GAAkB,KAAML,KAGzDxlB,KAAO8jB,mBAAmBjgB,EAAQT,GACzBS,IAGXsf,GAAAhd,UAAE2d,mBAAkB,SAACjgB,EAAQT,aAC3BpD,MAAO2jB,SAASlB,wBAAwBrf,EAAM,SAACse,EAAYC,GACzD,GAAQ3iB,GAAMK,EAAYqiB,EACnB7d,GAAOhD,eAAe7B,IAC3B6J,EAAOmc,YAAY7iB,EAASiB,EAAMse,GAAa1iB,EAAK2iB,EAAa9d,MAKvEsf,GAAAhd,UAAEud,OAAM,SAACtgB,EAAM0iB,EAAuBN,GACpCM,EAA0BA,KAC1B,IAAQjiB,GAAS7D,KAAK4iB,WAAWxf,EAC1BS,KACD2hB,GAAexlB,KAAK+lB,sBAAsB3iB,EAAM0iB,IAC/C7iB,EAAEya,QAAQoI,IAA2B9lB,KAAKgmB,gBAAgBniB,IAG/D7D,KAAOimB,kBAAkBpiB,EAAQiiB,KAIrC3C,GAAAhd,UAAE4f,sBAAqB,SAAC3iB,EAAM0iB,aAC5B,KAAOnlB,GAAIulB,KAAkBlmB,MAAKujB,aAChC,GAAOvjB,EAAKujB,aAAa1iB,eAAeqlB,GAAxC,CACA,GAAM9iB,IAAS8iB,GAAqC,MAAnBA,GAC7BjjB,EAAII,WAAWD,EAAM8iB,EAAiB,KAAM,OAAO,CACvD,IAAe,MAAT9iB,GAAgBH,EAAEI,WAAW6iB,EAAgB9iB,EAAO,KAExD,IAAOzC,GADCyB,GAAW8jB,EAAe5R,MAAM,KAC7BjS,EAAID,EAASG,OAAQF,EAAI,EAAGA,IAAK,CAC1C,GAAQ4M,GAAU7M,EAAS1C,MAAM,EAAG2C,GAAGO,KAAK,KACpCqB,EAAS5B,IAAMD,EAASG,MAChC,IAAMujB,EAAsB7W,IAAY6W,EAAsB7W,KAAahL,EAAQ,KAEnF,IADA6hB,EAAwB7W,GAAWhL,EAC7BgL,IAAY7L,EAAM,SAMhC+f,GAAAhd,UAAE6f,gBAAe,SAACG,GAKhB,eAFMC,GAAU,EACVviB,EAASsiB,EACNtiB,GAAUA,IAAW7D,KAAKuU,MAAM,CACvC,IAAOvU,EAAK2jB,SAASpB,cAAc1e,EAAO6a,OAAQ,CAChD,GAAQ2H,GAAeD,EAAU,MAAQD,EAClCnmB,GAAKsmB,mBAAmBziB,EAAQwiB,KACrCD,GAAY,EACZvd,EAAO0d,wBAAwB1iB,EAAO2a,QAAS3a,EAAO4a,OAG1D5a,EAAWA,EAAO2a,QAEpB,MAAS4H,IAGXjD,GAAAhd,UAAEmgB,mBAAkB,SAACziB,EAAQwiB,aAC3B,SAAMA,IAAgBpjB,EAAEoR,SAASgS,EAAcxiB,QACzCZ,EAAEqN,KAAKzM,EAAQ,SAAAH,GAAM,OAAIA,EAAMzB,UAC5BgB,EAAEqN,KAAKzM,EAAQ,SAAAH,GAAM,MAAG1D,GAAKsmB,mBAAmB5iB,EAAO2iB,OAGlElD,GAAAhd,UAAE8f,kBAAiB,SAACpiB,EAAQiiB,aAC1B,IAAMA,EAAsBjiB,EAAO6a,OAAQ,OAAO,CAClD,IAAM8H,IAAyB,CAmB/B,OAlBAvjB,GAAIC,KAAKW,EAAQ,SAACH,EAAO1E,GACvB,GACMynB,GADAC,GAAe,CAEfZ,GAAsB3jB,EAAS0B,EAAO6a,MAAO3f,EAAUC,MAC3D0nB,GAAiB,EACjBD,GAAgB,GACL/iB,EAAMzB,SACXjC,EAAK2jB,SAASpB,cAAc7e,EAAMgb,QACtC+H,EAAgBzmB,EAAKimB,kBAAkBviB,EAAOoiB,GAC9CY,GAAiB,GACNzjB,EAAEsQ,IAAIuS,EAAuBpiB,EAAMgb,SAC9C+H,EAAgBzmB,EAAKimB,kBAAkBviB,GACvCgjB,GAAkBD,IAGhBC,GAAc1mB,EAAKumB,wBAAwB1iB,EAAQ7E,GACzDwnB,EAA2BA,GAA0BC,IAE9CD,GAGXrD,GAAAhd,UAAEyc,WAAU,SAAC+D,GAIX,IAAkB,GAHZ9iB,UACEzB,EAAWa,EAAEme,SAASuF,GAC5B1jB,EAAI0jB,GAAgBrS,MAAM,KAAK9Q,IAAInE,GAAaqE,QAAUijB,EAC1CtkB,EAAA,EAAAC,EAAIF,EAAQC,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CAC9B,GADSG,GAAOF,EAAAD,EAEhB,IADEwB,EAASrB,EAAUqB,EAAOrB,GAAWxC,EAAKuU,KAC3BxO,SAAXlC,EAAsB,OAE9B,MAASA,IAGXsf,GAAAhd,UAAEygB,+BAA8B,SAAC/iB,EAAQ7E,GACvC,GAAMgT,GAAa5M,OAAO2b,yBAAyBld,EAAQ7E,EAC3D,IAAMgT,EAAY,CAChB,IAAOA,EAAWe,WAChB,KAAQ,IAAIxS,OACV,wEACKsD,EAAY,MAAA,KAAK7E,EAE1B,KAAOgT,EAAWtQ,MAAQsQ,EAAWzF,IACnC,KAAQ,IAAIhM,OAAM,uBAAuBsD,EAAY,MAAA,KAAK7E,GAG9D,MAASgT,IAGXmR,GAAAhd,UAAEyf,qBAAoB,SAAC/hB,EAAQ7E,EAAK0E,GAClC,GAAMsO,GAAahS,KAAK4mB,+BAA+B/iB,EAAQ7E,EACzDgT,IACJhS,KAAOqjB,8BAA+B,EACtCxf,EAAS7E,GAAO0E,EAChB1D,KAAOqjB,8BAA+B,IAEtCxR,EAAMtF,IAAI1I,EAAQ7E,EAAK0E,GACvBsO,EAAe5M,OAAO2b,yBAAyBld,EAAQ7E,GACvDoG,OAASyZ,eAAehb,EAAQ7E,GAC9B0C,IAAOsQ,EAAWtQ,IAClB6K,IAAO,SAASnC,GACd,IAAOpK,KAAKqjB,6BACV,KAAQ,IAAI9iB,OAAM,6CAA6CvB,EAEjEgT,GAAazF,IAAI5K,KAAK3B,KAAMoK,IAE9B0I,cAAgB,EAAMC,YAAY,MAKxCoQ,GAAAhd,UAAEogB,wBAAuB,SAAC1iB,EAAQ7E,GAEhCgB,KAAO4mB,+BAA+B/iB,EAAQ7E,GAC9CgB,KAAOulB,eAAe1hB,EAAO7E,IAC7B6S,EAAMoC,OAAOpQ,EAAQ7E,IAGvBgJ,GAAE2W,sBAAgCjd,IAAA,WAChC,MAASke,GAAQjB,8FQ3enBhe,IAAIuE,IACE2hB,MAGe7hB,GAAM,SAWbwG,EAASqU,GAErB,IAAO3a,GACL,KAAQ,IAAI3E,OAAM,oEAEpBP,MAAOmZ,SAAW3N,EAAQtM,QAAQ,MAAO,IACzCc,KAAO8mB,cAAgB,GAAIrO,GAC3BzY,KAAOyb,YAAc,GAAInF,GAAWpR,IACpClF,KAAO4R,KAAO,GAAIC,GAElB7R,KAAO+mB,UAAY,GAAI7N,GAASlZ,KAAKmZ,SAAUjU,IAC/CE,OAASyZ,eAAe7e,KAAM,QAC5B0D,MAAS1D,KAAK+mB,UAAUxS,KAAM+K,UAAU,EAAOxM,cAAc,EAAOC,YAAY,IAGlF/S,KAAOqO,MAAQ,GAAI8U,IAAKnjB,KAAMA,KAAKmZ,SAAUjU,GAAQlF,KAAKyb,YAAaoE,GACvEza,OAASyZ,eAAe7e,KAAM,QAC5B0D,MAAS1D,KAAKqO,MAAMkG,KAAM+K,UAAU,EAAOxM,cAAc,EAAOC,YAAY,mFAIhF/N,IAAAmB,UAAEmM,QAAO,WACPtS,KAAO4R,KAAKmI,WACZ/Z,KAAOqO,MAAMiE,UACbtS,KAAO+mB,UAAUzU,WAGnBtM,GAAEoP,IAAO1T,IAAA,WAAI,MAAOyT,MAAKC,MAAQpV,KAAKgnB,KAAK1N,YAC3CtU,GAAAmB,UAAE8gB,OAAM,WAAI,MAAOjnB,MAAK8mB,cAAclO,kBAAkB5Y,KAAKoV,MAE7DpQ,GAAAmB,UAAE+gB,aAAY,SAACzc,aACb,OAASzK,MAAKyb,YAAY9D,QAAQ,OAAQ,GAAIjJ,GAAU1O,KAAKqO,MAAO,KAAM,WACxE,MAASnJ,IAAOiH,oBAAoBnM,EAAKmZ,SAAU1O,MAGvDzF,GAAAmB,UAAEghB,eAAc,qBACd,OAASnnB,MAAKyb,YAAY9D,QAAQ,OAAQ,GAAIjJ,GAAU1O,KAAKqO,MAAO,KAAM,WACxE,MAASnJ,IAAOoH,OAAOtM,EAAKmZ,aAIhCnU,GAAAmB,UAAEqQ,UAAS,SAAC4Q,EAAY1Q,GACtB,MAAS1W,MAAKyb,YAAYjF,UAAU4Q,EAAY1Q,IAIlD1R,GAAAmB,UAAEkhB,QAAO,SAACjW,EAAOC,GAMf,MALOA,KACLA,EAAgBD,EAChBA,EAAUrL,OACJsL,YAAuBnD,KAAQmD,GAAepO,EAAGoO,KAEhD,GAAIF,GAAUC,EAAOC,EAAarR,KAAKqO,MAAO,YAIzDrJ,GAAAmB,UAAEiJ,KAAI,SAACsG,EAAQ9V,aAEb,OADAA,GAAaD,EAAoBC,GACxB,GAAIC,SAAQ,SAACC,EAASK,GAC7B,GAAQiR,MACAkW,EAAY,GAAInW,GAAUC,GAAQ3P,OAAQiU,GAAS1V,EAAKqO,MAAO,QAC/DoE,EAAUzS,EAAK4R,KAAKsB,OAAO,WAAG,MAAGoU,GAAUxX,OAAO,SAAAA,GACjDA,IACP2C,IACA7S,EAAWwR,EAAM3P,QAAQqI,KAAK,SAAArI,GAC5B6lB,EAAYhV,UACZxS,EAAU2B,IACP,SAAAhB,GACH6mB,EAAYhV,UACZnS,EAASM,WAMjBuH,GAAE2W,sBAAgCjd,IAAA,WAAI,MAAO1B,MAAKqO,MAAMsQ,uBAExD3Z,GAAEuiB,cAAoB,SAAClhB,GACrB,GAAMnB,GAAQ,KAAM,IAAI3E,OAAM,2BAC9B,IAAM0C,EAAEme,SAAS/a,GAAY,CAC3B,GAAQmhB,GAAStjB,OAAOujB,cAAgBvjB,OAAOsjB,MAC/C,KAAOA,EAAQ,KAAM,IAAIjnB,OAAM,yCAC/B8F,GAAc,GAAImhB,GAAOnhB,GAG3B,MADAnB,IAAW,GAAIkB,GAAOC,GACbnB,GAAOwC,KAAKrB,GAAWyD,KAC9B,SAAGtE,MAACkiB,GAAoBliB,EAAAkiB,qBAAEC,EAAkBniB,EAAAmiB,kBAC1C3iB,IAAQ4iB,qBAAuBD,CAC/B,KAAe,GAAAtlB,GAAA,EAAAC,EAAIolB,EAAoBrlB,EAAAC,EAAAC,OAAAF,GAAA,EAAE,CACvC,GADSmH,GAAIlH,EAAAD,EACX2C,IAAM6iB,OAAOre,GAAQtE,GAAOqE,oBAAoBC,OAM1DxB,GAAE6f,OAAiBnmB,IAAA,WAAI,MAAOmlB,KAE9B7hB,GAAE8iB,UAAgB,SAACC,GACjB/iB,GAAQ6iB,OAAOE,GAAgB7iB,GAAOqE,oBAAoBwe,IAG5D/iB,GAAE+I,iBAAuB,WAAI,MAAO7I,IAAO6I,oBAC3C/I,GAAEkD,QAAc,WAAI,MAAOhD,IAAOgD,WAClClD,GAAEsD,4BAAkC,SAACC,EAAyBC,EAAuBC,GACnF,MAASvD,IAAOoD,4BACdC,EAA2BC,EAAuBC,IAGtDzD,GAAEgjB,sBAA4B,SAAC3jB,GAC7BqV,EAAuBtV,eAAeC,IAGxCW,GAAEjG,UAAgB,QAAAA,GAACC,GAAM,MAAOD,GAAUC,IAC1CgG,GAAE3F,YAAkB,QAAAA,GAACqiB,GAAa,MAAOriB,GAAYqiB,IAErD1Z,GAAE7C,iBAA2BzD,IAAA,WAAI,MAAOyD,4EAGxCuU,EAAqB3U,aAAaC","file":"firetruss.min.js","sourcesContent":["/* globals window */\n\nimport _ from 'lodash';\n\n\nlet earlyDigestPending;\nlet bareDigest = function() {\n  earlyDigestPending = true;\n};\n\nconst angularProxy = {\n  active: typeof window !== 'undefined' && window.angular,\n  debounceDigest(wait) {\n    if (wait) {\n      angularProxy.digest = _.debounce(bareDigest, wait);\n    } else {\n      angularProxy.digest = bareDigest;\n    }\n  }\n};\n['digest', 'defineModule'].forEach(method => {angularProxy[method] = noop;});\n\nif (angularProxy.active) {\n  angularProxy.digest = bareDigest;\n  window.angular.module('firetruss', []).run(['$rootScope', function($rootScope) {\n    bareDigest = $rootScope.$evalAsync.bind($rootScope);\n    if (earlyDigestPending) bareDigest();\n  }]);\n  angularProxy.defineModule = function(Truss) {\n    window.angular.module('firetruss').constant('Truss', Truss);\n  };\n}\n\nfunction noop() {}\n\nexport default angularProxy;\n","export function escapeKey(key) {\n  if (!key) return key;\n  return key.toString().replace(/[\\\\\\.\\$\\#\\[\\]\\/]/g, function(char) {\n    return '\\\\' + char.charCodeAt(0).toString(16);\n  });\n}\n\nexport function unescapeKey(key) {\n  if (!key) return key;\n  return key.toString().replace(/\\\\[0-9a-f]{2}/gi, function(code) {\n    return String.fromCharCode(parseInt(code.slice(1), 16));\n  });\n}\n\nexport function wrapPromiseCallback(callback) {\n  return function() {\n    try {\n      return Promise.resolve(callback.apply(this, arguments));\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n}\n\nexport const SERVER_TIMESTAMP = Object.freeze({'.sv': 'timestamp'});\n","/* global setImmediate */\n\nimport {unescapeKey} from './utils.js';\n\n// jshint browser:true\n\nlet bridge;\n\n\nclass Snapshot {\n  constructor({path, value, valueError, exists}) {\n    this._path = path;\n    this._value = value;\n    this._valueError = errorFromJson(valueError);\n    this._exists = value === undefined ? exists || false : value !== null;\n  }\n\n  get path() {\n    return this._path;\n  }\n\n  get exists() {\n    return this._exists;\n  }\n\n  get value() {\n    this._checkValue();\n    return this._value;\n  }\n\n  get key() {\n    if (this._key === undefined) this._key = unescapeKey(this._path.replace(/.*\\//, ''));\n    return this._key;\n  }\n\n  _checkValue() {\n    if (this._valueError) throw this._valueError;\n    if (this._value === undefined) throw new Error('Value omitted from snapshot');\n  }\n}\n\n\nexport default class Bridge {\n  constructor(webWorker) {\n    this._idCounter = 0;\n    this._deferreds = {};\n    this._suspended = false;\n    this._servers = {};\n    this._callbacks = {};\n    this._simulatedTokenGenerator = null;\n    this._maxSimulationDuration = 5000;\n    this._simulatedCallFilter = null;\n    this._inboundMessages = [];\n    this._outboundMessages = [];\n    this._flushMessageQueue = this._flushMessageQueue.bind(this);\n    this._port = webWorker.port || webWorker;\n    this._shared = !!webWorker.port;\n    this._port.onmessage = this._receive.bind(this);\n    window.addEventListener('unload', () => {this._send({msg: 'destroy'});});\n    setInterval(() => {this._send({msg: 'ping'});}, 60 * 1000);\n  }\n\n  static init(webWorker) {\n    const items = [];\n    try {\n      const storage = window.localStorage || window.sessionStorage;\n      if (!storage) return;\n      for (let i = 0; i < storage.length; i++) {\n        const key = storage.key(i);\n        items.push({key, value: storage.getItem(key)});\n      }\n    } catch (e) {\n      // Some browsers don't like us accessing local storage -- nothing we can do.\n    }\n    return this._send({msg: 'init', storage: items});\n  }\n\n  static get instance() {\n    if (!bridge) throw new Error('No web worker connected, please call Truss.connectWorker first');\n    return bridge;\n  }\n\n  suspend(suspended) {\n    if (suspended === undefined) suspended = true;\n    if (this._suspended === suspended) return;\n    this._suspended = suspended;\n    if (!suspended) {\n      this._receiveMessages(this._inboundMessages);\n      this._inboundMessages = [];\n      if (this._outboundMessages.length) setImmediate(this._flushMessageQueue);\n    }\n  }\n\n  debugPermissionDeniedErrors(simulatedTokenGenerator, maxSimulationDuration, callFilter) {\n    this._simulatedTokenGenerator = simulatedTokenGenerator;\n    if (maxSimulationDuration !== undefined) this._maxSimulationDuration = maxSimulationDuration;\n    this._simulatedCallFilter = callFilter || function() {return true;};\n  }\n\n  _send(message) {\n    message.id = ++this._idCounter;\n    let promise;\n    if (message.oneWay) {\n      promise = Promise.resolve();\n    } else {\n      promise = new Promise((resolve, reject) => {\n        this._deferreds[message.id] = {resolve, reject};\n      });\n      const deferred = this._deferreds[message.id];\n      deferred.promise = promise;\n      promise.sent = new Promise(resolve => {\n        deferred.resolveSent = resolve;\n      });\n      deferred.params = message;\n    }\n    if (!this._outboundMessages.length && !this._suspended) setImmediate(this._flushMessageQueue);\n    this._outboundMessages.push(message);\n    return promise;\n  }\n\n  _flushMessageQueue() {\n    this._port.postMessage(this._outboundMessages);\n    this._outboundMessages = [];\n  }\n\n  _receive(event) {\n    if (this._suspended) {\n      this._inboundMessages = this._inboundMessages.concat(event.data);\n    } else {\n      this._receiveMessages(event.data);\n    }\n  }\n\n  _receiveMessages(messages) {\n    for (let message of messages) {\n      const fn = this[message.msg];\n      if (typeof fn !== 'function') throw new Error('Unknown message: ' + message.msg);\n      fn.call(this, message);\n    }\n  }\n\n  bindExposedFunction(name) {\n    return (function() {\n      return this._send({msg: 'call', name, args: Array.prototype.slice.call(arguments)});\n    }).bind(this);\n  }\n\n  resolve(message) {\n    const deferred = this._deferreds[message.id];\n    if (!deferred) throw new Error('Received resolution to inexistent Firebase call');\n    delete this._deferreds[message.id];\n    deferred.resolve(message.result);\n  }\n\n  reject(message) {\n    const deferred = this._deferreds[message.id];\n    if (!deferred) throw new Error('Received rejection of inexistent Firebase call');\n    delete this._deferreds[message.id];\n    deferred.reject(errorFromJson(message.error, deferred.params));\n  }\n\n  probeError(error) {\n    const code = error.code || error.message;\n    if (error.params && code && code.toLowerCase() === 'permission_denied') {\n      return this._simulateCall(error.params).then(securityTrace => {\n        if (securityTrace) error.permissionDeniedDetails = securityTrace;\n      });\n    } else {\n      return Promise.resolve();\n    }\n  }\n\n  _simulateCall(props) {\n    if (!(this._simulatedTokenGenerator && this._maxSimulationDuration > 0)) {\n      return Promise.resolve();\n    }\n    let simulatedCalls = [];\n    switch (props.msg) {\n      case 'set':\n        simulatedCalls.push({method: 'set', url: props.url, args: [props.value]});\n        break;\n      case 'update':\n        simulatedCalls.push({method: 'update', url: props.url, args: [props.value]});\n        break;\n      case 'on':\n        simulatedCalls.push({method: 'once', url: props.url, spec: props.spec, args: ['value']});\n        break;\n      case 'transaction':\n        simulatedCalls.push({method: 'once', url: props.url, args: ['value']});\n        simulatedCalls.push({method: 'set', url: props.url, args: [props.newValue]});\n        break;\n    }\n    if (!simulatedCalls.length || !this._simulatedCallFilter(props.msg, props.url)) {\n      return Promise.resolve();\n    }\n    const auth = this.getAuth(getUrlRoot(props.url));\n    const simulationPromise = this._simulatedTokenGenerator(auth && auth.uid).then(token => {\n      return Promise.all(simulatedCalls.map(message => {\n        message.msg = 'simulate';\n        message.token = token;\n        return this._send(message);\n      }));\n    }).then(securityTraces => {\n      if (securityTraces.every(trace => trace === null)) {\n        return 'Unable to reproduce error in simulation';\n      }\n      return securityTraces.filter(trace => trace).join('\\n\\n');\n    }).catch(e => {\n      return 'Error running simulation: ' + e;\n    });\n    const timeoutPromise = new Promise(resolve => {\n      setTimeout(resolve.bind(null, 'Simulated call timed out'), this._maxSimulationDuration);\n    });\n    return Promise.race([simulationPromise, timeoutPromise]);\n  }\n\n  updateLocalStorage(items) {\n    try {\n      const storage = window.localStorage || window.sessionStorage;\n      for (let item in items) {\n        if (item.value === null) {\n          storage.removeItem(item.key);\n        } else {\n          storage.setItem(item.key, item.value);\n        }\n      }\n    } catch (e) {\n      // If we're denied access, there's nothing we can do.\n    }\n  }\n\n  trackServer(rootUrl) {\n    if (this._servers.hasOwnProperty(rootUrl)) return;\n    const server = this._servers[rootUrl] = {authListeners: []};\n    const authCallbackId = this._registerCallback(this._authCallback.bind(this, server));\n    this._send({msg: 'onAuth', url: rootUrl, callbackId: authCallbackId});\n  }\n\n  _authCallback(server, auth) {\n    server.auth = auth;\n    for (let listener of server.authListeners) listener(auth);\n  }\n\n  onAuth(rootUrl, callback, context) {\n    const listener = callback.bind(context);\n    listener.callback = callback;\n    listener.context = context;\n    this._servers[rootUrl].authListeners.push(listener);\n    listener(this.getAuth(rootUrl));\n  }\n\n  offAuth(rootUrl, callback, context) {\n    const authListeners = this._servers[rootUrl].authListeners;\n    for (let i = 0; i < authListeners.length; i++) {\n      const listener = authListeners[i];\n      if (listener.callback === callback && listener.context === context) {\n        authListeners.splice(i, 1);\n        break;\n      }\n    }\n  }\n\n  getAuth(rootUrl) {\n    return this._servers[rootUrl].auth;\n  }\n\n  authWithCustomToken(url, authToken, options) {\n    return this._send({msg: 'authWithCustomToken', url, authToken, options});\n  }\n\n  unauth(url) {\n    return this._send({msg: 'unauth', url});\n  }\n\n  set(url, value, writeSerial) {return this._send({msg: 'set', url, value, writeSerial});}\n  update(url, value, writeSerial) {return this._send({msg: 'update', url, value, writeSerial});}\n\n  on(listenerKey, url, spec, eventType, snapshotCallback, cancelCallback, context, options) {\n    const handle = {\n      listenerKey, eventType, snapshotCallback, cancelCallback, context,\n      params: {msg: 'on', listenerKey, url, spec, eventType, options}\n    };\n    const callback = this._onCallback.bind(this, handle);\n    this._registerCallback(callback, handle);\n    // Keep multiple IDs to allow the same snapshotCallback to be reused.\n    snapshotCallback.__callbackIds = snapshotCallback.__callbackIds || [];\n    snapshotCallback.__callbackIds.push(handle.id);\n    this._send({\n      msg: 'on', listenerKey, url, spec, eventType, callbackId: handle.id, options\n    }).catch(error => {\n      callback(error);\n    });\n  }\n\n  off(listenerKey, url, spec, eventType, snapshotCallback, context) {\n    const idsToDeregister = [];\n    let callbackId;\n    if (snapshotCallback) {\n      callbackId = this._findAndRemoveCallbackId(\n        snapshotCallback,\n        handle =>\n          handle.listenerKey === listenerKey && handle.eventType === eventType &&\n          handle.context === context\n      );\n      if (!callbackId) return Promise.resolve();  // no-op, never registered or already deregistered\n      idsToDeregister.push(callbackId);\n    } else {\n      for (let id of Object.keys(this._callbacks)) {\n        const handle = this._callbacks[id];\n        if (handle.listenerKey === listenerKey && (!eventType || handle.eventType === eventType)) {\n          idsToDeregister.push(id);\n        }\n      }\n    }\n    // Nullify callbacks first, then deregister after off() is complete.  We don't want any\n    // callbacks in flight from the worker to be invoked while the off() is processing, but we don't\n    // want them to throw an exception either.\n    for (let id of idsToDeregister) this._nullifyCallback(id);\n    return this._send({msg: 'off', listenerKey, url, spec, eventType, callbackId}).then(() => {\n      for (let id of idsToDeregister) this._deregisterCallback(id);\n    });\n  }\n\n  _onCallback(handle, error, snapshotJson) {\n    if (error) {\n      this._deregisterCallback(handle.id);\n      const e = errorFromJson(error, handle.params);\n      if (handle.cancelCallback) {\n        handle.cancelCallback.call(handle.context, e);\n      } else {\n        console.error(e);\n      }\n    } else {\n      handle.snapshotCallback.call(handle.context, new Snapshot(snapshotJson));\n    }\n  }\n\n  transaction(url, oldValue, relativeUpdates) {\n    return this._send({msg: 'transaction', url, oldValue, relativeUpdates});\n  }\n\n  onDisconnect(url, method, value) {\n    return this._send({msg: 'onDisconnect', url, method, value});\n  }\n\n  bounceConnection() {\n    return this._send({msg: 'bounceConnection'});\n  }\n\n  callback({id, args}) {\n    const handle = this._callbacks[id];\n    if (!handle) throw new Error('Unregistered callback: ' + id);\n    handle.callback.apply(null, args);\n  }\n\n  _registerCallback(callback, handle) {\n    handle = handle || {};\n    handle.callback = callback;\n    handle.id = `cb${++this._idCounter}`;\n    this._callbacks[handle.id] = handle;\n    return handle.id;\n  }\n\n  _nullifyCallback(id) {\n    this._callbacks[id].callback = noop;\n  }\n\n  _deregisterCallback(id) {\n    delete this._callbacks[id];\n  }\n\n  _findAndRemoveCallbackId(callback, predicate) {\n    if (!callback.__callbackIds) return;\n    let i = 0;\n    while (i < callback.__callbackIds.length) {\n      const id = callback.__callbackIds[i];\n      const handle = this._callbacks[id];\n      if (!handle) {\n        callback.__callbackIds.splice(i, 1);\n        continue;\n      }\n      if (predicate(handle)) {\n        callback.__callbackIds.splice(i, 1);\n        return id;\n      }\n      i += 1;\n    }\n  }\n}\n\n\nfunction noop() {}\n\nfunction errorFromJson(json, params) {\n  if (!json || json instanceof Error) return json;\n  const error = new Error(json.message);\n  error.params = params;\n  for (let propertyName in json) {\n    if (propertyName === 'message' || !json.hasOwnProperty(propertyName)) continue;\n    try {\n      error[propertyName] = json[propertyName];\n    } catch (e) {\n      e.extra = {propertyName};\n      throw e;\n    }\n  }\n  return error;\n}\n\nfunction getUrlRoot(url) {\n  const k = url.indexOf('/', 8);\n  return k >= 8 ? url.slice(0, k) : url;\n}\n","import Reference from './Reference.js';\nimport {unescapeKey} from './utils.js';\n\nimport _ from 'lodash';\nimport performanceNow from 'performance-now';\n\n// These are defined separately for each object so they're not included in Value below.\nconst RESERVED_VALUE_PROPERTY_NAMES = {$truss: true, $parent: true, $key: true, $path: true};\n\nconst computedPropertyStats = {};\n\n\nclass Value {\n  get $ref() {\n    Object.defineProperty(this, '$ref', {value: new Reference(this.$truss._tree, this.$path)});\n  }\n  get $refs() {return [this.$ref];}\n  get $keys() {return _.keys(this);}\n  get $values() {return _.values(this);}\n  get $root() {return this.$truss.root;}  // access indirectly to leave dependency trace\n\n  $watch(subjectFn, callbackFn) {\n    let done = false;\n    let unwatchAndRemoveDestructor = () => {done = true;};\n\n    const unwatch = this.$truss._tree._vue.$watch(() => {\n      if (done) return;\n      this.$$touchThis();\n      return subjectFn();\n    }, (newValue, oldValue) => {\n      if (done) return;\n      callbackFn.call(this, newValue, oldValue, unwatchAndRemoveDestructor);\n    }, {immediate: true});\n\n    if (done) {\n      unwatch();\n      return _.noop;\n    }\n\n    if (!this.$$finalizers) {\n      Object.defineProperty(this, '$$finalizers', {\n        value: [], writable: false, enumerable: false, configurable: false});\n    }\n    unwatchAndRemoveDestructor = () => {\n      if (done) return;\n      done = true;\n      unwatch();\n      _.pull(this.$$finalizers, unwatchAndRemoveDestructor);\n    };\n    this.$$finalizers.push(unwatchAndRemoveDestructor);\n    return unwatchAndRemoveDestructor;\n  }\n\n  $set(value) {return this.$ref.set(value);}\n  $update(values) {return this.$ref.update(values);}\n  $commit(options, updateFn) {return this.$ref.commit(options, updateFn);}\n  // TODO\n  // $temporarilyOverride(updateFn)\n  // $onPropertyChange(method)\n  // $freezeProperty\n}\n\nclass ComputedPropertyStats {\n  constructor(name) {\n    _.extend(this, {name, numRecomputes: 0, numUpdates: 0, runtime: 0});\n  }\n}\n\n\nexport default class Modeler {\n  constructor(classes) {\n    this._mounts = _(classes).uniq().map(Class => this._mountClass(Class)).flatten().value();\n    const patterns = _.map(this._mounts, mount => mount.regex.toString());\n    if (patterns.length !== _.uniq(patterns).length) {\n      const badPaths = _(patterns)\n        .groupBy()\n        .map((group, key) =>\n          group.length === 1 ? null : key.replace(/\\(\\[\\^\\/\\]\\+\\)/g, '$').slice(1, -1))\n        .compact()\n        .value();\n      throw new Error('Paths have multiple mounted classes: ' + badPaths.join(', '));\n    }\n  }\n\n  destroy() {\n  }\n\n  _augmentClass(Class) {\n    let computedProperties;\n    let proto = Class.prototype;\n    while (proto && proto.constructor !== Object) {\n      for (let name of Object.getOwnPropertyNames(proto)) {\n        const descriptor = Object.getOwnPropertyDescriptor(proto, name);\n        if (name.charAt(0) === '$') {\n          if (_.isEqual(descriptor, Object.getOwnPropertyDescriptor(Value.prototype, name))) {\n            continue;\n          }\n          throw new Error(`Property names starting with \"$\" are reserved: ${Class.name}.${name}`);\n        }\n        if (descriptor.set) {\n          throw new Error(`Computed properties must not have a setter: ${Class.name}.${name}`);\n        }\n        if (descriptor.get && !(computedProperties && computedProperties[name])) {\n          (computedProperties || (computedProperties = {}))[name] = {\n            name, fullName: `${proto.constructor.name}.${name}`, get: descriptor.get\n          };\n        }\n      }\n      proto = Object.getPrototypeOf(proto);\n    }\n    for (let name of Object.getOwnPropertyNames(Value.prototype)) {\n      if (name === 'constructor' || Class.prototype.hasOwnProperty(name)) continue;\n      Object.defineProperty(\n        Class.prototype, name, Object.getOwnPropertyDescriptor(Value.prototype, name));\n    }\n    return computedProperties;\n  }\n\n  _mountClass(Class) {\n    const computedProperties = this._augmentClass(Class);\n    let mounts = Class.$trussMount;\n    if (!mounts) throw new Error(`Class ${Class.name} lacks a $trussMount static property`);\n    if (!_.isArray(mounts)) mounts = [mounts];\n    return _.map(mounts, mount => {\n      if (_.isString(mount)) mount = {path: mount};\n      const variables = [];\n      const pathTemplate = mount.path.replace(/\\/\\$[^\\/]+/g, match => {\n        variables.push(match.slice(1));\n        return '\\u0001';\n      }).replace(/[$-.?[-^{|}]/g, '\\\\$&');\n      for (let variable of variables) {\n        if (variable === '$' || variable.charAt(1) === '$') {\n          throw new Error(`Invalid variable name: ${variable}`);\n        }\n        if (variable.charAt(0) === '$' && (\n            _.has(Value.prototype, variable) || RESERVED_VALUE_PROPERTY_NAMES[variable]\n        )) {\n          throw new Error(`Variable name conflicts with built-in property or method: ${variable}`);\n        }\n      }\n      return {\n        klass: Class, variables, computedProperties,\n        escapedKey: mount.path.match(/\\/([^/]*)$/)[1],\n        placeholder: mount.placeholder,\n        regex: new RegExp('^' + pathTemplate.replace(/\\u0001/g, '/([^/]+)') + '$'),\n        parentRegex: new RegExp(\n          '^' + (pathTemplate.replace(/\\/[^/]*$/, '').replace(/\\u0001/g, '/([^/]+)') || '/') + '$')\n      };\n    });\n  }\n\n  /**\n   * Creates a Truss object and sets all its basic properties: path segment variables, user-defined\n   * properties, and computed properties.  The latter two will be enumerable so that Vue will pick\n   * them up and make the reactive, so you should call _completeCreateObject once it's done so and\n   * before any Firebase properties are added.\n   */\n  createObject(path, properties) {\n    let Class = Value;\n    let computedProperties;\n    for (let mount of this._mounts) {\n      mount.regex.lastIndex = 0;\n      var match = mount.regex.exec(path);\n      if (match) {\n        Class = mount.klass;\n        computedProperties = mount.computedProperties;\n        for (let i = 0; i < mount.variables.length; i++) {\n          properties[mount.variables[i]] = {\n            value: unescapeKey(match[i + 1]),\n            writable: false, configurable: false, enumerable: false\n          };\n        }\n        break;\n      }\n    }\n\n    const object = new Class();\n\n    if (computedProperties) {\n      _.each(computedProperties, prop => {\n        properties[prop.name] = this._buildComputedPropertyDescriptor(object, prop);\n      });\n    }\n\n    return object;\n  }\n\n  _buildComputedPropertyDescriptor(object, prop) {\n    if (!computedPropertyStats[prop.fullName]) {\n      Object.defineProperty(computedPropertyStats, prop.fullName, {\n        value: new ComputedPropertyStats(prop.fullName), writable: false, enumerable: true,\n        configurable: false\n      });\n    }\n    const stats = computedPropertyStats[prop.fullName];\n\n    let value;\n    let writeAllowed = false;\n    let firstCallback = true;\n\n    if (!object.$$finalizers) {\n      Object.defineProperty(object, '$$finalizers', {\n        value: [], writable: false, enumerable: false, configurable: false});\n    }\n    if (!object.$$initializers) {\n      Object.defineProperty(object, '$$initializers', {\n        value: [], writable: false, enumerable: false, configurable: true});\n    }\n    object.$$initializers.push(vue => {\n      object.$$finalizers.push(\n        vue.$watch(computeValue.bind(object, prop, stats), newValue => {\n          if (firstCallback) {\n            stats.numUpdates += 1;\n            value = newValue;\n            firstCallback = false;\n          } else {\n            if (_.isEqual(value, newValue, isTrussValueEqual)) return;\n            stats.numUpdates += 1;\n            writeAllowed = true;\n            object[prop.name] = newValue;\n            writeAllowed = false;\n          }\n        }, {immediate: true})  // use immediate:true since watcher will run computeValue anyway\n      );\n    });\n    return {\n      enumerable: true, configurable: true,\n      get: function() {return value;},\n      set: function(newValue) {\n        if (!writeAllowed) throw new Error(`You cannot set a computed property: ${prop.name}`);\n        value = newValue;\n      }\n    };\n  }\n\n  isPlaceholder(path) {\n    // TODO: optimize by precomputing a single all-placeholder-paths regex\n    return _.some(this._mounts, mount => mount.placeholder && mount.regex.test(path));\n  }\n\n  forEachPlaceholderChild(path, iteratee) {\n    _.each(this._mounts, mount => {\n      if (mount.placeholder && mount.parentRegex.test(path)) {\n        iteratee(mount.escapedKey, mount.placeholder);\n      }\n    });\n  }\n\n  static get computedPropertyStats() {\n    return computedPropertyStats;\n  }\n}\n\n\nfunction computeValue(prop, stats) {\n  // jshint validthis: true\n  // Touch this object, since a failed access to a missing property doesn't get captured as a\n  // dependency.\n  this.$$touchThis();\n\n  const startTime = performanceNow();\n  const result = prop.get.call(this);\n  stats.runtime += performanceNow() - startTime;\n  stats.numRecomputes += 1;\n  return result;\n  // jshint validthis: false\n}\n\nfunction isTrussValueEqual(a, b) {\n  if (a && a.$truss || b && b.$truss) return a === b;\n}\n","import angularCompatibility from './angularCompatibility.js';\nimport Coupler from './Coupler.js';\nimport Modeler from './Modeler.js';\nimport {escapeKey, unescapeKey, SERVER_TIMESTAMP} from './utils.js';\n\nimport _ from 'lodash';\nimport Vue from 'vue';\n\n\nclass Transaction {\n  constructor(path, tree) {\n    this._path = path;\n    this._tree = tree;\n  }\n\n  get currentValue() {return this._tree._getObject(this._path);}\n  get outcome() {return this._outcome;}\n  get values() {return this._values;}\n\n  _setOutcome(value) {\n    if (this._outcome) throw new Error('Transaction already resolved with ' + this._outcome);\n    this._outcome = value;\n  }\n\n  abort() {\n    this._setOutcome('abort');\n  }\n\n  cancel() {\n    this._setOutcome('cancel');\n  }\n\n  set(value) {\n    if (value === undefined) throw new Error('Invalid argument: undefined');\n    this._setOutcome('set');\n    this._values = {'': value};\n  }\n\n  update(values) {\n    if (values === undefined) throw new Error('Invalid argument: undefined');\n    if (_.isEmpty(values)) return this.cancel();\n    this._setOutcome('update');\n    this._values = values;\n  }\n}\n\n\nexport default class Tree {\n  constructor(truss, rootUrl, bridge, dispatcher, classes) {\n    this._truss = truss;\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._dispatcher = dispatcher;\n    this._firebasePropertyEditAllowed = false;\n    this._writeSerial = 0;\n    this._localWrites = {};\n    this._localWriteTimestamp = null;\n    this._coupler = new Coupler(\n      rootUrl, bridge, dispatcher, this._integrateSnapshot.bind(this), this._prune.bind(this));\n    this._vue = new Vue({data: {$root: undefined}});\n    if (angularCompatibility.active) {\n      this._vue.$watch('$data', angularCompatibility.digest, {deep: true});\n    }\n    this._modeler = new Modeler(classes);\n    this._vue.$data.$root = this._createObject('/', '');\n    this._completeCreateObject(this.root);\n    this._plantPlaceholders(this.root, '/');\n  }\n\n  get root() {\n    return this._vue.$data.$root;\n  }\n\n  get truss() {\n    return this._truss;\n  }\n\n  destroy() {\n    this._coupler.destroy();\n    this._modeler.destroy();\n    this._vue.$destroy();\n  }\n\n  connectReference(ref, valueCallback, method) {\n    this._checkHandle(ref);\n    const operation = this._dispatcher.createOperation('read', method, ref);\n    let unwatch;\n    if (valueCallback) {\n      const segments = _(ref.path).split('/').map(segment => unescapeKey(segment)).value();\n      unwatch = this._vue.$watch(this._getObject.bind(segments), valueCallback);\n    }\n    operation._disconnect = this._disconnectReference.bind(this, ref, operation, unwatch);\n    this._dispatcher.begin(operation).then(() => {\n      if (operation.running) this._coupler.couple(ref.path, operation);\n    }).catch(e => {});  // ignore exception, let onFailure handlers deal with it\n    return operation._disconnect;\n  }\n\n  _disconnectReference(ref, operation, unwatch, error) {\n    if (operation._disconnected) return;\n    operation._disconnected = true;\n    if (unwatch) unwatch();\n    this._coupler.decouple(ref.path, operation);  // will call back to _prune if necessary\n    this._dispatcher.end(operation, error).catch(e => {});\n  }\n\n  isReferenceReady(ref) {\n    this._checkHandle(ref);\n    return this._coupler.isSubtreeReady(ref.path);\n  }\n\n  connectQuery(query, keysCallback, method) {\n    this._checkHandle(query);\n    const operation = this._dispatcher.createOperation('read', method, query);\n    operation._disconnect = this._disconnectQuery.bind(this, query, operation);\n    this._dispatcher.begin(operation).then(() => {\n      if (operation.running) this._coupler.subscribe(query, operation, keysCallback);\n    }).catch(e => {});  // ignore exception, let onFailure handlers deal with it\n    return operation._disconnect;\n  }\n\n  _disconnectQuery(query, operation, error) {\n    if (operation._disconnected) return;\n    operation._disconnected = true;\n    this._coupler.unsubscribe(query, operation);  // will call back to _prune if necessary\n    this._dispatcher.end(operation, error).catch(e => {});\n  }\n\n  isQueryReady(query) {\n    return this._coupler.isQueryReady(query);\n  }\n\n  _checkHandle(handle) {\n    if (!handle.belongsTo(this._truss)) {\n      throw new Error('Reference belongs to another Truss instance');\n    }\n  }\n\n  update(ref, method, values) {\n    const numValues = _.size(values);\n    if (!numValues) return;\n    if (method === 'update') checkUpdateHasOnlyDescendantsWithNoOverlap(ref.path, values);\n    this._applyLocalWrite(values);\n    const url = this.rootUrl + this._extractCommonPathPrefix(values);\n    return this._dispatcher.execute('write', method, ref, () => {\n      if (numValues === 1) {\n        return this._bridge.set(url, values[''], this._writeSerial);\n      } else {\n        return this._bridge.update(url, values, this._writeSerial);\n      }\n    });\n  }\n\n  commit(ref, updateFunction) {\n    let tries = 0;\n\n    const attemptTransaction = () => {\n      if (tries++ >= 25) return Promise.reject(new Error('maxretry'));\n      const txn = new Transaction();\n      try {\n        updateFunction(txn);\n      } catch (e) {\n        return Promise.reject(e);\n      }\n      const oldValue = toFirebaseJson(this._getObject(ref.path));\n      switch (txn.outcome) {\n        case 'abort': return;\n        case 'cancel':\n          break;\n        case 'set':\n          this._applyLocalWrite({[ref.path]: txn.values['']});\n          break;\n        case 'update':\n          checkUpdateHasOnlyDescendantsWithNoOverlap(ref.path, txn.values, true);\n          this._applyLocalWrite(txn.values);\n          break;\n        default:\n          throw new Error('Invalid transaction outcome: ' + (txn.outcome || 'none'));\n      }\n      return this._bridge.transaction(\n        this._rootUrl + ref.path, oldValue, txn.values\n      ).then(committed => {\n        if (!committed) return attemptTransaction();\n      });\n    };\n\n    return this._truss.peek(ref, () => {\n      return this._dispatcher.execute('write', 'commit', ref, attemptTransaction);\n    });\n  }\n\n  _applyLocalWrite(values) {\n    // TODO: correctly apply local writes that impact queries.  Currently, a local write will update\n    // any objects currently selected by a query, but won't add or remove results.\n    this._writeSerial++;\n    this._localWriteTimestamp = this._truss.now();\n    _.each(values, (value, path) => {\n      const coupledDescendantPaths = this._coupler.findCoupledDescendantPaths(path);\n      if (_.isEmpty(coupledDescendantPaths)) return;\n      const offset = (path === '/' ? 0 : path.length) + 1;\n      for (let descendantPath of coupledDescendantPaths) {\n        const subPath = descendantPath.slice(offset);\n        let subValue = value;\n        if (subPath) {\n          const segments = subPath.split('/');\n          for (let segment of segments) {\n            subValue = subValue[unescapeKey(segment)];\n            if (subValue === undefined) break;\n          }\n        }\n        if (subValue === undefined || subValue === null) {\n          this._prune(subPath);\n        } else {\n          const key = unescapeKey(_.last(descendantPath.split('/')));\n          this._plantValue(descendantPath, key, subValue, this._scaffoldAncestors(descendantPath));\n        }\n        this._localWrites[descendantPath] = this._writeSerial;\n      }\n    });\n  }\n\n  _extractCommonPathPrefix(values) {\n    let prefixSegments;\n    _.each(values, (value, path) => {\n      const segments = path === '/' ? [] : path.split('/');\n      if (prefixSegments) {\n        let firstMismatchIndex = 0;\n        const maxIndex = Math.min(prefixSegments.length, segments.length);\n        while (firstMismatchIndex < maxIndex &&\n               prefixSegments[firstMismatchIndex] === segments[firstMismatchIndex]) {\n          firstMismatchIndex++;\n        }\n        prefixSegments = prefixSegments.slice(0, firstMismatchIndex);\n        if (!prefixSegments.length) return false;\n      } else {\n        prefixSegments = segments;\n      }\n    });\n    const pathPrefix = '/' + prefixSegments.join('/');\n    _.each(_.keys(values), key => {\n      values[key.slice(pathPrefix.length + 1)] = values[key];\n      delete values[key];\n    });\n    return pathPrefix;\n  }\n\n  /**\n   * Creates a Truss object and sets all its basic properties: path segment variables, user-defined\n   * properties, and computed properties.  The latter two will be enumerable so that Vue will pick\n   * them up and make the reactive, so you should call _completeCreateObject once it's done so and\n   * before any Firebase properties are added.\n   */\n  _createObject(path, key, parent) {\n    if (parent && _.has(parent, key)) throw new Error(`Duplicate object created for ${path}`);\n    let properties = {\n      $truss: {value: this._truss, writable: false, configurable: false, enumerable: false},\n      // We want Vue to wrap this; we'll make it non-enumerable in _completeCreateObject.\n      $parent: {value: parent, writable: false, configurable: true, enumerable: true},\n      $key: {value: key, writable: false, configurable: false, enumerable: false},\n      $path: {value: path, writable: false, configurable: false, enumerable: false},\n      $$touchThis: {\n        value: parent ? () => parent[key] : () => this._vue.$data.$root,\n        writable: false, configurable: false, enumerable: false\n      }\n    };\n\n    const object = this._modeler.createObject(path, properties);\n    Object.defineProperties(object, properties);\n    return object;\n  }\n\n  // To be called on the result of _createObject after it's been inserted into the _vue hierarchy\n  // and Vue has had a chance to initialize it.\n  _completeCreateObject(object) {\n    for (let name of Object.getOwnPropertyNames(object)) {\n      const descriptor = Object.getOwnPropertyDescriptor(object, name);\n      if (descriptor.configurable && descriptor.enumerable) {\n        descriptor.enumerable = false;\n        if (name === '$parent') {\n          descriptor.configurable = false;\n          descriptor.set = throwReadOnlyError;\n        }\n        Object.defineProperty(object, name, descriptor);\n      }\n    }\n    if (object.$$initializers) {\n      for (let fn of object.$$initializers) fn(this._vue);\n      delete object.$$initializers;\n    }\n  }\n\n  _destroyObject(object) {\n    if (!(object && object.$truss)) return;\n    if (object.$$finalizers) {\n      // Some destructors remove themselves from the array, so clone it before iterating.\n      for (let fn of _.clone(object.$$finalizers)) fn();\n    }\n    for (let key in object) {\n      if (!Object.hasOwnProperty(object, key)) continue;\n      this._destroyObject(object[key]);\n    }\n  }\n\n  _integrateSnapshot(snap) {\n    _.each(_.keys(this._localWrites), (writeSerial, path) => {\n      if (snap.writeSerial >= writeSerial) delete this._localWrites[path];\n    });\n    if (snap.exists) {\n      const parent = this._scaffoldAncestors(snap.path, true);\n      if (parent) this._plantValue(snap.path, snap.key, snap.value, parent, true);\n    } else {\n      this._prune(snap.path, null, true);\n    }\n  }\n\n  _scaffoldAncestors(path, remoteWrite) {\n    let object;\n    const segments = _(path).split('/').dropRight().value();\n    _.each(segments, (segment, i) => {\n      const childKey = unescapeKey(segment);\n      let child = childKey ? object[childKey] : this.root;\n      if (!child) {\n        const ancestorPath = segments.slice(0, i + 1).join('/');\n        if (remoteWrite && this._localWrites[ancestorPath || '/']) return;\n        child = this._plantValue(ancestorPath, childKey, {}, object);\n      }\n      object = child;\n    });\n    return object;\n  }\n\n  _plantValue(path, key, value, parent, remoteWrite) {\n    if (value === null || value === undefined) {\n      throw new Error('Snapshot includes invalid value: ' + value);\n    }\n    if (remoteWrite && this._localWrites[path]) return;\n    if (value === SERVER_TIMESTAMP) value = this._localWriteTimestamp;\n    if (!_.isArray(value) && !_.isObject(value)) {\n      this._setFirebaseProperty(parent, key, value);\n      return;\n    }\n    let object = parent[key];\n    if (object === undefined) {\n      object = this._createObject(path, key, parent);\n      this._setFirebaseProperty(parent, key, object);\n      this._completeCreateObject(object);\n    }\n    _.each(value, (item, escapedChildKey) => {\n      this._plantValue(\n        joinPath(path, escapedChildKey), unescapeKey(escapedChildKey), item, object, remoteWrite);\n    });\n    _.each(object, (item, childKey) => {\n      const escapedChildKey = escapeKey(childKey);\n      if (!value.hasOwnProperty(escapedChildKey)) {\n        this._prune(joinPath(path, escapedChildKey), null, remoteWrite);\n      }\n    });\n    this._plantPlaceholders(object, path);\n    return object;\n  }\n\n  _plantPlaceholders(object, path) {\n    this._modeler.forEachPlaceholderChild(path, (escapedKey, placeholder) => {\n      const key = unescapeKey(escapedKey);\n      if (!object.hasOwnProperty(key)) {\n        this._plantValue(joinPath(path, escapedKey), key, placeholder, object);\n      }\n    });\n  }\n\n  _prune(path, lockedDescendantPaths, remoteWrite) {\n    lockedDescendantPaths = lockedDescendantPaths || {};\n    const object = this._getObject(path);\n    if (!object) return;\n    if (remoteWrite && this._avoidLocalWritePaths(path, lockedDescendantPaths)) return;\n    if (!_.isEmpty(lockedDescendantPaths) || !this._pruneAncestors(object)) {\n      // The target object is a placeholder, and all ancestors are placeholders or otherwise needed\n      // as well, so we can't delete it.  Instead, dive into its descendants to delete what we can.\n      this._pruneDescendants(object, lockedDescendantPaths);\n    }\n  }\n\n  _avoidLocalWritePaths(path, lockedDescendantPaths) {\n    for (let localWritePath in this._localWrites) {\n      if (!this._localWrites.hasOwnProperty(localWritePath)) continue;\n      if (path === localWritePath || localWritePath === '/' ||\n          _.startsWith(path, localWritePath + '/')) return true;\n      if (path === '/' || _.startsWith(localWritePath, path + '/')) {\n        const segments = localWritePath.split('/');\n        for (let i = segments.length; i > 0; i--) {\n          const subPath = segments.slice(0, i).join('/');\n          const active = i === segments.length;\n          if (lockedDescendantPaths[subPath] || lockedDescendantPaths[subPath] === active) break;\n          lockedDescendantPaths[subPath] = active;\n          if (subPath === path) break;\n        }\n      }\n    }\n  }\n\n  _pruneAncestors(targetObject) {\n    // Destroy the child (unless it's a placeholder that's still needed) and any ancestors that\n    // are no longer needed to keep this child rooted, and have no other reason to exist.\n    let deleted = false;\n    let object = targetObject;\n    while (object && object !== this.root) {\n      if (!this._modeler.isPlaceholder(object.$path)) {\n        const ghostObjects = deleted ? null : [targetObject];\n        if (!this._holdsConcreteData(object, ghostObjects)) {\n          deleted = true;\n          this._deleteFirebaseProperty(object.$parent, object.$key);\n        }\n      }\n      object = object.$parent;\n    }\n    return deleted;\n  }\n\n  _holdsConcreteData(object, ghostObjects) {\n    if (ghostObjects && _.contains(ghostObjects, object)) return false;\n    if (_.some(object, value => !value.$truss)) return true;\n    return _.some(object, value => this._holdsConcreteData(value, ghostObjects));\n  }\n\n  _pruneDescendants(object, lockedDescendantPaths) {\n    if (lockedDescendantPaths[object.$path]) return true;\n    let coupledDescendantFound = false;\n    _.each(object, (value, key) => {\n      let shouldDelete = true;\n      let valueLocked;\n      if (lockedDescendantPaths[joinPath(object.$path, escapeKey(key))]) {\n        shouldDelete = false;\n        valueLocked = true;\n      } else if (value.$truss) {\n        if (this._modeler.isPlaceholder(value.$path)) {\n          valueLocked = this._pruneDescendants(value, lockedDescendantPaths);\n          shouldDelete = false;\n        } else if (_.has(lockedDescendantPaths, value.$path)) {\n          valueLocked = this._pruneDescendants(value);\n          shouldDelete = !valueLocked;\n        }\n      }\n      if (shouldDelete) this._deleteFirebaseProperty(object, key);\n      coupledDescendantFound = coupledDescendantFound || valueLocked;\n    });\n    return coupledDescendantFound;\n  }\n\n  _getObject(pathOrSegments) {\n    let object;\n    const segments = _.isString(pathOrSegments) ?\n      _(pathOrSegments).split('/').map(unescapeKey).value() : pathOrSegments;\n    for (let segment of segments) {\n      object = segment ? object[segment] : this.root;\n      if (object === undefined) return;\n    }\n    return object;\n  }\n\n  _getFirebasePropertyDescriptor(object, key) {\n    let descriptor = Object.getOwnPropertyDescriptor(object, key);\n    if (descriptor) {\n      if (!descriptor.enumerable) {\n        throw new Error(\n          `Key conflict between Firebase and instance or computed properties at ` +\n          `${object.$path}: ${key}`);\n      }\n      if (!descriptor.get || !descriptor.set) {\n        throw new Error(`Unbound property at ${object.$path}: ${key}`);\n      }\n    }\n    return descriptor;\n  }\n\n  _setFirebaseProperty(object, key, value) {\n    let descriptor = this._getFirebasePropertyDescriptor(object, key);\n    if (descriptor) {\n      this._firebasePropertyEditAllowed = true;\n      object[key] = value;\n      this._firebasePropertyEditAllowed = false;\n    } else {\n      Vue.set(object, key, value);\n      descriptor = Object.getOwnPropertyDescriptor(object, key);\n      Object.defineProperty(object, key, {\n        get: descriptor.get,\n        set: function(newValue) {\n          if (!this._firebasePropertyEditAllowed) {\n            throw new Error(`Firebase data cannot be mutated directly: ${key}`);\n          }\n          descriptor.set.call(this, newValue);\n        },\n        configurable: true, enumerable: true\n      });\n    }\n  }\n\n  _deleteFirebaseProperty(object, key) {\n    // Make sure it's actually a Firebase property.\n    this._getFirebasePropertyDescriptor(object, key);\n    this._destroyObject(object[key]);\n    Vue.delete(object, key);\n  }\n\n  static get computedPropertyStats() {\n    return Modeler.computedPropertyStats;\n  }\n}\n\n\nfunction throwReadOnlyError() {throw new Error('Read-only property');}\n\nexport function joinPath() {\n  const segments = [];\n  for (let segment of arguments) {\n    if (segment.charAt(0) === '/') segments.splice(0, segments.length);\n    segments.push(segment);\n  }\n  if (segments[0] === '/') segments[0] = '';\n  return segments.join('/');\n}\n\nexport function checkUpdateHasOnlyDescendantsWithNoOverlap(rootPath, values, relativizePaths) {\n  // First, check all paths for correctness and absolutize them, since there could be a mix of\n  // absolute paths and relative keys.\n  _.each(_.keys(values), path => {\n    if (path.charAt(0) === '/') {\n      if (!(path === rootPath || rootPath === '/' ||\n            _.startsWith(path, rootPath + '/') && path.length > rootPath.length + 1)) {\n        throw new Error(`Update item is not a descendant of target ref: ${path}`);\n      }\n    } else {\n      if (path.indexOf('/') >= 0) {\n        throw new Error(`Update item deep path must be absolute, taken from a reference: ${path}`);\n      }\n      const absolutePath = joinPath(rootPath, escapeKey(path));\n      if (values.hasOwnProperty(absolutePath)) {\n        throw new Error(`Update items overlap: ${path} and ${absolutePath}`);\n      }\n      values[absolutePath] = values[path];\n      delete values[path];\n    }\n  });\n  // Then check for overlaps and relativize if desired.\n  const allPaths = _(values).keys().map(path => joinPath(path, '')).sortBy('length').value();\n  _.each(_.keys(values), path => {\n    for (let otherPath of allPaths) {\n      if (otherPath.length > path.length) break;\n      if (path !== otherPath && _.startsWith(path, otherPath)) {\n        throw new Error(`Update items overlap: ${otherPath} and ${path}`);\n      }\n    }\n    if (relativizePaths) {\n      values[path.slice(rootPath === '/' ? 1 : rootPath.length + 1)] = values[path];\n      delete values[path];\n    }\n  });\n}\n\nexport function toFirebaseJson(object) {\n  if (typeof object === 'object') {\n    const result = {};\n    for (let key in object) {\n      if (!object.hasOwnProperty(key)) continue;\n      result[escapeKey(key)] = toFirebaseJson(object[key]);\n    }\n    return result;\n  } else {\n    return object;\n  }\n}\n\n","import {escapeKey, unescapeKey} from './utils.js';\n\nimport _ from 'lodash';\n\n\nconst EMPTY_ANNOTATIONS = {};\nObject.freeze(EMPTY_ANNOTATIONS);\n\n\nexport class Handle {\n  constructor(tree, path, annotations) {\n    this._tree = tree;\n    this._path = path.replace(/^\\/*/, '/').replace(/\\/$/, '');\n    if (annotations) {\n      this._annotations = annotations;\n      Object.freeze(annotations);\n    }\n  }\n\n  get $ref() {return this;}\n  get key() {\n    if (!this._key) this._key = unescapeKey(this._path.replace(/.*\\//, ''));\n    return this._key;\n  }\n  get path() {return this._path;}\n  get _pathPrefix() {return this._path === '/' ? '' : this._path;}\n  get parent() {\n    return new Reference(this._tree, this._path.replace(/\\/[^/]*$/, ''), this._annotations);\n  }\n\n  get annotations() {\n    return this._annotations || EMPTY_ANNOTATIONS;\n  }\n\n  child() {\n    if (!arguments.length) return this;\n    return new Reference(\n      this._tree, `${this._pathPrefix}/${_.map(arguments, key => escapeKey(key)).join('/')}`,\n      this._annotations\n    );\n  }\n\n  children() {\n    if (!arguments.length) return this;\n    const escapedKeys = [];\n    for (let i = 0; i < arguments.length; i++) {\n      const arg = arguments[i];\n      if (_.isArray(arg)) {\n        const mapping = {};\n        const subPath = `${this._pathPrefix}/${escapedKeys.join('/')}`;\n        const rest = _.slice(arguments, i + 1);\n        for (let key of arg) {\n          const subRef =\n            new Reference(this._tree, `${subPath}/${escapeKey(key)}`, this._annotations);\n          mapping[key] = subRef.children.apply(subRef, rest);\n        }\n        return mapping;\n      } else {\n        escapedKeys.push(escapeKey(arg));\n      }\n    }\n    return new Reference(\n      this._tree, `${this._pathPrefix}/${escapedKeys.join('/')}`, this._annotations);\n  }\n\n  peek(callback) {\n    return this._tree.truss.peek(this, callback);\n  }\n\n  isEqual(that) {\n    if (!(that instanceof Handle)) return false;\n    return this._tree === that._tree && this.toString() === that.toString();\n  }\n\n  belongsTo(truss) {\n    return this._tree.truss === truss;\n  }\n}\n\n\nexport class Query extends Handle {\n  constructor(tree, path, spec, annotations) {\n    super(tree, path, annotations);\n    this._spec = this._copyAndValidateSpec(spec);\n  }\n\n  // Vue-bound\n  get ready() {\n    return this._tree.isQueryReady(this);\n  }\n\n  get constraints() {\n    return this._spec;\n  }\n\n  annotate(annotations) {\n    return new Query(\n      this._tree, this._path, this._spec, _.extend({}, this._annotations, annotations));\n  }\n\n  _copyAndValidateSpec(spec) {\n    if (!spec.by) throw new Error('Query needs \"by\" clause: ' + JSON.stringify(spec));\n    if (('at' in spec) + ('from' in spec) + ('to' in spec) > 1) {\n      throw new Error(\n        'Query must contain at most one of \"at\", \"from\", or \"to\" clauses: ' + JSON.stringify(spec));\n    }\n    if (('first' in spec) + ('last' in spec) > 1) {\n      throw new Error(\n        'Query must contain at most one of \"first\" or \"last\" clauses: ' + JSON.stringify(spec));\n    }\n    if (!_.some(['at', 'from', 'to', 'first', 'last'], clause => clause in spec)) {\n      throw new Error(\n        'Query must contain at least one of \"at\", \"from\", \"to\", \"first\", or \"last\" clauses: ' +\n        JSON.stringify(spec));\n    }\n    spec = _.clone(spec);\n    if (spec.by !== '$key' && spec.by !== '$value') {\n      if (!(spec.by instanceof Reference)) {\n        throw new Error('Query \"by\" value must be a reference: ' + spec.by);\n      }\n      let childPath = spec.by.toString();\n      if (!_.startsWith(childPath, this._path)) {\n        throw new Error(\n          'Query \"by\" value must be a descendant of target reference: ' + spec.by);\n      }\n      childPath = childPath.slice(this._path.length).replace(/^\\/?/, '');\n      if (childPath.indexOf('/') === -1) {\n        throw new Error(\n          'Query \"by\" value must not be a direct child of target reference: ' + spec.by);\n      }\n      spec.by = childPath.replace(/.*?\\//, '');\n    }\n    Object.freeze(spec);\n    return spec;\n  }\n\n\n  toString() {\n    if (!this._string) {\n      const queryTerms = _(this._spec)\n        .map((value, key) => `${key}=${encodeURIComponent(JSON.stringify(value))}`)\n        .sortBy()\n        .join('&');\n      this._string = `${this._path}?${queryTerms}`;\n    }\n    return this._string;\n  }\n}\n\n\n// jshint latedef:false\nexport class Reference extends Handle {\n// jshint latedef:nofunc\n\n  constructor(tree, path, annotations) {\n    super(tree, path, annotations);\n  }\n\n  // Vue-bound\n  get ready() {\n    return this._tree.isReferenceReady(this);\n  }\n\n  toString() {\n    return this._path;\n  }\n\n  annotate(annotations) {\n    return new Reference(this._tree, this._path, _.extend({}, this._annotations, annotations));\n  }\n\n  query(spec) {\n    return new Query(this._tree, this._path, spec);\n  }\n\n  set(value) {\n    return this._tree.update(this, 'set', {[this.path]: value});\n  }\n\n  update(values) {\n    return this._tree.update(this, 'update', values);\n  }\n\n  commit(updateFunction) {\n    return this._tree.commit(this, updateFunction);\n  }\n}\n\nexport default Reference;\n","import {Handle, Query, Reference} from './Reference.js';\nimport angular from './angularCompatibility.js';\n\nimport _ from 'lodash';\nimport Vue from 'vue';\n\n\nexport default class Connector {\n  constructor(scope, connections, tree, method) {\n    connections.freeze();\n    this._scope = scope;\n    this._connections = connections;\n    this._tree = tree;\n    this._method = method;\n    this._subConnectors = {};\n    this._currentDescriptors = {};\n    this._disconnects = {};\n    this._vue = new Vue({data: _.mapValues(connections, _.constant(undefined))});\n\n    this._linkScopeProperties();\n\n    _.each(connections, (descriptor, key) => {\n      if (_.isFunction(descriptor)) {\n        this._bindComputedConnection(key, descriptor);\n      } else {\n        this._connect(key, descriptor);\n      }\n    });\n\n    if (angular.active && scope.$on && scope.$$id) scope.$on('$destroy', () => {this.destroy();});\n  }\n\n  get ready() {\n    return _.every(this._currentDescriptors, (descriptor, key) => {\n      if (!descriptor) return false;\n      if (descriptor instanceof Handle) return descriptor.ready;\n      return this._subConnectors[key].ready;\n    });\n  }\n\n  destroy() {\n    this._unlinkScopeProperties();\n    _.each(this._angularUnwatches, unwatch => {unwatch();});\n    _.each(this._connections, (descriptor, key) => {this._disconnect(key);});\n  }\n\n  _linkScopeProperties() {\n    if (!this._scope) return;\n    const duplicateKey = _.find(this._connections, (descriptor, key) => key in this._scope);\n    if (duplicateKey) {\n      throw new Error(`Property already defined on connection target: ${duplicateKey}`);\n    }\n    Object.defineProperties(this._scope, _.mapValues(this._connections, (descriptor, key) => ({\n      configurable: true, enumerable: true, get: () => this._vue.$data[key]\n    })));\n  }\n\n  _unlinkScopeProperties() {\n    if (!this._scope) return;\n    _.each(this._connections, (descriptor, key) => {\n      delete this._scope[key];\n    });\n  }\n\n  _bindComputedConnection(key, fn) {\n    fn = fn.bind(this._scope);\n    const update = this._updateComputedConnection.bind(this, key);\n    this._vue.$watch(fn, update, {immediate: !angular.active});\n    if (angular.active) {\n      if (!this._angularUnwatches) this._angularUnwatches = [];\n      this._angularUnwatches.push(angular.watch(fn, update));\n    }\n  }\n\n  _updateComputedConnection(key, newDescriptor) {\n    const oldDescriptor = this._currentDescriptors[key];\n    if (oldDescriptor === newDescriptor ||\n        newDescriptor instanceof Handle && newDescriptor.isEqual(oldDescriptor)) return;\n    if (!newDescriptor) {\n      this._disconnect(key);\n      return;\n    }\n    if (newDescriptor instanceof Handle || !_.has(this._subConnectors, key)) {\n      this._disconnect(key);\n      this._connect(key, newDescriptor);\n    } else {\n      this._subConnectors[key]._updateConnections(newDescriptor);\n    }\n    this._currentDescriptors[key] = newDescriptor;\n  }\n\n  _updateConnections(connections) {\n    _.each(connections, (descriptor, key) => {\n      this._updateComputedConnection(key, descriptor);\n    });\n    _.each(this._connections, (descriptor, key) => {\n      if (!_.has(connections, key)) this._updateComputedConnection(key);\n    });\n    this._connections = connections;\n  }\n\n  _connect(key, descriptor) {\n    this._currentDescriptors[key] = descriptor;\n    if (!descriptor) return;\n    if (descriptor instanceof Reference) {\n      const updateFn = this._scope ? this._updateScopeRef.bind(this, key) : null;\n      this._disconnects[key] = this._tree.connectReference(descriptor, updateFn, this._method);\n    } else if (descriptor instanceof Query) {\n      const updateFn = this._scope ? this._updateScopeQuery.bind(this, key) : null;\n      this._disconnects[key] = this._tree.connectQuery(descriptor, updateFn, this._method);\n    } else {\n      const subScope = {};\n      const subConnector = this._subConnectors[key] =\n        new Connector(subScope, descriptor, this._tree, this._method);\n      if (this._scope) {\n        const unwatch = this._vue.$watch(() => subConnector.ready, subReady => {\n          if (!subReady) return;\n          unwatch();\n          Vue.set(this._scope, key, subScope);\n          angular.digest();\n        }, {immediate: true});\n      }\n    }\n  }\n\n  _disconnect(key) {\n    if (this._scope) {\n      Vue.delete(this._scope, key);\n      angular.digest();\n    }\n    if (_.has(this._subConnectors, key)) {\n      this._subConnectors[key].destroy();\n      delete this._subConnectors[key];\n    }\n    if (this._disconnects[key]) this._disconnects[key]();\n    delete this._disconnects[key];\n    delete this._currentDescriptors[key];\n  }\n\n  _updateScopeRef(key, value) {\n    if (this._scope[key] !== value) {\n      Vue.set(this._scope, key, value);\n      angular.digest();\n    }\n  }\n\n  _updateScopeQuery(key, childKeys) {\n    let changed = false;\n    if (!this._scope[key]) {\n      Vue.set(this._scope, key, {});\n      changed = true;\n    }\n    const subScope = this._scope[key];\n    for (let childKey in subScope) {\n      if (!subScope.hasOwnProperty(childKey)) continue;\n      if (!_.contains(childKeys, childKey)) {\n        Vue.delete(subScope, childKey);\n        changed = true;\n      }\n    }\n    let object;\n    for (let segment of this._currentDescriptors[key].path.split('/')) {\n      object = segment ? object[segment] : this._tree.root;\n    }\n    for (let childKey of childKeys) {\n      if (subScope.hasOwnProperty(childKey)) continue;\n      Vue.set(subScope, childKey, object[childKey]);\n      changed = true;\n    }\n    if (changed) angular.digest();\n  }\n\n}\n","import _ from 'lodash';\nimport {wrapPromiseCallback} from './utils.js';\n\n\nconst INTERCEPT_KEYS = [\n  'read', 'write', 'auth', 'set', 'update', 'commit', 'connect', 'peek', 'all'\n];\n\n\nclass SlowHandle {\n  constructor(operation, delay, callback) {\n    this._operation = operation;\n    this._delay = delay;\n    this._callback = callback;\n    this._fired = false;\n  }\n\n  initiate() {\n    this.cancel();\n    this._fired = false;\n    const elapsed = Date.now() - this._operation._startTimestamp;\n    this._timeoutId = setTimeout(this._delay - elapsed, () => {\n      this._fired = true;\n      this._callback(this._operation);\n    });\n  }\n\n  cancel() {\n    if (this._fired) this._callback(this._operation);\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n}\n\n\nclass Operation {\n  constructor(type, method, target) {\n    this._type = type;\n    this._method = method;\n    this._target = target;\n    this._ready = false;\n    this._running = false;\n    this._startTimestamp = Date.now();\n    this._slowHandles = [];\n  }\n\n  get type() {return this._type;}\n  get method() {return this._method;}\n  get target() {return this._target;}\n  get ready() {return this._ready;}\n  get running() {return this._running;}\n  get error() {return this._error;}\n\n  onSlow(delay, callback) {\n    const handle = new SlowHandle(this, delay, callback);\n    this._slowHandles.push(handle);\n    handle.initiate();\n  }\n\n  _setRunning(value) {\n    this._running = value;\n  }\n\n  _markReady() {\n    this._ready = true;\n    _.each(this._slowHandles, handle => handle.cancel());\n  }\n\n  _clearReady() {\n    this._ready = false;\n    this._startTimestamp = Date.now();\n    _.each(this._slowHandles, handle => handle.initiate());\n  }\n}\n\n\nexport default class Dispatcher {\n  constructor(bridge) {\n    this._bridge = bridge;\n    this._callbacks = {};\n  }\n\n  intercept(interceptKey, callbacks) {\n    if (!_.contains(INTERCEPT_KEYS, interceptKey)) {\n      throw new Error('Unknown intercept operation type: ' + interceptKey);\n    }\n    const badCallbackKeys =\n      _.difference(_.keys(callbacks), ['onBefore', 'onAfter', 'onError', 'onFailure']);\n    if (badCallbackKeys.length) {\n      throw new Error('Unknown intercept callback types: ' + badCallbackKeys.join(', '));\n    }\n    const wrappedCallbacks = {\n      onBefore: this._addCallback('onBefore', interceptKey, callbacks.onBefore),\n      onAfter: this._addCallback('onAfter', interceptKey, callbacks.onAfter),\n      onError: this._addCallback('onError', interceptKey, callbacks.onError),\n      onFailure: this._addCallback('onFailure', interceptKey, callbacks.onFailure)\n    };\n    return this._removeCallbacks.bind(this, interceptKey, wrappedCallbacks);\n  }\n\n  _addCallback(stage, interceptKey, callback) {\n    if (!callback) return;\n    const key = this._getCallbacksKey(interceptKey, stage);\n    const wrappedCallback = wrapPromiseCallback(callback);\n    (this._callbacks[key] || (this._callbacks[key] = [])).push(wrappedCallback);\n    return wrappedCallback;\n  }\n\n  _removeCallback(stage, interceptKey, wrappedCallback) {\n    if (!wrappedCallback) return;\n    const key = this._getCallbacksKey(interceptKey, stage);\n    if (this._callbacks[key]) _.pull(this._callbacks[key], wrappedCallback);\n  }\n\n  _removeCallbacks(interceptKey, wrappedCallbacks) {\n    _.each(wrappedCallbacks, (wrappedCallback, stage) => {\n      this._removeCallback(stage, interceptKey, wrappedCallback);\n    });\n  }\n\n  _getCallbacks(stage, operationType, method) {\n    return [].concat(\n      this._callbacks[this._getCallbacksKey(stage, method)],\n      this._callbacks[this._getCallbacksKey(stage, operationType)],\n      this._callbacks[this._getCallbacksKey(stage, 'all')]\n    );\n  }\n\n  _getCallbacksKey(stage, interceptKey) {\n    return `${stage}_${interceptKey}`;\n  }\n\n  execute(operationType, method, target, executor) {\n    executor = wrapPromiseCallback(executor);\n    const operation = this.createOperation(operationType, method, target);\n    return this.begin(operation).then(() => {\n      const executeWithRetries = () => {\n        return executor().catch(e => this._retryOrEnd(operation, e).then(executeWithRetries));\n      };\n      return executeWithRetries();\n    }).then(result => this.end(operation).then(() => result));\n  }\n\n  createOperation(operationType, method, target) {\n    return new Operation(operationType, method, target);\n  }\n\n  begin(operation) {\n    return Promise.all(\n      _.map(this._getCallbacks('onBefore', operation.type), onBefore => onBefore(operation))\n    ).then(() => {operation._setRunning(true);}, e => this.end(operation, e));\n  }\n\n  markReady(operation) {\n    operation._markReady();\n  }\n\n  clearReady(operation) {\n    operation._clearReady();\n  }\n\n  retry(operation, error) {\n    return Promise.all(\n      _.map(this._getCallbacks('onError', operation.type), onError => {\n        try {\n          return Promise.resolve(onError(operation, error));\n        } catch (e) {\n          return Promise.reject(e);\n        }\n      })\n    ).then(results => _.some(results));\n  }\n\n  _retryOrEnd(operation, error) {\n    return this.retry(operation, error).then(result => {\n      if (!result) return this.end(operation, error);\n    }, e => this.end(operation, e));\n  }\n\n  end(operation, error) {\n    operation._setRunning(false);\n    if (error) operation._error = error;\n    return Promise.all(\n      _.map(this._getCallbacks('onAfter', operation.type), onAfter => onAfter(operation))\n    ).then(\n      () => this._afterEnd(operation),\n      e => {\n        operation._error = e;\n        return this._afterEnd(operation);\n      }\n    );\n  }\n\n  _afterEnd(operation) {\n    this.markReady(operation);\n    if (operation.error) {\n      const onFailureCallbacks = this._getCallbacks('onFailure', operation.type);\n      return this._bridge.probeError(operation.error).then(() => {\n        if (onFailureCallbacks) {\n          setTimeout(0, () => {\n            _.each(onFailureCallbacks, onFailure => onFailure(operation));\n          });\n        }\n        return Promise.reject(operation.error);\n      });\n    }\n  }\n}\n\n","'use strict';\n\nconst ALPHABET = '-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz';\n\nexport default class KeyGenerator {\n  constructor() {\n    this._lastUniqueKeyTime = 0;\n    this._lastRandomValues = [];\n  }\n\n  generateUniqueKey(now) {\n    now = now || Date.now();\n    const chars = new Array(20);\n    let prefix = now;\n    for (let i = 7; i >= 0; i--) {\n      chars[i] = ALPHABET.charAt(prefix & 0x3f);\n      prefix = Math.floor(prefix / 64);\n    }\n    if (now === this._lastUniqueKeyTime) {\n      let i = 11;\n      while (i >= 0 && this._lastRandomValues[i] === 63) {\n        this._lastRandomValues[i] = 0;\n        i -= 1;\n      }\n      if (i === -1) {\n        throw new Error('Internal assertion failure: ran out of unique IDs for this millisecond');\n      }\n      this._lastRandomValues[i] += 1;\n    } else {\n      this._lastUniqueKeyTime = now;\n      for (let i = 0; i < 12; i++) {\n        // Make sure to leave some space for incrementing in the top nibble.\n        this._lastRandomValues[i] = Math.floor(Math.random() * (i ? 64 : 16));\n      }\n    }\n    for (let i = 0; i < 12; i++) {\n      chars[i + 8] = ALPHABET[this._lastRandomValues[i]];\n    }\n    return chars.join('');\n  }\n}\n","import angularCompatibility from './angularCompatibility.js';\nimport Vue from 'vue';\n\nexport default class MetaTree {\n  constructor(rootUrl, bridge) {\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._vue = new Vue({data: {$root: {\n      connected: undefined, timeOffset: 0, user: undefined, uid: undefined,\n      updateNowAtIntervals(name, intervalMillis) {\n        if (this.hasOwnProperty(name)) throw new Error(`Property \"${name}\" already defined`);\n        Vue.set(this, name, Date.now() + this.timeOffset);\n        setInterval(() => {\n          this[name] = Date.now() + this.timeOffset;\n        }, intervalMillis);\n      }\n    }}});\n\n    if (angularCompatibility.active) {\n      this._vue.$watch('$data', angularCompatibility.digest, {deep: true});\n    }\n\n    bridge.trackAuth(rootUrl);\n    bridge.onAuth(rootUrl, this._handleAuthChange, this);\n\n    this._connectInfoProperty('serverTimeOffset', 'timeOffset');\n    this._connectInfoProperty('connected', 'connected');\n  }\n\n  get root() {\n    return this._vue.$data.$root;\n  }\n\n  destroy() {\n    this._bridge.offAuth(this._rootUrl, this._handleAuthChange, this);\n    this._vue.$destroy();\n  }\n\n  _handleAuthChange(user) {\n    this.root.user = user;\n    this.root.uid = user && user.uid;\n  }\n\n  _connectInfoProperty(property, attribute) {\n    const propertyUrl = `${this._rootUrl}/.info/{property}`;\n    this._bridge.on(propertyUrl, propertyUrl, null, 'value', snap => {\n      this.root[attribute] = snap.value;\n    });\n  }\n}\n","import _ from 'lodash';\nimport Vue from 'vue';\nimport angularCompatibility from './angularCompatibility.js';\n\n\nclass QueryHandler {\n  constructor(coupler, query) {\n    this._coupler = coupler;\n    this._query = query;\n    this._listeners = [];\n    this._keys = [];\n    this._url = this._coupler._rootUrl + query.path;\n    this._segments = query.path.split('/');\n    this._listening = false;\n    this.ready = false;\n  }\n\n  attach(operation, keysCallback) {\n    this._listen();\n    this._listeners.push({operation, keysCallback});\n    keysCallback(this._keys);\n  }\n\n  detach(operation) {\n    const k = _.findIndex(this._listeners, {operation});\n    if (k >= 0) this._listeners.splice(k, 1);\n    return this._listeners.length;\n  }\n\n  _listen() {\n    if (this._listening) return;\n    this._coupler._bridge.on(\n      this._query.toString(), this._url, this._query.constraints, 'value',\n      this._handleSnapshot, this._handleError.bind(this._query.path), this, {sync: true});\n    this._listening = true;\n  }\n\n  destroy() {\n    this._coupler._bridge.off(\n      this._query.toString(), this._url, this._query.constraints, 'value', this._handleSnapshot,\n      this);\n    this._listening = false;\n    this.ready = false;\n    angularCompatibility.digest();\n    for (let key of this._keys) {\n      this._coupler._decoupleSegments(this._segments.concat(key));\n    }\n  }\n\n  _handleSnapshot(snap) {\n    // Order is important here: first couple any new subpaths so _handleSnapshot will update the\n    // tree, then tell the client to update its keys, pulling values from the tree.\n    if (!this._listeners.length || !this._listening) return;\n    const updatedKeys = this._updateKeys(snap);\n    this._coupler._applySnapshot(snap);\n    if (!this.ready) {\n      this.ready = true;\n      angularCompatibility.digest();\n      for (let listener of this._listeners) this._coupler._dispatcher.markReady(listener.operation);\n    }\n    if (updatedKeys) {\n      for (let listener of this._listeners) listener.keysCallback(updatedKeys);\n    }\n  }\n\n  _updateKeys(snap) {\n    let updatedKeys;\n    if (snap.path === this._query.path) {\n      updatedKeys = _.keys(snap.value);\n      updatedKeys.sort();\n      if (_.isEqual(this._keys, updatedKeys)) {\n        updatedKeys = null;\n      } else {\n        for (let key of _.difference(updatedKeys, this._keys)) {\n          this._coupler._coupleSegments(this._segments.concat(key));\n        }\n        for (let key of _.difference(this._keys, updatedKeys)) {\n          this._coupler._decoupleSegments(this._segments.concat(key));\n        }\n        this._keys = updatedKeys;\n      }\n    } else if (snap.path.replace(/\\/[^/]+/, '') === this._query.path) {\n      const hasKey = _.contains(this._keys, snap.key);\n      if (snap.value) {\n        if (!hasKey) {\n          this._coupler._coupleSegments(this._segments.concat(snap.key));\n          this._keys.push(snap.key);\n          this._keys.sort();\n          updatedKeys = this._keys;\n        }\n      } else {\n        if (hasKey) {\n          this._coupler._decoupleSegments(this._segments.concat(snap.key));\n          _.pull(this._keys, snap.key);\n          this._keys.sort();\n          updatedKeys = this._keys;\n        }\n      }\n    }\n    return updatedKeys;\n  }\n\n  _handleError(error) {\n    if (!this._listeners.length || !this._listening) return;\n    this._listening = false;\n    Promise.all(_.map(this._listeners, listener => {\n      this._coupler._dispatcher.clearReady(listener.operation);\n      return this._coupler._dispatcher.retry(listener.operation, error).catch(e => {\n        listener.operation._disconnect(e);\n        return false;\n      });\n    })).then(results => {\n      if (_.some(results)) {\n        if (this._listeners.length) this._listen();\n      } else {\n        for (let listener of this._listeners) listener.operation._disconnect(error);\n      }\n    });\n  }\n}\n\n\nclass Node {\n  constructor(coupler, path) {\n    this._coupler = coupler;\n    this.path = path;\n    this.url = this._coupler._rootUrl + path;\n    this.operations = [];\n    this.queryCount = 0;\n    this.listening = false;\n    this.ready = false;\n    this.children = {};\n  }\n\n  get active() {\n    return this.count || this.queryCount;\n  }\n\n  get count() {\n    return this.operations.length;\n  }\n\n  listen(skip) {\n    if (!skip && this.count) {\n      if (this.listening) return;\n      _.each(this.operations, op => {this._coupler._dispatcher.clearReady(op);});\n      this._coupler._bridge.on(\n        this.url, this.url, null, 'value', this._handleSnapshot, this._handleError.bind(this),\n        this, {sync: true});\n      this.listening = true;\n    } else {\n      _.each(this.children, child => {child.listen();});\n    }\n  }\n\n  unlisten(skip) {\n    if (!skip && this.listening) {\n      this._coupler._bridge.off(this.url, this.url, null, 'value', this._handleSnapshot, this);\n      this.listening = false;\n      this._forAllDescendants(node => {\n        if (node.ready) {\n          node.ready = false;\n          angularCompatibility.digest();\n        }\n      });\n    } else {\n      _.each(this.children, child => {child.unlisten();});\n    }\n  }\n\n  _handleSnapshot(snap) {\n    if (!this.listening || !this._coupler.isTrunkCoupled(snap.path)) return;\n    this._coupler._applySnapshot(snap);\n    if (!this.ready && snap.path === this.path) {\n      this.ready = true;\n      angularCompatibility.digest();\n      this.unlisten(true);\n      this._forAllDescendants(node => {\n        for (let op of this.operations) this._coupler._dispatcher.markReady(op);\n      });\n    }\n  }\n\n  _handleError(error) {\n    if (!this.count || !this.listening) return;\n    this.listening = false;\n    this._forAllDescendants(node => {\n      if (node.ready) {\n        node.ready = false;\n        angularCompatibility.digest();\n      }\n      for (let op of this.operations) this._coupler._dispatcher.clearReady(op);\n    });\n    return Promise.all(_.map(this.operations, op => {\n      return this._coupler._dispatcher.retry(op, error).catch(e => {\n        op._disconnect(e);\n        return false;\n      });\n    })).then(results => {\n      if (_.some(results)) {\n        if (this.count) this.listen();\n      } else {\n        for (let op of this.operations) op._disconnect(error);\n        // Pulling all the operations will automatically get us listening on descendants.\n      }\n    });\n  }\n\n  _forAllDescendants(iteratee) {\n    iteratee(this);\n    _.each(this.children, child => child._forAllDescendants(iteratee));\n  }\n\n  collectCoupledDescendantPaths(paths) {\n    if (!paths) paths = {};\n    paths[this.path] = this.active;\n    if (!this.active) {\n      _.each(this.children, child => {child.collectCoupledDescendantPaths(paths);});\n    }\n    return paths;\n  }\n}\n\n\nexport default class Coupler {\n  constructor(rootUrl, bridge, dispatcher, applySnapshot, prunePath) {\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._dispatcher = dispatcher;\n    this._applySnapshot = applySnapshot;\n    this._prunePath = prunePath;\n    this._vue = new Vue({data: {root: new Node(this, '/'), queryHandlers: {}}});\n  }\n\n  get _root() {return this._vue.root;}\n  get _queryHandlers() {return this._vue.queryHandlers;}\n\n  destroy() {\n    _.each(this._queryHandlers, queryHandler => {queryHandler.destroy();});\n    this._root.unlisten();\n    this._vue.$destroy();\n  }\n\n  couple(path, operation) {\n    return this._coupleSegments(path.split('/'), operation);\n  }\n\n  _coupleSegments(segments, operation) {\n    let node;\n    let superseded = !operation;\n    let ready = false;\n    for (let segment of segments) {\n      let child = segment ? node.children && node.children[segment] : this._root;\n      if (!child) {\n        child = new Node(this, `${node.path === '/' ? '' : node.path}/${segment}`);\n        Vue.set(node.children, segment, child);\n      }\n      superseded = superseded || child.listening;\n      ready = ready || child.ready;\n      node = child;\n    }\n    if (operation) {\n      node.operations.push(operation);\n    } else {\n      node.queryCount++;\n    }\n    if (superseded) {\n      if (operation && ready) this._dispatcher.markReady(operation);\n    } else {\n      node.listen();  // node will call unlisten() on descendants when ready\n    }\n  }\n\n  decouple(path, operation) {\n    return this._decoupleSegments(path.split('/'), operation);\n  }\n\n  _decoupleSegments(segments, operation) {\n    const ancestors = [];\n    let node;\n    for (let segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) break;\n      ancestors.push(node);\n    }\n    if (!node || !(operation ? node.count : node.queryCount)) {\n      throw new Error(`Path not coupled: ${segments.join('/')}`);\n    }\n    if (operation) {\n      _.pull(node.operations, operation);\n    } else {\n      node.queryCount--;\n    }\n    if (operation && !node.count) {\n      // Ideally, we wouldn't resync the full values here since we probably already have the current\n      // value for all children.  But making sure that's true is tricky in an async system (what if\n      // the node's value changes and the update crosses the 'off' call in transit?) and this\n      // situation should be sufficiently rare that the optimization is probably not worth it right\n      // now.\n      node.listen();\n      if (node.listening) node.unlisten();\n    }\n    if (!node.active) {\n      const coupledDescendantPaths = node.collectCoupledDescendantPaths();\n      this._prunePath(segments.join('/'), coupledDescendantPaths);\n      for (let i = ancestors.length - 1; i > 0; i--) {\n        node = ancestors[i];\n        if (node === this._root || node.active || !_.isEmpty(node.children)) break;\n        Vue.delete(ancestors[i - 1].children, segments[i]);\n      }\n    }\n  }\n\n  subscribe(query, operation, keysCallback) {\n    let queryHandler = this._queryHandlers[query.toString()];\n    if (!queryHandler) {\n      queryHandler = new QueryHandler(this, query);\n      Vue.set(this._queryHandlers, query.toString(), queryHandler);\n    }\n    queryHandler.attach(operation, keysCallback);\n }\n\n  unsubscribe(query, operation) {\n    const queryHandler = this._queryHandlers[query.toString()];\n    if (queryHandler && !queryHandler.detach(operation)) {\n      queryHandler.destroy();\n      Vue.delete(this._queryHandlers, query.toString());\n    }\n  }\n\n  // Return whether the node at path or any ancestors are coupled.\n  isTrunkCoupled(path) {\n    const segments = path.split('/');\n    let node;\n    for (let segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) return false;\n      if (node.active) return true;\n    }\n    return false;\n  }\n\n  findCoupledDescendantPaths(path) {\n    const segments = path.split('/');\n    let node;\n    for (let segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) break;\n    }\n    return node ? node.collectCoupledDescendantPaths() : {};\n  }\n\n  isSubtreeReady(path) {\n    const segments = path.split('/');\n    let node;\n    for (let segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) return false;\n      if (node.ready) return true;\n    }\n    return false;\n  }\n\n  isQueryReady(query) {\n    const queryHandler = this._queryHandlers[query.toString()];\n    return queryHandler && queryHandler.ready;\n  }\n\n}\n\n","// Generated by CoffeeScript 1.7.1\n(function() {\n  var getNanoSeconds, hrtime, loadTime;\n\n  if ((typeof performance !== \"undefined\" && performance !== null) && performance.now) {\n    module.exports = function() {\n      return performance.now();\n    };\n  } else if ((typeof process !== \"undefined\" && process !== null) && process.hrtime) {\n    module.exports = function() {\n      return (getNanoSeconds() - loadTime) / 1e6;\n    };\n    hrtime = process.hrtime;\n    getNanoSeconds = function() {\n      var hr;\n      hr = hrtime();\n      return hr[0] * 1e9 + hr[1];\n    };\n    loadTime = getNanoSeconds();\n  } else if (Date.now) {\n    module.exports = function() {\n      return Date.now() - loadTime;\n    };\n    loadTime = Date.now();\n  } else {\n    module.exports = function() {\n      return new Date().getTime() - loadTime;\n    };\n    loadTime = new Date().getTime();\n  }\n\n}).call(this);\n","import _ from 'lodash';\nimport Vue from 'vue';\nimport angularCompatibility from './angularCompatibility.js';\nimport Bridge from './Bridge.js';\nimport Connector from './Connector.js';\nimport Dispatcher from './Dispatcher.js';\nimport KeyGenerator from './KeyGenerator.js';\nimport MetaTree from './MetaTree.js';\nimport {Handle, Reference} from './Reference.js';\nimport Tree from './Tree.js';\nimport {escapeKey, unescapeKey, wrapPromiseCallback, SERVER_TIMESTAMP} from './utils.js';\n\n\nlet bridge;\nconst workerFunctions = {};\n\n\nexport default class Truss {\n\n  /**\n   * Create a new Truss instance, specific to a given datastore.  To avoid confusion there should be\n   * exactly one Truss per root datastore URL, so in most code this will be a singleton.\n   *\n   * @param rootUrl {String} The root URL, https://{project}.firebaseio.com.\n   * @param classes {Array<Function>} A list of the classes to map onto the datastore structure.\n   *    Each class must have a static $trussMount property that is a (wildcarded) datastore path, or\n   *    an options object {path: string, placeholder: object}, or an array of either.\n   */\n  constructor(rootUrl, classes) {\n    // TODO: allow rootUrl to be a test database object for testing\n    if (!bridge) {\n      throw new Error('Truss worker not connected, please call Truss.connectWorker first');\n    }\n    this._rootUrl = rootUrl.replace(/\\/$/, '');\n    this._keyGenerator = new KeyGenerator();\n    this._dispatcher = new Dispatcher(bridge);\n    this._vue = new Vue();\n\n    this._metaTree = new MetaTree(this._rootUrl, bridge);\n    Object.defineProperty(this, 'meta', {\n      value: this._metaTree.root, writable: false, configurable: false, enumerable: false\n    });\n\n    this._tree = new Tree(this, this._rootUrl, bridge, this._dispatcher, classes);\n    Object.defineProperty(this, 'root', {\n      value: this._tree.root, writable: false, configurable: false, enumerable: false\n    });\n  }\n\n  destroy() {\n    this._vue.$destroy();\n    this._tree.destroy();\n    this._metaTree.destroy();\n  }\n\n  get now() {return Date.now() + this.meta.timeOffset;}\n  newKey() {return this._keyGenerator.generateUniqueKey(this.now);}\n\n  authenticate(token) {\n    return this._dispatcher.execute('auth', new Reference(this._tree, '/'), () => {\n      return bridge.authWithCustomToken(this._rootUrl, token);\n    });\n  }\n  unauthenticate() {\n    return this._dispatcher.execute('auth', new Reference(this._tree, '/'), () => {\n      return bridge.unauth(this._rootUrl);\n    });\n  }\n\n  intercept(actionType, callbacks) {\n    return this._dispatcher.intercept(actionType, callbacks);\n  }\n\n  // connections are {key: Query | Object | fn() -> (Query | Object)}\n  connect(scope, connections) {\n    if (!connections) {\n      connections = scope;\n      scope = undefined;\n      if (connections instanceof Handle) connections = {_: connections};\n    }\n    return new Connector(scope, connections, this._tree, 'connect');\n  }\n\n  // target is Reference, Query, or connection Object like above\n  peek(target, callback) {\n    callback = wrapPromiseCallback(callback);\n    return new Promise((resolve, reject) => {\n      const scope = {};\n      const connector = new Connector(scope, {result: target}, this._tree, 'peek');\n      const unwatch = this._vue.$watch(() => connector.ready, ready => {\n        if (!ready) return;\n        unwatch();\n        callback(scope.result).then(result => {\n          connector.destroy();\n          resolve(result);\n        }, error => {\n          connector.destroy();\n          reject(error);\n        });\n      });\n    });\n  }\n\n  static get computedPropertyStats() {return this._tree.computedPropertyStats;}\n\n  static connectWorker(webWorker) {\n    if (bridge) throw new Error('Worker already connected');\n    if (_.isString(webWorker)) {\n      const Worker = window.SharedWorker || window.Worker;\n      if (!Worker) throw new Error('Browser does not implement Web Workers');\n      webWorker = new Worker(webWorker);\n    }\n    bridge = new Bridge(webWorker);\n    return bridge.init(webWorker).then(\n      ({exposedFunctionNames, firebaseSdkVersion}) => {\n        Truss.FIREBASE_SDK_VERSION = firebaseSdkVersion;\n        for (let name of exposedFunctionNames) {\n          Truss.worker[name] = bridge.bindExposedFunction(name);\n        }\n      }\n    );\n  }\n\n  static get worker() {return workerFunctions;}\n\n  static preExpose(functionName) {\n    Truss.worker[functionName] = bridge.bindExposedFunction(functionName);\n  }\n\n  static bounceConnection() {return bridge.bounceConnection();}\n  static suspend() {return bridge.suspend();}\n  static debugPermissionDeniedErrors(simulatedTokenGenerator, maxSimulationDuration, callFilter) {\n    return bridge.debugPermissionDeniedErrors(\n      simulatedTokenGenerator, maxSimulationDuration, callFilter);\n  }\n\n  static debounceAngularDigest(wait) {\n    angularCompatibility.debounceDigest(wait);\n  }\n\n  static escapeKey(key) {return escapeKey(key);}\n  static unescapeKey(escapedKey) {return unescapeKey(escapedKey);}\n\n  static get SERVER_TIMESTAMP() {return SERVER_TIMESTAMP;}\n}\n\nangularCompatibility.defineModule(Truss);\n"]}