{"version":3,"sources":["../src/client/angularCompatibility.js","../src/client/utils.js","../src/client/Bridge.js","../src/client/Modeler.js","../src/client/Tree.js","../src/client/Reference.js","../src/client/Connector.js","../src/client/Dispatcher.js","../src/client/KeyGenerator.js","../src/client/MetaTree.js","../src/client/Coupler.js","../node_modules/performance-now/lib/performance-now.js","../src/client/Truss.js"],"names":["noop","escapeKey","key","toString","replace","char","charCodeAt","unescapeKey","code","String","fromCharCode","parseInt","slice","wrapPromiseCallback","callback","Promise","resolve","apply","this","arguments","e","reject","errorFromJson","json","params","Error","const","error","message","let","propertyName","hasOwnProperty","extra","getUrlRoot","url","k","indexOf","isTrussValueEqual","a","b","$truss","throwReadOnlyError","joinPath","segments","i","list","length","segment","charAt","splice","push","join","checkUpdateHasOnlyDescendantsWithNoOverlap","rootPath","values","relativizePaths","paths","_","keys","map","path","sortBy","value","each","startsWith","otherPath","toFirebaseJson","object","result","earlyDigestPending","bareDigest","angularProxy","active","window","angular","debounceDigest","wait","digest","debounce","forEach","method","module","run","$rootScope","$evalAsync","bind","defineModule","Truss","constant","bridge","SERVER_TIMESTAMP","Object","freeze",".sv","Snapshot","ref","valueError","exists","_path","_value","_valueError","_exists","undefined","prototypeAccessors","get","_checkValue","_key","prototype","Bridge","webWorker","_idCounter","_deferreds","_suspended","_servers","_callbacks","_simulatedTokenGenerator","_maxSimulationDuration","_simulatedCallFilter","_inboundMessages","_outboundMessages","_flushMessageQueue","_port","port","_shared","onmessage","_receive","addEventListener","_send","msg","setInterval","init","items","storage","localStorage","sessionStorage","getItem","staticAccessors","instance","suspend","suspended","_receiveMessages","setImmediate","debugPermissionDeniedErrors","simulatedTokenGenerator","maxSimulationDuration","callFilter","id","promise","oneWay","this$1","deferred","sent","resolveSent","postMessage","event","concat","data","messages","fn","call","bindExposedFunction","name","args","Array","probeError","toLowerCase","_simulateCall","then","securityTrace","permissionDeniedDetails","props","simulatedCalls","spec","newValue","auth","getAuth","simulationPromise","uid","token","all","securityTraces","every","trace","filter","catch","timeoutPromise","setTimeout","race","updateLocalStorage","item","removeItem","setItem","trackServer","rootUrl","server","authListeners","authCallbackId","_registerCallback","_authCallback","callbackId","listener","onAuth","context","offAuth","authWithCustomToken","authToken","options","unauth","set","writeSerial","update","on","listenerKey","eventType","snapshotCallback","cancelCallback","handle","_onCallback","__callbackIds","off","idsToDeregister","_findAndRemoveCallbackId","i$1","list$1","_nullifyCallback","_deregisterCallback","snapshotJson","console","transaction","oldValue","relativeUpdates","onDisconnect","bounceConnection","predicate","EMPTY_ANNOTATIONS","Handle","tree","annotations","_tree","_annotations","_pathPrefix","parent","Reference","child","children","escapedKeys","arg","isArray","mapping","subPath","rest","subRef","peek","truss","isEqual","that","belongsTo","Query","super","_spec","_copyAndValidateSpec","prototypeAccessors$1","ready","isQueryReady","constraints","annotate","extend","by","JSON","stringify","some","clause","clone","childPath","_string","queryTerms","encodeURIComponent","prototypeAccessors$2","isReferenceReady","query","obj","commit","updateFunction","Connector","scope","connections","_scope","_connections","_method","_subConnectors","_currentDescriptors","_disconnects","_vue","Vue","mapValues","_linkScopeProperties","descriptor","isFunction","_bindComputedConnection","_connect","$on","$$id","destroy","_unlinkScopeProperties","_angularUnwatches","unwatch","_disconnect","duplicateKey","find","defineProperties","configurable","enumerable","$data","_updateComputedConnection","$watch","immediate","watch","newDescriptor","oldDescriptor","has","_updateConnections","updateFn","_updateScopeRef","connectReference","_updateScopeQuery","connectQuery","subScope","subConnector","subReady","delete","childKeys","changed","childKey","contains","split","root","SlowHandle","operation","delay","_operation","_delay","_callback","_fired","initiate","cancel","elapsed","Date","now","_startTimestamp","_timeoutId","clearTimeout","Operation","type","target","_type","_target","_ready","_running","_slowHandles","running","_error","onSlow","_setRunning","_markReady","_clearReady","Dispatcher","_bridge","intercept","operationType","callbacks","badCallbackKeys","difference","_addCallback","onBefore","onAfter","onError","onFailure","stage","_getCallbacksKey","_getCallbacks","execute","executor","createOperation","begin","executeWithRetries","_retryOrEnd","end","markReady","clearReady","retry","results","_afterEnd","onFailureCallbacks","ALPHABET","KeyGenerator","_lastUniqueKeyTime","_lastRandomValues","generateUniqueKey","chars","prefix","Math","floor","random","MetaTree","_rootUrl","$root","connected","timeOffset","user","updateNowAtIntervals","intervalMillis","angularCompatibility","deep","trackAuth","_handleAuthChange","_connectInfoProperty","$destroy","property","attribute","propertyUrl","snap","QueryHandler","coupler","_coupler","_query","_listeners","_keys","_url","_segments","_listening","attach","keysCallback","_listen","detach","findIndex","_handleSnapshot","_handleError","sync","_decoupleSegments","updatedKeys","_updateKeys","_applySnapshot","_dispatcher","sort","_coupleSegments","hasKey","pull","Node","operations","queryCount","listening","count","listen","skip","op","unlisten","_forAllDescendants","node","isTrunkCoupled","iteratee","collectCoupledDescendantPaths","Coupler","dispatcher","applySnapshot","prunePath","_prunePath","queryHandlers","_root","_queryHandlers","queryHandler","couple","superseded","decouple","ancestors","coupledDescendantPaths","isEmpty","subscribe","unsubscribe","findCoupledDescendantPaths","isSubtreeReady","getNanoSeconds","hrtime","loadTime","performance","exports","process","hr","getTime","RESERVED_VALUE_PROPERTY_NAMES","$parent","$key","$path","computedPropertyStats","Value","$ref","defineProperty","$refs","$keys","$values","$set","$update","$commit","ComputedPropertyStats","numRecomputes","numUpdates","runtime","Modeler","classes","_mounts","uniq","Class","_mountClass","flatten","patterns","mount","regex","badPaths","groupBy","group","compact","_augmentClass","computedProperties","proto","constructor","getOwnPropertyNames","getOwnPropertyDescriptor","fullName","getPrototypeOf","mounts","$trussMount","isString","variables","pathTemplate","match","variable","klass","escapedKey","placeholder","RegExp","parentRegex","createObject","properties","touchThis","lastIndex","exec","writable","prop","_buildComputedPropertyDescriptor","computeValue","startTime","performanceNow","stats","writeAllowed","firstCallback","__destructors__","__initializers__","vue","isPlaceholder","test","forEachPlaceholderChild","Transaction","outcome","_outcome","_values","_setOutcome","abort","","Tree","_truss","_firebasePropertyEditAllowed","_writeSerial","_localWrites","_localWriteTimestamp","_integrateSnapshot","_prune","_modeler","_createObject","_completeCreateObject","_plantPlaceholders","valueCallback","_checkHandle","_getObject","_disconnectReference","_disconnected","_disconnectQuery","numValues","size","_applyLocalWrite","_extractCommonPathPrefix","tries","attemptTransaction","txn","committed","offset","descendantPath","subValue","last","_plantValue","_scaffoldAncestors","prefixSegments","firstMismatchIndex","maxIndex","min","pathPrefix","_destroyObject","remoteWrite","dropRight","ancestorPath","isObject","_setFirebaseProperty","escapedChildKey","lockedDescendantPaths","_avoidLocalWritePaths","_pruneAncestors","_pruneDescendants","localWritePath","targetObject","deleted","ghostObjects","_holdsConcreteData","_deleteFirebaseProperty","coupledDescendantFound","valueLocked","shouldDelete","pathOrSegments","_getFirebasePropertyDescriptor","workerFunctions","_keyGenerator","_metaTree","meta","newKey","authenticate","unauthenticate","actionType","connect","connector","connectWorker","Worker","SharedWorker","exposedFunctionNames","firebaseSdkVersion","FIREBASE_SDK_VERSION","worker","preExpose","functionName","debounceAngularDigest"],"mappings":"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","file":"firetruss.min.js","sourcesContent":["/* globals window */\n\nimport _ from 'lodash';\n\n\nlet earlyDigestPending;\nlet bareDigest = function() {\n  earlyDigestPending = true;\n};\n\nconst angularProxy = {\n  active: typeof window !== 'undefined' && window.angular,\n  debounceDigest(wait) {\n    if (wait) {\n      angularProxy.digest = _.debounce(bareDigest, wait);\n    } else {\n      angularProxy.digest = bareDigest;\n    }\n  }\n};\n['digest', 'defineModule'].forEach(method => {angularProxy[method] = noop;});\n\nif (angularProxy.active) {\n  angularProxy.digest = bareDigest;\n  window.angular.module('firetruss', []).run(['$rootScope', function($rootScope) {\n    bareDigest = $rootScope.$evalAsync.bind($rootScope);\n    if (earlyDigestPending) bareDigest();\n  }]);\n  angularProxy.defineModule = function(Truss) {\n    window.angular.module('firetruss').constant('Truss', Truss);\n  };\n}\n\nfunction noop() {}\n\nexport default angularProxy;\n","export function escapeKey(key) {\n  if (!key) return key;\n  return key.toString().replace(/[\\\\\\.\\$\\#\\[\\]\\/]/g, function(char) {\n    return '\\\\' + char.charCodeAt(0).toString(16);\n  });\n}\n\nexport function unescapeKey(key) {\n  if (!key) return key;\n  return key.toString().replace(/\\\\[0-9a-f]{2}/gi, function(code) {\n    return String.fromCharCode(parseInt(code.slice(1), 16));\n  });\n}\n\nexport function wrapPromiseCallback(callback) {\n  return function() {\n    try {\n      return Promise.resolve(callback.apply(this, arguments));\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n}\n\nexport const SERVER_TIMESTAMP = Object.freeze({'.sv': 'timestamp'});\n","/* global setImmediate */\n\nimport {unescapeKey} from './utils.js';\n\n// jshint browser:true\n\nlet bridge;\n\n\nclass Snapshot {\n  constructor({path, value, valueError, exists}) {\n    this._path = path;\n    this._value = value;\n    this._valueError = errorFromJson(valueError);\n    this._exists = value === undefined ? exists || false : value !== null;\n  }\n\n  get path() {\n    return this._path;\n  }\n\n  get exists() {\n    return this._exists;\n  }\n\n  get value() {\n    this._checkValue();\n    return this._value;\n  }\n\n  get key() {\n    if (this._key === undefined) this._key = unescapeKey(this._path.replace(/.*\\//, ''));\n    return this._key;\n  }\n\n  _checkValue() {\n    if (this._valueError) throw this._valueError;\n    if (this._value === undefined) throw new Error('Value omitted from snapshot');\n  }\n}\n\n\nexport default class Bridge {\n  constructor(webWorker) {\n    this._idCounter = 0;\n    this._deferreds = {};\n    this._suspended = false;\n    this._servers = {};\n    this._callbacks = {};\n    this._simulatedTokenGenerator = null;\n    this._maxSimulationDuration = 5000;\n    this._simulatedCallFilter = null;\n    this._inboundMessages = [];\n    this._outboundMessages = [];\n    this._flushMessageQueue = this._flushMessageQueue.bind(this);\n    this._port = webWorker.port || webWorker;\n    this._shared = !!webWorker.port;\n    this._port.onmessage = this._receive.bind(this);\n    window.addEventListener('unload', () => {this._send({msg: 'destroy'});});\n    setInterval(() => {this._send({msg: 'ping'});}, 60 * 1000);\n  }\n\n  static init(webWorker) {\n    const items = [];\n    try {\n      const storage = window.localStorage || window.sessionStorage;\n      if (!storage) return;\n      for (let i = 0; i < storage.length; i++) {\n        const key = storage.key(i);\n        items.push({key, value: storage.getItem(key)});\n      }\n    } catch (e) {\n      // Some browsers don't like us accessing local storage -- nothing we can do.\n    }\n    return this._send({msg: 'init', storage: items});\n  }\n\n  static get instance() {\n    if (!bridge) throw new Error('No web worker connected, please call Truss.connectWorker first');\n    return bridge;\n  }\n\n  suspend(suspended) {\n    if (suspended === undefined) suspended = true;\n    if (this._suspended === suspended) return;\n    this._suspended = suspended;\n    if (!suspended) {\n      this._receiveMessages(this._inboundMessages);\n      this._inboundMessages = [];\n      if (this._outboundMessages.length) setImmediate(this._flushMessageQueue);\n    }\n  }\n\n  debugPermissionDeniedErrors(simulatedTokenGenerator, maxSimulationDuration, callFilter) {\n    this._simulatedTokenGenerator = simulatedTokenGenerator;\n    if (maxSimulationDuration !== undefined) this._maxSimulationDuration = maxSimulationDuration;\n    this._simulatedCallFilter = callFilter || function() {return true;};\n  }\n\n  _send(message) {\n    message.id = ++this._idCounter;\n    let promise;\n    if (message.oneWay) {\n      promise = Promise.resolve();\n    } else {\n      promise = new Promise((resolve, reject) => {\n        this._deferreds[message.id] = {resolve, reject};\n      });\n      const deferred = this._deferreds[message.id];\n      deferred.promise = promise;\n      promise.sent = new Promise(resolve => {\n        deferred.resolveSent = resolve;\n      });\n      deferred.params = message;\n    }\n    if (!this._outboundMessages.length && !this._suspended) setImmediate(this._flushMessageQueue);\n    this._outboundMessages.push(message);\n    return promise;\n  }\n\n  _flushMessageQueue() {\n    this._port.postMessage(this._outboundMessages);\n    this._outboundMessages = [];\n  }\n\n  _receive(event) {\n    if (this._suspended) {\n      this._inboundMessages = this._inboundMessages.concat(event.data);\n    } else {\n      this._receiveMessages(event.data);\n    }\n  }\n\n  _receiveMessages(messages) {\n    for (let message of messages) {\n      const fn = this[message.msg];\n      if (typeof fn !== 'function') throw new Error('Unknown message: ' + message.msg);\n      fn.call(this, message);\n    }\n  }\n\n  bindExposedFunction(name) {\n    return (function() {\n      return this._send({msg: 'call', name, args: Array.prototype.slice.call(arguments)});\n    }).bind(this);\n  }\n\n  resolve(message) {\n    const deferred = this._deferreds[message.id];\n    if (!deferred) throw new Error('Received resolution to inexistent Firebase call');\n    delete this._deferreds[message.id];\n    deferred.resolve(message.result);\n  }\n\n  reject(message) {\n    const deferred = this._deferreds[message.id];\n    if (!deferred) throw new Error('Received rejection of inexistent Firebase call');\n    delete this._deferreds[message.id];\n    deferred.reject(errorFromJson(message.error, deferred.params));\n  }\n\n  probeError(error) {\n    const code = error.code || error.message;\n    if (error.params && code && code.toLowerCase() === 'permission_denied') {\n      return this._simulateCall(error.params).then(securityTrace => {\n        if (securityTrace) error.permissionDeniedDetails = securityTrace;\n      });\n    } else {\n      return Promise.resolve();\n    }\n  }\n\n  _simulateCall(props) {\n    if (!(this._simulatedTokenGenerator && this._maxSimulationDuration > 0)) {\n      return Promise.resolve();\n    }\n    let simulatedCalls = [];\n    switch (props.msg) {\n      case 'set':\n        simulatedCalls.push({method: 'set', url: props.url, args: [props.value]});\n        break;\n      case 'update':\n        simulatedCalls.push({method: 'update', url: props.url, args: [props.value]});\n        break;\n      case 'on':\n        simulatedCalls.push({method: 'once', url: props.url, spec: props.spec, args: ['value']});\n        break;\n      case 'transaction':\n        simulatedCalls.push({method: 'once', url: props.url, args: ['value']});\n        simulatedCalls.push({method: 'set', url: props.url, args: [props.newValue]});\n        break;\n    }\n    if (!simulatedCalls.length || !this._simulatedCallFilter(props.msg, props.url)) {\n      return Promise.resolve();\n    }\n    const auth = this.getAuth(getUrlRoot(props.url));\n    const simulationPromise = this._simulatedTokenGenerator(auth && auth.uid).then(token => {\n      return Promise.all(simulatedCalls.map(message => {\n        message.msg = 'simulate';\n        message.token = token;\n        return this._send(message);\n      }));\n    }).then(securityTraces => {\n      if (securityTraces.every(trace => trace === null)) {\n        return 'Unable to reproduce error in simulation';\n      }\n      return securityTraces.filter(trace => trace).join('\\n\\n');\n    }).catch(e => {\n      return 'Error running simulation: ' + e;\n    });\n    const timeoutPromise = new Promise(resolve => {\n      setTimeout(resolve.bind(null, 'Simulated call timed out'), this._maxSimulationDuration);\n    });\n    return Promise.race([simulationPromise, timeoutPromise]);\n  }\n\n  updateLocalStorage(items) {\n    try {\n      const storage = window.localStorage || window.sessionStorage;\n      for (let item in items) {\n        if (item.value === null) {\n          storage.removeItem(item.key);\n        } else {\n          storage.setItem(item.key, item.value);\n        }\n      }\n    } catch (e) {\n      // If we're denied access, there's nothing we can do.\n    }\n  }\n\n  trackServer(rootUrl) {\n    if (this._servers.hasOwnProperty(rootUrl)) return;\n    const server = this._servers[rootUrl] = {authListeners: []};\n    const authCallbackId = this._registerCallback(this._authCallback.bind(this, server));\n    this._send({msg: 'onAuth', url: rootUrl, callbackId: authCallbackId});\n  }\n\n  _authCallback(server, auth) {\n    server.auth = auth;\n    for (let listener of server.authListeners) listener(auth);\n  }\n\n  onAuth(rootUrl, callback, context) {\n    const listener = callback.bind(context);\n    listener.callback = callback;\n    listener.context = context;\n    this._servers[rootUrl].authListeners.push(listener);\n    listener(this.getAuth(rootUrl));\n  }\n\n  offAuth(rootUrl, callback, context) {\n    const authListeners = this._servers[rootUrl].authListeners;\n    for (let i = 0; i < authListeners.length; i++) {\n      const listener = authListeners[i];\n      if (listener.callback === callback && listener.context === context) {\n        authListeners.splice(i, 1);\n        break;\n      }\n    }\n  }\n\n  getAuth(rootUrl) {\n    return this._servers[rootUrl].auth;\n  }\n\n  authWithCustomToken(url, authToken, options) {\n    return this._send({msg: 'authWithCustomToken', url, authToken, options});\n  }\n\n  unauth(url) {\n    return this._send({msg: 'unauth', url});\n  }\n\n  set(url, value, writeSerial) {return this._send({msg: 'set', url, value, writeSerial});}\n  update(url, value, writeSerial) {return this._send({msg: 'update', url, value, writeSerial});}\n\n  on(listenerKey, url, spec, eventType, snapshotCallback, cancelCallback, context, options) {\n    const handle = {\n      listenerKey, eventType, snapshotCallback, cancelCallback, context,\n      params: {msg: 'on', listenerKey, url, spec, eventType, options}\n    };\n    const callback = this._onCallback.bind(this, handle);\n    this._registerCallback(callback, handle);\n    // Keep multiple IDs to allow the same snapshotCallback to be reused.\n    snapshotCallback.__callbackIds = snapshotCallback.__callbackIds || [];\n    snapshotCallback.__callbackIds.push(handle.id);\n    this._send({\n      msg: 'on', listenerKey, url, spec, eventType, callbackId: handle.id, options\n    }).catch(error => {\n      callback(error);\n    });\n  }\n\n  off(listenerKey, url, spec, eventType, snapshotCallback, context) {\n    const idsToDeregister = [];\n    let callbackId;\n    if (snapshotCallback) {\n      callbackId = this._findAndRemoveCallbackId(\n        snapshotCallback,\n        handle =>\n          handle.listenerKey === listenerKey && handle.eventType === eventType &&\n          handle.context === context\n      );\n      if (!callbackId) return Promise.resolve();  // no-op, never registered or already deregistered\n      idsToDeregister.push(callbackId);\n    } else {\n      for (let id of Object.keys(this._callbacks)) {\n        const handle = this._callbacks[id];\n        if (handle.listenerKey === listenerKey && (!eventType || handle.eventType === eventType)) {\n          idsToDeregister.push(id);\n        }\n      }\n    }\n    // Nullify callbacks first, then deregister after off() is complete.  We don't want any\n    // callbacks in flight from the worker to be invoked while the off() is processing, but we don't\n    // want them to throw an exception either.\n    for (let id of idsToDeregister) this._nullifyCallback(id);\n    return this._send({msg: 'off', listenerKey, url, spec, eventType, callbackId}).then(() => {\n      for (let id of idsToDeregister) this._deregisterCallback(id);\n    });\n  }\n\n  _onCallback(handle, error, snapshotJson) {\n    if (error) {\n      this._deregisterCallback(handle.id);\n      const e = errorFromJson(error, handle.params);\n      if (handle.cancelCallback) {\n        handle.cancelCallback.call(handle.context, e);\n      } else {\n        console.error(e);\n      }\n    } else {\n      handle.snapshotCallback.call(handle.context, new Snapshot(snapshotJson));\n    }\n  }\n\n  transaction(url, oldValue, relativeUpdates) {\n    return this._send({msg: 'transaction', url, oldValue, relativeUpdates});\n  }\n\n  onDisconnect(url, method, value) {\n    return this._send({msg: 'onDisconnect', url, method, value});\n  }\n\n  bounceConnection() {\n    return this._send({msg: 'bounceConnection'});\n  }\n\n  callback({id, args}) {\n    const handle = this._callbacks[id];\n    if (!handle) throw new Error('Unregistered callback: ' + id);\n    handle.callback.apply(null, args);\n  }\n\n  _registerCallback(callback, handle) {\n    handle = handle || {};\n    handle.callback = callback;\n    handle.id = `cb${++this._idCounter}`;\n    this._callbacks[handle.id] = handle;\n    return handle.id;\n  }\n\n  _nullifyCallback(id) {\n    this._callbacks[id].callback = noop;\n  }\n\n  _deregisterCallback(id) {\n    delete this._callbacks[id];\n  }\n\n  _findAndRemoveCallbackId(callback, predicate) {\n    if (!callback.__callbackIds) return;\n    let i = 0;\n    while (i < callback.__callbackIds.length) {\n      const id = callback.__callbackIds[i];\n      const handle = this._callbacks[id];\n      if (!handle) {\n        callback.__callbackIds.splice(i, 1);\n        continue;\n      }\n      if (predicate(handle)) {\n        callback.__callbackIds.splice(i, 1);\n        return id;\n      }\n      i += 1;\n    }\n  }\n}\n\n\nfunction noop() {}\n\nfunction errorFromJson(json, params) {\n  if (!json || json instanceof Error) return json;\n  const error = new Error(json.message);\n  error.params = params;\n  for (let propertyName in json) {\n    if (propertyName === 'message' || !json.hasOwnProperty(propertyName)) continue;\n    try {\n      error[propertyName] = json[propertyName];\n    } catch (e) {\n      e.extra = {propertyName};\n      throw e;\n    }\n  }\n  return error;\n}\n\nfunction getUrlRoot(url) {\n  const k = url.indexOf('/', 8);\n  return k >= 8 ? url.slice(0, k) : url;\n}\n","import Reference from './Reference.js';\nimport {unescapeKey} from './utils.js';\n\nimport _ from 'lodash';\nimport performanceNow from 'performance-now';\n\n// These are defined separately for each object so they're not included in Value below.\nconst RESERVED_VALUE_PROPERTY_NAMES = {$truss: true, $parent: true, $key: true, $path: true};\n\nconst computedPropertyStats = {};\n\n\nclass Value {\n  get $ref() {\n    Object.defineProperty(this, '$ref', {value: new Reference(this.$truss._tree, this.$path)});\n  }\n  get $refs() {return [this.$ref];}\n  get $keys() {return _.keys(this);}\n  get $values() {return _.values(this);}\n  get $root() {return this.$truss.root;}  // access indirectly to leave dependency trace\n  $set(value) {return this.$ref.set(value);}\n  $update(values) {return this.$ref.update(values);}\n  $commit(options, updateFn) {return this.$ref.commit(options, updateFn);}\n  // TODO\n  // $temporarilyOverride(updateFn)\n  // $onPropertyChange(method)\n  // $freezeProperty\n}\n\nclass ComputedPropertyStats {\n  constructor(name) {\n    _.extend(this, {name, numRecomputes: 0, numUpdates: 0, runtime: 0});\n  }\n}\n\n\nexport default class Modeler {\n  constructor(classes) {\n    this._mounts = _(classes).uniq().map(Class => this._mountClass(Class)).flatten().value();\n    const patterns = _.map(this._mounts, mount => mount.regex.toString());\n    if (patterns.length !== _.uniq(patterns).length) {\n      const badPaths = _(patterns)\n        .groupBy()\n        .map((group, key) =>\n          group.length === 1 ? null : key.replace(/\\(\\[\\^\\/\\]\\+\\)/g, '$').slice(1, -1))\n        .compact()\n        .value();\n      throw new Error('Paths have multiple mounted classes: ' + badPaths.join(', '));\n    }\n  }\n\n  destroy() {\n  }\n\n  _augmentClass(Class) {\n    let computedProperties;\n    let proto = Class.prototype;\n    while (proto && proto.constructor !== Object) {\n      for (let name of Object.getOwnPropertyNames(proto)) {\n        const descriptor = Object.getOwnPropertyDescriptor(proto, name);\n        if (name.charAt(0) === '$') {\n          if (_.isEqual(descriptor, Object.getOwnPropertyDescriptor(Value.prototype, name))) {\n            continue;\n          }\n          throw new Error(`Property names starting with \"$\" are reserved: ${Class.name}.${name}`);\n        }\n        if (descriptor.set) {\n          throw new Error(`Computed properties must not have a setter: ${Class.name}.${name}`);\n        }\n        if (descriptor.get && !(computedProperties && computedProperties[name])) {\n          (computedProperties || (computedProperties = {}))[name] = {\n            name, fullName: `${proto.constructor.name}.${name}`, get: descriptor.get\n          };\n        }\n      }\n      proto = Object.getPrototypeOf(proto);\n    }\n    for (let name of Object.getOwnPropertyNames(Value.prototype)) {\n      if (name === 'constructor' || Class.prototype.hasOwnProperty(name)) continue;\n      Object.defineProperty(\n        Class.prototype, name, Object.getOwnPropertyDescriptor(Value.prototype, name));\n    }\n    return computedProperties;\n  }\n\n  _mountClass(Class) {\n    const computedProperties = this._augmentClass(Class);\n    let mounts = Class.$trussMount;\n    if (!mounts) throw new Error(`Class ${Class.name} lacks a $trussMount static property`);\n    if (!_.isArray(mounts)) mounts = [mounts];\n    return _.map(mounts, mount => {\n      if (_.isString(mount)) mount = {path: mount};\n      const variables = [];\n      const pathTemplate = mount.path.replace(/\\/\\$[^\\/]+/g, match => {\n        variables.push(match.slice(1));\n        return '\\u0001';\n      }).replace(/[$-.?[-^{|}]/g, '\\\\$&');\n      for (let variable of variables) {\n        if (variable === '$' || variable.charAt(1) === '$') {\n          throw new Error(`Invalid variable name: ${variable}`);\n        }\n        if (variable.charAt(0) === '$' && (\n            _.has(Value.prototype, variable) || RESERVED_VALUE_PROPERTY_NAMES[variable]\n        )) {\n          throw new Error(`Variable name conflicts with built-in property or method: ${variable}`);\n        }\n      }\n      return {\n        klass: Class, variables, computedProperties,\n        escapedKey: mount.path.match(/\\/([^/]*)$/)[1],\n        placeholder: mount.placeholder,\n        regex: new RegExp('^' + pathTemplate.replace(/\\u0001/g, '/([^/]+)') + '$'),\n        parentRegex: new RegExp(\n          '^' + (pathTemplate.replace(/\\/[^/]*$/, '').replace(/\\u0001/g, '/([^/]+)') || '/') + '$')\n      };\n    });\n  }\n\n  /**\n   * Creates a Truss object and sets all its basic properties: path segment variables, user-defined\n   * properties, and computed properties.  The latter two will be enumerable so that Vue will pick\n   * them up and make the reactive, so you should call _completeCreateObject once it's done so and\n   * before any Firebase properties are added.\n   */\n  createObject(path, properties, touchThis) {\n    let Class = Value;\n    let computedProperties;\n    for (let mount of this._mounts) {\n      mount.regex.lastIndex = 0;\n      var match = mount.regex.exec(path);\n      if (match) {\n        Class = mount.klass;\n        computedProperties = mount.computedProperties;\n        for (let i = 0; i < mount.variables.length; i++) {\n          properties[mount.variables[i]] = {\n            value: unescapeKey(match[i + 1]),\n            writable: false, configurable: false, enumerable: false\n          };\n        }\n        break;\n      }\n    }\n\n    const object = new Class();\n\n    if (computedProperties) {\n      _.each(computedProperties, prop => {\n        properties[prop.name] = this._buildComputedPropertyDescriptor(object, prop, touchThis);\n      });\n    }\n\n    return object;\n  }\n\n  _buildComputedPropertyDescriptor(object, prop, touchThis) {\n    if (!computedPropertyStats[prop.fullName]) {\n      Object.defineProperty(computedPropertyStats, prop.fullName, {\n        value: new ComputedPropertyStats(prop.fullName), writable: false, enumerable: true,\n        configurable: false\n      });\n    }\n    const stats = computedPropertyStats[prop.fullName];\n\n    function computeValue() {\n      // jshint validthis: true\n      // Touch this object, since a failed access to a missing property doesn't get captured as a\n      // dependency.\n      touchThis();\n\n      const startTime = performanceNow();\n      const result = prop.get.call(this);\n      stats.runtime += performanceNow() - startTime;\n      stats.numRecomputes += 1;\n      return result;\n      // jshint validthis: false\n    }\n\n    let value;\n    let writeAllowed = false;\n    let firstCallback = true;\n\n    if (!object.__destructors__) {\n      Object.defineProperty(object, '__destructors__', {\n        value: [], writable: false, enumerable: false, configurable: false});\n    }\n    if (!object.__initializers__) {\n      Object.defineProperty(object, '__initializers__', {\n        value: [], writable: false, enumerable: false, configurable: false});\n    }\n    object.__initializers__.push(vue => {\n      object.__destructors__.push(\n        vue.$watch(computeValue.bind(object), newValue => {\n          if (firstCallback) {\n            stats.numUpdates += 1;\n            value = newValue;\n            firstCallback = false;\n          } else {\n            if (_.isEqual(value, newValue, isTrussValueEqual)) return;\n            stats.numUpdates += 1;\n            writeAllowed = true;\n            object[prop.name] = newValue;\n            writeAllowed = false;\n          }\n        }, {immediate: true})  // use immediate:true since watcher will run computeValue anyway\n      );\n    });\n    return {\n      enumerable: true, configurable: true,\n      get: function() {return value;},\n      set: function(newValue) {\n        if (!writeAllowed) throw new Error(`You cannot set a computed property: ${prop.name}`);\n        value = newValue;\n      }\n    };\n  }\n\n  isPlaceholder(path) {\n    // TODO: optimize by precomputing a single all-placeholder-paths regex\n    return _.some(this._mounts, mount => mount.placeholder && mount.regex.test(path));\n  }\n\n  forEachPlaceholderChild(path, iteratee) {\n    _.each(this._mounts, mount => {\n      if (mount.placeholder && mount.parentRegex.test(path)) {\n        iteratee(mount.escapedKey, mount.placeholder);\n      }\n    });\n  }\n\n  static get computedPropertyStats() {\n    return computedPropertyStats;\n  }\n}\n\n\nfunction isTrussValueEqual(a, b) {\n  if (a && a.$truss || b && b.$truss) return a === b;\n}\n","import angularCompatibility from './angularCompatibility.js';\nimport Coupler from './Coupler.js';\nimport Modeler from './Modeler.js';\nimport {escapeKey, unescapeKey, SERVER_TIMESTAMP} from './utils.js';\n\nimport _ from 'lodash';\nimport Vue from 'vue';\n\n\nclass Transaction {\n  get outcome() {return this._outcome;}\n  get values() {return this._values;}\n\n  _setOutcome(value) {\n    if (this._outcome) throw new Error('Transaction already resolved with ' + this._outcome);\n    this._outcome = value;\n  }\n\n  abort() {\n    this._setOutcome('abort');\n  }\n\n  cancel() {\n    this._setOutcome('cancel');\n  }\n\n  set(value) {\n    if (value === undefined) throw new Error('Invalid argument: undefined');\n    this._setOutcome('set');\n    this._values = {'': value};\n  }\n\n  update(values) {\n    if (values === undefined) throw new Error('Invalid argument: undefined');\n    if (_.isEmpty(values)) return this.cancel();\n    this._setOutcome('update');\n    this._values = values;\n  }\n}\n\n\nexport default class Tree {\n  constructor(truss, rootUrl, bridge, dispatcher, classes) {\n    this._truss = truss;\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._dispatcher = dispatcher;\n    this._firebasePropertyEditAllowed = false;\n    this._writeSerial = 0;\n    this._localWrites = {};\n    this._localWriteTimestamp = null;\n    this._coupler = new Coupler(\n      rootUrl, bridge, dispatcher, this._integrateSnapshot.bind(this), this._prune.bind(this));\n    this._vue = new Vue({data: {$root: undefined}});\n    if (angularCompatibility.active) {\n      this._vue.$watch('$data', angularCompatibility.digest, {deep: true});\n    }\n    this._modeler = new Modeler(classes);\n    this._vue.$data.$root = this._createObject('/', '');\n    this._completeCreateObject(this.root);\n    this._plantPlaceholders(this.root, '/');\n  }\n\n  get root() {\n    return this._vue.$data.$root;\n  }\n\n  get truss() {\n    return this._truss;\n  }\n\n  destroy() {\n    this._coupler.destroy();\n    this._modeler.destroy();\n    this._vue.$destroy();\n  }\n\n  connectReference(ref, valueCallback, method) {\n    this._checkHandle(ref);\n    const operation = this._dispatcher.createOperation('read', method, ref);\n    let unwatch;\n    if (valueCallback) {\n      const segments = _(ref.path).split('/').map(segment => unescapeKey(segment)).value();\n      unwatch = this._vue.$watch(this._getObject.bind(segments), valueCallback);\n    }\n    operation._disconnect = this._disconnectReference.bind(this, ref, operation, unwatch);\n    this._dispatcher.begin(operation).then(() => {\n      if (operation.running) this._coupler.couple(ref.path, operation);\n    }).catch(e => {});  // ignore exception, let onFailure handlers deal with it\n    return operation._disconnect;\n  }\n\n  _disconnectReference(ref, operation, unwatch, error) {\n    if (operation._disconnected) return;\n    operation._disconnected = true;\n    if (unwatch) unwatch();\n    this._coupler.decouple(ref.path, operation);  // will call back to _prune if necessary\n    this._dispatcher.end(operation, error).catch(e => {});\n  }\n\n  isReferenceReady(ref) {\n    this._checkHandle(ref);\n    return this._coupler.isSubtreeReady(ref.path);\n  }\n\n  connectQuery(query, keysCallback, method) {\n    this._checkHandle(query);\n    const operation = this._dispatcher.createOperation('read', method, query);\n    operation._disconnect = this._disconnectQuery.bind(this, query, operation);\n    this._dispatcher.begin(operation).then(() => {\n      if (operation.running) this._coupler.subscribe(query, operation, keysCallback);\n    }).catch(e => {});  // ignore exception, let onFailure handlers deal with it\n    return operation._disconnect;\n  }\n\n  _disconnectQuery(query, operation, error) {\n    if (operation._disconnected) return;\n    operation._disconnected = true;\n    this._coupler.unsubscribe(query, operation);  // will call back to _prune if necessary\n    this._dispatcher.end(operation, error).catch(e => {});\n  }\n\n  isQueryReady(query) {\n    return this._coupler.isQueryReady(query);\n  }\n\n  _checkHandle(handle) {\n    if (!handle.belongsTo(this._truss)) {\n      throw new Error('Reference belongs to another Truss instance');\n    }\n  }\n\n  update(ref, method, values) {\n    const numValues = _.size(values);\n    if (!numValues) return;\n    if (method === 'update') checkUpdateHasOnlyDescendantsWithNoOverlap(ref.path, values);\n    this._applyLocalWrite(values);\n    const url = this.rootUrl + this._extractCommonPathPrefix(values);\n    return this._dispatcher.execute('write', method, ref, () => {\n      if (numValues === 1) {\n        return this._bridge.set(url, values[''], this._writeSerial);\n      } else {\n        return this._bridge.update(url, values, this._writeSerial);\n      }\n    });\n  }\n\n  commit(ref, updateFunction) {\n    const url = this._rootUrl + ref.path;\n    let tries = 0;\n\n    const attemptTransaction = () => {\n      if (tries++ >= 25) return Promise.reject(new Error('maxretry'));\n      const txn = new Transaction();\n      try {\n        updateFunction(txn);\n      } catch (e) {\n        return Promise.reject(e);\n      }\n      const oldValue = toFirebaseJson(this._getObject(ref.path));\n      switch (txn.outcome) {\n        case 'abort': return;\n        case 'cancel':\n          break;\n        case 'set':\n          this._applyLocalWrite({[ref.path]: txn.values['']});\n          break;\n        case 'update':\n          checkUpdateHasOnlyDescendantsWithNoOverlap(ref.path, txn.values);\n          this._applyLocalWrite(txn.values);\n          break;\n        default:\n          throw new Error('Invalid transaction outcome: ' + (txn.outcome || 'none'));\n      }\n      return this._bridge.transaction(url, oldValue, txn.values).then(committed => {\n        if (!committed) return attemptTransaction();\n      });\n    };\n\n    return this._truss.peek(ref, () => {\n      return this._dispatcher.execute('write', 'commit', ref, attemptTransaction);\n    });\n  }\n\n  _applyLocalWrite(values) {\n    // TODO: correctly apply local writes that impact queries.  Currently, a local write will update\n    // any objects currently selected by a query, but won't add or remove results.\n    this._writeSerial++;\n    this._localWriteTimestamp = this._truss.now();\n    _.each(values, (value, path) => {\n      const coupledDescendantPaths = this._coupler.findCoupledDescendantPaths(path);\n      if (_.isEmpty(coupledDescendantPaths)) return;\n      const offset = (path === '/' ? 0 : path.length) + 1;\n      for (let descendantPath of coupledDescendantPaths) {\n        const subPath = descendantPath.slice(offset);\n        let subValue = value;\n        if (subPath) {\n          const segments = subPath.split('/');\n          for (let segment of segments) {\n            subValue = subValue[unescapeKey(segment)];\n            if (subValue === undefined) break;\n          }\n        }\n        if (subValue === undefined || subValue === null) {\n          this._prune(subPath);\n        } else {\n          const key = unescapeKey(_.last(descendantPath.split('/')));\n          this._plantValue(descendantPath, key, subValue, this._scaffoldAncestors(descendantPath));\n        }\n        this._localWrites[descendantPath] = this._writeSerial;\n      }\n    });\n  }\n\n  _extractCommonPathPrefix(values) {\n    let prefixSegments;\n    _.each(values, (value, path) => {\n      const segments = path === '/' ? [] : path.split('/');\n      if (prefixSegments) {\n        let firstMismatchIndex = 0;\n        const maxIndex = Math.min(prefixSegments.length, segments.length);\n        while (firstMismatchIndex < maxIndex &&\n               prefixSegments[firstMismatchIndex] === segments[firstMismatchIndex]) {\n          firstMismatchIndex++;\n        }\n        prefixSegments = prefixSegments.slice(0, firstMismatchIndex);\n        if (!prefixSegments.length) return false;\n      } else {\n        prefixSegments = segments;\n      }\n    });\n    const pathPrefix = '/' + prefixSegments.join('/');\n    _.each(_.keys(values), key => {\n      values[key.slice(pathPrefix.length + 1)] = values[key];\n      delete values[key];\n    });\n    return pathPrefix;\n  }\n\n  /**\n   * Creates a Truss object and sets all its basic properties: path segment variables, user-defined\n   * properties, and computed properties.  The latter two will be enumerable so that Vue will pick\n   * them up and make the reactive, so you should call _completeCreateObject once it's done so and\n   * before any Firebase properties are added.\n   */\n  _createObject(path, key, parent) {\n    if (parent && _.has(parent, key)) throw new Error(`Duplicate object created for ${path}`);\n    let properties = {\n      $truss: {value: this._truss, writable: false, configurable: false, enumerable: false},\n      // We want Vue to wrap this; we'll make it non-enumerable in _completeCreateObject.\n      $parent: {value: parent, writable: false, configurable: true, enumerable: true},\n      $key: {value: key, writable: false, configurable: false, enumerable: false},\n      $path: {value: path, writable: false, configurable: false, enumerable: false}\n    };\n\n    const touchThis = parent ? () => parent[key] : () => this._vue.$data.$root;\n    const object = this._modeler.createObject(path, properties, touchThis);\n    Object.defineProperties(object, properties);\n    return object;\n  }\n\n  // To be called on the result of _createObject after it's been inserted into the _vue hierarchy\n  // and Vue has had a chance to initialize it.\n  _completeCreateObject(object) {\n    for (let name of Object.getOwnPropertyNames(object)) {\n      const descriptor = Object.getOwnPropertyDescriptor(object, name);\n      if (descriptor.configurable && descriptor.enumerable) {\n        descriptor.enumerable = false;\n        if (name === '$parent') {\n          descriptor.configurable = false;\n          descriptor.set = throwReadOnlyError;\n        }\n        Object.defineProperty(object, name, descriptor);\n      }\n    }\n    if (object.__initializers__) {\n      for (let fn of object.__initializers__) fn(this._vue);\n    }\n  }\n\n  _destroyObject(object) {\n    if (!(object && object.$truss)) return;\n    if (object.__destructors__) {\n      for (let fn of object.__destructors__) fn();\n    }\n    for (let key in object) {\n      if (!Object.hasOwnProperty(object, key)) continue;\n      this._destroyObject(object[key]);\n    }\n  }\n\n  _integrateSnapshot(snap) {\n    _.each(_.keys(this._localWrites), (writeSerial, path) => {\n      if (snap.writeSerial >= writeSerial) delete this._localWrites[path];\n    });\n    if (snap.exists) {\n      const parent = this._scaffoldAncestors(snap.path, true);\n      if (parent) this._plantValue(snap.path, snap.key, snap.value, parent, true);\n    } else {\n      this._prune(snap.path, null, true);\n    }\n  }\n\n  _scaffoldAncestors(path, remoteWrite) {\n    let object;\n    const segments = _(path).split('/').dropRight().value();\n    _.each(segments, (segment, i) => {\n      const childKey = unescapeKey(segment);\n      let child = childKey ? object[childKey] : this.root;\n      if (!child) {\n        const ancestorPath = segments.slice(0, i + 1).join('/');\n        if (remoteWrite && this._localWrites[ancestorPath || '/']) return;\n        child = this._plantValue(ancestorPath, childKey, {}, object);\n      }\n      object = child;\n    });\n    return object;\n  }\n\n  _plantValue(path, key, value, parent, remoteWrite) {\n    if (value === null || value === undefined) {\n      throw new Error('Snapshot includes invalid value: ' + value);\n    }\n    if (remoteWrite && this._localWrites[path]) return;\n    if (value === SERVER_TIMESTAMP) value = this._localWriteTimestamp;\n    if (!_.isArray(value) && !_.isObject(value)) {\n      this._setFirebaseProperty(parent, key, value);\n      return;\n    }\n    let object = parent[key];\n    if (object === undefined) {\n      object = this._createObject(path, key, parent);\n      this._setFirebaseProperty(parent, key, object);\n      this._completeCreateObject(object);\n    }\n    _.each(value, (item, escapedChildKey) => {\n      this._plantValue(\n        joinPath(path, escapedChildKey), unescapeKey(escapedChildKey), item, object, remoteWrite);\n    });\n    _.each(object, (item, childKey) => {\n      const escapedChildKey = escapeKey(childKey);\n      if (!value.hasOwnProperty(escapedChildKey)) {\n        this._prune(joinPath(path, escapedChildKey), null, remoteWrite);\n      }\n    });\n    this._plantPlaceholders(object, path);\n    return object;\n  }\n\n  _plantPlaceholders(object, path) {\n    this._modeler.forEachPlaceholderChild(path, (escapedKey, placeholder) => {\n      const key = unescapeKey(escapedKey);\n      if (!object.hasOwnProperty(key)) {\n        this._plantValue(joinPath(path, escapedKey), key, placeholder, object);\n      }\n    });\n  }\n\n  _prune(path, lockedDescendantPaths, remoteWrite) {\n    lockedDescendantPaths = lockedDescendantPaths || {};\n    const object = this._getObject(path);\n    if (!object) return;\n    if (remoteWrite && this._avoidLocalWritePaths(path, lockedDescendantPaths)) return;\n    if (!_.isEmpty(lockedDescendantPaths) || !this._pruneAncestors(object)) {\n      // The target object is a placeholder, and all ancestors are placeholders or otherwise needed\n      // as well, so we can't delete it.  Instead, dive into its descendants to delete what we can.\n      this._pruneDescendants(object, lockedDescendantPaths);\n    }\n  }\n\n  _avoidLocalWritePaths(path, lockedDescendantPaths) {\n    for (let localWritePath in this._localWrites) {\n      if (!this._localWrites.hasOwnProperty(localWritePath)) continue;\n      if (path === localWritePath || localWritePath === '/' ||\n          _.startsWith(path, localWritePath + '/')) return true;\n      if (path === '/' || _.startsWith(localWritePath, path + '/')) {\n        const segments = localWritePath.split('/');\n        for (let i = segments.length; i > 0; i--) {\n          const subPath = segments.slice(0, i).join('/');\n          const active = i === segments.length;\n          if (lockedDescendantPaths[subPath] || lockedDescendantPaths[subPath] === active) break;\n          lockedDescendantPaths[subPath] = active;\n          if (subPath === path) break;\n        }\n      }\n    }\n  }\n\n  _pruneAncestors(targetObject) {\n    // Destroy the child (unless it's a placeholder that's still needed) and any ancestors that\n    // are no longer needed to keep this child rooted, and have no other reason to exist.\n    let deleted = false;\n    let object = targetObject;\n    while (object && object !== this.root) {\n      if (!this._modeler.isPlaceholder(object.$path)) {\n        const ghostObjects = deleted ? null : [targetObject];\n        if (!this._holdsConcreteData(object, ghostObjects)) {\n          deleted = true;\n          this._deleteFirebaseProperty(object.$parent, object.$key);\n        }\n      }\n      object = object.$parent;\n    }\n    return deleted;\n  }\n\n  _holdsConcreteData(object, ghostObjects) {\n    if (ghostObjects && _.contains(ghostObjects, object)) return false;\n    if (_.some(object, value => !value.$truss)) return true;\n    return _.some(object, value => this._holdsConcreteData(value, ghostObjects));\n  }\n\n  _pruneDescendants(object, lockedDescendantPaths) {\n    if (lockedDescendantPaths[object.$path]) return true;\n    let coupledDescendantFound = false;\n    _.each(object, (value, key) => {\n      let shouldDelete = true;\n      let valueLocked;\n      if (lockedDescendantPaths[joinPath(object.$path, escapeKey(key))]) {\n        shouldDelete = false;\n        valueLocked = true;\n      } else if (value.$truss) {\n        if (this._modeler.isPlaceholder(value.$path)) {\n          valueLocked = this._pruneDescendants(value, lockedDescendantPaths);\n          shouldDelete = false;\n        } else if (_.has(lockedDescendantPaths, value.$path)) {\n          valueLocked = this._pruneDescendants(value);\n          shouldDelete = !valueLocked;\n        }\n      }\n      if (shouldDelete) this._deleteFirebaseProperty(object, key);\n      coupledDescendantFound = coupledDescendantFound || valueLocked;\n    });\n    return coupledDescendantFound;\n  }\n\n  _getObject(pathOrSegments) {\n    let object;\n    const segments = _.isString(pathOrSegments) ?\n      _(pathOrSegments).split('/').map(unescapeKey).value() : pathOrSegments;\n    for (let segment of segments) {\n      object = segment ? object[segment] : this.root;\n      if (object === undefined) return;\n    }\n    return object;\n  }\n\n  _getFirebasePropertyDescriptor(object, key) {\n    let descriptor = Object.getOwnPropertyDescriptor(object, key);\n    if (descriptor) {\n      if (!descriptor.enumerable) {\n        throw new Error(\n          `Key conflict between Firebase and instance or computed properties at ` +\n          `${object.$path}: ${key}`);\n      }\n      if (!descriptor.get || !descriptor.set) {\n        throw new Error(`Unbound property at ${object.$path}: ${key}`);\n      }\n    }\n    return descriptor;\n  }\n\n  _setFirebaseProperty(object, key, value) {\n    let descriptor = this._getFirebasePropertyDescriptor(object, key);\n    if (descriptor) {\n      this._firebasePropertyEditAllowed = true;\n      object[key] = value;\n      this._firebasePropertyEditAllowed = false;\n    } else {\n      Vue.set(object, key, value);\n      descriptor = Object.getOwnPropertyDescriptor(object, key);\n      Object.defineProperty(object, key, {\n        get: descriptor.get,\n        set: function(newValue) {\n          if (!this._firebasePropertyEditAllowed) {\n            throw new Error(`Firebase data cannot be mutated directly: ${key}`);\n          }\n          descriptor.set.call(this, newValue);\n        },\n        configurable: true, enumerable: true\n      });\n    }\n  }\n\n  _deleteFirebaseProperty(object, key) {\n    // Make sure it's actually a Firebase property.\n    this._getFirebasePropertyDescriptor(object, key);\n    this._destroyObject(object[key]);\n    Vue.delete(object, key);\n  }\n\n  static get computedPropertyStats() {\n    return Modeler.computedPropertyStats;\n  }\n}\n\n\nfunction throwReadOnlyError() {throw new Error('Read-only property');}\n\nexport function joinPath() {\n  const segments = [];\n  for (let segment of arguments) {\n    if (segment.charAt(0) === '/') segments.splice(0, segments.length);\n    segments.push(segment);\n  }\n  if (segments[0] === '/') segments[0] = '';\n  return segments.join('/');\n}\n\nexport function checkUpdateHasOnlyDescendantsWithNoOverlap(rootPath, values, relativizePaths) {\n  const paths = _(values)\n    .keys().map(path => path === '/' ? '/' : (path + '/')).sortBy(path => path.length).value();\n  _.each(_.keys(values), path => {\n    if (path.charAt(0) !== '/') {\n      throw new Error('Update item does not have an absolute path: ' + path);\n    }\n    if (!(path === rootPath || rootPath === '/' ||\n          _.startsWith(path, rootPath + '/') && path.length > rootPath.length + 1)) {\n      throw new Error(`Update item is not a descendant of target ref: ${path}`);\n    }\n    for (let otherPath of paths) {\n      if (otherPath.length > path.length) break;\n      if (path !== otherPath && _.startsWith(path, otherPath)) {\n        throw new Error(`Update items overlap: ${otherPath} and ${path}`);\n      }\n    }\n    if (relativizePaths) {\n      values[path.slice(rootPath === '/' ? 1 : rootPath.length + 1)] = values[path];\n      delete values[path];\n    }\n  });\n}\n\nexport function toFirebaseJson(object) {\n  if (typeof object === 'object') {\n    const result = {};\n    for (let key in object) {\n      if (!object.hasOwnProperty(key)) continue;\n      result[escapeKey(key)] = toFirebaseJson(object[key]);\n    }\n    return result;\n  } else {\n    return object;\n  }\n}\n\n","import {escapeKey, unescapeKey} from './utils.js';\n\nimport _ from 'lodash';\n\n\nconst EMPTY_ANNOTATIONS = {};\nObject.freeze(EMPTY_ANNOTATIONS);\n\n\nexport class Handle {\n  constructor(tree, path, annotations) {\n    this._tree = tree;\n    this._path = path.replace(/^\\/*/, '/').replace(/\\/$/, '');\n    if (annotations) {\n      this._annotations = annotations;\n      Object.freeze(annotations);\n    }\n  }\n\n  get key() {\n    if (!this._key) this._key = unescapeKey(this._path.replace(/.*\\//, ''));\n    return this._key;\n  }\n  get path() {return this._path;}\n  get _pathPrefix() {return this._path === '/' ? '' : this._path;}\n  get parent() {\n    return new Reference(this._tree, this._path.replace(/\\/[^/]*$/, ''), this._annotations);\n  }\n\n  get annotations() {\n    return this._annotations || EMPTY_ANNOTATIONS;\n  }\n\n  child() {\n    if (!arguments.length) return this;\n    return new Reference(\n      this._tree, `${this._pathPrefix}/${_.map(arguments, key => escapeKey(key)).join('/')}`,\n      this._annotations\n    );\n  }\n\n  children() {\n    if (!arguments.length) return this;\n    const escapedKeys = [];\n    for (let i = 0; i < arguments.length; i++) {\n      const arg = arguments[i];\n      if (_.isArray(arg)) {\n        const mapping = {};\n        const subPath = `${this._pathPrefix}/${escapedKeys.join('/')}`;\n        const rest = _.slice(arguments, i + 1);\n        for (let key of arg) {\n          const subRef =\n            new Reference(this._tree, `${subPath}/${escapeKey(key)}`, this._annotations);\n          mapping[key] = subRef.children.apply(subRef, rest);\n        }\n        return mapping;\n      } else {\n        escapedKeys.push(escapeKey(arg));\n      }\n    }\n    return new Reference(\n      this._tree, `${this._pathPrefix}/${escapedKeys.join('/')}`, this._annotations);\n  }\n\n  peek(callback) {\n    return this._tree.truss.peek(this, callback);\n  }\n\n  isEqual(that) {\n    if (!(that instanceof Handle)) return false;\n    return this._tree === that._tree && this.toString() === that.toString();\n  }\n\n  belongsTo(truss) {\n    return this._tree.truss === truss;\n  }\n}\n\n\nexport class Query extends Handle {\n  constructor(tree, path, spec, annotations) {\n    super(tree, path, annotations);\n    this._spec = this._copyAndValidateSpec(spec);\n  }\n\n  // Vue-bound\n  get ready() {\n    return this._tree.isQueryReady(this);\n  }\n\n  get constraints() {\n    return this._spec;\n  }\n\n  annotate(annotations) {\n    return new Query(\n      this._tree, this._path, this._spec, _.extend({}, this._annotations, annotations));\n  }\n\n  _copyAndValidateSpec(spec) {\n    if (!spec.by) throw new Error('Query needs \"by\" clause: ' + JSON.stringify(spec));\n    if (('at' in spec) + ('from' in spec) + ('to' in spec) > 1) {\n      throw new Error(\n        'Query must contain at most one of \"at\", \"from\", or \"to\" clauses: ' + JSON.stringify(spec));\n    }\n    if (('first' in spec) + ('last' in spec) > 1) {\n      throw new Error(\n        'Query must contain at most one of \"first\" or \"last\" clauses: ' + JSON.stringify(spec));\n    }\n    if (!_.some(['at', 'from', 'to', 'first', 'last'], clause => clause in spec)) {\n      throw new Error(\n        'Query must contain at least one of \"at\", \"from\", \"to\", \"first\", or \"last\" clauses: ' +\n        JSON.stringify(spec));\n    }\n    spec = _.clone(spec);\n    if (spec.by !== '$key' && spec.by !== '$value') {\n      if (!(spec.by instanceof Reference)) {\n        throw new Error('Query \"by\" value must be a reference: ' + spec.by);\n      }\n      let childPath = spec.by.toString();\n      if (!_.startsWith(childPath, this._path)) {\n        throw new Error(\n          'Query \"by\" value must be a descendant of target reference: ' + spec.by);\n      }\n      childPath = childPath.slice(this._path.length).replace(/^\\/?/, '');\n      if (childPath.indexOf('/') === -1) {\n        throw new Error(\n          'Query \"by\" value must not be a direct child of target reference: ' + spec.by);\n      }\n      spec.by = childPath.replace(/.*?\\//, '');\n    }\n    Object.freeze(spec);\n    return spec;\n  }\n\n\n  toString() {\n    if (!this._string) {\n      const queryTerms = _(this._spec)\n        .map((value, key) => `${key}=${encodeURIComponent(JSON.stringify(value))}`)\n        .sortBy()\n        .join('&');\n      this._string = `${this._path}?${queryTerms}`;\n    }\n    return this._string;\n  }\n}\n\n\n// jshint latedef:false\nexport class Reference extends Handle {\n// jshint latedef:nofunc\n\n  constructor(tree, path, annotations) {\n    super(tree, path, annotations);\n  }\n\n  // Vue-bound\n  get ready() {\n    return this._tree.isReferenceReady(this);\n  }\n\n  toString() {\n    return this._path;\n  }\n\n  annotate(annotations) {\n    return new Reference(this._tree, this._path, _.extend({}, this._annotations, annotations));\n  }\n\n  query(spec) {\n    return new Query(this._tree, this._path, spec);\n  }\n\n  set(value) {\n    return this._tree.update(this, 'set', {[this.path]: value});\n  }\n\n  update(values) {\n    return this._tree.update(this, 'update', values);\n  }\n\n  commit(updateFunction) {\n    return this._tree.commit(this, updateFunction);\n  }\n}\n\nexport default Reference;\n","import {Handle, Query, Reference} from './Reference.js';\nimport angular from './angularCompatibility.js';\n\nimport _ from 'lodash';\nimport Vue from 'vue';\n\n\nexport default class Connector {\n  constructor(scope, connections, tree, method) {\n    connections.freeze();\n    this._scope = scope;\n    this._connections = connections;\n    this._tree = tree;\n    this._method = method;\n    this._subConnectors = {};\n    this._currentDescriptors = {};\n    this._disconnects = {};\n    this._vue = new Vue({data: _.mapValues(connections, _.constant(undefined))});\n\n    this._linkScopeProperties();\n\n    _.each(connections, (descriptor, key) => {\n      if (_.isFunction(descriptor)) {\n        this._bindComputedConnection(key, descriptor);\n      } else {\n        this._connect(key, descriptor);\n      }\n    });\n\n    if (angular.active && scope.$on && scope.$$id) scope.$on('$destroy', () => {this.destroy();});\n  }\n\n  get ready() {\n    return _.every(this._currentDescriptors, (descriptor, key) => {\n      if (!descriptor) return false;\n      if (descriptor instanceof Handle) return descriptor.ready;\n      return this._subConnectors[key].ready;\n    });\n  }\n\n  destroy() {\n    this._unlinkScopeProperties();\n    _.each(this._angularUnwatches, unwatch => {unwatch();});\n    _.each(this._connections, (descriptor, key) => {this._disconnect(key);});\n  }\n\n  _linkScopeProperties() {\n    if (!this._scope) return;\n    const duplicateKey = _.find(this._connections, (descriptor, key) => key in this._scope);\n    if (duplicateKey) {\n      throw new Error(`Property already defined on connection target: ${duplicateKey}`);\n    }\n    Object.defineProperties(this._scope, _.mapValues(this._connections, (descriptor, key) => ({\n      configurable: true, enumerable: true, get: () => this._vue.$data[key]\n    })));\n  }\n\n  _unlinkScopeProperties() {\n    if (!this._scope) return;\n    _.each(this._connections, (descriptor, key) => {\n      delete this._scope[key];\n    });\n  }\n\n  _bindComputedConnection(key, fn) {\n    fn = fn.bind(this._scope);\n    const update = this._updateComputedConnection.bind(this, key);\n    this._vue.$watch(fn, update, {immediate: !angular.active});\n    if (angular.active) {\n      if (!this._angularUnwatches) this._angularUnwatches = [];\n      this._angularUnwatches.push(angular.watch(fn, update));\n    }\n  }\n\n  _updateComputedConnection(key, newDescriptor) {\n    const oldDescriptor = this._currentDescriptors[key];\n    if (oldDescriptor === newDescriptor ||\n        newDescriptor instanceof Handle && newDescriptor.isEqual(oldDescriptor)) return;\n    if (!newDescriptor) {\n      this._disconnect(key);\n      return;\n    }\n    if (newDescriptor instanceof Handle || !_.has(this._subConnectors, key)) {\n      this._disconnect(key);\n      this._connect(key, newDescriptor);\n    } else {\n      this._subConnectors[key]._updateConnections(newDescriptor);\n    }\n    this._currentDescriptors[key] = newDescriptor;\n  }\n\n  _updateConnections(connections) {\n    _.each(connections, (descriptor, key) => {\n      this._updateComputedConnection(key, descriptor);\n    });\n    _.each(this._connections, (descriptor, key) => {\n      if (!_.has(connections, key)) this._updateComputedConnection(key);\n    });\n    this._connections = connections;\n  }\n\n  _connect(key, descriptor) {\n    this._currentDescriptors[key] = descriptor;\n    if (!descriptor) return;\n    if (descriptor instanceof Reference) {\n      const updateFn = this._scope ? this._updateScopeRef.bind(this, key) : null;\n      this._disconnects[key] = this._tree.connectReference(descriptor, updateFn, this._method);\n    } else if (descriptor instanceof Query) {\n      const updateFn = this._scope ? this._updateScopeQuery.bind(this, key) : null;\n      this._disconnects[key] = this._tree.connectQuery(descriptor, updateFn, this._method);\n    } else {\n      const subScope = {};\n      const subConnector = this._subConnectors[key] =\n        new Connector(subScope, descriptor, this._tree, this._method);\n      if (this._scope) {\n        const unwatch = this._vue.$watch(() => subConnector.ready, subReady => {\n          if (!subReady) return;\n          unwatch();\n          Vue.set(this._scope, key, subScope);\n          angular.digest();\n        }, {immediate: true});\n      }\n    }\n  }\n\n  _disconnect(key) {\n    if (this._scope) {\n      Vue.delete(this._scope, key);\n      angular.digest();\n    }\n    if (_.has(this._subConnectors, key)) {\n      this._subConnectors[key].destroy();\n      delete this._subConnectors[key];\n    }\n    if (this._disconnects[key]) this._disconnects[key]();\n    delete this._disconnects[key];\n    delete this._currentDescriptors[key];\n  }\n\n  _updateScopeRef(key, value) {\n    if (this._scope[key] !== value) {\n      Vue.set(this._scope, key, value);\n      angular.digest();\n    }\n  }\n\n  _updateScopeQuery(key, childKeys) {\n    let changed = false;\n    if (!this._scope[key]) {\n      Vue.set(this._scope, key, {});\n      changed = true;\n    }\n    const subScope = this._scope[key];\n    for (let childKey in subScope) {\n      if (!subScope.hasOwnProperty(childKey)) continue;\n      if (!_.contains(childKeys, childKey)) {\n        Vue.delete(subScope, childKey);\n        changed = true;\n      }\n    }\n    let object;\n    for (let segment of this._currentDescriptors[key].path.split('/')) {\n      object = segment ? object[segment] : this._tree.root;\n    }\n    for (let childKey of childKeys) {\n      if (subScope.hasOwnProperty(childKey)) continue;\n      Vue.set(subScope, childKey, object[childKey]);\n      changed = true;\n    }\n    if (changed) angular.digest();\n  }\n\n}\n","import _ from 'lodash';\nimport {wrapPromiseCallback} from './utils.js';\n\nclass SlowHandle {\n  constructor(operation, delay, callback) {\n    this._operation = operation;\n    this._delay = delay;\n    this._callback = callback;\n    this._fired = false;\n  }\n\n  initiate() {\n    this.cancel();\n    const elapsed = Date.now() - this._operation._startTimestamp;\n    this._timeoutId = setTimeout(this._delay - elapsed, () => {\n      this._fired = true;\n      this._callback(this._operation);\n    });\n  }\n\n  cancel() {\n    if (this._fired) this._callback(this._operation);\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n}\n\n\nclass Operation {\n  constructor(type, method, target) {\n    this._type = type;\n    this._method = method;\n    this._target = target;\n    this._ready = false;\n    this._running = false;\n    this._startTimestamp = Date.now();\n    this._slowHandles = [];\n  }\n\n  get type() {return this._type;}\n  get method() {return this._method;}\n  get target() {return this._target;}\n  get ready() {return this._ready;}\n  get running() {return this._running;}\n  get error() {return this._error;}\n\n  onSlow(delay, callback) {\n    const handle = new SlowHandle(this, delay, callback);\n    this._slowHandles.push(handle);\n    handle.initiate();\n  }\n\n  _setRunning(value) {\n    this._running = value;\n  }\n\n  _markReady() {\n    this._ready = true;\n    _.each(this._slowHandles, handle => handle.cancel());\n  }\n\n  _clearReady() {\n    this._ready = false;\n    this._startTimestamp = Date.now();\n    _.each(this._slowHandles, handle => handle.initiate());\n  }\n}\n\n\nexport default class Dispatcher {\n  constructor(bridge) {\n    this._bridge = bridge;\n    this._callbacks = {};\n  }\n\n  intercept(operationType, callbacks) {\n    if (!_.contains(['read', 'write', 'auth'], operationType)) {\n      throw new Error('Unknown intercept operation type: ' + operationType);\n    }\n    const badCallbackKeys =\n      _.difference(_.keys(callbacks), ['onBefore', 'onAfter', 'onError', 'onFailure']);\n    if (badCallbackKeys.length) {\n      throw new Error('Unknown intercept callback types: ' + badCallbackKeys.join(', '));\n    }\n    this._addCallback('onBefore', operationType, callbacks.onBefore);\n    this._addCallback('onAfter', operationType, callbacks.onAfter);\n    this._addCallback('onError', operationType, callbacks.onError);\n    this._addCallback('onFailure', operationType, callbacks.onFailure);\n  }\n\n  _addCallback(stage, operationType, callback) {\n    if (!callback) return;\n    const key = this._getCallbacksKey(operationType, stage);\n    (this._callbacks[key] || (this._callbacks[key] = [])).push(wrapPromiseCallback(callback));\n  }\n\n  _getCallbacks(stage, operationType) {\n    return this._callbacks[this._getCallbacksKey(stage, operationType)];\n  }\n\n  _getCallbacksKey(stage, operationType) {\n    return `${stage}_${operationType}`;\n  }\n\n  execute(operationType, method, target, executor) {\n    executor = wrapPromiseCallback(executor);\n    const operation = this.createOperation(operationType, method, target);\n    return this.begin(operation).then(() => {\n      const executeWithRetries = () => {\n        return executor().catch(e => this._retryOrEnd(operation, e).then(executeWithRetries));\n      };\n      return executeWithRetries();\n    }).then(result => this.end(operation).then(() => result));\n  }\n\n  createOperation(operationType, method, target) {\n    return new Operation(operationType, method, target);\n  }\n\n  begin(operation) {\n    return Promise.all(\n      _.map(this._getCallbacks('onBefore', operation.type), onBefore => onBefore(operation))\n    ).then(() => {operation._setRunning(true);}, e => this.end(operation, e));\n  }\n\n  markReady(operation) {\n    operation._markReady();\n  }\n\n  clearReady(operation) {\n    operation._clearReady();\n  }\n\n  retry(operation, error) {\n    return Promise.all(\n      _.map(this._getCallbacks('onError', operation.type), onError => {\n        try {\n          return Promise.resolve(onError(operation, error));\n        } catch (e) {\n          return Promise.reject(e);\n        }\n      })\n    ).then(results => _.some(results));\n  }\n\n  _retryOrEnd(operation, error) {\n    return this.retry(operation, error).then(result => {\n      if (!result) return this.end(operation, error);\n    }, e => this.end(operation, e));\n  }\n\n  end(operation, error) {\n    operation._setRunning(false);\n    if (error) operation._error = error;\n    return Promise.all(\n      _.map(this._getCallbacks('onAfter', operation.type), onAfter => onAfter(operation))\n    ).then(\n      () => this._afterEnd(operation),\n      e => {\n        operation._error = e;\n        return this._afterEnd(operation);\n      }\n    );\n  }\n\n  _afterEnd(operation) {\n    this.markReady(operation);\n    if (operation.error) {\n      const onFailureCallbacks = this._getCallbacks('onFailure', operation.type);\n      return this._bridge.probeError(operation.error).then(() => {\n        if (onFailureCallbacks) {\n          setTimeout(0, () => {\n            _.each(onFailureCallbacks, onFailure => onFailure(operation));\n          });\n        }\n        return Promise.reject(operation.error);\n      });\n    }\n  }\n}\n\n","'use strict';\n\nconst ALPHABET = '-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz';\n\nexport default class KeyGenerator {\n  constructor() {\n    this._lastUniqueKeyTime = 0;\n    this._lastRandomValues = [];\n  }\n\n  generateUniqueKey(now) {\n    now = now || Date.now();\n    const chars = new Array(20);\n    let prefix = now;\n    for (let i = 7; i >= 0; i--) {\n      chars[i] = ALPHABET.charAt(prefix & 0x3f);\n      prefix = Math.floor(prefix / 64);\n    }\n    if (now === this._lastUniqueKeyTime) {\n      let i = 11;\n      while (i >= 0 && this._lastRandomValues[i] === 63) {\n        this._lastRandomValues[i] = 0;\n        i -= 1;\n      }\n      if (i === -1) {\n        throw new Error('Internal assertion failure: ran out of unique IDs for this millisecond');\n      }\n      this._lastRandomValues[i] += 1;\n    } else {\n      this._lastUniqueKeyTime = now;\n      for (let i = 0; i < 12; i++) {\n        // Make sure to leave some space for incrementing in the top nibble.\n        this._lastRandomValues[i] = Math.floor(Math.random() * (i ? 64 : 16));\n      }\n    }\n    for (let i = 0; i < 12; i++) {\n      chars[i + 8] = ALPHABET[this._lastRandomValues[i]];\n    }\n    return chars.join('');\n  }\n}\n","import angularCompatibility from './angularCompatibility.js';\nimport Vue from 'vue';\n\nexport default class MetaTree {\n  constructor(rootUrl, bridge) {\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._vue = new Vue({data: {$root: {\n      connected: undefined, timeOffset: 0, user: undefined, uid: undefined,\n      updateNowAtIntervals(name, intervalMillis) {\n        if (this.hasOwnProperty(name)) throw new Error(`Property \"${name}\" already defined`);\n        Vue.set(this, name, Date.now() + this.timeOffset);\n        setInterval(() => {\n          this[name] = Date.now() + this.timeOffset;\n        }, intervalMillis);\n      }\n    }}});\n\n    if (angularCompatibility.active) {\n      this._vue.$watch('$data', angularCompatibility.digest, {deep: true});\n    }\n\n    bridge.trackAuth(rootUrl);\n    bridge.onAuth(rootUrl, this._handleAuthChange, this);\n\n    this._connectInfoProperty('serverTimeOffset', 'timeOffset');\n    this._connectInfoProperty('connected', 'connected');\n  }\n\n  get root() {\n    return this._vue.$data.$root;\n  }\n\n  destroy() {\n    this._bridge.offAuth(this._rootUrl, this._handleAuthChange, this);\n    this._vue.$destroy();\n  }\n\n  _handleAuthChange(user) {\n    this.root.user = user;\n    this.root.uid = user && user.uid;\n  }\n\n  _connectInfoProperty(property, attribute) {\n    const propertyUrl = `${this._rootUrl}/.info/{property}`;\n    this._bridge.on(propertyUrl, propertyUrl, null, 'value', snap => {\n      this.root[attribute] = snap.value;\n    });\n  }\n}\n","import _ from 'lodash';\nimport Vue from 'vue';\nimport angularCompatibility from './angularCompatibility.js';\n\n\nclass QueryHandler {\n  constructor(coupler, query) {\n    this._coupler = coupler;\n    this._query = query;\n    this._listeners = [];\n    this._keys = [];\n    this._url = this._coupler._rootUrl + query.path;\n    this._segments = query.path.split('/');\n    this._listening = false;\n    this.ready = false;\n  }\n\n  attach(operation, keysCallback) {\n    this._listen();\n    this._listeners.push({operation, keysCallback});\n    keysCallback(this._keys);\n  }\n\n  detach(operation) {\n    const k = _.findIndex(this._listeners, {operation});\n    if (k >= 0) this._listeners.splice(k, 1);\n    return this._listeners.length;\n  }\n\n  _listen() {\n    if (this._listening) return;\n    this._coupler._bridge.on(\n      this._query.toString(), this._url, this._query.constraints, 'value',\n      this._handleSnapshot, this._handleError.bind(this._query.path), this, {sync: true});\n    this._listening = true;\n  }\n\n  destroy() {\n    this._coupler._bridge.off(\n      this._query.toString(), this._url, this._query.constraints, 'value', this._handleSnapshot,\n      this);\n    this._listening = false;\n    this.ready = false;\n    angularCompatibility.digest();\n    for (let key of this._keys) {\n      this._coupler._decoupleSegments(this._segments.concat(key));\n    }\n  }\n\n  _handleSnapshot(snap) {\n    // Order is important here: first couple any new subpaths so _handleSnapshot will update the\n    // tree, then tell the client to update its keys, pulling values from the tree.\n    if (!this._listeners.length || !this._listening) return;\n    const updatedKeys = this._updateKeys(snap);\n    this._coupler._applySnapshot(snap);\n    if (!this.ready) {\n      this.ready = true;\n      angularCompatibility.digest();\n      for (let listener of this._listeners) this._coupler._dispatcher.markReady(listener.operation);\n    }\n    if (updatedKeys) {\n      for (let listener of this._listeners) listener.keysCallback(updatedKeys);\n    }\n  }\n\n  _updateKeys(snap) {\n    let updatedKeys;\n    if (snap.path === this._query.path) {\n      updatedKeys = _.keys(snap.value);\n      updatedKeys.sort();\n      if (_.isEqual(this._keys, updatedKeys)) {\n        updatedKeys = null;\n      } else {\n        for (let key of _.difference(updatedKeys, this._keys)) {\n          this._coupler._coupleSegments(this._segments.concat(key));\n        }\n        for (let key of _.difference(this._keys, updatedKeys)) {\n          this._coupler._decoupleSegments(this._segments.concat(key));\n        }\n        this._keys = updatedKeys;\n      }\n    } else if (snap.path.replace(/\\/[^/]+/, '') === this._query.path) {\n      const hasKey = _.contains(this._keys, snap.key);\n      if (snap.value) {\n        if (!hasKey) {\n          this._coupler._coupleSegments(this._segments.concat(snap.key));\n          this._keys.push(snap.key);\n          this._keys.sort();\n          updatedKeys = this._keys;\n        }\n      } else {\n        if (hasKey) {\n          this._coupler._decoupleSegments(this._segments.concat(snap.key));\n          _.pull(this._keys, snap.key);\n          this._keys.sort();\n          updatedKeys = this._keys;\n        }\n      }\n    }\n    return updatedKeys;\n  }\n\n  _handleError(error) {\n    if (!this._listeners.length || !this._listening) return;\n    this._listening = false;\n    Promise.all(_.map(this._listeners, listener => {\n      this._coupler._dispatcher.clearReady(listener.operation);\n      return this._coupler._dispatcher.retry(listener.operation, error).catch(e => {\n        listener.operation._disconnect(e);\n        return false;\n      });\n    })).then(results => {\n      if (_.some(results)) {\n        if (this._listeners.length) this._listen();\n      } else {\n        for (let listener of this._listeners) listener.operation._disconnect(error);\n      }\n    });\n  }\n}\n\n\nclass Node {\n  constructor(coupler, path) {\n    this._coupler = coupler;\n    this.path = path;\n    this.url = this._coupler._rootUrl + path;\n    this.operations = [];\n    this.queryCount = 0;\n    this.listening = false;\n    this.ready = false;\n    this.children = {};\n  }\n\n  get active() {\n    return this.count || this.queryCount;\n  }\n\n  get count() {\n    return this.operations.length;\n  }\n\n  listen(skip) {\n    if (!skip && this.count) {\n      if (this.listening) return;\n      _.each(this.operations, op => {this._coupler._dispatcher.clearReady(op);});\n      this._coupler._bridge.on(\n        this.url, this.url, null, 'value', this._handleSnapshot, this._handleError.bind(this),\n        this, {sync: true});\n      this.listening = true;\n    } else {\n      _.each(this.children, child => {child.listen();});\n    }\n  }\n\n  unlisten(skip) {\n    if (!skip && this.listening) {\n      this._coupler._bridge.off(this.url, this.url, null, 'value', this._handleSnapshot, this);\n      this.listening = false;\n      this._forAllDescendants(node => {\n        if (node.ready) {\n          node.ready = false;\n          angularCompatibility.digest();\n        }\n      });\n    } else {\n      _.each(this.children, child => {child.unlisten();});\n    }\n  }\n\n  _handleSnapshot(snap) {\n    if (!this.listening || !this._coupler.isTrunkCoupled(snap.path)) return;\n    this._coupler._applySnapshot(snap);\n    if (!this.ready && snap.path === this.path) {\n      this.ready = true;\n      angularCompatibility.digest();\n      this.unlisten(true);\n      this._forAllDescendants(node => {\n        for (let op of this.operations) this._coupler._dispatcher.markReady(op);\n      });\n    }\n  }\n\n  _handleError(error) {\n    if (!this.count || !this.listening) return;\n    this.listening = false;\n    this._forAllDescendants(node => {\n      if (node.ready) {\n        node.ready = false;\n        angularCompatibility.digest();\n      }\n      for (let op of this.operations) this._coupler._dispatcher.clearReady(op);\n    });\n    return Promise.all(_.map(this.operations, op => {\n      return this._coupler._dispatcher.retry(op, error).catch(e => {\n        op._disconnect(e);\n        return false;\n      });\n    })).then(results => {\n      if (_.some(results)) {\n        if (this.count) this.listen();\n      } else {\n        for (let op of this.operations) op._disconnect(error);\n        // Pulling all the operations will automatically get us listening on descendants.\n      }\n    });\n  }\n\n  _forAllDescendants(iteratee) {\n    iteratee(this);\n    _.each(this.children, child => child._forAllDescendants(iteratee));\n  }\n\n  collectCoupledDescendantPaths(paths) {\n    if (!paths) paths = {};\n    paths[this.path] = this.active;\n    if (!this.active) {\n      _.each(this.children, child => {child.collectCoupledDescendantPaths(paths);});\n    }\n    return paths;\n  }\n}\n\n\nexport default class Coupler {\n  constructor(rootUrl, bridge, dispatcher, applySnapshot, prunePath) {\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._dispatcher = dispatcher;\n    this._applySnapshot = applySnapshot;\n    this._prunePath = prunePath;\n    this._vue = new Vue({data: {root: new Node(this, '/'), queryHandlers: {}}});\n  }\n\n  get _root() {return this._vue.root;}\n  get _queryHandlers() {return this._vue.queryHandlers;}\n\n  destroy() {\n    _.each(this._queryHandlers, queryHandler => {queryHandler.destroy();});\n    this._root.unlisten();\n    this._vue.$destroy();\n  }\n\n  couple(path, operation) {\n    return this._coupleSegments(path.split('/'), operation);\n  }\n\n  _coupleSegments(segments, operation) {\n    let node;\n    let superseded = !operation;\n    let ready = false;\n    for (let segment of segments) {\n      let child = segment ? node.children && node.children[segment] : this._root;\n      if (!child) {\n        child = new Node(this, `${node.path === '/' ? '' : node.path}/${segment}`);\n        Vue.set(node.children, segment, child);\n      }\n      superseded = superseded || child.listening;\n      ready = ready || child.ready;\n      node = child;\n    }\n    if (operation) {\n      node.operations.push(operation);\n    } else {\n      node.queryCount++;\n    }\n    if (superseded) {\n      if (operation && ready) this._dispatcher.markReady(operation);\n    } else {\n      node.listen();  // node will call unlisten() on descendants when ready\n    }\n  }\n\n  decouple(path, operation) {\n    return this._decoupleSegments(path.split('/'), operation);\n  }\n\n  _decoupleSegments(segments, operation) {\n    const ancestors = [];\n    let node;\n    for (let segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) break;\n      ancestors.push(node);\n    }\n    if (!node || !(operation ? node.count : node.queryCount)) {\n      throw new Error(`Path not coupled: ${segments.join('/')}`);\n    }\n    if (operation) {\n      _.pull(node.operations, operation);\n    } else {\n      node.queryCount--;\n    }\n    if (operation && !node.count) {\n      // Ideally, we wouldn't resync the full values here since we probably already have the current\n      // value for all children.  But making sure that's true is tricky in an async system (what if\n      // the node's value changes and the update crosses the 'off' call in transit?) and this\n      // situation should be sufficiently rare that the optimization is probably not worth it right\n      // now.\n      node.listen();\n      if (node.listening) node.unlisten();\n    }\n    if (!node.active) {\n      const coupledDescendantPaths = node.collectCoupledDescendantPaths();\n      this._prunePath(segments.join('/'), coupledDescendantPaths);\n      for (let i = ancestors.length - 1; i > 0; i--) {\n        node = ancestors[i];\n        if (node === this._root || node.active || !_.isEmpty(node.children)) break;\n        Vue.delete(ancestors[i - 1].children, segments[i]);\n      }\n    }\n  }\n\n  subscribe(query, operation, keysCallback) {\n    let queryHandler = this._queryHandlers[query.toString()];\n    if (!queryHandler) {\n      queryHandler = new QueryHandler(this, query);\n      Vue.set(this._queryHandlers, query.toString(), queryHandler);\n    }\n    queryHandler.attach(operation, keysCallback);\n }\n\n  unsubscribe(query, operation) {\n    const queryHandler = this._queryHandlers[query.toString()];\n    if (queryHandler && !queryHandler.detach(operation)) {\n      queryHandler.destroy();\n      Vue.delete(this._queryHandlers, query.toString());\n    }\n  }\n\n  // Return whether the node at path or any ancestors are coupled.\n  isTrunkCoupled(path) {\n    const segments = path.split('/');\n    let node;\n    for (let segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) return false;\n      if (node.active) return true;\n    }\n    return false;\n  }\n\n  findCoupledDescendantPaths(path) {\n    const segments = path.split('/');\n    let node;\n    for (let segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) break;\n    }\n    return node ? node.collectCoupledDescendantPaths() : {};\n  }\n\n  isSubtreeReady(path) {\n    const segments = path.split('/');\n    let node;\n    for (let segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) return false;\n      if (node.ready) return true;\n    }\n    return false;\n  }\n\n  isQueryReady(query) {\n    const queryHandler = this._queryHandlers[query.toString()];\n    return queryHandler && queryHandler.ready;\n  }\n\n}\n\n","// Generated by CoffeeScript 1.7.1\n(function() {\n  var getNanoSeconds, hrtime, loadTime;\n\n  if ((typeof performance !== \"undefined\" && performance !== null) && performance.now) {\n    module.exports = function() {\n      return performance.now();\n    };\n  } else if ((typeof process !== \"undefined\" && process !== null) && process.hrtime) {\n    module.exports = function() {\n      return (getNanoSeconds() - loadTime) / 1e6;\n    };\n    hrtime = process.hrtime;\n    getNanoSeconds = function() {\n      var hr;\n      hr = hrtime();\n      return hr[0] * 1e9 + hr[1];\n    };\n    loadTime = getNanoSeconds();\n  } else if (Date.now) {\n    module.exports = function() {\n      return Date.now() - loadTime;\n    };\n    loadTime = Date.now();\n  } else {\n    module.exports = function() {\n      return new Date().getTime() - loadTime;\n    };\n    loadTime = new Date().getTime();\n  }\n\n}).call(this);\n","import _ from 'lodash';\nimport Vue from 'vue';\nimport angularCompatibility from './angularCompatibility.js';\nimport Bridge from './Bridge.js';\nimport Connector from './Connector.js';\nimport Dispatcher from './Dispatcher.js';\nimport KeyGenerator from './KeyGenerator.js';\nimport MetaTree from './MetaTree.js';\nimport Reference from './Reference.js';\nimport Tree from './Tree.js';\nimport {escapeKey, unescapeKey, wrapPromiseCallback, SERVER_TIMESTAMP} from './utils.js';\n\n\nlet bridge;\nconst workerFunctions = {};\n\n\nexport default class Truss {\n\n  /**\n   * Create a new Truss instance, specific to a given datastore.  To avoid confusion there should be\n   * exactly one Truss per root datastore URL, so in most code this will be a singleton.\n   *\n   * @param rootUrl {String} The root URL, https://{project}.firebaseio.com.\n   * @param classes {Array<Function>} A list of the classes to map onto the datastore structure.\n   *    Each class must have a static $trussMount property that is a (wildcarded) datastore path, or\n   *    an options object {path: string, placeholder: object}, or an array of either.\n   */\n  constructor(rootUrl, classes) {\n    // TODO: allow rootUrl to be a test database object for testing\n    if (!bridge) {\n      throw new Error('Truss worker not connected, please call Truss.connectWorker first');\n    }\n    this._rootUrl = rootUrl.replace(/\\/$/, '');\n    this._keyGenerator = new KeyGenerator();\n    this._dispatcher = new Dispatcher(bridge);\n\n    this._metaTree = new MetaTree(this._rootUrl, bridge);\n    Object.defineProperty(this, 'meta', {\n      value: this._metaTree.root, writable: false, configurable: false, enumerable: false\n    });\n\n    this._tree = new Tree(this, this._rootUrl, bridge, this._dispatcher, classes);\n    Object.defineProperty(this, 'root', {\n      value: this._tree.root, writable: false, configurable: false, enumerable: false\n    });\n  }\n\n  destroy() {\n    this._tree.destroy();\n    this._metaTree.destroy();\n  }\n\n  get now() {return Date.now() + this.meta.timeOffset;}\n  newKey() {return this._keyGenerator.generateUniqueKey(this.now);}\n\n  authenticate(token) {\n    return this._dispatcher.execute('auth', new Reference(this._tree, '/'), () => {\n      return bridge.authWithCustomToken(this._rootUrl, token);\n    });\n  }\n  unauthenticate() {\n    return this._dispatcher.execute('auth', new Reference(this._tree, '/'), () => {\n      return bridge.unauth(this._rootUrl);\n    });\n  }\n\n  intercept(actionType, callbacks) {\n    return this._dispatcher.intercept(actionType, callbacks);\n  }\n\n  // connections are {key: Query | Object | fn() -> (Query | Object)}\n  connect(scope, connections) {\n    if (!connections) {\n      connections = scope;\n      scope = undefined;\n    }\n    return new Connector(scope, connections, this._tree, 'connect');\n  }\n\n  // target is Reference, Query, or connection Object like above\n  peek(target, callback) {\n    callback = wrapPromiseCallback(callback);\n    return new Promise((resolve, reject) => {\n      const scope = {};\n      const connector = new Connector(scope, {result: target}, this._tree, 'peek');\n      const vue = new Vue();\n      vue.$watch(() => connector.ready, ready => {\n        if (!ready) return;\n        vue.$destroy();\n        callback(scope.result).then(result => {\n          connector.destroy();\n          resolve(result);\n        }, error => {\n          connector.destroy();\n          reject(error);\n        });\n      });\n    });\n  }\n\n  static get computedPropertyStats() {return this._tree.computedPropertyStats;}\n\n  static connectWorker(webWorker) {\n    if (bridge) throw new Error('Worker already connected');\n    if (_.isString(webWorker)) {\n      const Worker = window.SharedWorker || window.Worker;\n      if (!Worker) throw new Error('Browser does not implement Web Workers');\n      webWorker = new Worker(webWorker);\n    }\n    bridge = new Bridge(webWorker);\n    return bridge.init(webWorker).then(\n      ({exposedFunctionNames, firebaseSdkVersion}) => {\n        Truss.FIREBASE_SDK_VERSION = firebaseSdkVersion;\n        for (let name of exposedFunctionNames) {\n          Truss.worker[name] = bridge.bindExposedFunction(name);\n        }\n      }\n    );\n  }\n\n  static get worker() {return workerFunctions;}\n\n  static preExpose(functionName) {\n    Truss.worker[functionName] = bridge.bindExposedFunction(functionName);\n  }\n\n  static bounceConnection() {return bridge.bounceConnection();}\n  static suspend() {return bridge.suspend();}\n  static debugPermissionDeniedErrors(simulatedTokenGenerator, maxSimulationDuration, callFilter) {\n    return bridge.debugPermissionDeniedErrors(\n      simulatedTokenGenerator, maxSimulationDuration, callFilter);\n  }\n\n  static debounceAngularDigest(wait) {\n    angularCompatibility.debounceDigest(wait);\n  }\n\n  static escapeKey(key) {return escapeKey(key);}\n  static unescapeKey(escapedKey) {return unescapeKey(escapedKey);}\n\n  static get SERVER_TIMESTAMP() {return SERVER_TIMESTAMP;}\n}\n\nangularCompatibility.defineModule(Truss);\n"]}