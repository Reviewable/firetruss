{"version":3,"sources":["../src/angularCompatibility.js","../src/utils.js","../src/Bridge.js","../src/Connector.js","../src/Modeler.js","../src/Tree.js","../src/Reference.js","../src/Dispatcher.js","../src/KeyGenerator.js","../src/MetaTree.js","../src/Coupler.js","../node_modules/performance-now/lib/performance-now.js","../src/Truss.js"],"names":["indirectBareDigest","bareDigest","noop","escapeKey","key","toString","replace","char","charCodeAt","unescapeKey","code","String","fromCharCode","parseInt","slice","wrapPromiseCallback","callback","Promise","resolve","apply","this","arguments","e","reject","promiseCancel","promise","cancel","promiseFinally","propagatePromiseProperty","propertyName","const","originalThen","then","originalCatch","catch","onResolved","onRejected","derivedPromise","call","onFinally","result","error","joinPath","segments","i","list","length","let","segment","_","isString","charAt","splice","push","join","makePathMatcher","pattern","matcher","pathMatchers","PathMatcher","size","maxNumPathMatchers","keys","errorFromJson","json","params","Error","message","hasOwnProperty","extra","getUrlRoot","url","k","indexOf","flattenRefs","refs","Handle","mapValues","computeValue","prop","stats","$$touchThis","startTime","performanceNow","get","ErrorWrapper","runtime","numRecomputes","wrapConnections","object","connections","descriptor","isFunction","isTrussValueEqual","a","b","$truss","checkUpdateHasOnlyDescendantsWithNoOverlap","rootPath","values","each","path","startsWith","absolutePath","allPaths","map","sortBy","value","otherPath","relativizePaths","toFirebaseJson","digestRequested","angularProxy","active","window","angular","debounceDigest","wait","digest","debounce","watch","module","run","$rootScope","$evalAsync","$watch","bind","defineModule","Truss","constant","forEach","method","SERVER_TIMESTAMP","Object","freeze",".sv","variables","prefixMatch","endsWith","pathTemplate","match","test","_regex","RegExp","prototype","lastIndex","exec","bindings","MIN_WORKER_VERSION","Snapshot","ref","valueError","exists","_path","_value","_valueError","_exists","undefined","prototypeAccessors","_checkValue","_key","Bridge","webWorker","_idCounter","_deferreds","_suspended","_servers","_callbacks","_log","_simulatedTokenGenerator","_maxSimulationDuration","_simulatedCallFilter","_inboundMessages","_outboundMessages","_flushMessageQueue","_port","port","_shared","onmessage","_receive","addEventListener","_send","msg","setInterval","init","items","storage","localStorage","sessionStorage","getItem","response","workerVersion","version","minVersion","sufficient","suspend","suspended","_receiveMessages","debugPermissionDeniedErrors","simulatedTokenGenerator","maxSimulationDuration","callFilter","enableLogging","fn","console","log","id","oneWay","this$1","deferred","sent","resolveSent","postMessage","event","concat","data","messages","bindExposedFunction","name","args","Array","probeError","toLowerCase","_simulateCall","securityTrace","permissionDeniedDetails","props","simulatedCalls","spec","newValue","auth","getAuth","simulationPromise","uid","token","all","securityTraces","every","trace","filter","timeoutPromise","setTimeout","race","updateLocalStorage","item","removeItem","setItem","trackServer","rootUrl","server","authListeners","authCallbackId","_registerCallback","_authCallback","callbackId","listener","onAuth","context","offAuth","authWithCustomToken","authToken","options","unauth","set","writeSerial","update","on","listenerKey","eventType","snapshotCallback","cancelCallback","handle","_onCallback","__callbackIds","off","idsToDeregister","_findAndRemoveCallbackId","i$1","list$1","_nullifyCallback","_deregisterCallback","snapshotJson","transaction","oldValue","relativeUpdates","onDisconnect","bounceConnection","predicate","EMPTY_ANNOTATIONS","tree","annotations","_tree","_annotations","$ref","_pathPrefix","parent","Reference","child","children","escapedKeys","arg","isArray","mapping","subPath","rest","subRef","subMapping","isEmpty","peek","truss","isEqual","that","belongsTo","Query","super","_spec","_copyAndValidateSpec","queryTerms","encodeURIComponent","JSON","stringify","_string","prototypeAccessors$1","ready","isQueryReady","constraints","annotate","extend","by","some","clause","clone","childPath","prototypeAccessors$2","isReferenceReady","getObject","query","obj","override","commit","updateFunction","Connector","scope","_scope","_connections","_method","_subConnectors","_disconnects","_angularUnwatches","_vue","Vue","descriptors","destroy","seal","_linkScopeProperties","_bindComputedConnection","_connect","$on","$id","ignored","at","_unlinkScopeProperties","unwatch","_disconnect","$destroy","__ob__","defineProperties","configurable","enumerable","getter","_computeConnection","_updateComputedConnection","immediate","deep","newDescriptor","oldDescriptor","has","_updateConnections","updateFn","_updateScopeRef","connectReference","_updateScopeQuery","connectQuery","subScope","subRefs","subConnector","subReady","delete","childKeys","changed","childKey","contains","split","root","INTERCEPT_KEYS","EMPTY_ARRAY","SlowHandle","operation","delay","_operation","_delay","_callback","_fired","initiate","elapsed","Date","now","_startTimestamp","_timeoutId","clearTimeout","Operation","type","target","_type","_target","_ready","_running","_ended","_tries","_slowHandles","running","ended","tries","_error","onSlow","_setRunning","_setEnded","_markReady","_clearReady","_incrementTries","Dispatcher","bridge","_bridge","intercept","interceptKey","callbacks","badCallbackKeys","difference","wrappedCallbacks","onBefore","_addCallback","onAfter","onError","onFailure","_removeCallbacks","stage","_getCallbacksKey","wrappedCallback","_removeCallback","pull","_getCallbacks","operationType","execute","executor","createOperation","begin","executeWithRetries","_retryOrEnd","end","markReady","clearReady","retry","results","retrying","_afterEnd","onFailureCallbacks","ALPHABET","KeyGenerator","_lastUniqueKeyTime","_lastRandomValues","generateUniqueKey","chars","prefix","Math","floor","random","MetaTree","_rootUrl","$root","connected","timeOffset","user","userid","nowAtInterval","intervalMillis","angularCompatibility","_handleAuthChange","_connectInfoProperty","$data","property","attribute","propertyUrl","snap","QueryHandler","coupler","_coupler","_query","_listeners","_keys","_url","_segments","_listening","attach","keysCallback","_listen","detach","findIndex","_handleSnapshot","_handleError","sync","_decoupleSegments","updatedKeys","_updateKeys","_applySnapshot","_dispatcher","sort","_coupleSegments","hasKey","Node","operations","queryCount","listening","count","listen","skip","op","unlisten","_forAllDescendants","node","isTrunkCoupled","iteratee","collectCoupledDescendantPaths","paths","Coupler","dispatcher","applySnapshot","prunePath","_prunePath","queryHandlers","_root","_queryHandlers","queryHandler","couple","superseded","decouple","ancestors","findCoupledDescendantPaths","subscribe","unsubscribe","pathOrSegments","isSubtreeReady","creatingObjectProperties","getNanoSeconds","hrtime","loadTime","performance","exports","process","hr","getTime","RESERVED_VALUE_PROPERTY_NAMES","$parent","$key","$path","$$initializers","$$finalizers","$$watchers","$$$trussCheck","computedPropertyStats","Value","defineProperty","$refs","lastIndexOf","$empty","$keys","$values","$meta","meta","$now","$ready","$overridden","$intercept","actionType","unintercept","uninterceptAndRemoveFinalizer","$connect","connector","connect","originalDestroy","$peek","subjectFn","callbackFn","unwatchAndRemoveFinalizer","$when","expression","when","$set","$update","$override","$commit","writable","ComputedPropertyStats","numUpdates","runtimePerRecompute","Modeler","_trie","Class","classes","rootAcceptable","isPlainObject","$trussMount","$$trussMount","uniq","_mountClass","_decorateTrie","_getMount","scaffold","$","_findMount","local","localDescendants","_augmentClass","computedProperties","proto","constructor","getOwnPropertyNames","getOwnPropertyDescriptor","fullName","getPrototypeOf","mounts","mount","variable","escapedKey","placeholder","targetMount","createObject","properties","keysUnsafe","create","_buildComputedPropertyDescriptor","writeAllowed","vue","last","_watchers","destroyObject","isPlaceholder","isLocal","forEachPlaceholderChild","checkVueObject","checkedObjects","top","includes","trussCode","isObject","isExtensible","Function","staticAccessors","stat","Transaction","currentValue","outcome","_outcome","_values","_setOutcome","abort","","Tree","_truss","_firebasePropertyEditAllowed","_writeSerial","_localWrites","_localWriteTimestamp","_initialized","_modeler","_integrateSnapshot","_prune","_createObject","_fixObject","_completeCreateObject","_plantPlaceholders","valueCallback","_checkHandle","_disconnectReference","_disconnected","_coupled","_disconnectQuery","numValues","_applyLocalWrite","_extractCommonPathPrefix","attemptTransaction","txn","committed","coupledDescendantPaths","offset","descendantPath","subValue","_plantValue","_scaffoldAncestors","prefixSegments","firstMismatchIndex","maxIndex","min","pathPrefix","_destroyObject","remoteWrite","dropRight","ancestorPath","_setFirebaseProperty","objectCreated","escapedChildKey","lockedDescendantPaths","_avoidLocalWritePaths","_pruneAncestors","_pruneDescendants","localWritePath","targetPath","targetObject","deleted","targetSegments","ghostObjects","_holdsConcreteData","_deleteFirebaseProperty","coupledDescendantFound","valueLocked","shouldDelete","_getFirebasePropertyDescriptor","_overwriteFirebaseProperty","logging","workerFunctions","VERSION","_keyGenerator","_metaTree","newKey","authenticate","rememberMe","unauthenticate","cleanup","callbackPromise","numCallbacks","timeoutHandle","nextTick","timeoutMessage","timeout","checkObjectsForRogueProperties","logComputedPropertyStats","n","take","totals","lines","toFixed","unshift","widths","range","line","max","column","padLeft","connectWorker","Worker","SharedWorker","exposedFunctionNames","firebaseSdkVersion","worker","preExpose","functionName","debounceAngularDigest","FIREBASE_SDK_VERSION"],"mappings":"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","file":"firetruss.umd.min.js","sourcesContent":["/* globals window */\n\nimport _ from 'lodash';\n\n\nlet digestRequested;\nlet bareDigest = function() {\n  digestRequested = true;\n};\nfunction indirectBareDigest() {\n  bareDigest();\n}\n\nconst angularProxy = {\n  active: typeof window !== 'undefined' && window.angular,\n  debounceDigest(wait) {\n    // Bind indirectly, so we always pick up the latest definition of bareDigest.\n    if (wait) {\n      angularProxy.digest = _.debounce(indirectBareDigest, wait);\n    } else {\n      angularProxy.digest = indirectBareDigest;\n    }\n  }\n};\n\nif (angularProxy.active) {\n  angularProxy.digest = indirectBareDigest;\n  angularProxy.watch = function() {throw new Error('Angular watch proxy not yet initialized');};\n  window.angular.module('firetruss', []).run(['$rootScope', function($rootScope) {\n    bareDigest = function() {\n      if (digestRequested) return;\n      digestRequested = true;\n      $rootScope.$evalAsync(function() {digestRequested = false;});\n    };\n    if (digestRequested) angularProxy.digest();\n    angularProxy.watch = $rootScope.$watch.bind($rootScope);\n  }]);\n  angularProxy.defineModule = function(Truss) {\n    window.angular.module('firetruss').constant('Truss', Truss);\n  };\n} else {\n  ['digest', 'watch', 'defineModule'].forEach(method => {angularProxy[method] = noop;});\n}\n\nfunction noop() {}\n\nexport default angularProxy;\n","import _ from 'lodash';\n\n\nexport const SERVER_TIMESTAMP = Object.freeze({'.sv': 'timestamp'});\n\nexport function escapeKey(key) {\n  if (!key) return key;\n  return key.toString().replace(/[\\\\\\.\\$\\#\\[\\]\\/]/g, function(char) {\n    return '\\\\' + char.charCodeAt(0).toString(16);\n  });\n}\n\nexport function unescapeKey(key) {\n  if (!key) return key;\n  return key.toString().replace(/\\\\[0-9a-f]{2}/gi, function(code) {\n    return String.fromCharCode(parseInt(code.slice(1), 16));\n  });\n}\n\nexport function wrapPromiseCallback(callback) {\n  return function() {\n    try {\n      return Promise.resolve(callback.apply(this, arguments));\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n}\n\nexport function promiseCancel(promise, cancel) {\n  promise = promiseFinally(promise, () => {cancel = null;});\n  promise.cancel = () => {\n    if (!cancel) return;\n    cancel();\n    cancel = null;\n  };\n  propagatePromiseProperty(promise, 'cancel');\n  return promise;\n}\n\nfunction propagatePromiseProperty(promise, propertyName) {\n  const originalThen = promise.then, originalCatch = promise.catch;\n  promise.then = (onResolved, onRejected) => {\n    const derivedPromise = originalThen.call(promise, onResolved, onRejected);\n    derivedPromise[propertyName] = promise[propertyName];\n    propagatePromiseProperty(derivedPromise, propertyName);\n    return derivedPromise;\n  };\n  promise.catch = onRejected => {\n    const derivedPromise = originalCatch.call(promise, onRejected);\n    derivedPromise[propertyName] = promise[propertyName];\n    propagatePromiseProperty(derivedPromise, propertyName);\n    return derivedPromise;\n  };\n  return promise;\n}\n\nexport function promiseFinally(promise, onFinally) {\n  if (!onFinally) return promise;\n  onFinally = wrapPromiseCallback(onFinally);\n  return promise.then(result => {\n    return onFinally().then(() => result);\n  }, error => {\n    return onFinally().then(() => Promise.reject(error));\n  });\n}\n\nexport function joinPath() {\n  const segments = [];\n  for (let segment of arguments) {\n    if (!_.isString(segment)) segment = '' + segment;\n    if (segment.charAt(0) === '/') segments.splice(0, segments.length);\n    segments.push(segment);\n  }\n  if (segments[0] === '/') segments[0] = '';\n  return segments.join('/');\n}\n\n\nconst pathMatchers = {};\nconst maxNumPathMatchers = 1000;\n\n\nclass PathMatcher {\n  constructor(pattern) {\n    this.variables = [];\n    const prefixMatch = _.endsWith(pattern, '/$*');\n    if (prefixMatch) pattern = pattern.slice(0, -3);\n    const pathTemplate = pattern.replace(/\\/\\$[^\\/]*/g, match => {\n      if (match.length > 1) this.variables.push(match.slice(1));\n      return '\\u0001';\n    });\n    Object.freeze(this.variables);\n    if (/[$-.?[-^{|}]/.test(pathTemplate)) {\n      throw new Error('Path pattern has unescaped keys: ' + pattern);\n    }\n    this._regex = new RegExp(\n      '^' + pathTemplate.replace(/\\u0001/g, '/([^/]+)') + (prefixMatch ? '($|/)' : '$'));\n  }\n\n  match(path) {\n    this._regex.lastIndex = 0;\n    const match = this._regex.exec(path);\n    if (!match) return;\n    const bindings = {};\n    for (let i = 0; i < this.variables.length; i++) {\n      bindings[this.variables[i]] = unescapeKey(match[i + 1]);\n    }\n    return bindings;\n  }\n\n  test(path) {\n    return this._regex.test(path);\n  }\n\n  toString() {\n    return this._regex.toString();\n  }\n}\n\n\nexport function makePathMatcher(pattern) {\n  let matcher = pathMatchers[pattern];\n  if (!matcher) {\n    matcher = new PathMatcher(pattern);\n    // Minimal pseudo-LRU behavior, since we don't expect to actually fill up the cache.\n    if (_.size(pathMatchers) === maxNumPathMatchers) delete pathMatchers[_.keys(pathMatchers)[0]];\n    pathMatchers[pattern] = matcher;\n  }\n  return matcher;\n}\n","import {unescapeKey} from './utils.js';\nimport _ from 'lodash';\n\n// jshint browser:true\n\nconst MIN_WORKER_VERSION = '0.4.0';\n\n\nclass Snapshot {\n  constructor({path, value, valueError, exists}) {\n    this._path = path;\n    this._value = value;\n    this._valueError = errorFromJson(valueError);\n    this._exists = value === undefined ? exists || false : value !== null;\n  }\n\n  get path() {\n    return this._path;\n  }\n\n  get exists() {\n    return this._exists;\n  }\n\n  get value() {\n    this._checkValue();\n    return this._value;\n  }\n\n  get key() {\n    if (this._key === undefined) this._key = unescapeKey(this._path.replace(/.*\\//, ''));\n    return this._key;\n  }\n\n  _checkValue() {\n    if (this._valueError) throw this._valueError;\n    if (this._value === undefined) throw new Error('Value omitted from snapshot');\n  }\n}\n\n\nexport default class Bridge {\n  constructor(webWorker) {\n    this._idCounter = 0;\n    this._deferreds = {};\n    this._suspended = false;\n    this._servers = {};\n    this._callbacks = {};\n    this._log = _.noop;\n    this._simulatedTokenGenerator = null;\n    this._maxSimulationDuration = 5000;\n    this._simulatedCallFilter = null;\n    this._inboundMessages = [];\n    this._outboundMessages = [];\n    this._flushMessageQueue = this._flushMessageQueue.bind(this);\n    this._port = webWorker.port || webWorker;\n    this._shared = !!webWorker.port;\n    this._port.onmessage = this._receive.bind(this);\n    window.addEventListener('unload', () => {this._send({msg: 'destroy'});});\n    setInterval(() => {this._send({msg: 'ping'});}, 60 * 1000);\n  }\n\n  init(webWorker) {\n    const items = [];\n    try {\n      const storage = window.localStorage || window.sessionStorage;\n      if (!storage) return;\n      for (let i = 0; i < storage.length; i++) {\n        const key = storage.key(i);\n        items.push({key, value: storage.getItem(key)});\n      }\n    } catch (e) {\n      // Some browsers don't like us accessing local storage -- nothing we can do.\n    }\n    return this._send({msg: 'init', storage: items}).then(response => {\n      const workerVersion = response.version.match(/^(\\d+)\\.(\\d+)\\.(\\d+)(-.*)?$/);\n      if (workerVersion) {\n        const minVersion = MIN_WORKER_VERSION.match(/^(\\d+)\\.(\\d+)\\.(\\d+)(-.*)?$/);\n        // Major version must match precisely, minor and patch must be greater than or equal.\n        const sufficient = workerVersion[1] === minVersion[1] && (\n          workerVersion[2] > minVersion[2] ||\n          workerVersion[2] === minVersion[2] && workerVersion[3] >= minVersion[3]\n        );\n        if (!sufficient) return Promise.reject(new Error(\n          `Incompatible Firetruss worker version: ${response.version} ` +\n          `(${MIN_WORKER_VERSION} or better required)`\n        ));\n      }\n      return response;\n    });\n  }\n\n  suspend(suspended) {\n    if (suspended === undefined) suspended = true;\n    if (this._suspended === suspended) return;\n    this._suspended = suspended;\n    if (!suspended) {\n      this._receiveMessages(this._inboundMessages);\n      this._inboundMessages = [];\n      if (this._outboundMessages.length) Promise.resolve().then(this._flushMessageQueue);\n    }\n  }\n\n  debugPermissionDeniedErrors(simulatedTokenGenerator, maxSimulationDuration, callFilter) {\n    this._simulatedTokenGenerator = simulatedTokenGenerator;\n    if (maxSimulationDuration !== undefined) this._maxSimulationDuration = maxSimulationDuration;\n    this._simulatedCallFilter = callFilter || function() {return true;};\n  }\n\n  enableLogging(fn) {\n    if (fn) {\n      if (fn === true) fn = console.log.bind(console);\n      this._log = fn;\n    } else {\n      this._log = _.noop;\n    }\n  }\n\n  _send(message) {\n    message.id = ++this._idCounter;\n    let promise;\n    if (message.oneWay) {\n      promise = Promise.resolve();\n    } else {\n      promise = new Promise((resolve, reject) => {\n        this._deferreds[message.id] = {resolve, reject};\n      });\n      const deferred = this._deferreds[message.id];\n      deferred.promise = promise;\n      promise.sent = new Promise(resolve => {\n        deferred.resolveSent = resolve;\n      });\n      deferred.params = message;\n    }\n    if (!this._outboundMessages.length && !this._suspended) {\n      Promise.resolve().then(this._flushMessageQueue);\n    }\n    this._log('send:', message);\n    this._outboundMessages.push(message);\n    return promise;\n  }\n\n  _flushMessageQueue() {\n    this._port.postMessage(this._outboundMessages);\n    this._outboundMessages = [];\n  }\n\n  _receive(event) {\n    if (this._suspended) {\n      this._inboundMessages = this._inboundMessages.concat(event.data);\n    } else {\n      this._receiveMessages(event.data);\n    }\n  }\n\n  _receiveMessages(messages) {\n    for (const message of messages) {\n      this._log('recv:', message);\n      const fn = this[message.msg];\n      if (typeof fn !== 'function') throw new Error('Unknown message: ' + message.msg);\n      fn.call(this, message);\n    }\n  }\n\n  bindExposedFunction(name) {\n    return (function() {\n      return this._send({msg: 'call', name, args: Array.prototype.slice.call(arguments)});\n    }).bind(this);\n  }\n\n  resolve(message) {\n    const deferred = this._deferreds[message.id];\n    if (!deferred) throw new Error('Received resolution to inexistent Firebase call');\n    delete this._deferreds[message.id];\n    deferred.resolve(message.result);\n  }\n\n  reject(message) {\n    const deferred = this._deferreds[message.id];\n    if (!deferred) throw new Error('Received rejection of inexistent Firebase call');\n    delete this._deferreds[message.id];\n    deferred.reject(errorFromJson(message.error, deferred.params));\n  }\n\n  probeError(error) {\n    const code = error.code || error.message;\n    if (error.params && code && code.toLowerCase() === 'permission_denied') {\n      return this._simulateCall(error.params).then(securityTrace => {\n        if (securityTrace) error.permissionDeniedDetails = securityTrace;\n      });\n    } else {\n      return Promise.resolve();\n    }\n  }\n\n  _simulateCall(props) {\n    if (!(this._simulatedTokenGenerator && this._maxSimulationDuration > 0)) {\n      return Promise.resolve();\n    }\n    let simulatedCalls = [];\n    switch (props.msg) {\n      case 'set':\n        simulatedCalls.push({method: 'set', url: props.url, args: [props.value]});\n        break;\n      case 'update':\n        simulatedCalls.push({method: 'update', url: props.url, args: [props.value]});\n        break;\n      case 'on':\n        simulatedCalls.push({method: 'once', url: props.url, spec: props.spec, args: ['value']});\n        break;\n      case 'transaction':\n        simulatedCalls.push({method: 'once', url: props.url, args: ['value']});\n        simulatedCalls.push({method: 'set', url: props.url, args: [props.newValue]});\n        break;\n    }\n    if (!simulatedCalls.length || !this._simulatedCallFilter(props.msg, props.url)) {\n      return Promise.resolve();\n    }\n    const auth = this.getAuth(getUrlRoot(props.url));\n    const simulationPromise = this._simulatedTokenGenerator(auth && auth.uid).then(token => {\n      return Promise.all(simulatedCalls.map(message => {\n        message.msg = 'simulate';\n        message.token = token;\n        return this._send(message);\n      }));\n    }).then(securityTraces => {\n      if (securityTraces.every(trace => trace === null)) {\n        return 'Unable to reproduce error in simulation';\n      }\n      return securityTraces.filter(trace => trace).join('\\n\\n');\n    }).catch(e => {\n      return 'Error running simulation: ' + e;\n    });\n    const timeoutPromise = new Promise(resolve => {\n      setTimeout(resolve.bind(null, 'Simulated call timed out'), this._maxSimulationDuration);\n    });\n    return Promise.race([simulationPromise, timeoutPromise]);\n  }\n\n  updateLocalStorage(items) {\n    try {\n      const storage = window.localStorage || window.sessionStorage;\n      for (const item in items) {\n        if (item.value === null) {\n          storage.removeItem(item.key);\n        } else {\n          storage.setItem(item.key, item.value);\n        }\n      }\n    } catch (e) {\n      // If we're denied access, there's nothing we can do.\n    }\n  }\n\n  trackServer(rootUrl) {\n    if (this._servers.hasOwnProperty(rootUrl)) return;\n    const server = this._servers[rootUrl] = {authListeners: []};\n    const authCallbackId = this._registerCallback(this._authCallback.bind(this, server));\n    this._send({msg: 'onAuth', url: rootUrl, callbackId: authCallbackId});\n  }\n\n  _authCallback(server, auth) {\n    server.auth = auth;\n    for (const listener of server.authListeners) listener(auth);\n  }\n\n  onAuth(rootUrl, callback, context) {\n    const listener = callback.bind(context);\n    listener.callback = callback;\n    listener.context = context;\n    this._servers[rootUrl].authListeners.push(listener);\n    listener(this.getAuth(rootUrl));\n  }\n\n  offAuth(rootUrl, callback, context) {\n    const authListeners = this._servers[rootUrl].authListeners;\n    for (let i = 0; i < authListeners.length; i++) {\n      const listener = authListeners[i];\n      if (listener.callback === callback && listener.context === context) {\n        authListeners.splice(i, 1);\n        break;\n      }\n    }\n  }\n\n  getAuth(rootUrl) {\n    return this._servers[rootUrl].auth;\n  }\n\n  authWithCustomToken(url, authToken, options) {\n    return this._send({msg: 'authWithCustomToken', url, authToken, options});\n  }\n\n  unauth(url) {\n    return this._send({msg: 'unauth', url});\n  }\n\n  set(url, value, writeSerial) {return this._send({msg: 'set', url, value, writeSerial});}\n  update(url, value, writeSerial) {return this._send({msg: 'update', url, value, writeSerial});}\n\n  on(listenerKey, url, spec, eventType, snapshotCallback, cancelCallback, context, options) {\n    const handle = {\n      listenerKey, eventType, snapshotCallback, cancelCallback, context,\n      params: {msg: 'on', listenerKey, url, spec, eventType, options}\n    };\n    const callback = this._onCallback.bind(this, handle);\n    this._registerCallback(callback, handle);\n    // Keep multiple IDs to allow the same snapshotCallback to be reused.\n    snapshotCallback.__callbackIds = snapshotCallback.__callbackIds || [];\n    snapshotCallback.__callbackIds.push(handle.id);\n    this._send({\n      msg: 'on', listenerKey, url, spec, eventType, callbackId: handle.id, options\n    }).catch(error => {\n      callback(error);\n    });\n  }\n\n  off(listenerKey, url, spec, eventType, snapshotCallback, context) {\n    const idsToDeregister = [];\n    let callbackId;\n    if (snapshotCallback) {\n      callbackId = this._findAndRemoveCallbackId(\n        snapshotCallback,\n        handle =>\n          handle.listenerKey === listenerKey && handle.eventType === eventType &&\n          handle.context === context\n      );\n      if (!callbackId) return Promise.resolve();  // no-op, never registered or already deregistered\n      idsToDeregister.push(callbackId);\n    } else {\n      for (const id of Object.keys(this._callbacks)) {\n        const handle = this._callbacks[id];\n        if (handle.listenerKey === listenerKey && (!eventType || handle.eventType === eventType)) {\n          idsToDeregister.push(id);\n        }\n      }\n    }\n    // Nullify callbacks first, then deregister after off() is complete.  We don't want any\n    // callbacks in flight from the worker to be invoked while the off() is processing, but we don't\n    // want them to throw an exception either.\n    for (const id of idsToDeregister) this._nullifyCallback(id);\n    return this._send({msg: 'off', listenerKey, url, spec, eventType, callbackId}).then(() => {\n      for (const id of idsToDeregister) this._deregisterCallback(id);\n    });\n  }\n\n  _onCallback(handle, error, snapshotJson) {\n    if (error) {\n      this._deregisterCallback(handle.id);\n      const e = errorFromJson(error, handle.params);\n      if (handle.cancelCallback) {\n        handle.cancelCallback.call(handle.context, e);\n      } else {\n        console.error(e);\n      }\n    } else {\n      handle.snapshotCallback.call(handle.context, new Snapshot(snapshotJson));\n    }\n  }\n\n  transaction(url, oldValue, relativeUpdates) {\n    return this._send({msg: 'transaction', url, oldValue, relativeUpdates});\n  }\n\n  onDisconnect(url, method, value) {\n    return this._send({msg: 'onDisconnect', url, method, value});\n  }\n\n  bounceConnection() {\n    return this._send({msg: 'bounceConnection'});\n  }\n\n  callback({id, args}) {\n    const handle = this._callbacks[id];\n    if (!handle) throw new Error('Unregistered callback: ' + id);\n    handle.callback.apply(null, args);\n  }\n\n  _registerCallback(callback, handle) {\n    handle = handle || {};\n    handle.callback = callback;\n    handle.id = `cb${++this._idCounter}`;\n    this._callbacks[handle.id] = handle;\n    return handle.id;\n  }\n\n  _nullifyCallback(id) {\n    this._callbacks[id].callback = noop;\n  }\n\n  _deregisterCallback(id) {\n    delete this._callbacks[id];\n  }\n\n  _findAndRemoveCallbackId(callback, predicate) {\n    if (!callback.__callbackIds) return;\n    let i = 0;\n    while (i < callback.__callbackIds.length) {\n      const id = callback.__callbackIds[i];\n      const handle = this._callbacks[id];\n      if (!handle) {\n        callback.__callbackIds.splice(i, 1);\n        continue;\n      }\n      if (predicate(handle)) {\n        callback.__callbackIds.splice(i, 1);\n        return id;\n      }\n      i += 1;\n    }\n  }\n}\n\n\nfunction noop() {}\n\nfunction errorFromJson(json, params) {\n  if (!json || json instanceof Error) return json;\n  const error = new Error(json.message);\n  error.params = params;\n  for (const propertyName in json) {\n    if (propertyName === 'message' || !json.hasOwnProperty(propertyName)) continue;\n    try {\n      error[propertyName] = json[propertyName];\n    } catch (e) {\n      e.extra = {propertyName};\n      throw e;\n    }\n  }\n  return error;\n}\n\nfunction getUrlRoot(url) {\n  const k = url.indexOf('/', 8);\n  return k >= 8 ? url.slice(0, k) : url;\n}\n","import {Handle, Query, Reference} from './Reference.js';\nimport angular from './angularCompatibility.js';\n\nimport _ from 'lodash';\nimport Vue from 'vue';\n\n\nexport default class Connector {\n  constructor(scope, connections, tree, method, refs) {\n    Object.freeze(connections);\n    this._scope = scope;\n    this._connections = connections;\n    this._tree = tree;\n    this._method = method;\n    this._subConnectors = {};\n\n    this._disconnects = {};\n    this._angularUnwatches = undefined;\n    this._vue = new Vue({data: {\n      values: _.mapValues(connections, _.constant(undefined)),\n      descriptors: {},\n      refs: refs || {}\n    }});\n    this.destroy = this.destroy;  // allow instance-level overrides of destroy() method\n    Object.seal(this);\n\n    this._linkScopeProperties();\n\n    _.each(connections, (descriptor, key) => {\n      if (_.isFunction(descriptor)) {\n        this._bindComputedConnection(key, descriptor);\n      } else {\n        this._connect(key, descriptor);\n      }\n    });\n\n    if (angular.active && scope && scope.$on && scope.$id) {\n      scope.$on('$destroy', () => {this.destroy();});\n    }\n  }\n\n  get ready() {\n    return _.every(this._connections, (ignored, key) => {\n      const descriptor = this._vue.descriptors[key];\n      if (!descriptor) return false;\n      if (descriptor instanceof Handle) return descriptor.ready;\n      return this._subConnectors[key].ready;\n    });\n  }\n\n  get at() {\n    return this._vue.refs;\n  }\n\n  destroy() {\n    this._unlinkScopeProperties();\n    _.each(this._angularUnwatches, unwatch => {unwatch();});\n    _.each(this._connections, (descriptor, key) => {this._disconnect(key);});\n    this._vue.$destroy();\n  }\n\n  _linkScopeProperties() {\n    if (!this._scope) return;\n    for (const key in this._connections) {\n      if (key in this._scope) {\n        throw new Error(`Property already defined on connection target: ${key}`);\n      }\n    }\n    if (!this._scope.__ob__) {\n      Object.defineProperties(this._scope, _.mapValues(this._connections, (descriptor, key) => ({\n        configurable: true, enumerable: true, get: () => this._vue.values[key]\n      })));\n    }\n  }\n\n  _unlinkScopeProperties() {\n    if (!this._scope) return;\n    _.each(this._connections, (descriptor, key) => {\n      delete this._scope[key];\n    });\n  }\n\n  _bindComputedConnection(key, fn) {\n    const getter = this._computeConnection.bind(this, fn);\n    const update = this._updateComputedConnection.bind(this, key, fn);\n    // Use this._vue.$watch instead of truss.watch here so that we can disable the immediate\n    // callback if we'll get one from Angular anyway.\n    this._vue.$watch(getter, update, {immediate: !angular.active, deep: true});\n    if (angular.active) {\n      if (!this._angularUnwatches) this._angularUnwatches = [];\n      this._angularUnwatches.push(angular.watch(getter, update, true));\n    }\n  }\n\n  _computeConnection(fn) {\n    return flattenRefs(fn.call(this._scope));\n  }\n\n  _updateComputedConnection(key, value) {\n    const newDescriptor = _.isFunction(value) ? value(this._scope) : value;\n    const oldDescriptor = this._vue.descriptors[key];\n    if (oldDescriptor === newDescriptor ||\n        newDescriptor instanceof Handle && newDescriptor.isEqual(oldDescriptor)) return;\n    if (!newDescriptor) {\n      this._disconnect(key);\n      return;\n    }\n    if (newDescriptor instanceof Handle || !_.has(this._subConnectors, key)) {\n      this._disconnect(key);\n      this._connect(key, newDescriptor);\n    } else {\n      this._subConnectors[key]._updateConnections(newDescriptor);\n    }\n    Vue.set(this._vue.descriptors, key, newDescriptor);\n  }\n\n  _updateConnections(connections) {\n    _.each(connections, (descriptor, key) => {\n      this._updateComputedConnection(key, descriptor);\n    });\n    _.each(this._connections, (descriptor, key) => {\n      if (!_.has(connections, key)) this._updateComputedConnection(key);\n    });\n    this._connections = connections;\n  }\n\n  _connect(key, descriptor) {\n    Vue.set(this._vue.descriptors, key, descriptor);\n    if (!descriptor) return;\n    if (descriptor instanceof Reference) {\n      Vue.set(this._vue.refs, key, descriptor);\n      const updateFn = this._scope ? this._updateScopeRef.bind(this, key) : null;\n      this._disconnects[key] = this._tree.connectReference(descriptor, updateFn, this._method);\n    } else if (descriptor instanceof Query) {\n      Vue.set(this._vue.refs, key, descriptor);\n      const updateFn = this._scope ? this._updateScopeQuery.bind(this, key) : null;\n      this._disconnects[key] = this._tree.connectQuery(descriptor, updateFn, this._method);\n    } else {\n      const subScope = {}, subRefs = {};\n      Vue.set(this._vue.refs, key, subRefs);\n      const subConnector = this._subConnectors[key] =\n        new Connector(subScope, descriptor, this._tree, this._method, subRefs);\n      if (this._scope) {\n        // Use a truss.watch here instead of this._vue.$watch so that the \"immediate\" execution\n        // actually takes place after we've captured the unwatch function, in case the subConnector\n        // is ready immediately.\n        const unwatch = this._disconnects[key] = this._tree.truss.watch(\n          () => subConnector.ready,\n          subReady => {\n            if (!subReady) return;\n            unwatch();\n            delete this._disconnects[key];\n            Vue.set(this._vue.values, key, subScope);\n            if (this._scope.__ob__) Vue.set(this._scope, key, subScope);\n            angular.digest();\n          }\n        );\n      }\n    }\n  }\n\n  _disconnect(key) {\n    Vue.delete(this._vue.refs, key);\n    if (this._scope) this._updateScopeRef(key, undefined);\n    if (_.has(this._subConnectors, key)) {\n      this._subConnectors[key].destroy();\n      delete this._subConnectors[key];\n    }\n    if (this._disconnects[key]) this._disconnects[key]();\n    delete this._disconnects[key];\n    Vue.delete(this._vue.descriptors, key);\n  }\n\n  _updateScopeRef(key, value) {\n    if (this._vue.values[key] !== value) {\n      Vue.set(this._vue.values, key, value);\n      if (this._scope && this._scope.__ob__) Vue.set(this._scope, key, value);\n      angular.digest();\n    }\n  }\n\n  _updateScopeQuery(key, childKeys) {\n    let changed = false;\n    if (!this._vue.values[key]) {\n      Vue.set(this._vue.values, key, {});\n      if (this._scope && this._scope.__ob__) Vue.set(this._scope, key, this._vue.values[key]);\n      changed = true;\n    }\n    const subScope = this._vue.values[key];\n    for (const childKey in subScope) {\n      if (!subScope.hasOwnProperty(childKey)) continue;\n      if (!_.contains(childKeys, childKey)) {\n        Vue.delete(subScope, childKey);\n        changed = true;\n      }\n    }\n    let object;\n    for (const segment of this._vue.descriptors[key].path.split('/')) {\n      object = segment ? object[segment] : this._tree.root;\n    }\n    for (const childKey of childKeys) {\n      if (subScope.hasOwnProperty(childKey)) continue;\n      Vue.set(subScope, childKey, object[childKey]);\n      changed = true;\n    }\n    if (changed) angular.digest();\n  }\n\n}\n\nfunction flattenRefs(refs) {\n  if (!refs) return;\n  if (refs instanceof Handle) return refs.toString();\n  return _.mapValues(refs, flattenRefs);\n}\n\n","import {Reference, Handle} from './Reference.js';\nimport {makePathMatcher, joinPath, escapeKey, unescapeKey, promiseFinally} from './utils.js';\n\nimport _ from 'lodash';\nimport performanceNow from 'performance-now';\n\n// These are defined separately for each object so they're not included in Value below.\nconst RESERVED_VALUE_PROPERTY_NAMES = {\n  $truss: true, $parent: true, $key: true, $path: true, $ref: true,\n  $$touchThis: true, $$initializers: true, $$finalizers: true, $$watchers: true,\n  $$$trussCheck: true,\n  __ob__: true\n};\n\nconst computedPropertyStats = {};\n\n// Holds properties that we're going to set on a model object that's being created right now as soon\n// as it's been created, but that we'd like to be accessible in the constructor.  The object\n// prototype's getters will pick those up until they get overridden in the instance.\nlet creatingObjectProperties;\n\n\nclass Value {\n  get $parent() {return creatingObjectProperties.$parent.value;}\n  get $path() {return creatingObjectProperties.$path.value;}\n  get $truss() {\n    Object.defineProperty(this, '$truss', {value: this.$parent.$truss});\n    return this.$truss;\n  }\n  get $ref() {\n    Object.defineProperty(this, '$ref', {value: new Reference(this.$truss._tree, this.$path)});\n    return this.$ref;\n  }\n  get $refs() {return this.$ref;}\n  get $key() {\n    Object.defineProperty(\n      this, '$key', {value: unescapeKey(this.$path.slice(this.$path.lastIndexOf('/') + 1))});\n    return this.$key;\n  }\n  get $data() {return this;}\n  get $empty() {return _.isEmpty(this.$data);}\n  get $keys() {return _.keys(this.$data);}\n  get $values() {return _.values(this.$data);}\n  get $meta() {return this.$truss.meta;}\n  get $root() {return this.$truss.root;}  // access indirectly to leave dependency trace\n  get $now() {return this.$truss.now;}\n  get $ready() {return this.$ref.ready;}\n  get $overridden() {return false;}\n\n  $intercept(actionType, callbacks) {\n    const unintercept = this.$truss.intercept(actionType, callbacks);\n    const uninterceptAndRemoveFinalizer = () => {\n      unintercept();\n      _.pull(this.$$finalizers, uninterceptAndRemoveFinalizer);\n    };\n    this.$$finalizers.push(uninterceptAndRemoveFinalizer);\n    return uninterceptAndRemoveFinalizer;\n  }\n\n  $connect(scope, connections) {\n    if (!connections) {\n      connections = scope;\n      scope = undefined;\n    }\n    const connector = this.$truss.connect(scope, wrapConnections(this, connections));\n    const originalDestroy = connector.destroy;\n    const destroy = () => {\n      _.pull(this.$$finalizers, destroy);\n      return originalDestroy.call(connector);\n    };\n    this.$$finalizers.push(destroy);\n    connector.destroy = destroy;\n    return connector;\n  }\n\n  $peek(target, callback) {\n    const promise = promiseFinally(\n      this.$truss.peek(target, callback), () => {_.pull(this.$$finalizers, promise.cancel);}\n    );\n    this.$$finalizers.push(promise.cancel);\n    return promise;\n  }\n\n  $watch(subjectFn, callbackFn, options) {\n    let unwatchAndRemoveFinalizer;\n\n    const unwatch = this.$truss.watch(() => {\n      this.$$touchThis();\n      return subjectFn.call(this);\n    }, callbackFn.bind(this), options);\n\n    unwatchAndRemoveFinalizer = () => {\n      unwatch();\n      _.pull(this.$$finalizers, unwatchAndRemoveFinalizer);\n    };\n    this.$$finalizers.push(unwatchAndRemoveFinalizer);\n    return unwatchAndRemoveFinalizer;\n  }\n\n  $when(expression, options) {\n    const promise = this.$truss.when(() => {\n      this.$$touchThis();\n      return expression.call(this);\n    }, options);\n    promiseFinally(promise, () => {_.pull(this.$$finalizers, promise.cancel);});\n    this.$$finalizers.push(promise.cancel);\n    return promise;\n  }\n\n  $set(value) {return this.$ref.set(value);}\n  $update(values) {return this.$ref.update(values);}\n  $override(values) {return this.$ref.override(values);}\n  $commit(options, updateFn) {return this.$ref.commit(options, updateFn);}\n\n  $$touchThis() {\n    // jshint expr:true\n    if (this.$parent) {\n      (this.$parent.hasOwnProperty('$data') ? this.$parent.$data : this.$parent)[this.$key];\n    } else {\n      this.$root;\n    }\n    // jshint expr:false\n  }\n\n  get $$initializers() {\n    Object.defineProperty(this, '$$initializers', {\n      value: [], writable: false, enumerable: false, configurable: true});\n    return this.$$initializers;\n  }\n\n  get $$finalizers() {\n    Object.defineProperty(this, '$$finalizers', {\n      value: [], writable: false, enumerable: false, configurable: false});\n    return this.$$finalizers;\n  }\n\n  get $$watchers() {\n    Object.defineProperty(this, '$$watchers', {\n      value: {}, writable: false, enumerable: false, configurable: false});\n    return this.$$watchers;\n  }\n}\n\nclass ComputedPropertyStats {\n  constructor(name) {\n    _.extend(this, {name, numRecomputes: 0, numUpdates: 0, runtime: 0});\n  }\n\n  get runtimePerRecompute() {\n    return this.numRecomputes ? this.runtime / this.numRecomputes : 0;\n  }\n}\n\nclass ErrorWrapper {\n  constructor(error) {\n    this.error = error;\n  }\n}\n\n\nexport default class Modeler {\n  constructor() {\n    this._trie = {Class: Value};\n    Object.freeze(this);\n  }\n\n  init(classes, rootAcceptable) {\n    if (_.isPlainObject(classes)) {\n      _.each(classes, (Class, path) => {\n        if (Class.$trussMount) return;\n        Class.$$trussMount = Class.$$trussMount || [];\n        Class.$$trussMount.push(path);\n      });\n      classes = _.values(classes);\n      _.each(classes, Class => {\n        if (!Class.$trussMount && Class.$$trussMount) {\n          Class.$trussMount = Class.$$trussMount;\n          delete Class.$$trussMount;\n        }\n      });\n    }\n    classes = _.uniq(classes);\n    _.each(classes, Class => this._mountClass(Class, rootAcceptable));\n    this._decorateTrie(this._trie);\n  }\n\n  destroy() {\n  }\n\n  _getMount(path, scaffold, predicate) {\n    const segments = path.split('/');\n    let node;\n    for (const segment of segments) {\n      let child = segment ?\n        node.children && (node.children[segment] || node.children.$) : this._trie;\n      if (!child) {\n        if (!scaffold) return;\n        node.children = node.children || {};\n        child = node.children[segment] = {Class: Value};\n      }\n      node = child;\n      if (predicate && predicate(node)) break;\n    }\n    return node;\n  }\n\n  _findMount(predicate, node) {\n    if (!node) node = this._trie;\n    if (predicate(node)) return node;\n    for (const childKey of _.keys(node.children)) {\n      const result = this._findMount(predicate, node.children[childKey]);\n      if (result) return result;\n    }\n  }\n\n  _decorateTrie(node) {\n    _.each(node.children, child => {\n      this._decorateTrie(child);\n      if (child.local || child.localDescendants) node.localDescendants = true;\n    });\n  }\n\n  _augmentClass(Class) {\n    let computedProperties;\n    let proto = Class.prototype;\n    while (proto && proto.constructor !== Object) {\n      for (const name of Object.getOwnPropertyNames(proto)) {\n        const descriptor = Object.getOwnPropertyDescriptor(proto, name);\n        if (name.charAt(0) === '$') {\n          if (_.isEqual(descriptor, Object.getOwnPropertyDescriptor(Value.prototype, name))) {\n            continue;\n          }\n          throw new Error(`Property names starting with \"$\" are reserved: ${Class.name}.${name}`);\n        }\n        if (descriptor.set) {\n          throw new Error(`Computed properties must not have a setter: ${Class.name}.${name}`);\n        }\n        if (descriptor.get && !(computedProperties && computedProperties[name])) {\n          (computedProperties || (computedProperties = {}))[name] = {\n            name, fullName: `${proto.constructor.name}.${name}`, get: descriptor.get\n          };\n        }\n      }\n      proto = Object.getPrototypeOf(proto);\n    }\n    for (const name of Object.getOwnPropertyNames(Value.prototype)) {\n      if (name === 'constructor' || Class.prototype.hasOwnProperty(name)) continue;\n      Object.defineProperty(\n        Class.prototype, name, Object.getOwnPropertyDescriptor(Value.prototype, name));\n    }\n    return computedProperties;\n  }\n\n  _mountClass(Class, rootAcceptable) {\n    const computedProperties = this._augmentClass(Class);\n    let mounts = Class.$trussMount;\n    if (!mounts) throw new Error(`Class ${Class.name} lacks a $trussMount static property`);\n    if (!_.isArray(mounts)) mounts = [mounts];\n    _.each(mounts, mount => {\n      if (_.isString(mount)) mount = {path: mount};\n      if (!rootAcceptable && mount.path === '/') {\n        throw new Error('Data root already accessed, too late to mount class');\n      }\n      const matcher = makePathMatcher(mount.path);\n      for (const variable of matcher.variables) {\n        if (variable === '$' || variable.charAt(1) === '$') {\n          throw new Error(`Invalid variable name: ${variable}`);\n        }\n        if (variable.charAt(0) === '$' && (\n            _.has(Value.prototype, variable) || RESERVED_VALUE_PROPERTY_NAMES[variable]\n        )) {\n          throw new Error(`Variable name conflicts with built-in property or method: ${variable}`);\n        }\n      }\n      const escapedKey = mount.path.match(/\\/([^/]*)$/)[1];\n      if (escapedKey.charAt(0) === '$') {\n        if (mount.placeholder) {\n          throw new Error(\n            `Class ${Class.name} mounted at wildcard ${escapedKey} cannot be a placeholder`);\n        }\n      } else {\n        if (!_.has(mount, 'placeholder')) mount.placeholder = {};\n      }\n      const targetMount = this._getMount(mount.path.replace(/\\$[^/]*/g, '$'), true);\n      if (targetMount.matcher) {\n        throw new Error(\n          `Multiple classes mounted at ${mount.path}: ${targetMount.Class.name}, ${Class.name}`);\n      }\n      _.extend(targetMount, {\n        Class, matcher, computedProperties, escapedKey, placeholder: mount.placeholder,\n        local: mount.local\n      });\n    });\n  }\n\n  /**\n   * Creates a Truss object and sets all its basic properties: path segment variables, user-defined\n   * properties, and computed properties.  The latter two will be enumerable so that Vue will pick\n   * them up and make the reactive, so you should call _completeCreateObject once it's done so and\n   * before any Firebase properties are added.\n   */\n  createObject(path, properties) {\n    let mount = this._getMount(path) || {Class: Value};\n    if (mount.matcher) {\n      const match = mount.matcher.match(path);\n      for (const variable in match) {\n        properties[variable] = {value: match[variable]};\n      }\n    }\n\n    creatingObjectProperties = properties;\n    const object = new mount.Class();\n    creatingObjectProperties = null;\n\n    if (mount.keysUnsafe) properties.$data = {value: Object.create(null)};\n    if (mount.computedProperties) {\n      _.each(mount.computedProperties, prop => {\n        properties[prop.name] = this._buildComputedPropertyDescriptor(object, prop);\n      });\n    }\n\n    return object;\n  }\n\n  _buildComputedPropertyDescriptor(object, prop) {\n    if (!computedPropertyStats[prop.fullName]) {\n      Object.defineProperty(computedPropertyStats, prop.fullName, {\n        value: new ComputedPropertyStats(prop.fullName), writable: false, enumerable: true,\n        configurable: false\n      });\n    }\n    const stats = computedPropertyStats[prop.fullName];\n\n    let value;\n    let writeAllowed = false;\n\n    object.$$initializers.push(vue => {\n      object.$$finalizers.push(\n        vue.$watch(computeValue.bind(object, prop, stats), newValue => {\n          if (_.isEqual(value, newValue, isTrussValueEqual)) return;\n          // console.log('updating', object.$key, prop.fullName, 'from', value, 'to', newValue);\n          stats.numUpdates += 1;\n          writeAllowed = true;\n          object[prop.name] = newValue;\n          writeAllowed = false;\n          if (newValue instanceof ErrorWrapper) throw newValue.error;\n        }, {immediate: true})  // use immediate:true since watcher will run computeValue anyway\n      );\n      object.$$watchers[prop.name] = _.last(vue._watchers);\n    });\n    return {\n      enumerable: true, configurable: true,\n      get: function() {\n        if (value instanceof ErrorWrapper) throw value.error;\n        return value;\n      },\n      set: function(newValue) {\n        if (!writeAllowed) throw new Error(`You cannot set a computed property: ${prop.name}`);\n        value = newValue;\n      }\n    };\n  }\n\n  destroyObject(object) {\n    if (_.has(object, '$$finalizers')) {\n      // Some destructors remove themselves from the array, so clone it before iterating.\n      for (const fn of _.clone(object.$$finalizers)) fn();\n    }\n  }\n\n  isPlaceholder(path) {\n    const mount = this._getMount(path);\n    return mount && mount.placeholder;\n  }\n\n  isLocal(path) {\n    const mount = this._getMount(path, false, mount => mount.local);\n    if (!mount) return false;\n    if (mount.local) return true;\n    if (mount.localDescendants) throw new Error(`Subtree mixes local and remote data: ${path}`);\n    return false;\n  }\n\n  forEachPlaceholderChild(path, iteratee) {\n    const mount = this._getMount(path);\n    _.each(mount && mount.children, child => {\n      if (child.placeholder) iteratee(child.escapedKey, child.placeholder);\n    });\n  }\n\n  checkVueObject(object, path, checkedObjects) {\n    const top = !checkedObjects;\n    if (top) checkedObjects = [];\n    try {\n      for (const key of Object.getOwnPropertyNames(object)) {\n        if (RESERVED_VALUE_PROPERTY_NAMES[key]) continue;\n        // jshint loopfunc:true\n        const mount = this._findMount(mount => mount.Class === object.constructor);\n        // jshint loopfunc:false\n        if (mount && mount.matcher && _.includes(mount.matcher.variables, key)) continue;\n        if (!(Array.isArray(object) && (/\\d+/.test(key) || key === 'length'))) {\n          const descriptor = Object.getOwnPropertyDescriptor(object, key);\n          if ('value' in descriptor || !descriptor.get) {\n            throw new Error(\n              `Value at ${path}, contained in a Firetruss object, has a rogue property: ${key}`);\n          }\n          if (object.$truss && descriptor.enumerable) {\n            try {\n              object[key] = object[key];\n              throw new Error(\n                `Firetruss object at ${path} has an enumerable non-Firebase property: ${key}`);\n            } catch (e) {\n              if (e.trussCode !== 'firebase_overwrite') throw e;\n            }\n          }\n        }\n        const value = object[key];\n        if (_.isObject(value) && !value.$$$trussCheck && Object.isExtensible(value) &&\n            !(value instanceof Function)) {\n          value.$$$trussCheck = true;\n          checkedObjects.push(value);\n          this.checkVueObject(value, joinPath(path, escapeKey(key)), checkedObjects);\n        }\n      }\n    } finally {\n      if (top) {\n        for (const item of checkedObjects) delete item.$$$trussCheck;\n      }\n    }\n  }\n\n  static get computedPropertyStats() {\n    return _(computedPropertyStats).values().sortBy(stat => -stat.runtime).value();\n  }\n}\n\n\nfunction computeValue(prop, stats) {\n  // jshint validthis: true\n  // Touch this object, since a failed access to a missing property doesn't get captured as a\n  // dependency.\n  this.$$touchThis();\n\n  const startTime = performanceNow();\n  try {\n    return prop.get.call(this);\n  } catch (e) {\n    return new ErrorWrapper(e);\n  } finally {\n    stats.runtime += performanceNow() - startTime;\n    stats.numRecomputes += 1;\n  }\n  // jshint validthis: false\n}\n\nfunction wrapConnections(object, connections) {\n  if (!connections || connections instanceof Handle) return connections;\n  return _.mapValues(connections, descriptor => {\n    if (descriptor instanceof Handle) return descriptor;\n    if (_.isFunction(descriptor)) {\n      return function() {\n        object.$$touchThis();\n        return wrapConnections(object, descriptor.call(this));\n      };\n    } else {\n      return wrapConnections(object, descriptor);\n    }\n  });\n}\n\nfunction isTrussValueEqual(a, b) {\n  if (a && a.$truss || b && b.$truss) return a === b;\n}\n","import angularCompatibility from './angularCompatibility.js';\nimport Coupler from './Coupler.js';\nimport Modeler from './Modeler.js';\nimport {escapeKey, unescapeKey, joinPath, SERVER_TIMESTAMP} from './utils.js';\n\nimport _ from 'lodash';\nimport Vue from 'vue';\n\n\nclass Transaction {\n  constructor(path, tree) {\n    this._path = path;\n    this._tree = tree;\n  }\n\n  get currentValue() {return this._tree.getObject(this._path);}\n  get outcome() {return this._outcome;}\n  get values() {return this._values;}\n\n  _setOutcome(value) {\n    if (this._outcome) throw new Error('Transaction already resolved with ' + this._outcome);\n    this._outcome = value;\n  }\n\n  abort() {\n    this._setOutcome('abort');\n  }\n\n  cancel() {\n    this._setOutcome('cancel');\n  }\n\n  set(value) {\n    if (value === undefined) throw new Error('Invalid argument: undefined');\n    this._setOutcome('set');\n    this._values = {'': value};\n  }\n\n  update(values) {\n    if (values === undefined) throw new Error('Invalid argument: undefined');\n    if (_.isEmpty(values)) return this.cancel();\n    this._setOutcome('update');\n    this._values = values;\n  }\n}\n\n\nexport default class Tree {\n  constructor(truss, rootUrl, bridge, dispatcher) {\n    this._truss = truss;\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._dispatcher = dispatcher;\n    this._firebasePropertyEditAllowed = false;\n    this._writeSerial = 0;\n    this._localWrites = {};\n    this._localWriteTimestamp = null;\n    this._initialized = false;\n    this._modeler = new Modeler();\n    this._coupler = new Coupler(\n      rootUrl, bridge, dispatcher, this._integrateSnapshot.bind(this), this._prune.bind(this));\n    this._vue = new Vue({data: {$root: undefined}});\n    Object.seal(this);\n    if (angularCompatibility.active) {\n      this._vue.$watch('$data', () => {angularCompatibility.digest();}, {deep: true});\n    }\n    // Call this.init(classes) to complete initialization; we need two phases so that truss can bind\n    // the tree into its own accessors prior to defining computed functions, which may try to\n    // access the tree root via truss.\n  }\n\n  get root() {\n    if (!this._vue.$data.$root) {\n      this._vue.$data.$root = this._createObject('/', '');\n      this._fixObject(this._vue.$data.$root);\n      this._completeCreateObject(this._vue.$data.$root);\n    }\n    return this._vue.$data.$root;\n  }\n\n  get truss() {\n    return this._truss;\n  }\n\n  init(classes) {\n    if (this._initialized) {\n      throw new Error('Data objects already created, too late to mount classes');\n    }\n    this._initialized = true;\n    this._modeler.init(classes, !this._vue.$data.$root);\n    this._plantPlaceholders(this.root, '/');\n  }\n\n  destroy() {\n    this._coupler.destroy();\n    if (this._modeler) this._modeler.destroy();\n    this._vue.$destroy();\n  }\n\n  connectReference(ref, valueCallback, method) {\n    this._checkHandle(ref);\n    const operation = this._dispatcher.createOperation('read', method, ref);\n    let unwatch;\n    if (valueCallback) {\n      const segments = _(ref.path).split('/').map(segment => unescapeKey(segment)).value();\n      unwatch = this._vue.$watch(\n        this.getObject.bind(this, segments), valueCallback, {immediate: true});\n    }\n    operation._disconnect = this._disconnectReference.bind(this, ref, operation, unwatch);\n    this._dispatcher.begin(operation).then(() => {\n      if (operation.running && !operation._disconnected) {\n        this._coupler.couple(ref.path, operation);\n        operation._coupled = true;\n      }\n    }).catch(e => {});  // ignore exception, let onFailure handlers deal with it\n    return operation._disconnect;\n  }\n\n  _disconnectReference(ref, operation, unwatch, error) {\n    if (operation._disconnected) return;\n    operation._disconnected = true;\n    if (unwatch) unwatch();\n    if (operation._coupled) {\n      this._coupler.decouple(ref.path, operation);  // will call back to _prune if necessary\n      operation._coupled = false;\n    }\n    this._dispatcher.end(operation, error).catch(e => {});\n  }\n\n  isReferenceReady(ref) {\n    this._checkHandle(ref);\n    return this._coupler.isSubtreeReady(ref.path);\n  }\n\n  connectQuery(query, keysCallback, method) {\n    this._checkHandle(query);\n    const operation = this._dispatcher.createOperation('read', method, query);\n    operation._disconnect = this._disconnectQuery.bind(this, query, operation);\n    this._dispatcher.begin(operation).then(() => {\n      if (operation.running && !operation._disconnected) {\n        this._coupler.subscribe(query, operation, keysCallback);\n        operation._coupled = true;\n      }\n    }).catch(e => {});  // ignore exception, let onFailure handlers deal with it\n    return operation._disconnect;\n  }\n\n  _disconnectQuery(query, operation, error) {\n    if (operation._disconnected) return;\n    operation._disconnected = true;\n    if (operation._coupled) {\n      this._coupler.unsubscribe(query, operation);  // will call back to _prune if necessary\n      operation._coupled = false;\n    }\n    this._dispatcher.end(operation, error).catch(e => {});\n  }\n\n  isQueryReady(query) {\n    return this._coupler.isQueryReady(query);\n  }\n\n  _checkHandle(handle) {\n    if (!handle.belongsTo(this._truss)) {\n      throw new Error('Reference belongs to another Truss instance');\n    }\n  }\n\n  update(ref, method, values) {\n    values = _.clone(values);\n    let numValues = _.size(values);\n    if (!numValues) return Promise.resolve();\n    if (method === 'update' || method === 'override') {\n      checkUpdateHasOnlyDescendantsWithNoOverlap(ref.path, values);\n    }\n    this._applyLocalWrite(values, method === 'override');\n    if (method === 'override') return Promise.resolve();\n    for (const path of _.keys(values)) {\n      if (this._modeler.isLocal(path)) delete values[path];\n    }\n    numValues = _.size(values);\n    if (!numValues) return Promise.resolve();\n    const url = this._rootUrl + this._extractCommonPathPrefix(values);\n    return this._dispatcher.execute('write', method, ref, () => {\n      if (numValues === 1) {\n        return this._bridge.set(url, values[''], this._writeSerial);\n      } else {\n        return this._bridge.update(url, values, this._writeSerial);\n      }\n    });\n  }\n\n  commit(ref, updateFunction) {\n    let tries = 0;\n\n    const attemptTransaction = () => {\n      if (tries++ >= 25) return Promise.reject(new Error('maxretry'));\n      const txn = new Transaction();\n      try {\n        updateFunction(txn);\n      } catch (e) {\n        return Promise.reject(e);\n      }\n      const values = _.clone(txn.values);\n      const oldValue = toFirebaseJson(this.getObject(ref.path));\n      switch (txn.outcome) {\n        case 'abort': return;\n        case 'cancel':\n          break;\n        case 'set':\n          if (this._modeler.isLocal(ref.path)) {\n            throw new Error(`Commit in local subtree: ${ref.path}`);\n          }\n          this._applyLocalWrite({[ref.path]: values['']});\n          break;\n        case 'update':\n          checkUpdateHasOnlyDescendantsWithNoOverlap(ref.path, values);\n          _(values).keys().each(path => {\n            if (this._modeler.isLocal(path)) throw new Error(`Commit in local subtree: ${path}`);\n          });\n          this._applyLocalWrite(values);\n          relativizePaths(ref.path, values);\n          break;\n        default:\n          throw new Error('Invalid transaction outcome: ' + (txn.outcome || 'none'));\n      }\n      return this._bridge.transaction(\n        this._rootUrl + ref.path, oldValue, values\n      ).then(committed => {\n        if (!committed) return attemptTransaction();\n        return txn;\n      });\n    };\n\n    return this._truss.peek(ref, () => {\n      return this._dispatcher.execute('write', 'commit', ref, attemptTransaction);\n    });\n  }\n\n  _applyLocalWrite(values, override) {\n    // TODO: correctly apply local writes that impact queries.  Currently, a local write will update\n    // any objects currently selected by a query, but won't add or remove results.\n    this._writeSerial++;\n    this._localWriteTimestamp = this._truss.now;\n    _.each(values, (value, path) => {\n      const local = this._modeler.isLocal(path);\n      const coupledDescendantPaths =\n        local ? [path] : this._coupler.findCoupledDescendantPaths(path);\n      if (_.isEmpty(coupledDescendantPaths)) return;\n      const offset = (path === '/' ? 0 : path.length) + 1;\n      for (const descendantPath of coupledDescendantPaths) {\n        const subPath = descendantPath.slice(offset);\n        let subValue = value;\n        if (subPath) {\n          const segments = subPath.split('/');\n          for (const segment of segments) {\n            subValue = subValue[unescapeKey(segment)];\n            if (subValue === undefined) break;\n          }\n        }\n        if (subValue === undefined || subValue === null) {\n          this._prune(descendantPath);\n        } else {\n          const key = unescapeKey(_.last(descendantPath.split('/')));\n          this._plantValue(\n            descendantPath, key, subValue, this._scaffoldAncestors(descendantPath), false,\n            override\n          );\n        }\n        if (!override && !local) {\n          this._localWrites[descendantPath] = this._writeSerial;\n        }\n      }\n    });\n  }\n\n  _extractCommonPathPrefix(values) {\n    let prefixSegments;\n    _.each(values, (value, path) => {\n      const segments = path === '/' ? [''] : path.split('/');\n      if (prefixSegments) {\n        let firstMismatchIndex = 0;\n        const maxIndex = Math.min(prefixSegments.length, segments.length);\n        while (firstMismatchIndex < maxIndex &&\n               prefixSegments[firstMismatchIndex] === segments[firstMismatchIndex]) {\n          firstMismatchIndex++;\n        }\n        prefixSegments = prefixSegments.slice(0, firstMismatchIndex);\n        if (!prefixSegments.length) return false;\n      } else {\n        prefixSegments = segments;\n      }\n    });\n    const pathPrefix = prefixSegments.length === 1 ? '/' : prefixSegments.join('/');\n    _.each(_.keys(values), key => {\n      values[key.slice(pathPrefix.length + 1)] = values[key];\n      delete values[key];\n    });\n    return pathPrefix;\n  }\n\n  /**\n   * Creates a Truss object and sets all its basic properties: path segment variables, user-defined\n   * properties, and computed properties.  The latter two will be enumerable so that Vue will pick\n   * them up and make the reactive, so you should call _completeCreateObject once it's done so and\n   * before any Firebase properties are added.\n   */\n  _createObject(path, key, parent) {\n    if (!this._initialized && path !== '/') this.init();\n    let properties = {\n      // We want Vue to wrap this; we'll make it non-enumerable in _completeCreateObject.\n      $parent: {value: parent, configurable: true, enumerable: true},\n      $path: {value: path}\n    };\n    if (path === '/') properties.$truss = {value: this._truss};\n\n    const object = this._modeler.createObject(path, properties);\n    Object.defineProperties(object, properties);\n    return object;\n  }\n\n  // To be called on the result of _createObject after it's been inserted into the _vue hierarchy\n  // and Vue has had a chance to initialize it.\n  _fixObject(object) {\n    for (const name of Object.getOwnPropertyNames(object)) {\n      const descriptor = Object.getOwnPropertyDescriptor(object, name);\n      if (descriptor.configurable && descriptor.enumerable) {\n        descriptor.enumerable = false;\n        if (name === '$parent') descriptor.configurable = false;\n        Object.defineProperty(object, name, descriptor);\n      }\n    }\n  }\n\n  // To be called on the result of _createObject after _fixObject, and after any additional Firebase\n  // properties have been set, to run initialiers.\n  _completeCreateObject(object) {\n    if (object.hasOwnProperty('$$initializers')) {\n      for (const fn of object.$$initializers) fn(this._vue);\n      delete object.$$initializers;\n    }\n  }\n\n  _destroyObject(object) {\n    if (!(object && object.$truss)) return;\n    this._modeler.destroyObject(object);\n    for (const key in object) {\n      if (!Object.hasOwnProperty(object, key)) continue;\n      this._destroyObject(object[key]);\n    }\n  }\n\n  _integrateSnapshot(snap) {\n    _.each(_.keys(this._localWrites), (writeSerial, path) => {\n      if (snap.writeSerial >= writeSerial) delete this._localWrites[path];\n    });\n    if (snap.exists) {\n      const parent = this._scaffoldAncestors(snap.path, true);\n      if (parent) this._plantValue(snap.path, snap.key, snap.value, parent, true, false);\n    } else {\n      this._prune(snap.path, null, true);\n    }\n  }\n\n  _scaffoldAncestors(path, remoteWrite) {\n    let object;\n    const segments = _(path).split('/').dropRight().value();\n    _.each(segments, (segment, i) => {\n      const childKey = unescapeKey(segment);\n      let child = childKey ? object[childKey] : this.root;\n      if (!child) {\n        const ancestorPath = segments.slice(0, i + 1).join('/');\n        if (remoteWrite && this._localWrites[ancestorPath || '/']) return;\n        child = this._plantValue(ancestorPath, childKey, {}, object);\n      }\n      object = child;\n    });\n    return object;\n  }\n\n  _plantValue(path, key, value, parent, remoteWrite, override) {\n    if (remoteWrite && (value === null || value === undefined)) {\n      throw new Error(`Snapshot includes invalid value at ${path}: ${value}`);\n    }\n    if (remoteWrite && this._localWrites[path]) return;\n    if (value === SERVER_TIMESTAMP) value = this._localWriteTimestamp;\n    if (!_.isArray(value) && !(_.isObject(value) && value.constructor === Object)) {\n      this._setFirebaseProperty(parent, key, value);\n      return;\n    }\n    let objectCreated = false;\n    let object = parent[key];\n    if (!_.isObject(object)) {\n      // Need to pre-set the property, so that if the child object attempts to watch any of its own\n      // properties while being created the $$touchThis method has something to add a dependency on\n      // as the object's own properties won't be made reactive until *after* it's been created.\n      this._setFirebaseProperty(parent, key, null);\n      object = this._createObject(path, key, parent);\n      this._setFirebaseProperty(parent, key, object);\n      this._fixObject(object);\n      objectCreated = true;\n    }\n    if (override) {\n      Object.defineProperty(object, '$overridden', {get: _.constant(true), configurable: true});\n    } else if (object.$overridden) {\n      delete object.$overridden;\n    }\n    _.each(value, (item, escapedChildKey) => {\n      this._plantValue(\n        joinPath(path, escapedChildKey), unescapeKey(escapedChildKey), item, object, remoteWrite,\n        override\n      );\n    });\n    if (objectCreated) {\n      this._completeCreateObject(object);\n      this._plantPlaceholders(object, path);\n    } else {\n      _.each(object, (item, childKey) => {\n        const escapedChildKey = escapeKey(childKey);\n        if (!value.hasOwnProperty(escapedChildKey)) {\n          this._prune(joinPath(path, escapedChildKey), null, remoteWrite);\n        }\n      });\n    }\n    return object;\n  }\n\n  _plantPlaceholders(object, path) {\n    this._modeler.forEachPlaceholderChild(path, (escapedKey, placeholder) => {\n      const key = unescapeKey(escapedKey);\n      if (!object.hasOwnProperty(key)) {\n        this._plantValue(joinPath(path, escapedKey), key, placeholder, object);\n      }\n    });\n  }\n\n  _prune(path, lockedDescendantPaths, remoteWrite) {\n    lockedDescendantPaths = lockedDescendantPaths || {};\n    const object = this.getObject(path);\n    if (object === undefined) return;\n    if (remoteWrite && this._avoidLocalWritePaths(path, lockedDescendantPaths)) return;\n    if (!(_.isEmpty(lockedDescendantPaths) && this._pruneAncestors(path, object)) &&\n        _.isObject(object)) {\n      // The target object is a placeholder, and all ancestors are placeholders or otherwise needed\n      // as well, so we can't delete it.  Instead, dive into its descendants to delete what we can.\n      this._pruneDescendants(object, lockedDescendantPaths);\n    }\n  }\n\n  _avoidLocalWritePaths(path, lockedDescendantPaths) {\n    for (const localWritePath in this._localWrites) {\n      if (!this._localWrites.hasOwnProperty(localWritePath)) continue;\n      if (path === localWritePath || localWritePath === '/' ||\n          _.startsWith(path, localWritePath + '/')) return true;\n      if (path === '/' || _.startsWith(localWritePath, path + '/')) {\n        const segments = localWritePath.split('/');\n        for (let i = segments.length; i > 0; i--) {\n          const subPath = segments.slice(0, i).join('/');\n          const active = i === segments.length;\n          if (lockedDescendantPaths[subPath] || lockedDescendantPaths[subPath] === active) break;\n          lockedDescendantPaths[subPath] = active;\n          if (subPath === path) break;\n        }\n      }\n    }\n  }\n\n  _pruneAncestors(targetPath, targetObject) {\n    // Destroy the child (unless it's a placeholder that's still needed) and any ancestors that\n    // are no longer needed to keep this child rooted, and have no other reason to exist.\n    let deleted = false;\n    let object = targetObject;\n    // The target object may be a primitive, in which case it won't have $path, $parent and $key\n    // properties.  In that case, use the target path to figure those out instead.  Note that all\n    // ancestors of the target object will necessarily not be primitives and will have those\n    // properties.\n    const targetSegments = _(targetPath).split('/').map(unescapeKey).value();\n    while (object && object !== this.root) {\n      const parent =\n        object.$parent || object === targetObject && this.getObject(targetSegments.slice(0, -1));\n      if (!this._modeler.isPlaceholder(object.$path || targetPath)) {\n        const ghostObjects = deleted ? null : [targetObject];\n        if (!this._holdsConcreteData(object, ghostObjects)) {\n          deleted = true;\n          this._deleteFirebaseProperty(\n            parent, object.$key || object === targetObject && _.last(targetSegments));\n        }\n      }\n      object = parent;\n    }\n    return deleted;\n  }\n\n  _holdsConcreteData(object, ghostObjects) {\n    if (ghostObjects && _.includes(ghostObjects, object)) return false;\n    if (_.some(object, value => !value.$truss)) return true;\n    return _.some(object, value => this._holdsConcreteData(value, ghostObjects));\n  }\n\n  _pruneDescendants(object, lockedDescendantPaths) {\n    if (lockedDescendantPaths[object.$path]) return true;\n    if (object.$overridden) delete object.$overridden;\n    let coupledDescendantFound = false;\n    _.each(object, (value, key) => {\n      let shouldDelete = true;\n      let valueLocked;\n      if (lockedDescendantPaths[joinPath(object.$path, escapeKey(key))]) {\n        shouldDelete = false;\n        valueLocked = true;\n      } else if (value.$truss) {\n        const placeholder = this._modeler.isPlaceholder(value.$path);\n        if (placeholder || _.has(lockedDescendantPaths, value.$path)) {\n          valueLocked = this._pruneDescendants(value, lockedDescendantPaths);\n          shouldDelete = !placeholder && !valueLocked;\n        }\n      }\n      if (shouldDelete) this._deleteFirebaseProperty(object, key);\n      coupledDescendantFound = coupledDescendantFound || valueLocked;\n    });\n    return coupledDescendantFound;\n  }\n\n  getObject(pathOrSegments) {\n    let object;\n    const segments = _.isString(pathOrSegments) ?\n      _(pathOrSegments).split('/').map(unescapeKey).value() : pathOrSegments;\n    for (const segment of segments) {\n      object = segment ? object[segment] : this.root;\n      if (object === undefined) return;\n    }\n    return object;\n  }\n\n  _getFirebasePropertyDescriptor(object, key) {\n    let descriptor = Object.getOwnPropertyDescriptor(object, key);\n    if (descriptor) {\n      if (!descriptor.enumerable) {\n        throw new Error(\n          `Key conflict between Firebase and instance or computed properties at ` +\n          `${object.$path}: ${key}`);\n      }\n      if (!descriptor.get || !descriptor.set) {\n        throw new Error(`Unbound property at ${object.$path}: ${key}`);\n      }\n    } else if (key in object) {\n      throw new Error(\n        `Key conflict between Firebase and inherited property at ${object.$path}: ${key}`);\n    }\n    return descriptor;\n  }\n\n  _setFirebaseProperty(object, key, value) {\n    if (object.hasOwnProperty('$data')) object = object.$data;\n    let descriptor = this._getFirebasePropertyDescriptor(object, key);\n    if (descriptor) {\n      this._firebasePropertyEditAllowed = true;\n      object[key] = value;\n      this._firebasePropertyEditAllowed = false;\n    } else {\n      Vue.set(object, key, value);\n      descriptor = Object.getOwnPropertyDescriptor(object, key);\n      Object.defineProperty(object, key, {\n        get: descriptor.get, set: this._overwriteFirebaseProperty.bind(this, descriptor, key),\n        configurable: true, enumerable: true\n      });\n    }\n  }\n\n  _overwriteFirebaseProperty(descriptor, key, newValue) {\n    if (!this._firebasePropertyEditAllowed) {\n      const e = new Error(`Firebase data cannot be mutated directly: ${key}`);\n      e.trussCode = 'firebase_overwrite';\n      throw e;\n    }\n    descriptor.set.call(this, newValue);\n  }\n\n  _deleteFirebaseProperty(object, key) {\n    if (object.hasOwnProperty('$data')) object = object.$data;\n    // Make sure it's actually a Firebase property.\n    this._getFirebasePropertyDescriptor(object, key);\n    this._destroyObject(object[key]);\n    Vue.delete(object, key);\n  }\n\n  checkVueObject(object, path) {\n    this._modeler.checkVueObject(object, path);\n  }\n\n  static get computedPropertyStats() {\n    return Modeler.computedPropertyStats;\n  }\n}\n\n\nexport function checkUpdateHasOnlyDescendantsWithNoOverlap(rootPath, values) {\n  // First, check all paths for correctness and absolutize them, since there could be a mix of\n  // absolute paths and relative keys.\n  _.each(_.keys(values), path => {\n    if (path.charAt(0) === '/') {\n      if (!(path === rootPath || rootPath === '/' ||\n            _.startsWith(path, rootPath + '/') && path.length > rootPath.length + 1)) {\n        throw new Error(`Update item is not a descendant of target ref: ${path}`);\n      }\n    } else {\n      if (path.indexOf('/') >= 0) {\n        throw new Error(`Update item deep path must be absolute, taken from a reference: ${path}`);\n      }\n      const absolutePath = joinPath(rootPath, escapeKey(path));\n      if (values.hasOwnProperty(absolutePath)) {\n        throw new Error(`Update items overlap: ${path} and ${absolutePath}`);\n      }\n      values[absolutePath] = values[path];\n      delete values[path];\n    }\n  });\n  // Then check for overlaps;\n  const allPaths = _(values).keys().map(path => joinPath(path, '')).sortBy('length').value();\n  _.each(values, (value, path) => {\n    for (const otherPath of allPaths) {\n      if (otherPath.length > path.length) break;\n      if (path !== otherPath && _.startsWith(path, otherPath)) {\n        throw new Error(`Update items overlap: ${otherPath} and ${path}`);\n      }\n    }\n  });\n}\n\nexport function relativizePaths(rootPath, values) {\n  _.each(_.keys(values), path => {\n    values[path.slice(rootPath === '/' ? 1 : rootPath.length + 1)] = values[path];\n    delete values[path];\n  });\n}\n\nexport function toFirebaseJson(object) {\n  if (typeof object === 'object') {\n    const result = {};\n    for (const key in object) {\n      if (!object.hasOwnProperty(key)) continue;\n      result[escapeKey(key)] = toFirebaseJson(object[key]);\n    }\n    return result;\n  } else {\n    return object;\n  }\n}\n\n","import {escapeKey, unescapeKey, makePathMatcher} from './utils.js';\n\nimport _ from 'lodash';\n\n\nconst EMPTY_ANNOTATIONS = {};\nObject.freeze(EMPTY_ANNOTATIONS);\n\n\nexport class Handle {\n  constructor(tree, path, annotations) {\n    this._tree = tree;\n    this._path = path.replace(/^\\/*/, '/').replace(/\\/$/, '');\n    if (annotations) {\n      this._annotations = annotations;\n      Object.freeze(annotations);\n    }\n  }\n\n  get $ref() {return this;}\n  get key() {\n    if (!this._key) this._key = unescapeKey(this._path.replace(/.*\\//, ''));\n    return this._key;\n  }\n  get path() {return this._path;}\n  get _pathPrefix() {return this._path === '/' ? '' : this._path;}\n  get parent() {\n    return new Reference(this._tree, this._path.replace(/\\/[^/]*$/, ''), this._annotations);\n  }\n\n  get annotations() {\n    return this._annotations || EMPTY_ANNOTATIONS;\n  }\n\n  child() {\n    if (!arguments.length) return this;\n    const segments = [];\n    for (const key of arguments) {\n      if (key === undefined || key === null) return;\n      segments.push(escapeKey(key));\n    }\n    return new Reference(\n      this._tree, `${this._pathPrefix}/${segments.join('/')}`,\n      this._annotations\n    );\n  }\n\n  children() {\n    if (!arguments.length) return this;\n    const escapedKeys = [];\n    for (let i = 0; i < arguments.length; i++) {\n      const arg = arguments[i];\n      if (_.isArray(arg)) {\n        const mapping = {};\n        const subPath = this._pathPrefix + (escapedKeys.length ? `/${escapedKeys.join('/')}` : '');\n        const rest = _.slice(arguments, i + 1);\n        for (const key of arg) {\n          const subRef =\n            new Reference(this._tree, `${subPath}/${escapeKey(key)}`, this._annotations);\n          const subMapping = subRef.children.apply(subRef, rest);\n          if (subMapping) mapping[key] = subMapping;\n        }\n        if (_.isEmpty(mapping)) return;\n        return mapping;\n      } else {\n        if (arg === undefined || arg === null) return;\n        escapedKeys.push(escapeKey(arg));\n      }\n    }\n    return new Reference(\n      this._tree, `${this._pathPrefix}/${escapedKeys.join('/')}`, this._annotations);\n  }\n\n  peek(callback) {\n    return this._tree.truss.peek(this, callback);\n  }\n\n  match(pattern) {\n    return makePathMatcher(pattern).match(this.path);\n  }\n\n  isEqual(that) {\n    if (!(that instanceof Handle)) return false;\n    return this._tree === that._tree && this.toString() === that.toString();\n  }\n\n  belongsTo(truss) {\n    return this._tree.truss === truss;\n  }\n}\n\n\nexport class Query extends Handle {\n  constructor(tree, path, spec, annotations) {\n    super(tree, path, annotations);\n    this._spec = this._copyAndValidateSpec(spec);\n    const queryTerms = _(this._spec)\n      .map((value, key) => `${key}=${encodeURIComponent(JSON.stringify(value))}`)\n      .sortBy()\n      .join('&');\n    this._string = `${this._path}?${queryTerms}`;\n    Object.freeze(this);\n  }\n\n  // Vue-bound\n  get ready() {\n    return this._tree.isQueryReady(this);\n  }\n\n  get constraints() {\n    return this._spec;\n  }\n\n  annotate(annotations) {\n    return new Query(\n      this._tree, this._path, this._spec, _.extend({}, this._annotations, annotations));\n  }\n\n  _copyAndValidateSpec(spec) {\n    if (!spec.by) throw new Error('Query needs \"by\" clause: ' + JSON.stringify(spec));\n    if (('at' in spec) + ('from' in spec) + ('to' in spec) > 1) {\n      throw new Error(\n        'Query must contain at most one of \"at\", \"from\", or \"to\" clauses: ' + JSON.stringify(spec));\n    }\n    if (('first' in spec) + ('last' in spec) > 1) {\n      throw new Error(\n        'Query must contain at most one of \"first\" or \"last\" clauses: ' + JSON.stringify(spec));\n    }\n    if (!_.some(['at', 'from', 'to', 'first', 'last'], clause => clause in spec)) {\n      throw new Error(\n        'Query must contain at least one of \"at\", \"from\", \"to\", \"first\", or \"last\" clauses: ' +\n        JSON.stringify(spec));\n    }\n    spec = _.clone(spec);\n    if (spec.by !== '$key' && spec.by !== '$value') {\n      if (!(spec.by instanceof Reference)) {\n        throw new Error('Query \"by\" value must be a reference: ' + spec.by);\n      }\n      let childPath = spec.by.toString();\n      if (!_.startsWith(childPath, this._path)) {\n        throw new Error(\n          'Query \"by\" value must be a descendant of target reference: ' + spec.by);\n      }\n      childPath = childPath.slice(this._path.length).replace(/^\\/?/, '');\n      if (childPath.indexOf('/') === -1) {\n        throw new Error(\n          'Query \"by\" value must not be a direct child of target reference: ' + spec.by);\n      }\n      spec.by = childPath.replace(/.*?\\//, '');\n    }\n    Object.freeze(spec);\n    return spec;\n  }\n\n\n  toString() {\n    return this._string;\n  }\n}\n\n\n// jshint latedef:false\nexport class Reference extends Handle {\n// jshint latedef:nofunc\n\n  constructor(tree, path, annotations) {\n    super(tree, path, annotations);\n    Object.freeze(this);\n  }\n\n  get ready() {return this._tree.isReferenceReady(this);}  // Vue-bound\n  get value() {return this._tree.getObject(this.path);}  // Vue-bound\n  toString() {return this._path;}\n\n  annotate(annotations) {\n    return new Reference(this._tree, this._path, _.extend({}, this._annotations, annotations));\n  }\n\n  query(spec) {\n    return new Query(this._tree, this._path, spec);\n  }\n\n  set(value) {\n    return this._tree.update(this, 'set', {[this.path]: value});\n  }\n\n  update(values) {\n    return this._tree.update(this, 'update', values);\n  }\n\n  override(value) {\n    return this._tree.update(this, 'override', {[this.path]: value});\n  }\n\n  commit(updateFunction) {\n    return this._tree.commit(this, updateFunction);\n  }\n}\n\nexport default Reference;\n","import _ from 'lodash';\nimport {wrapPromiseCallback} from './utils.js';\n\n\nconst INTERCEPT_KEYS = [\n  'read', 'write', 'auth', 'set', 'update', 'commit', 'connect', 'peek', 'all'\n];\n\nconst EMPTY_ARRAY = [];\n\n\nclass SlowHandle {\n  constructor(operation, delay, callback) {\n    this._operation = operation;\n    this._delay = delay;\n    this._callback = callback;\n    this._fired = false;\n  }\n\n  initiate() {\n    this.cancel();\n    this._fired = false;\n    const elapsed = Date.now() - this._operation._startTimestamp;\n    this._timeoutId = setTimeout(this._delay - elapsed, () => {\n      this._fired = true;\n      this._callback(this._operation);\n    });\n  }\n\n  cancel() {\n    if (this._fired) this._callback(this._operation);\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n}\n\n\nclass Operation {\n  constructor(type, method, target) {\n    this._type = type;\n    this._method = method;\n    this._target = target;\n    this._ready = false;\n    this._running = false;\n    this._ended = false;\n    this._tries = 0;\n    this._startTimestamp = Date.now();\n    this._slowHandles = [];\n  }\n\n  get type() {return this._type;}\n  get method() {return this._method;}\n  get target() {return this._target;}\n  get ready() {return this._ready;}\n  get running() {return this._running;}\n  get ended() {return this._ended;}\n  get tries() {return this._tries;}\n  get error() {return this._error;}\n\n  onSlow(delay, callback) {\n    const handle = new SlowHandle(this, delay, callback);\n    this._slowHandles.push(handle);\n    handle.initiate();\n  }\n\n  _setRunning(value) {\n    this._running = value;\n  }\n\n  _setEnded(value) {\n    this._ended = value;\n  }\n\n  _markReady() {\n    this._ready = true;\n    this._tries = 0;\n    _.each(this._slowHandles, handle => handle.cancel());\n  }\n\n  _clearReady() {\n    this._ready = false;\n    this._startTimestamp = Date.now();\n    _.each(this._slowHandles, handle => handle.initiate());\n  }\n\n  _incrementTries() {\n    this._tries++;\n  }\n}\n\n\nexport default class Dispatcher {\n  constructor(bridge) {\n    this._bridge = bridge;\n    this._callbacks = {};\n    Object.freeze(this);\n  }\n\n  intercept(interceptKey, callbacks) {\n    if (!_.contains(INTERCEPT_KEYS, interceptKey)) {\n      throw new Error('Unknown intercept operation type: ' + interceptKey);\n    }\n    const badCallbackKeys =\n      _.difference(_.keys(callbacks), ['onBefore', 'onAfter', 'onError', 'onFailure']);\n    if (badCallbackKeys.length) {\n      throw new Error('Unknown intercept callback types: ' + badCallbackKeys.join(', '));\n    }\n    const wrappedCallbacks = {\n      onBefore: this._addCallback('onBefore', interceptKey, callbacks.onBefore),\n      onAfter: this._addCallback('onAfter', interceptKey, callbacks.onAfter),\n      onError: this._addCallback('onError', interceptKey, callbacks.onError),\n      onFailure: this._addCallback('onFailure', interceptKey, callbacks.onFailure)\n    };\n    return this._removeCallbacks.bind(this, interceptKey, wrappedCallbacks);\n  }\n\n  _addCallback(stage, interceptKey, callback) {\n    if (!callback) return;\n    const key = this._getCallbacksKey(stage, interceptKey);\n    const wrappedCallback = wrapPromiseCallback(callback);\n    (this._callbacks[key] || (this._callbacks[key] = [])).push(wrappedCallback);\n    return wrappedCallback;\n  }\n\n  _removeCallback(stage, interceptKey, wrappedCallback) {\n    if (!wrappedCallback) return;\n    const key = this._getCallbacksKey(stage, interceptKey);\n    if (this._callbacks[key]) _.pull(this._callbacks[key], wrappedCallback);\n  }\n\n  _removeCallbacks(interceptKey, wrappedCallbacks) {\n    _.each(wrappedCallbacks, (wrappedCallback, stage) => {\n      this._removeCallback(stage, interceptKey, wrappedCallback);\n    });\n  }\n\n  _getCallbacks(stage, operationType, method) {\n    return [].concat(\n      this._callbacks[this._getCallbacksKey(stage, method)] || EMPTY_ARRAY,\n      this._callbacks[this._getCallbacksKey(stage, operationType)] || EMPTY_ARRAY,\n      this._callbacks[this._getCallbacksKey(stage, 'all')] || EMPTY_ARRAY\n    );\n  }\n\n  _getCallbacksKey(stage, interceptKey) {\n    return `${stage}_${interceptKey}`;\n  }\n\n  execute(operationType, method, target, executor) {\n    executor = wrapPromiseCallback(executor);\n    const operation = this.createOperation(operationType, method, target);\n    return this.begin(operation).then(() => {\n      const executeWithRetries = () => {\n        return executor().catch(e => this._retryOrEnd(operation, e).then(executeWithRetries));\n      };\n      return executeWithRetries();\n    }).then(result => this.end(operation).then(() => result));\n  }\n\n  createOperation(operationType, method, target) {\n    return new Operation(operationType, method, target);\n  }\n\n  begin(operation) {\n    return Promise.all(_.map(\n      this._getCallbacks('onBefore', operation.type, operation.method),\n      onBefore => onBefore(operation)\n    )).then(() => {\n      if (!operation.ended) operation._setRunning(true);\n    }, e => this.end(operation, e));\n  }\n\n  markReady(operation) {\n    operation._markReady();\n  }\n\n  clearReady(operation) {\n    operation._clearReady();\n  }\n\n  retry(operation, error) {\n    operation._incrementTries();\n    operation._error = error;\n    return Promise.all(_.map(\n      this._getCallbacks('onError', operation.type, operation.method),\n      onError => onError(operation, error)\n    )).then(results => {\n      const retrying = _.some(results);\n      if (retrying) delete operation._error;\n      return retrying;\n    });\n  }\n\n  _retryOrEnd(operation, error) {\n    return this.retry(operation, error).then(result => {\n      if (!result) return this.end(operation, error);\n    }, e => this.end(operation, e));\n  }\n\n  end(operation, error) {\n    if (operation.ended) return;\n    operation._setRunning(false);\n    operation._setEnded(true);\n    if (error) operation._error = error;\n    return Promise.all(_.map(\n      this._getCallbacks('onAfter', operation.type, operation.method),\n      onAfter => onAfter(operation)\n    )).then(\n      () => this._afterEnd(operation),\n      e => {\n        operation._error = e;\n        return this._afterEnd(operation);\n      }\n    );\n  }\n\n  _afterEnd(operation) {\n    this.markReady(operation);\n    if (operation.error) {\n      const onFailureCallbacks = this._getCallbacks('onFailure', operation.type, operation.method);\n      return this._bridge.probeError(operation.error).then(() => {\n        if (onFailureCallbacks) {\n          setTimeout(() => {\n            _.each(onFailureCallbacks, onFailure => onFailure(operation));\n          }, 0);\n        }\n        return Promise.reject(operation.error);\n      });\n    }\n  }\n}\n\n","'use strict';\n\nconst ALPHABET = '-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz';\n\nexport default class KeyGenerator {\n  constructor() {\n    this._lastUniqueKeyTime = 0;\n    this._lastRandomValues = [];\n  }\n\n  generateUniqueKey(now) {\n    now = now || Date.now();\n    const chars = new Array(20);\n    let prefix = now;\n    for (let i = 7; i >= 0; i--) {\n      chars[i] = ALPHABET.charAt(prefix & 0x3f);\n      prefix = Math.floor(prefix / 64);\n    }\n    if (now === this._lastUniqueKeyTime) {\n      let i = 11;\n      while (i >= 0 && this._lastRandomValues[i] === 63) {\n        this._lastRandomValues[i] = 0;\n        i -= 1;\n      }\n      if (i === -1) {\n        throw new Error('Internal assertion failure: ran out of unique IDs for this millisecond');\n      }\n      this._lastRandomValues[i] += 1;\n    } else {\n      this._lastUniqueKeyTime = now;\n      for (let i = 0; i < 12; i++) {\n        // Make sure to leave some space for incrementing in the top nibble.\n        this._lastRandomValues[i] = Math.floor(Math.random() * (i ? 64 : 16));\n      }\n    }\n    for (let i = 0; i < 12; i++) {\n      chars[i + 8] = ALPHABET[this._lastRandomValues[i]];\n    }\n    return chars.join('');\n  }\n}\n","import angularCompatibility from './angularCompatibility.js';\nimport Vue from 'vue';\n\nexport default class MetaTree {\n  constructor(rootUrl, bridge) {\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._vue = new Vue({data: {$root: {\n      connected: undefined, timeOffset: 0, user: undefined, userid: undefined,\n      nowAtInterval(intervalMillis) {\n        const key = 'now' + intervalMillis;\n        if (!this.hasOwnProperty(key)) {\n          const update = () => {\n            this[key] = Date.now() + this.timeOffset;\n            angularCompatibility.digest();\n          };\n          update();\n          setInterval(() => update, intervalMillis);\n        }\n        return this[key];\n      }\n    }}});\n\n    if (angularCompatibility.active) {\n      this._vue.$watch('$data', angularCompatibility.digest, {deep: true});\n    }\n\n    bridge.onAuth(rootUrl, this._handleAuthChange, this);\n\n    this._connectInfoProperty('serverTimeOffset', 'timeOffset');\n    this._connectInfoProperty('connected', 'connected');\n    Object.freeze(this);\n  }\n\n  get root() {\n    return this._vue.$data.$root;\n  }\n\n  destroy() {\n    this._bridge.offAuth(this._rootUrl, this._handleAuthChange, this);\n    this._vue.$destroy();\n  }\n\n  _handleAuthChange(user) {\n    this.root.user = user;\n    this.root.userid = user && user.uid;\n  }\n\n  _connectInfoProperty(property, attribute) {\n    const propertyUrl = `${this._rootUrl}/.info/${property}`;\n    this._bridge.on(propertyUrl, propertyUrl, null, 'value', snap => {\n      this.root[attribute] = snap.value;\n    });\n  }\n}\n","import _ from 'lodash';\nimport Vue from 'vue';\nimport angularCompatibility from './angularCompatibility.js';\n\n\nclass QueryHandler {\n  constructor(coupler, query) {\n    this._coupler = coupler;\n    this._query = query;\n    this._listeners = [];\n    this._keys = [];\n    this._url = this._coupler._rootUrl + query.path;\n    this._segments = query.path.split('/');\n    this._listening = false;\n    this.ready = false;\n  }\n\n  attach(operation, keysCallback) {\n    this._listen();\n    this._listeners.push({operation, keysCallback});\n    if (keysCallback) keysCallback(this._keys);\n  }\n\n  detach(operation) {\n    const k = _.findIndex(this._listeners, {operation});\n    if (k >= 0) this._listeners.splice(k, 1);\n    return this._listeners.length;\n  }\n\n  _listen() {\n    if (this._listening) return;\n    this._coupler._bridge.on(\n      this._query.toString(), this._url, this._query.constraints, 'value',\n      this._handleSnapshot, this._handleError.bind(this._query.path), this, {sync: true});\n    this._listening = true;\n  }\n\n  destroy() {\n    this._coupler._bridge.off(\n      this._query.toString(), this._url, this._query.constraints, 'value', this._handleSnapshot,\n      this);\n    this._listening = false;\n    this.ready = false;\n    angularCompatibility.digest();\n    for (const key of this._keys) {\n      this._coupler._decoupleSegments(this._segments.concat(key));\n    }\n  }\n\n  _handleSnapshot(snap) {\n    // Order is important here: first couple any new subpaths so _handleSnapshot will update the\n    // tree, then tell the client to update its keys, pulling values from the tree.\n    if (!this._listeners.length || !this._listening) return;\n    const updatedKeys = this._updateKeys(snap);\n    this._coupler._applySnapshot(snap);\n    if (!this.ready) {\n      this.ready = true;\n      angularCompatibility.digest();\n      for (const listener of this._listeners) {\n        this._coupler._dispatcher.markReady(listener.operation);\n      }\n    }\n    if (updatedKeys) {\n      for (const listener of this._listeners) {\n        if (listener.keysCallback) listener.keysCallback(updatedKeys);\n      }\n    }\n  }\n\n  _updateKeys(snap) {\n    let updatedKeys;\n    if (snap.path === this._query.path) {\n      updatedKeys = _.keys(snap.value);\n      updatedKeys.sort();\n      if (_.isEqual(this._keys, updatedKeys)) {\n        updatedKeys = null;\n      } else {\n        for (const key of _.difference(updatedKeys, this._keys)) {\n          this._coupler._coupleSegments(this._segments.concat(key));\n        }\n        for (const key of _.difference(this._keys, updatedKeys)) {\n          this._coupler._decoupleSegments(this._segments.concat(key));\n        }\n        this._keys = updatedKeys;\n      }\n    } else if (snap.path.replace(/\\/[^/]+/, '') === this._query.path) {\n      const hasKey = _.contains(this._keys, snap.key);\n      if (snap.value) {\n        if (!hasKey) {\n          this._coupler._coupleSegments(this._segments.concat(snap.key));\n          this._keys.push(snap.key);\n          this._keys.sort();\n          updatedKeys = this._keys;\n        }\n      } else {\n        if (hasKey) {\n          this._coupler._decoupleSegments(this._segments.concat(snap.key));\n          _.pull(this._keys, snap.key);\n          this._keys.sort();\n          updatedKeys = this._keys;\n        }\n      }\n    }\n    return updatedKeys;\n  }\n\n  _handleError(error) {\n    if (!this._listeners.length || !this._listening) return;\n    this._listening = false;\n    Promise.all(_.map(this._listeners, listener => {\n      this._coupler._dispatcher.clearReady(listener.operation);\n      return this._coupler._dispatcher.retry(listener.operation, error).catch(e => {\n        listener.operation._disconnect(e);\n        return false;\n      });\n    })).then(results => {\n      if (_.some(results)) {\n        if (this._listeners.length) this._listen();\n      } else {\n        for (const listener of this._listeners) listener.operation._disconnect(error);\n      }\n    });\n  }\n}\n\n\nclass Node {\n  constructor(coupler, path) {\n    this._coupler = coupler;\n    this.path = path;\n    this.url = this._coupler._rootUrl + path;\n    this.operations = [];\n    this.queryCount = 0;\n    this.listening = false;\n    this.ready = false;\n    this.children = {};\n  }\n\n  get active() {\n    return this.count || this.queryCount;\n  }\n\n  get count() {\n    return this.operations.length;\n  }\n\n  listen(skip) {\n    if (!skip && this.count) {\n      if (this.listening) return;\n      _.each(this.operations, op => {this._coupler._dispatcher.clearReady(op);});\n      this._coupler._bridge.on(\n        this.url, this.url, null, 'value', this._handleSnapshot, this._handleError.bind(this),\n        this, {sync: true});\n      this.listening = true;\n    } else {\n      _.each(this.children, child => {child.listen();});\n    }\n  }\n\n  unlisten(skip) {\n    if (!skip && this.listening) {\n      this._coupler._bridge.off(this.url, this.url, null, 'value', this._handleSnapshot, this);\n      this.listening = false;\n      this._forAllDescendants(node => {\n        if (node.ready) {\n          node.ready = false;\n          angularCompatibility.digest();\n        }\n      });\n    } else {\n      _.each(this.children, child => {child.unlisten();});\n    }\n  }\n\n  _handleSnapshot(snap) {\n    if (!this.listening || !this._coupler.isTrunkCoupled(snap.path)) return;\n    this._coupler._applySnapshot(snap);\n    if (!this.ready && snap.path === this.path) {\n      this.ready = true;\n      angularCompatibility.digest();\n      this.unlisten(true);\n      this._forAllDescendants(node => {\n        for (const op of this.operations) this._coupler._dispatcher.markReady(op);\n      });\n    }\n  }\n\n  _handleError(error) {\n    if (!this.count || !this.listening) return;\n    this.listening = false;\n    this._forAllDescendants(node => {\n      if (node.ready) {\n        node.ready = false;\n        angularCompatibility.digest();\n      }\n      for (const op of this.operations) this._coupler._dispatcher.clearReady(op);\n    });\n    return Promise.all(_.map(this.operations, op => {\n      return this._coupler._dispatcher.retry(op, error).catch(e => {\n        op._disconnect(e);\n        return false;\n      });\n    })).then(results => {\n      if (_.some(results)) {\n        if (this.count) this.listen();\n      } else {\n        for (const op of this.operations) op._disconnect(error);\n        // Pulling all the operations will automatically get us listening on descendants.\n      }\n    });\n  }\n\n  _forAllDescendants(iteratee) {\n    iteratee(this);\n    _.each(this.children, child => child._forAllDescendants(iteratee));\n  }\n\n  collectCoupledDescendantPaths(paths) {\n    if (!paths) paths = {};\n    paths[this.path] = this.active;\n    if (!this.active) {\n      _.each(this.children, child => {child.collectCoupledDescendantPaths(paths);});\n    }\n    return paths;\n  }\n}\n\n\nexport default class Coupler {\n  constructor(rootUrl, bridge, dispatcher, applySnapshot, prunePath) {\n    this._rootUrl = rootUrl;\n    this._bridge = bridge;\n    this._dispatcher = dispatcher;\n    this._applySnapshot = applySnapshot;\n    this._prunePath = prunePath;\n    this._vue = new Vue({data: {root: new Node(this, '/'), queryHandlers: {}}});\n    Object.freeze(this);\n  }\n\n  get _root() {return this._vue.root;}\n  get _queryHandlers() {return this._vue.queryHandlers;}\n\n  destroy() {\n    _.each(this._queryHandlers, queryHandler => {queryHandler.destroy();});\n    this._root.unlisten();\n    this._vue.$destroy();\n  }\n\n  couple(path, operation) {\n    return this._coupleSegments(path.split('/'), operation);\n  }\n\n  _coupleSegments(segments, operation) {\n    let node;\n    let superseded = !operation;\n    let ready = false;\n    for (const segment of segments) {\n      let child = segment ? node.children && node.children[segment] : this._root;\n      if (!child) {\n        child = new Node(this, `${node.path === '/' ? '' : node.path}/${segment}`);\n        Vue.set(node.children, segment, child);\n      }\n      superseded = superseded || child.listening;\n      ready = ready || child.ready;\n      node = child;\n    }\n    if (operation) {\n      node.operations.push(operation);\n    } else {\n      node.queryCount++;\n    }\n    if (superseded) {\n      if (operation && ready) this._dispatcher.markReady(operation);\n    } else {\n      node.listen();  // node will call unlisten() on descendants when ready\n    }\n  }\n\n  decouple(path, operation) {\n    return this._decoupleSegments(path.split('/'), operation);\n  }\n\n  _decoupleSegments(segments, operation) {\n    const ancestors = [];\n    let node;\n    for (const segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) break;\n      ancestors.push(node);\n    }\n    if (!node || !(operation ? node.count : node.queryCount)) {\n      throw new Error(`Path not coupled: ${segments.join('/')}`);\n    }\n    if (operation) {\n      _.pull(node.operations, operation);\n    } else {\n      node.queryCount--;\n    }\n    if (operation && !node.count) {\n      // Ideally, we wouldn't resync the full values here since we probably already have the current\n      // value for all children.  But making sure that's true is tricky in an async system (what if\n      // the node's value changes and the update crosses the 'off' call in transit?) and this\n      // situation should be sufficiently rare that the optimization is probably not worth it right\n      // now.\n      node.listen();\n      if (node.listening) node.unlisten();\n    }\n    if (!node.active) {\n      for (let i = ancestors.length - 1; i > 0; i--) {\n        node = ancestors[i];\n        if (node === this._root || node.active || !_.isEmpty(node.children)) break;\n        Vue.delete(ancestors[i - 1].children, segments[i]);\n      }\n      this._prunePath(segments.join('/'), this.findCoupledDescendantPaths(segments));\n    }\n  }\n\n  subscribe(query, operation, keysCallback) {\n    let queryHandler = this._queryHandlers[query.toString()];\n    if (!queryHandler) {\n      queryHandler = new QueryHandler(this, query);\n      Vue.set(this._queryHandlers, query.toString(), queryHandler);\n    }\n    queryHandler.attach(operation, keysCallback);\n }\n\n  unsubscribe(query, operation) {\n    const queryHandler = this._queryHandlers[query.toString()];\n    if (queryHandler && !queryHandler.detach(operation)) {\n      queryHandler.destroy();\n      Vue.delete(this._queryHandlers, query.toString());\n    }\n  }\n\n  // Return whether the node at path or any ancestors are coupled.\n  isTrunkCoupled(path) {\n    const segments = path.split('/');\n    let node;\n    for (const segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) return false;\n      if (node.active) return true;\n    }\n    return false;\n  }\n\n  findCoupledDescendantPaths(pathOrSegments) {\n    const segments = _.isString(pathOrSegments) ? pathOrSegments.split('/') : pathOrSegments;\n    let node;\n    for (const segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) break;\n    }\n    return node && node.collectCoupledDescendantPaths();\n  }\n\n  isSubtreeReady(path) {\n    const segments = path.split('/');\n    let node;\n    for (const segment of segments) {\n      node = segment ? node.children && node.children[segment] : this._root;\n      if (!node) return false;\n      if (node.ready) return true;\n    }\n    return false;\n  }\n\n  isQueryReady(query) {\n    const queryHandler = this._queryHandlers[query.toString()];\n    return queryHandler && queryHandler.ready;\n  }\n\n}\n\n","// Generated by CoffeeScript 1.7.1\n(function() {\n  var getNanoSeconds, hrtime, loadTime;\n\n  if ((typeof performance !== \"undefined\" && performance !== null) && performance.now) {\n    module.exports = function() {\n      return performance.now();\n    };\n  } else if ((typeof process !== \"undefined\" && process !== null) && process.hrtime) {\n    module.exports = function() {\n      return (getNanoSeconds() - loadTime) / 1e6;\n    };\n    hrtime = process.hrtime;\n    getNanoSeconds = function() {\n      var hr;\n      hr = hrtime();\n      return hr[0] * 1e9 + hr[1];\n    };\n    loadTime = getNanoSeconds();\n  } else if (Date.now) {\n    module.exports = function() {\n      return Date.now() - loadTime;\n    };\n    loadTime = Date.now();\n  } else {\n    module.exports = function() {\n      return new Date().getTime() - loadTime;\n    };\n    loadTime = new Date().getTime();\n  }\n\n}).call(this);\n","import _ from 'lodash';\nimport Vue from 'vue';\nimport angularCompatibility from './angularCompatibility.js';\nimport Bridge from './Bridge.js';\nimport Connector from './Connector.js';\nimport Dispatcher from './Dispatcher.js';\nimport KeyGenerator from './KeyGenerator.js';\nimport MetaTree from './MetaTree.js';\nimport {Handle, Reference} from './Reference.js';\nimport Tree from './Tree.js';\nimport {\n  escapeKey, unescapeKey, wrapPromiseCallback, promiseCancel, promiseFinally,\n  SERVER_TIMESTAMP\n} from './utils.js';\n\n\nlet bridge, logging;\nconst workerFunctions = {};\n// This version is filled in by the build, don't reformat the line.\nconst VERSION = 'dev';\n\n\nexport default class Truss {\n\n  /**\n   * Create a new Truss instance, specific to a given datastore.  To avoid confusion there should be\n   * exactly one Truss per root datastore URL, so in most code this will be a singleton.\n   *\n   * @param rootUrl {String} The root URL, https://{project}.firebaseio.com.\n   */\n  constructor(rootUrl) {\n    // TODO: allow rootUrl to be a test database object for testing\n    if (!bridge) {\n      throw new Error('Truss worker not connected, please call Truss.connectWorker first');\n    }\n    this._rootUrl = rootUrl.replace(/\\/$/, '');\n    this._keyGenerator = new KeyGenerator();\n    this._dispatcher = new Dispatcher(bridge);\n    this._vue = new Vue();\n\n    bridge.trackServer(this._rootUrl);\n    this._metaTree = new MetaTree(this._rootUrl, bridge);\n    this._tree = new Tree(this, this._rootUrl, bridge, this._dispatcher);\n\n    Object.freeze(this);\n  }\n\n  get meta() {return this._metaTree.root;}\n  get root() {return this._tree.root;}\n\n  /**\n   * Mount a set of classes against the datastore structure.  Must be called at most once, and\n   * cannot be called once any data has been loaded into the tree.\n   * @param classes {Array<Function> | Object<Function>} A list of the classes to map onto the\n   *    datastore structure.  Each class must have a static $trussMount property that is a\n   *    (wildcarded) unescaped datastore path, or an options object\n   *    {path: string, placeholder: object}, or an array of either.  If the list is an object then\n   *    the keys serve as default option-less $trussMount paths for classes that don't define an\n   *    explicit $trussMount.\n   */\n  mount(classes) {\n    this._tree.init(classes);\n  }\n\n  destroy() {\n    this._vue.$destroy();\n    this._tree.destroy();\n    this._metaTree.destroy();\n  }\n\n  get now() {return Date.now() + this.meta.timeOffset;}\n  newKey() {return this._keyGenerator.generateUniqueKey(this.now);}\n\n  authenticate(token) {\n    return this._dispatcher.execute('auth', 'authenticate', new Reference(this._tree, '/'), () => {\n      return bridge.authWithCustomToken(this._rootUrl, token, {rememberMe: true});\n    });\n  }\n\n  unauthenticate() {\n    return this._dispatcher.execute(\n      'auth', 'unauthenticate', new Reference(this._tree, '/'), () => {\n        return bridge.unauth(this._rootUrl);\n      }\n    );\n  }\n\n  intercept(actionType, callbacks) {\n    return this._dispatcher.intercept(actionType, callbacks);\n  }\n\n  // connections are {key: Query | Object | fn() -> (Query | Object)}\n  connect(scope, connections) {\n    if (!connections) {\n      connections = scope;\n      scope = undefined;\n    }\n    if (connections instanceof Handle) connections = {_: connections};\n    return new Connector(scope, connections, this._tree, 'connect');\n  }\n\n  // target is Reference, Query, or connection Object like above\n  peek(target, callback) {\n    callback = wrapPromiseCallback(callback);\n    let cleanup, cancel;\n    const promise = new Promise((resolve, reject) => {\n      const scope = {};\n      let callbackPromise;\n\n      let connector = new Connector(scope, {result: target}, this._tree, 'peek');\n\n      let unintercept = this.intercept('peek', {onFailure: op => {\n        function match(descriptor) {\n          if (!descriptor) return;\n          if (descriptor instanceof Handle) return op.target.isEqual(descriptor);\n          return _.some(descriptor, value => match(value));\n        }\n        if (match(connector.at)) {\n          reject(op.error);\n          cleanup();\n        }\n      }});\n\n      let unwatch = this.watch(() => connector.ready, ready => {\n        if (!ready) return;\n        unwatch();\n        unwatch = null;\n        callbackPromise = promiseFinally(\n          callback(scope.result), () => {callbackPromise = null; cleanup();}\n        ).then(result => {resolve(result);}, error => {reject(error);});\n      });\n\n      cleanup = () => {\n        if (unwatch) {unwatch(); unwatch = null;}\n        if (unintercept) {unintercept(); unintercept = null;}\n        if (connector) {connector.destroy(); connector = null;}\n        if (callbackPromise && callbackPromise.cancel) callbackPromise.cancel();\n      };\n\n      cancel = () => {\n        reject(new Error('Canceled'));\n        cleanup();\n      };\n    });\n    return promiseCancel(promise, cancel);\n  }\n\n  watch(subjectFn, callbackFn, options) {\n    let numCallbacks = 0;\n\n    const unwatch = this._vue.$watch(subjectFn, (newValue, oldValue) => {\n      numCallbacks++;\n      if (numCallbacks === 1) {\n        // Delay the immediate callback until we've had a chance to return the unwatch function.\n        Promise.resolve().then(() => {\n          if (numCallbacks > 1 || subjectFn() !== newValue) return;\n          callbackFn(newValue, oldValue);\n          angularCompatibility.digest();\n        });\n      } else {\n        callbackFn(newValue, oldValue);\n        angularCompatibility.digest();\n      }\n    }, {immediate: true, deep: options && options.deep});\n\n    return unwatch;\n  }\n\n  when(expression, options) {\n    let cleanup, timeoutHandle;\n    let promise = new Promise((resolve, reject) => {\n      let unwatch = this.watch(expression, value => {\n        if (!value) return;\n        // Wait for computed properties to settle and double-check.\n        Vue.nextTick(() => {\n          value = expression();\n          if (!value) return;\n          resolve(value);\n          cleanup();\n        });\n      });\n      if (_.has(options, 'timeout')) {\n        timeoutHandle = setTimeout(() => {\n          timeoutHandle = null;\n          reject(new Error(options.timeoutMessage || 'Timeout'));\n          cleanup();\n        }, options.timeout);\n      }\n      cleanup = () => {\n        if (unwatch) {unwatch(); unwatch = null;}\n        if (timeoutHandle) {clearTimeout(timeoutHandle); timeoutHandle = null;}\n        reject(new Error('Canceled'));\n      };\n    });\n    promise = promiseCancel(promiseFinally(promise, cleanup));\n    if (options && options.scope) options.scope.$on('$destroy', () => {promise.cancel();});\n    return promise;\n  }\n\n  checkObjectsForRogueProperties() {\n    this._tree.checkVueObject(this._tree.root, '/');\n  }\n\n  static get computedPropertyStats() {return Tree.computedPropertyStats;}\n\n  static logComputedPropertyStats(n = 10) {\n    const stats = _.take(Truss.computedPropertyStats, n);\n    if (!stats.length) return;\n    const totals = {runtime: 0, numUpdates: 0, numRecomputes: 0};\n    _.each(stats, stat => {\n      totals.runtime += stat.runtime;\n      totals.numUpdates += stat.numUpdates;\n      totals.numRecomputes += stat.numRecomputes;\n    });\n    const lines = _.map(stats, stat => [\n      `${stat.name}:`, ` ${(stat.runtime / 1000).toFixed(2)}s`,\n      `(${(stat.runtime / totals.runtime * 100).toFixed(1)}%)`,\n      ` ${stat.numUpdates} upd /`, `${stat.numRecomputes} runs`,\n      `(${(stat.numUpdates / stat.numRecomputes * 100).toFixed(1)}%)`,\n      ` ${stat.runtimePerRecompute.toFixed(2)}ms / run`\n    ]);\n    lines.unshift([\n      '--- Total:', ` ${(totals.runtime / 1000).toFixed(2)}s`, '(100.0%)',\n      ` ${totals.numUpdates} upd /`, `${totals.numRecomputes} runs`,\n      `(${(totals.numUpdates / totals.numRecomputes * 100).toFixed(1)}%)`,\n      ` ${(totals.runtime / totals.numRecomputes).toFixed(2)}ms / run`\n    ]);\n    const widths = _.map(_.range(lines[0].length), i => _(lines).map(line => line[i].length).max());\n    _.each(lines, line => {\n      console.log(_.map(line, (column, i) => _.padLeft(column, widths[i])).join(' '));\n    });\n  }\n\n  static connectWorker(webWorker) {\n    if (bridge) throw new Error('Worker already connected');\n    if (_.isString(webWorker)) {\n      const Worker = window.SharedWorker || window.Worker;\n      if (!Worker) throw new Error('Browser does not implement Web Workers');\n      webWorker = new Worker(webWorker);\n    }\n    bridge = new Bridge(webWorker);\n    if (logging) bridge.enableLogging(logging);\n    return bridge.init(webWorker).then(\n      ({exposedFunctionNames, firebaseSdkVersion}) => {\n        Object.defineProperty(Truss, 'FIREBASE_SDK_VERSION', {value: firebaseSdkVersion});\n        for (const name of exposedFunctionNames) {\n          Truss.worker[name] = bridge.bindExposedFunction(name);\n        }\n      }\n    );\n  }\n\n  static get worker() {return workerFunctions;}\n  static preExpose(functionName) {\n    Truss.worker[functionName] = bridge.bindExposedFunction(functionName);\n  }\n\n  static bounceConnection() {return bridge.bounceConnection();}\n  static suspend() {return bridge.suspend();}\n  static debugPermissionDeniedErrors(simulatedTokenGenerator, maxSimulationDuration, callFilter) {\n    return bridge.debugPermissionDeniedErrors(\n      simulatedTokenGenerator, maxSimulationDuration, callFilter);\n  }\n\n  static debounceAngularDigest(wait) {\n    angularCompatibility.debounceDigest(wait);\n  }\n\n  static escapeKey(key) {return escapeKey(key);}\n  static unescapeKey(escapedKey) {return unescapeKey(escapedKey);}\n\n  static enableLogging(fn) {\n    logging = fn;\n    if (bridge) bridge.enableLogging(fn);\n  }\n\n  // Duplicate static constants on instance for convenience.\n  get SERVER_TIMESTAMP() {return Truss.SERVER_TIMESTAMP;}\n  get VERSION() {return Truss.VERSION;}\n  get FIREBASE_SDK_VERSION() {return Truss.FIREBASE_SDK_VERSION;}\n}\n\nObject.defineProperties(Truss, {\n  SERVER_TIMESTAMP: {value: SERVER_TIMESTAMP},\n  VERSION: {value: VERSION}\n});\n\nangularCompatibility.defineModule(Truss);\n"]}