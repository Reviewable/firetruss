!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("lodash"),require("vue")):"function"==typeof define&&define.amd?define(["lodash","vue"],b):a.Truss=b(a._,a.Vue)}(this,function(a,b){"use strict";function c(){}function d(a){return a?a.toString().replace(/[\\\.\$\#\[\]\/]/g,function(a){return"\\"+a.charCodeAt(0).toString(16)}):a}function e(a){return a?a.toString().replace(/\\[0-9a-f]{2}/gi,function(a){return String.fromCharCode(parseInt(a.slice(1),16))}):a}function f(a){return function(){try{return Promise.resolve(a.apply(this,arguments))}catch(a){return Promise.reject(a)}}}function g(){}function h(a,b){if(!a||a instanceof Error)return a;var c=new Error(a.message);c.params=b;for(var d in a)if("message"!==d&&a.hasOwnProperty(d))try{c[d]=a[d]}catch(a){throw a.extra={propertyName:d},a}return c}function i(a){var b=a.indexOf("/",8);return b>=8?a.slice(0,b):a}function j(a,b){return b={exports:{}},a(b,b.exports),b.exports}function k(a,b){if(a&&a.$truss||b&&b.$truss)return a===b}function l(){throw new Error("Read-only property")}function m(){for(var a=[],b=0,c=arguments;b<c.length;b+=1){var d=c[b];"/"===d.charAt(0)&&a.splice(0,a.length),a.push(d)}return"/"===a[0]&&(a[0]=""),a.join("/")}function n(b,c,d){var e=a(c).keys().map(function(a){return"/"===a?"/":a+"/"}).sortBy(function(a){return a.length}).value();a.each(a.keys(c),function(f){if("/"!==f.charAt(0))throw new Error("Update item does not have an absolute path: "+f);if(!(f===b||"/"===b||a.startsWith(f,b+"/")&&f.length>b.length+1))throw new Error("Update item is not a descendant of target ref: "+f);for(var g=0,h=e;g<h.length;g+=1){var i=h[g];if(i.length>f.length)break;if(f!==i&&a.startsWith(f,i))throw new Error("Update items overlap: "+i+" and "+f)}d&&(c[f.slice("/"===b?1:b.length+1)]=c[f],delete c[f])})}function o(a){if("object"==typeof a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[d(c)]=o(a[c]));return b}return a}a="default"in a?a.default:a,b="default"in b?b.default:b;var p,q=function(){p=!0},r={active:"undefined"!=typeof window&&window.angular,debounceDigest:function(b){b?r.digest=a.debounce(q,b):r.digest=q}};["digest","defineModule"].forEach(function(a){r[a]=c}),r.active&&(r.digest=q,window.angular.module("firetruss",[]).run(["$rootScope",function(a){q=a.$evalAsync.bind(a),p&&q()}]),r.defineModule=function(a){window.angular.module("firetruss").constant("Truss",a)});var s,t=Object.freeze({".sv":"timestamp"}),u=function(a){var b=a.path,c=a.value,d=a.valueError,e=a.exists;this._path=b,this._value=c,this._valueError=h(d),this._exists=void 0===c?e||!1:null!==c},v={path:{},exists:{},value:{},key:{}};v.path.get=function(){return this._path},v.exists.get=function(){return this._exists},v.value.get=function(){return this._checkValue(),this._value},v.key.get=function(){return void 0===this._key&&(this._key=e(this._path.replace(/.*\//,""))),this._key},u.prototype._checkValue=function(){if(this._valueError)throw this._valueError;if(void 0===this._value)throw new Error("Value omitted from snapshot")},Object.defineProperties(u.prototype,v);var w=function(a){var b=this;this._idCounter=0,this._deferreds={},this._suspended=!1,this._servers={},this._callbacks={},this._simulatedTokenGenerator=null,this._maxSimulationDuration=5e3,this._simulatedCallFilter=null,this._inboundMessages=[],this._outboundMessages=[],this._flushMessageQueue=this._flushMessageQueue.bind(this),this._port=a.port||a,this._shared=!!a.port,this._port.onmessage=this._receive.bind(this),window.addEventListener("unload",function(){b._send({msg:"destroy"})}),setInterval(function(){b._send({msg:"ping"})},6e4)},x={instance:{}};w.init=function(a){var b=[];try{var c=window.localStorage||window.sessionStorage;if(!c)return;for(var d=0;d<c.length;d++){var e=c.key(d);b.push({key:e,value:c.getItem(e)})}}catch(a){}return this._send({msg:"init",storage:b})},x.instance.get=function(){if(!s)throw new Error("No web worker connected, please call Truss.connectWorker first");return s},w.prototype.suspend=function(a){void 0===a&&(a=!0),this._suspended!==a&&(this._suspended=a,a||(this._receiveMessages(this._inboundMessages),this._inboundMessages=[],this._outboundMessages.length&&setImmediate(this._flushMessageQueue)))},w.prototype.debugPermissionDeniedErrors=function(a,b,c){this._simulatedTokenGenerator=a,void 0!==b&&(this._maxSimulationDuration=b),this._simulatedCallFilter=c||function(){return!0}},w.prototype._send=function(a){var b=this;a.id=++this._idCounter;var c;if(a.oneWay)c=Promise.resolve();else{c=new Promise(function(c,d){b._deferreds[a.id]={resolve:c,reject:d}});var d=this._deferreds[a.id];d.promise=c,c.sent=new Promise(function(a){d.resolveSent=a}),d.params=a}return this._outboundMessages.length||this._suspended||setImmediate(this._flushMessageQueue),this._outboundMessages.push(a),c},w.prototype._flushMessageQueue=function(){this._port.postMessage(this._outboundMessages),this._outboundMessages=[]},w.prototype._receive=function(a){this._suspended?this._inboundMessages=this._inboundMessages.concat(a.data):this._receiveMessages(a.data)},w.prototype._receiveMessages=function(a){for(var b=this,c=0,d=a;c<d.length;c+=1){var e=d[c],f=b[e.msg];if("function"!=typeof f)throw new Error("Unknown message: "+e.msg);f.call(b,e)}},w.prototype.bindExposedFunction=function(a){return function(){return this._send({msg:"call",name:a,args:Array.prototype.slice.call(arguments)})}.bind(this)},w.prototype.resolve=function(a){var b=this._deferreds[a.id];if(!b)throw new Error("Received resolution to inexistent Firebase call");delete this._deferreds[a.id],b.resolve(a.result)},w.prototype.reject=function(a){var b=this._deferreds[a.id];if(!b)throw new Error("Received rejection of inexistent Firebase call");delete this._deferreds[a.id],b.reject(h(a.error,b.params))},w.prototype.probeError=function(a){var b=a.code||a.message;return a.params&&b&&"permission_denied"===b.toLowerCase()?this._simulateCall(a.params).then(function(b){b&&(a.permissionDeniedDetails=b)}):Promise.resolve()},w.prototype._simulateCall=function(a){var b=this;if(!(this._simulatedTokenGenerator&&this._maxSimulationDuration>0))return Promise.resolve();var c=[];switch(a.msg){case"set":c.push({method:"set",url:a.url,args:[a.value]});break;case"update":c.push({method:"update",url:a.url,args:[a.value]});break;case"on":c.push({method:"once",url:a.url,spec:a.spec,args:["value"]});break;case"transaction":c.push({method:"once",url:a.url,args:["value"]}),c.push({method:"set",url:a.url,args:[a.newValue]})}if(!c.length||!this._simulatedCallFilter(a.msg,a.url))return Promise.resolve();var d=this.getAuth(i(a.url)),e=this._simulatedTokenGenerator(d&&d.uid).then(function(a){return Promise.all(c.map(function(c){return c.msg="simulate",c.token=a,b._send(c)}))}).then(function(a){return a.every(function(a){return null===a})?"Unable to reproduce error in simulation":a.filter(function(a){return a}).join("\n\n")}).catch(function(a){return"Error running simulation: "+a}),f=new Promise(function(a){setTimeout(a.bind(null,"Simulated call timed out"),b._maxSimulationDuration)});return Promise.race([e,f])},w.prototype.updateLocalStorage=function(a){try{var b=window.localStorage||window.sessionStorage;for(var c in a)null===c.value?b.removeItem(c.key):b.setItem(c.key,c.value)}catch(a){}},w.prototype.trackServer=function(a){if(!this._servers.hasOwnProperty(a)){var b=this._servers[a]={authListeners:[]},c=this._registerCallback(this._authCallback.bind(this,b));this._send({msg:"onAuth",url:a,callbackId:c})}},w.prototype._authCallback=function(a,b){a.auth=b;for(var c=0,d=a.authListeners;c<d.length;c+=1){var e=d[c];e(b)}},w.prototype.onAuth=function(a,b,c){var d=b.bind(c);d.callback=b,d.context=c,this._servers[a].authListeners.push(d),d(this.getAuth(a))},w.prototype.offAuth=function(a,b,c){for(var d=this._servers[a].authListeners,e=0;e<d.length;e++){var f=d[e];if(f.callback===b&&f.context===c){d.splice(e,1);break}}},w.prototype.getAuth=function(a){return this._servers[a].auth},w.prototype.authWithCustomToken=function(a,b,c){return this._send({msg:"authWithCustomToken",url:a,authToken:b,options:c})},w.prototype.unauth=function(a){return this._send({msg:"unauth",url:a})},w.prototype.set=function(a,b,c){return this._send({msg:"set",url:a,value:b,writeSerial:c})},w.prototype.update=function(a,b,c){return this._send({msg:"update",url:a,value:b,writeSerial:c})},w.prototype.on=function(a,b,c,d,e,f,g,h){var i={listenerKey:a,eventType:d,snapshotCallback:e,cancelCallback:f,context:g,params:{msg:"on",listenerKey:a,url:b,spec:c,eventType:d,options:h}},j=this._onCallback.bind(this,i);this._registerCallback(j,i),e.__callbackIds=e.__callbackIds||[],e.__callbackIds.push(i.id),this._send({msg:"on",listenerKey:a,url:b,spec:c,eventType:d,callbackId:i.id,options:h}).catch(function(a){j(a)})},w.prototype.off=function(a,b,c,d,e,f){var g,h=this,i=[];if(e){if(g=this._findAndRemoveCallbackId(e,function(b){return b.listenerKey===a&&b.eventType===d&&b.context===f}),!g)return Promise.resolve();i.push(g)}else for(var j=0,k=Object.keys(this._callbacks);j<k.length;j+=1){var l=k[j],m=h._callbacks[l];m.listenerKey!==a||d&&m.eventType!==d||i.push(l)}for(var n=0,o=i;n<o.length;n+=1){var p=o[n];h._nullifyCallback(p)}return this._send({msg:"off",listenerKey:a,url:b,spec:c,eventType:d,callbackId:g}).then(function(){for(var a=0,b=i;a<b.length;a+=1){var c=b[a];h._deregisterCallback(c)}})},w.prototype._onCallback=function(a,b,c){if(b){this._deregisterCallback(a.id);var d=h(b,a.params);a.cancelCallback?a.cancelCallback.call(a.context,d):console.error(d)}else a.snapshotCallback.call(a.context,new u(c))},w.prototype.transaction=function(a,b,c){return this._send({msg:"transaction",url:a,oldValue:b,relativeUpdates:c})},w.prototype.onDisconnect=function(a,b,c){return this._send({msg:"onDisconnect",url:a,method:b,value:c})},w.prototype.bounceConnection=function(){return this._send({msg:"bounceConnection"})},w.prototype.callback=function(a){var b=a.id,c=a.args,d=this._callbacks[b];if(!d)throw new Error("Unregistered callback: "+b);d.callback.apply(null,c)},w.prototype._registerCallback=function(a,b){return b=b||{},b.callback=a,b.id="cb"+ ++this._idCounter,this._callbacks[b.id]=b,b.id},w.prototype._nullifyCallback=function(a){this._callbacks[a].callback=g},w.prototype._deregisterCallback=function(a){delete this._callbacks[a]},w.prototype._findAndRemoveCallbackId=function(a,b){var c=this;if(a.__callbackIds)for(var d=0;d<a.__callbackIds.length;){var e=a.__callbackIds[d],f=c._callbacks[e];if(f){if(b(f))return a.__callbackIds.splice(d,1),e;d+=1}else a.__callbackIds.splice(d,1)}},Object.defineProperties(w,x);var y={};Object.freeze(y);var z=function(a,b,c){this._tree=a,this._path=b.replace(/^\/*/,"/").replace(/\/$/,""),c&&(this._annotations=c,Object.freeze(c))},A={key:{},path:{},_pathPrefix:{},parent:{},annotations:{}};A.key.get=function(){return this._key||(this._key=e(this._path.replace(/.*\//,""))),this._key},A.path.get=function(){return this._path},A._pathPrefix.get=function(){return"/"===this._path?"":this._path},A.parent.get=function(){return new C(this._tree,this._path.replace(/\/[^\/]*$/,""),this._annotations)},A.annotations.get=function(){return this._annotations||y},z.prototype.child=function(){return arguments.length?new C(this._tree,this._pathPrefix+"/"+a.map(arguments,function(a){return d(a)}).join("/"),this._annotations):this},z.prototype.children=function(){var b=arguments,c=this;if(!arguments.length)return this;for(var e=[],f=0;f<arguments.length;f++){var g=b[f];if(a.isArray(g)){for(var h={},i=c._pathPrefix+"/"+e.join("/"),j=a.slice(b,f+1),k=0,l=g;k<l.length;k+=1){var m=l[k],n=new C(c._tree,i+"/"+d(m),c._annotations);h[m]=n.children.apply(n,j)}return h}e.push(d(g))}return new C(this._tree,this._pathPrefix+"/"+e.join("/"),this._annotations)},z.prototype.peek=function(a){return this._tree.truss.peek(this,a)},z.prototype.isEqual=function(a){return a instanceof z&&(this._tree===a._tree&&this.toString()===a.toString())},z.prototype.belongsTo=function(a){return this._tree.truss===a},Object.defineProperties(z.prototype,A);var B=function(b){function c(a,c,d,e){b.call(this,a,c,e),this._spec=this._copyAndValidateSpec(d)}b&&(c.__proto__=b),c.prototype=Object.create(b&&b.prototype),c.prototype.constructor=c;var d={ready:{},constraints:{}};return d.ready.get=function(){return this._tree.isQueryReady(this)},d.constraints.get=function(){return this._spec},c.prototype.annotate=function(b){return new c(this._tree,this._path,this._spec,a.extend({},this._annotations,b))},c.prototype._copyAndValidateSpec=function(b){if(!b.by)throw new Error('Query needs "by" clause: '+JSON.stringify(b));if(("at"in b)+("from"in b)+("to"in b)>1)throw new Error('Query must contain at most one of "at", "from", or "to" clauses: '+JSON.stringify(b));if(("first"in b)+("last"in b)>1)throw new Error('Query must contain at most one of "first" or "last" clauses: '+JSON.stringify(b));if(!a.some(["at","from","to","first","last"],function(a){return a in b}))throw new Error('Query must contain at least one of "at", "from", "to", "first", or "last" clauses: '+JSON.stringify(b));if(b=a.clone(b),"$key"!==b.by&&"$value"!==b.by){if(!(b.by instanceof C))throw new Error('Query "by" value must be a reference: '+b.by);var c=b.by.toString();if(!a.startsWith(c,this._path))throw new Error('Query "by" value must be a descendant of target reference: '+b.by);if(c=c.slice(this._path.length).replace(/^\/?/,""),c.indexOf("/")===-1)throw new Error('Query "by" value must not be a direct child of target reference: '+b.by);b.by=c.replace(/.*?\//,"")}return Object.freeze(b),b},c.prototype.toString=function(){if(!this._string){var b=a(this._spec).map(function(a,b){return b+"="+encodeURIComponent(JSON.stringify(a))}).sortBy().join("&");this._string=this._path+"?"+b}return this._string},Object.defineProperties(c.prototype,d),c}(z),C=function(b){function c(a,c,d){b.call(this,a,c,d)}b&&(c.__proto__=b),c.prototype=Object.create(b&&b.prototype),c.prototype.constructor=c;var d={ready:{}};return d.ready.get=function(){return this._tree.isReferenceReady(this)},c.prototype.toString=function(){return this._path},c.prototype.annotate=function(b){return new c(this._tree,this._path,a.extend({},this._annotations,b))},c.prototype.query=function(a){return new B(this._tree,this._path,a)},c.prototype.set=function(a){return this._tree.update(this,"set",(b={},b[this.path]=a,b));var b},c.prototype.update=function(a){return this._tree.update(this,"update",a)},c.prototype.commit=function(a){return this._tree.commit(this,a)},Object.defineProperties(c.prototype,d),c}(z),D=function(c,d,e,f){var g=this;d.freeze(),this._scope=c,this._connections=d,this._tree=e,this._method=f,this._subConnectors={},this._currentDescriptors={},this._disconnects={},this._vue=new b({data:a.mapValues(d,a.constant(void 0))}),this._linkScopeProperties(),a.each(d,function(b,c){a.isFunction(b)?g._bindComputedConnection(c,b):g._connect(c,b)}),r.active&&c.$on&&c.$$id&&c.$on("$destroy",function(){g.destroy()})},E={ready:{}};E.ready.get=function(){var b=this;return a.every(this._currentDescriptors,function(a,c){return!!a&&(a instanceof z?a.ready:b._subConnectors[c].ready)})},D.prototype.destroy=function(){var b=this;this._unlinkScopeProperties(),a.each(this._angularUnwatches,function(a){a()}),a.each(this._connections,function(a,c){b._disconnect(c)})},D.prototype._linkScopeProperties=function(){var b=this;if(this._scope){var c=a.find(this._connections,function(a,c){return c in b._scope});if(c)throw new Error("Property already defined on connection target: "+c);Object.defineProperties(this._scope,a.mapValues(this._connections,function(a,c){return{configurable:!0,enumerable:!0,get:function(){return b._vue.$data[c]}}}))}},D.prototype._unlinkScopeProperties=function(){var b=this;this._scope&&a.each(this._connections,function(a,c){delete b._scope[c]})},D.prototype._bindComputedConnection=function(a,b){b=b.bind(this._scope);var c=this._updateComputedConnection.bind(this,a);this._vue.$watch(b,c,{immediate:!r.active}),r.active&&(this._angularUnwatches||(this._angularUnwatches=[]),this._angularUnwatches.push(r.watch(b,c)))},D.prototype._updateComputedConnection=function(b,c){var d=this._currentDescriptors[b];if(!(d===c||c instanceof z&&c.isEqual(d))){if(!c)return void this._disconnect(b);c instanceof z||!a.has(this._subConnectors,b)?(this._disconnect(b),this._connect(b,c)):this._subConnectors[b]._updateConnections(c),this._currentDescriptors[b]=c}},D.prototype._updateConnections=function(b){var c=this;a.each(b,function(a,b){c._updateComputedConnection(b,a)}),a.each(this._connections,function(d,e){a.has(b,e)||c._updateComputedConnection(e)}),this._connections=b},D.prototype._connect=function(a,c){var d=this;if(this._currentDescriptors[a]=c,c)if(c instanceof C){var e=this._scope?this._updateScopeRef.bind(this,a):null;this._disconnects[a]=this._tree.connectReference(c,e,this._method)}else if(c instanceof B){var f=this._scope?this._updateScopeQuery.bind(this,a):null;this._disconnects[a]=this._tree.connectQuery(c,f,this._method)}else{var g={},h=this._subConnectors[a]=new D(g,c,this._tree,this._method);if(this._scope)var i=this._vue.$watch(function(){return h.ready},function(c){c&&(i(),b.set(d._scope,a,g),r.digest())},{immediate:!0})}},D.prototype._disconnect=function(c){this._scope&&(b.delete(this._scope,c),r.digest()),a.has(this._subConnectors,c)&&(this._subConnectors[c].destroy(),delete this._subConnectors[c]),this._disconnects[c]&&this._disconnects[c](),delete this._disconnects[c],delete this._currentDescriptors[c]},D.prototype._updateScopeRef=function(a,c){this._scope[a]!==c&&(b.set(this._scope,a,c),r.digest())},D.prototype._updateScopeQuery=function(c,d){var e=this,f=!1;this._scope[c]||(b.set(this._scope,c,{}),f=!0);var g=this._scope[c];for(var h in g)g.hasOwnProperty(h)&&(a.contains(d,h)||(b.delete(g,h),f=!0));for(var i,j=0,k=this._currentDescriptors[c].path.split("/");j<k.length;j+=1){var l=k[j];i=l?i[l]:e._tree.root}for(var m=0,n=d;m<n.length;m+=1){var o=n[m];g.hasOwnProperty(o)||(b.set(g,o,i[o]),f=!0)}f&&r.digest()},Object.defineProperties(D.prototype,E);var F=function(a,b,c){this._operation=a,this._delay=b,this._callback=c,this._fired=!1};F.prototype.initiate=function(){var a=this;this.cancel();var b=Date.now()-this._operation._startTimestamp;this._timeoutId=setTimeout(this._delay-b,function(){a._fired=!0,a._callback(a._operation)})},F.prototype.cancel=function(){this._fired&&this._callback(this._operation),this._timeoutId&&clearTimeout(this._timeoutId)};var G=function(a,b,c){this._type=a,this._method=b,this._target=c,this._ready=!1,this._running=!1,this._startTimestamp=Date.now(),this._slowHandles=[]},H={type:{},method:{},target:{},ready:{},running:{},error:{}};H.type.get=function(){return this._type},H.method.get=function(){return this._method},H.target.get=function(){return this._target},H.ready.get=function(){return this._ready},H.running.get=function(){return this._running},H.error.get=function(){return this._error},G.prototype.onSlow=function(a,b){var c=new F(this,a,b);this._slowHandles.push(c),c.initiate()},G.prototype._setRunning=function(a){this._running=a},G.prototype._markReady=function(){this._ready=!0,a.each(this._slowHandles,function(a){return a.cancel()})},G.prototype._clearReady=function(){this._ready=!1,this._startTimestamp=Date.now(),a.each(this._slowHandles,function(a){return a.initiate()})},Object.defineProperties(G.prototype,H);var I=function(a){this._bridge=a,this._callbacks={}};I.prototype.intercept=function(b,c){if(!a.contains(["read","write","auth"],b))throw new Error("Unknown intercept operation type: "+b);var d=a.difference(a.keys(c),["onBefore","onAfter","onError","onFailure"]);if(d.length)throw new Error("Unknown intercept callback types: "+d.join(", "));this._addCallback("onBefore",b,c.onBefore),this._addCallback("onAfter",b,c.onAfter),this._addCallback("onError",b,c.onError),this._addCallback("onFailure",b,c.onFailure)},I.prototype._addCallback=function(a,b,c){if(c){var d=this._getCallbacksKey(b,a);(this._callbacks[d]||(this._callbacks[d]=[])).push(f(c))}},I.prototype._getCallbacks=function(a,b){return this._callbacks[this._getCallbacksKey(a,b)]},I.prototype._getCallbacksKey=function(a,b){return a+"_"+b},I.prototype.execute=function(a,b,c,d){var e=this;d=f(d);var g=this.createOperation(a,b,c);return this.begin(g).then(function(){var a=function(){return d().catch(function(b){return e._retryOrEnd(g,b).then(a)})};return a()}).then(function(a){return e.end(g).then(function(){return a})})},I.prototype.createOperation=function(a,b,c){return new G(a,b,c)},I.prototype.begin=function(b){var c=this;return Promise.all(a.map(this._getCallbacks("onBefore",b.type),function(a){return a(b)})).then(function(){b._setRunning(!0)},function(a){return c.end(b,a)})},I.prototype.markReady=function(a){a._markReady()},I.prototype.clearReady=function(a){a._clearReady()},I.prototype.retry=function(b,c){return Promise.all(a.map(this._getCallbacks("onError",b.type),function(a){try{return Promise.resolve(a(b,c))}catch(a){return Promise.reject(a)}})).then(function(b){return a.some(b)})},I.prototype._retryOrEnd=function(a,b){var c=this;return this.retry(a,b).then(function(d){if(!d)return c.end(a,b)},function(b){return c.end(a,b)})},I.prototype.end=function(b,c){var d=this;return b._setRunning(!1),c&&(b._error=c),Promise.all(a.map(this._getCallbacks("onAfter",b.type),function(a){return a(b)})).then(function(){return d._afterEnd(b)},function(a){return b._error=a,d._afterEnd(b)})},I.prototype._afterEnd=function(b){if(this.markReady(b),b.error){var c=this._getCallbacks("onFailure",b.type);return this._bridge.probeError(b.error).then(function(){return c&&setTimeout(0,function(){a.each(c,function(a){return a(b)})}),Promise.reject(b.error)})}};var J="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",K=function(){this._lastUniqueKeyTime=0,this._lastRandomValues=[]};K.prototype.generateUniqueKey=function(a){var b=this;a=a||Date.now();for(var c=new Array(20),d=a,e=7;e>=0;e--)c[e]=J.charAt(63&d),d=Math.floor(d/64);if(a===this._lastUniqueKeyTime){for(var f=11;f>=0&&63===this._lastRandomValues[f];)b._lastRandomValues[f]=0,f-=1;if(f===-1)throw new Error("Internal assertion failure: ran out of unique IDs for this millisecond");this._lastRandomValues[f]+=1}else{this._lastUniqueKeyTime=a;for(var g=0;g<12;g++)b._lastRandomValues[g]=Math.floor(Math.random()*(g?64:16))}for(var h=0;h<12;h++)c[h+8]=J[b._lastRandomValues[h]];return c.join("")};var L=function(a,c){this._rootUrl=a,this._bridge=c,this._vue=new b({data:{$root:{connected:void 0,timeOffset:0,user:void 0,uid:void 0,updateNowAtIntervals:function(a,c){var d=this;if(this.hasOwnProperty(a))throw new Error('Property "'+a+'" already defined');b.set(this,a,Date.now()+this.timeOffset),setInterval(function(){d[a]=Date.now()+d.timeOffset},c)}}}}),r.active&&this._vue.$watch("$data",r.digest,{deep:!0}),c.trackAuth(a),c.onAuth(a,this._handleAuthChange,this),this._connectInfoProperty("serverTimeOffset","timeOffset"),this._connectInfoProperty("connected","connected")},M={root:{}};M.root.get=function(){return this._vue.$data.$root},L.prototype.destroy=function(){this._bridge.offAuth(this._rootUrl,this._handleAuthChange,this),this._vue.$destroy()},L.prototype._handleAuthChange=function(a){this.root.user=a,this.root.uid=a&&a.uid},L.prototype._connectInfoProperty=function(a,b){var c=this,d=this._rootUrl+"/.info/{property}";this._bridge.on(d,d,null,"value",function(a){c.root[b]=a.value})},Object.defineProperties(L.prototype,M);var N=function(a,b){this._coupler=a,this._query=b,this._listeners=[],this._keys=[],this._url=this._coupler._rootUrl+b.path,this._segments=b.path.split("/"),this._listening=!1,this.ready=!1};N.prototype.attach=function(a,b){this._listen(),this._listeners.push({operation:a,keysCallback:b}),b(this._keys)},N.prototype.detach=function(b){var c=a.findIndex(this._listeners,{operation:b});return c>=0&&this._listeners.splice(c,1),this._listeners.length},N.prototype._listen=function(){this._listening||(this._coupler._bridge.on(this._query.toString(),this._url,this._query.constraints,"value",this._handleSnapshot,this._handleError.bind(this._query.path),this,{sync:!0}),this._listening=!0)},N.prototype.destroy=function(){var a=this;this._coupler._bridge.off(this._query.toString(),this._url,this._query.constraints,"value",this._handleSnapshot,this),this._listening=!1,this.ready=!1,r.digest();for(var b=0,c=this._keys;b<c.length;b+=1){var d=c[b];a._coupler._decoupleSegments(a._segments.concat(d))}},N.prototype._handleSnapshot=function(a){var b=this;if(this._listeners.length&&this._listening){var c=this._updateKeys(a);if(this._coupler._applySnapshot(a),!this.ready){this.ready=!0,r.digest();for(var d=0,e=this._listeners;d<e.length;d+=1){var f=e[d];b._coupler._dispatcher.markReady(f.operation)}}if(c)for(var g=0,h=this._listeners;g<h.length;g+=1){var i=h[g];i.keysCallback(c)}}},N.prototype._updateKeys=function(b){var c,d=this;if(b.path===this._query.path)if(c=a.keys(b.value),c.sort(),a.isEqual(this._keys,c))c=null;else{for(var e=0,f=a.difference(c,this._keys);e<f.length;e+=1){var g=f[e];d._coupler._coupleSegments(d._segments.concat(g))}for(var h=0,i=a.difference(this._keys,c);h<i.length;h+=1){var j=i[h];d._coupler._decoupleSegments(d._segments.concat(j))}this._keys=c}else if(b.path.replace(/\/[^\/]+/,"")===this._query.path){var k=a.contains(this._keys,b.key);b.value?k||(this._coupler._coupleSegments(this._segments.concat(b.key)),this._keys.push(b.key),this._keys.sort(),c=this._keys):k&&(this._coupler._decoupleSegments(this._segments.concat(b.key)),a.pull(this._keys,b.key),this._keys.sort(),c=this._keys)}return c},N.prototype._handleError=function(b){var c=this;this._listeners.length&&this._listening&&(this._listening=!1,Promise.all(a.map(this._listeners,function(a){return c._coupler._dispatcher.clearReady(a.operation),c._coupler._dispatcher.retry(a.operation,b).catch(function(b){return a.operation._disconnect(b),!1})})).then(function(d){if(a.some(d))c._listeners.length&&c._listen();else for(var e=0,f=c._listeners;e<f.length;e+=1){var g=f[e];g.operation._disconnect(b)}}))};var O=function(a,b){this._coupler=a,this.path=b,this.url=this._coupler._rootUrl+b,this.operations=[],this.queryCount=0,this.listening=!1,this.ready=!1,this.children={}},P={active:{},count:{}};P.active.get=function(){return this.count||this.queryCount},P.count.get=function(){return this.operations.length},O.prototype.listen=function(b){var c=this;if(!b&&this.count){if(this.listening)return;a.each(this.operations,function(a){c._coupler._dispatcher.clearReady(a)}),this._coupler._bridge.on(this.url,this.url,null,"value",this._handleSnapshot,this._handleError.bind(this),this,{sync:!0}),this.listening=!0}else a.each(this.children,function(a){a.listen()})},O.prototype.unlisten=function(b){!b&&this.listening?(this._coupler._bridge.off(this.url,this.url,null,"value",this._handleSnapshot,this),this.listening=!1,this._forAllDescendants(function(a){a.ready&&(a.ready=!1,r.digest())})):a.each(this.children,function(a){a.unlisten()})},O.prototype._handleSnapshot=function(a){var b=this;this.listening&&this._coupler.isTrunkCoupled(a.path)&&(this._coupler._applySnapshot(a),this.ready||a.path!==this.path||(this.ready=!0,r.digest(),this.unlisten(!0),this._forAllDescendants(function(a){for(var c=0,d=b.operations;c<d.length;c+=1){var e=d[c];b._coupler._dispatcher.markReady(e)}})))},O.prototype._handleError=function(b){var c=this;if(this.count&&this.listening)return this.listening=!1,this._forAllDescendants(function(a){a.ready&&(a.ready=!1,r.digest());for(var b=0,d=c.operations;b<d.length;b+=1){var e=d[b];c._coupler._dispatcher.clearReady(e)}}),Promise.all(a.map(this.operations,function(a){return c._coupler._dispatcher.retry(a,b).catch(function(b){return a._disconnect(b),!1})})).then(function(d){if(a.some(d))c.count&&c.listen();else for(var e=0,f=c.operations;e<f.length;e+=1){var g=f[e];g._disconnect(b)}})},O.prototype._forAllDescendants=function(b){b(this),a.each(this.children,function(a){return a._forAllDescendants(b)})},O.prototype.collectCoupledDescendantPaths=function(b){return b||(b={}),b[this.path]=this.active,this.active||a.each(this.children,function(a){a.collectCoupledDescendantPaths(b)}),b},Object.defineProperties(O.prototype,P);var Q=function(a,c,d,e,f){this._rootUrl=a,this._bridge=c,this._dispatcher=d,this._applySnapshot=e,this._prunePath=f,this._vue=new b({data:{root:new O(this,"/"),queryHandlers:{}}})},R={_root:{},_queryHandlers:{}};R._root.get=function(){return this._vue.root},R._queryHandlers.get=function(){return this._vue.queryHandlers},Q.prototype.destroy=function(){a.each(this._queryHandlers,function(a){a.destroy()}),this._root.unlisten(),this._vue.$destroy()},Q.prototype.couple=function(a,b){return this._coupleSegments(a.split("/"),b)},Q.prototype._coupleSegments=function(a,c){for(var d,e=this,f=!c,g=!1,h=0,i=a;h<i.length;h+=1){var j=i[h],k=j?d.children&&d.children[j]:e._root;k||(k=new O(e,("/"===d.path?"":d.path)+"/"+j),b.set(d.children,j,k)),f=f||k.listening,g=g||k.ready,d=k}c?d.operations.push(c):d.queryCount++,f?c&&g&&this._dispatcher.markReady(c):d.listen()},Q.prototype.decouple=function(a,b){return this._decoupleSegments(a.split("/"),b)},Q.prototype._decoupleSegments=function(c,d){for(var e,f=this,g=[],h=0,i=c;h<i.length;h+=1){var j=i[h];if(e=j?e.children&&e.children[j]:f._root,!e)break;g.push(e)}if(!e||!(d?e.count:e.queryCount))throw new Error("Path not coupled: "+c.join("/"));if(d?a.pull(e.operations,d):e.queryCount--,d&&!e.count&&(e.listen(),e.listening&&e.unlisten()),!e.active){var k=e.collectCoupledDescendantPaths();this._prunePath(c.join("/"),k);for(var l=g.length-1;l>0&&(e=g[l],e!==f._root&&!e.active&&a.isEmpty(e.children));l--)b.delete(g[l-1].children,c[l])}},Q.prototype.subscribe=function(a,c,d){var e=this._queryHandlers[a.toString()];e||(e=new N(this,a),b.set(this._queryHandlers,a.toString(),e)),e.attach(c,d)},Q.prototype.unsubscribe=function(a,c){var d=this._queryHandlers[a.toString()];d&&!d.detach(c)&&(d.destroy(),b.delete(this._queryHandlers,a.toString()))},Q.prototype.isTrunkCoupled=function(a){for(var b,c=this,d=a.split("/"),e=0,f=d;e<f.length;e+=1){var g=f[e];if(b=g?b.children&&b.children[g]:c._root,!b)return!1;if(b.active)return!0}return!1},Q.prototype.findCoupledDescendantPaths=function(a){for(var b,c=this,d=a.split("/"),e=0,f=d;e<f.length;e+=1){var g=f[e];if(b=g?b.children&&b.children[g]:c._root,!b)break}return b?b.collectCoupledDescendantPaths():{}},Q.prototype.isSubtreeReady=function(a){for(var b,c=this,d=a.split("/"),e=0,f=d;e<f.length;e+=1){var g=f[e];if(b=g?b.children&&b.children[g]:c._root,!b)return!1;if(b.ready)return!0}return!1},Q.prototype.isQueryReady=function(a){var b=this._queryHandlers[a.toString()];return b&&b.ready},Object.defineProperties(Q.prototype,R);var S="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},T=j(function(a){(function(){var b,c,d;"undefined"!=typeof performance&&null!==performance&&performance.now?a.exports=function(){return performance.now()}:"undefined"!=typeof process&&null!==process&&process.hrtime?(a.exports=function(){return(b()-d)/1e6},c=process.hrtime,b=function(){var a;return a=c(),1e9*a[0]+a[1]},d=b()):Date.now?(a.exports=function(){return Date.now()-d},d=Date.now()):(a.exports=function(){return(new Date).getTime()-d},d=(new Date).getTime())}).call(S)}),U={$truss:!0,$parent:!0,$key:!0,$path:!0},V={},W=function(){},X={$ref:{},$refs:{},$keys:{},$values:{},$root:{}};X.$ref.get=function(){Object.defineProperty(this,"$ref",{value:new C(this.$truss._tree,this.$path)})},X.$refs.get=function(){return[this.$ref]},X.$keys.get=function(){return a.keys(this)},X.$values.get=function(){return a.values(this)},X.$root.get=function(){return this.$truss.root},W.prototype.$set=function(a){return this.$ref.set(a)},W.prototype.$update=function(a){return this.$ref.update(a)},W.prototype.$commit=function(a,b){return this.$ref.commit(a,b)},Object.defineProperties(W.prototype,X);var Y=function(b){a.extend(this,{name:b,numRecomputes:0,
numUpdates:0,runtime:0})},Z=function(b){var c=this;this._mounts=a(b).uniq().map(function(a){return c._mountClass(a)}).flatten().value();var d=a.map(this._mounts,function(a){return a.regex.toString()});if(d.length!==a.uniq(d).length){var e=a(d).groupBy().map(function(a,b){return 1===a.length?null:b.replace(/\(\[\^\/\]\+\)/g,"$").slice(1,-1)}).compact().value();throw new Error("Paths have multiple mounted classes: "+e.join(", "))}},$={computedPropertyStats:{}};Z.prototype.destroy=function(){},Z.prototype._augmentClass=function(b){for(var c,d=b.prototype;d&&d.constructor!==Object;){for(var e=0,f=Object.getOwnPropertyNames(d);e<f.length;e+=1){var g=f[e],h=Object.getOwnPropertyDescriptor(d,g);if("$"===g.charAt(0)){if(a.isEqual(h,Object.getOwnPropertyDescriptor(W.prototype,g)))continue;throw new Error('Property names starting with "$" are reserved: '+b.name+"."+g)}if(h.set)throw new Error("Computed properties must not have a setter: "+b.name+"."+g);!h.get||c&&c[g]||((c||(c={}))[g]={name:g,fullName:d.constructor.name+"."+g,get:h.get})}d=Object.getPrototypeOf(d)}for(var i=0,j=Object.getOwnPropertyNames(W.prototype);i<j.length;i+=1){var k=j[i];"constructor"===k||b.prototype.hasOwnProperty(k)||Object.defineProperty(b.prototype,k,Object.getOwnPropertyDescriptor(W.prototype,k))}return c},Z.prototype._mountClass=function(b){var c=this._augmentClass(b),d=b.$trussMount;if(!d)throw new Error("Class "+b.name+" lacks a $trussMount static property");return a.isArray(d)||(d=[d]),a.map(d,function(d){a.isString(d)&&(d={path:d});for(var e=[],f=d.path.replace(/\/\$[^\/]+/g,function(a){return e.push(a.slice(1)),""}).replace(/[$-.?[-^{|}]/g,"\\$&"),g=0,h=e;g<h.length;g+=1){var i=h[g];if("$"===i||"$"===i.charAt(1))throw new Error("Invalid variable name: "+i);if("$"===i.charAt(0)&&(a.has(W.prototype,i)||U[i]))throw new Error("Variable name conflicts with built-in property or method: "+i)}return{klass:b,variables:e,computedProperties:c,escapedKey:d.path.match(/\/([^\/]*)$/)[1],placeholder:d.placeholder,regex:new RegExp("^"+f.replace(/\u0001/g,"/([^/]+)")+"$"),parentRegex:new RegExp("^"+(f.replace(/\/[^\/]*$/,"").replace(/\u0001/g,"/([^/]+)")||"/")+"$")}})},Z.prototype.createObject=function(b,c,d){for(var f,g=this,h=W,i=0,j=this._mounts;i<j.length;i+=1){var k=j[i];k.regex.lastIndex=0;var l=k.regex.exec(b);if(l){h=k.klass,f=k.computedProperties;for(var m=0;m<k.variables.length;m++)c[k.variables[m]]={value:e(l[m+1]),writable:!1,configurable:!1,enumerable:!1};break}}var n=new h;return f&&a.each(f,function(a){c[a.name]=g._buildComputedPropertyDescriptor(n,a,d)}),n},Z.prototype._buildComputedPropertyDescriptor=function(b,c,d){function e(){d();var a=T(),b=c.get.call(this);return g.runtime+=T()-a,g.numRecomputes+=1,b}V[c.fullName]||Object.defineProperty(V,c.fullName,{value:new Y(c.fullName),writable:!1,enumerable:!0,configurable:!1});var f,g=V[c.fullName],h=!1,i=!0;return b.__destructors__||Object.defineProperty(b,"__destructors__",{value:[],writable:!1,enumerable:!1,configurable:!1}),b.__initializers__||Object.defineProperty(b,"__initializers__",{value:[],writable:!1,enumerable:!1,configurable:!1}),b.__initializers__.push(function(d){b.__destructors__.push(d.$watch(e.bind(b),function(d){if(i)g.numUpdates+=1,f=d,i=!1;else{if(a.isEqual(f,d,k))return;g.numUpdates+=1,h=!0,b[c.name]=d,h=!1}},{immediate:!0}))}),{enumerable:!0,configurable:!0,get:function(){return f},set:function(a){if(!h)throw new Error("You cannot set a computed property: "+c.name);f=a}}},Z.prototype.isPlaceholder=function(b){return a.some(this._mounts,function(a){return a.placeholder&&a.regex.test(b)})},Z.prototype.forEachPlaceholderChild=function(b,c){a.each(this._mounts,function(a){a.placeholder&&a.parentRegex.test(b)&&c(a.escapedKey,a.placeholder)})},$.computedPropertyStats.get=function(){return V},Object.defineProperties(Z,$);var _=function(){},aa={outcome:{},values:{}};aa.outcome.get=function(){return this._outcome},aa.values.get=function(){return this._values},_.prototype._setOutcome=function(a){if(this._outcome)throw new Error("Transaction already resolved with "+this._outcome);this._outcome=a},_.prototype.abort=function(){this._setOutcome("abort")},_.prototype.cancel=function(){this._setOutcome("cancel")},_.prototype.set=function(a){if(void 0===a)throw new Error("Invalid argument: undefined");this._setOutcome("set"),this._values={"":a}},_.prototype.update=function(b){if(void 0===b)throw new Error("Invalid argument: undefined");return a.isEmpty(b)?this.cancel():(this._setOutcome("update"),void(this._values=b))},Object.defineProperties(_.prototype,aa);var ba=function(a,c,d,e,f){this._truss=a,this._rootUrl=c,this._bridge=d,this._dispatcher=e,this._firebasePropertyEditAllowed=!1,this._writeSerial=0,this._localWrites={},this._localWriteTimestamp=null,this._coupler=new Q(c,d,e,this._integrateSnapshot.bind(this),this._prune.bind(this)),this._vue=new b({data:{$root:void 0}}),r.active&&this._vue.$watch("$data",r.digest,{deep:!0}),this._modeler=new Z(f),this._vue.$data.$root=this._createObject("/",""),this._completeCreateObject(this.root),this._plantPlaceholders(this.root,"/")},ca={root:{},truss:{}},da={computedPropertyStats:{}};ca.root.get=function(){return this._vue.$data.$root},ca.truss.get=function(){return this._truss},ba.prototype.destroy=function(){this._coupler.destroy(),this._modeler.destroy(),this._vue.$destroy()},ba.prototype.connectReference=function(b,c,d){var f=this;this._checkHandle(b);var g,h=this._dispatcher.createOperation("read",d,b);if(c){var i=a(b.path).split("/").map(function(a){return e(a)}).value();g=this._vue.$watch(this._getObject.bind(i),c)}return h._disconnect=this._disconnectReference.bind(this,b,h,g),this._dispatcher.begin(h).then(function(){h.running&&f._coupler.couple(b.path,h)}).catch(function(a){}),h._disconnect},ba.prototype._disconnectReference=function(a,b,c,d){b._disconnected||(b._disconnected=!0,c&&c(),this._coupler.decouple(a.path,b),this._dispatcher.end(b,d).catch(function(a){}))},ba.prototype.isReferenceReady=function(a){return this._checkHandle(a),this._coupler.isSubtreeReady(a.path)},ba.prototype.connectQuery=function(a,b,c){var d=this;this._checkHandle(a);var e=this._dispatcher.createOperation("read",c,a);return e._disconnect=this._disconnectQuery.bind(this,a,e),this._dispatcher.begin(e).then(function(){e.running&&d._coupler.subscribe(a,e,b)}).catch(function(a){}),e._disconnect},ba.prototype._disconnectQuery=function(a,b,c){b._disconnected||(b._disconnected=!0,this._coupler.unsubscribe(a,b),this._dispatcher.end(b,c).catch(function(a){}))},ba.prototype.isQueryReady=function(a){return this._coupler.isQueryReady(a)},ba.prototype._checkHandle=function(a){if(!a.belongsTo(this._truss))throw new Error("Reference belongs to another Truss instance")},ba.prototype.update=function(b,c,d){var e=this,f=a.size(d);if(f){"update"===c&&n(b.path,d),this._applyLocalWrite(d);var g=this.rootUrl+this._extractCommonPathPrefix(d);return this._dispatcher.execute("write",c,b,function(){return 1===f?e._bridge.set(g,d[""],e._writeSerial):e._bridge.update(g,d,e._writeSerial)})}},ba.prototype.commit=function(a,b){var c=this,d=this._rootUrl+a.path,e=0,f=function(){if(e++>=25)return Promise.reject(new Error("maxretry"));var g=new _;try{b(g)}catch(a){return Promise.reject(a)}var h=o(c._getObject(a.path));switch(g.outcome){case"abort":return;case"cancel":break;case"set":c._applyLocalWrite((i={},i[a.path]=g.values[""],i));var i;break;case"update":n(a.path,g.values),c._applyLocalWrite(g.values);break;default:throw new Error("Invalid transaction outcome: "+(g.outcome||"none"))}return c._bridge.transaction(d,h,g.values).then(function(a){if(!a)return f()})};return this._truss.peek(a,function(){return c._dispatcher.execute("write","commit",a,f)})},ba.prototype._applyLocalWrite=function(b){var c=this;this._writeSerial++,this._localWriteTimestamp=this._truss.now(),a.each(b,function(b,d){var f=c._coupler.findCoupledDescendantPaths(d);if(!a.isEmpty(f))for(var g=("/"===d?0:d.length)+1,h=0,i=f;h<i.length;h+=1){var j=i[h],k=j.slice(g),l=b;if(k)for(var m=k.split("/"),n=0,o=m;n<o.length;n+=1){var p=o[n];if(l=l[e(p)],void 0===l)break}if(void 0===l||null===l)c._prune(k);else{var q=e(a.last(j.split("/")));c._plantValue(j,q,l,c._scaffoldAncestors(j))}c._localWrites[j]=c._writeSerial}})},ba.prototype._extractCommonPathPrefix=function(b){var c;a.each(b,function(a,b){var d="/"===b?[]:b.split("/");if(c){for(var e=0,f=Math.min(c.length,d.length);e<f&&c[e]===d[e];)e++;if(c=c.slice(0,e),!c.length)return!1}else c=d});var d="/"+c.join("/");return a.each(a.keys(b),function(a){b[a.slice(d.length+1)]=b[a],delete b[a]}),d},ba.prototype._createObject=function(b,c,d){var e=this;if(d&&a.has(d,c))throw new Error("Duplicate object created for "+b);var f={$truss:{value:this._truss,writable:!1,configurable:!1,enumerable:!1},$parent:{value:d,writable:!1,configurable:!0,enumerable:!0},$key:{value:c,writable:!1,configurable:!1,enumerable:!1},$path:{value:b,writable:!1,configurable:!1,enumerable:!1}},g=d?function(){return d[c]}:function(){return e._vue.$data.$root},h=this._modeler.createObject(b,f,g);return Object.defineProperties(h,f),h},ba.prototype._completeCreateObject=function(a){for(var b=this,c=0,d=Object.getOwnPropertyNames(a);c<d.length;c+=1){var e=d[c],f=Object.getOwnPropertyDescriptor(a,e);f.configurable&&f.enumerable&&(f.enumerable=!1,"$parent"===e&&(f.configurable=!1,f.set=l),Object.defineProperty(a,e,f))}if(a.__initializers__)for(var g=0,h=a.__initializers__;g<h.length;g+=1){var i=h[g];i(b._vue)}},ba.prototype._destroyObject=function(a){var b=this;if(a&&a.$truss){if(a.__destructors__)for(var c=0,d=a.__destructors__;c<d.length;c+=1){var e=d[c];e()}for(var f in a)Object.hasOwnProperty(a,f)&&b._destroyObject(a[f])}},ba.prototype._integrateSnapshot=function(b){var c=this;if(a.each(a.keys(this._localWrites),function(a,d){b.writeSerial>=a&&delete c._localWrites[d]}),b.exists){var d=this._scaffoldAncestors(b.path,!0);d&&this._plantValue(b.path,b.key,b.value,d,!0)}else this._prune(b.path,null,!0)},ba.prototype._scaffoldAncestors=function(b,c){var d,f=this,g=a(b).split("/").dropRight().value();return a.each(g,function(a,b){var h=e(a),i=h?d[h]:f.root;if(!i){var j=g.slice(0,b+1).join("/");if(c&&f._localWrites[j||"/"])return;i=f._plantValue(j,h,{},d)}d=i}),d},ba.prototype._plantValue=function(b,c,f,g,h){var i=this;if(null===f||void 0===f)throw new Error("Snapshot includes invalid value: "+f);if(!h||!this._localWrites[b]){if(f===t&&(f=this._localWriteTimestamp),!a.isArray(f)&&!a.isObject(f))return void this._setFirebaseProperty(g,c,f);var j=g[c];return void 0===j&&(j=this._createObject(b,c,g),this._setFirebaseProperty(g,c,j),this._completeCreateObject(j)),a.each(f,function(a,c){i._plantValue(m(b,c),e(c),a,j,h)}),a.each(j,function(a,c){var e=d(c);f.hasOwnProperty(e)||i._prune(m(b,e),null,h)}),this._plantPlaceholders(j,b),j}},ba.prototype._plantPlaceholders=function(a,b){var c=this;this._modeler.forEachPlaceholderChild(b,function(d,f){var g=e(d);a.hasOwnProperty(g)||c._plantValue(m(b,d),g,f,a)})},ba.prototype._prune=function(b,c,d){c=c||{};var e=this._getObject(b);e&&(d&&this._avoidLocalWritePaths(b,c)||a.isEmpty(c)&&this._pruneAncestors(e)||this._pruneDescendants(e,c))},ba.prototype._avoidLocalWritePaths=function(b,c){var d=this;for(var e in this._localWrites)if(d._localWrites.hasOwnProperty(e)){if(b===e||"/"===e||a.startsWith(b,e+"/"))return!0;if("/"===b||a.startsWith(e,b+"/"))for(var f=e.split("/"),g=f.length;g>0;g--){var h=f.slice(0,g).join("/"),i=g===f.length;if(c[h]||c[h]===i)break;if(c[h]=i,h===b)break}}},ba.prototype._pruneAncestors=function(a){for(var b=this,c=!1,d=a;d&&d!==this.root;){if(!b._modeler.isPlaceholder(d.$path)){var e=c?null:[a];b._holdsConcreteData(d,e)||(c=!0,b._deleteFirebaseProperty(d.$parent,d.$key))}d=d.$parent}return c},ba.prototype._holdsConcreteData=function(b,c){var d=this;return(!c||!a.contains(c,b))&&(!!a.some(b,function(a){return!a.$truss})||a.some(b,function(a){return d._holdsConcreteData(a,c)}))},ba.prototype._pruneDescendants=function(b,c){var e=this;if(c[b.$path])return!0;var f=!1;return a.each(b,function(g,h){var i,j=!0;c[m(b.$path,d(h))]?(j=!1,i=!0):g.$truss&&(e._modeler.isPlaceholder(g.$path)?(i=e._pruneDescendants(g,c),j=!1):a.has(c,g.$path)&&(i=e._pruneDescendants(g),j=!i)),j&&e._deleteFirebaseProperty(b,h),f=f||i}),f},ba.prototype._getObject=function(b){for(var c,d=this,f=a.isString(b)?a(b).split("/").map(e).value():b,g=0,h=f;g<h.length;g+=1){var i=h[g];if(c=i?c[i]:d.root,void 0===c)return}return c},ba.prototype._getFirebasePropertyDescriptor=function(a,b){var c=Object.getOwnPropertyDescriptor(a,b);if(c){if(!c.enumerable)throw new Error("Key conflict between Firebase and instance or computed properties at "+a.$path+": "+b);if(!c.get||!c.set)throw new Error("Unbound property at "+a.$path+": "+b)}return c},ba.prototype._setFirebaseProperty=function(a,c,d){var e=this._getFirebasePropertyDescriptor(a,c);e?(this._firebasePropertyEditAllowed=!0,a[c]=d,this._firebasePropertyEditAllowed=!1):(b.set(a,c,d),e=Object.getOwnPropertyDescriptor(a,c),Object.defineProperty(a,c,{get:e.get,set:function(a){if(!this._firebasePropertyEditAllowed)throw new Error("Firebase data cannot be mutated directly: "+c);e.set.call(this,a)},configurable:!0,enumerable:!0}))},ba.prototype._deleteFirebaseProperty=function(a,c){this._getFirebasePropertyDescriptor(a,c),this._destroyObject(a[c]),b.delete(a,c)},da.computedPropertyStats.get=function(){return Z.computedPropertyStats},Object.defineProperties(ba.prototype,ca),Object.defineProperties(ba,da);var ea,fa={},ga=function(a,b){if(!ea)throw new Error("Truss worker not connected, please call Truss.connectWorker first");this._rootUrl=a.replace(/\/$/,""),this._keyGenerator=new K,this._dispatcher=new I(ea),this._metaTree=new L(this._rootUrl,ea),Object.defineProperty(this,"meta",{value:this._metaTree.root,writable:!1,configurable:!1,enumerable:!1}),this._tree=new ba(this,this._rootUrl,ea,this._dispatcher,b),Object.defineProperty(this,"root",{value:this._tree.root,writable:!1,configurable:!1,enumerable:!1})},ha={now:{}},ia={computedPropertyStats:{},worker:{},SERVER_TIMESTAMP:{}};return ga.prototype.destroy=function(){this._tree.destroy(),this._metaTree.destroy()},ha.now.get=function(){return Date.now()+this.meta.timeOffset},ga.prototype.newKey=function(){return this._keyGenerator.generateUniqueKey(this.now)},ga.prototype.authenticate=function(a){var b=this;return this._dispatcher.execute("auth",new C(this._tree,"/"),function(){return ea.authWithCustomToken(b._rootUrl,a)})},ga.prototype.unauthenticate=function(){var a=this;return this._dispatcher.execute("auth",new C(this._tree,"/"),function(){return ea.unauth(a._rootUrl)})},ga.prototype.intercept=function(a,b){return this._dispatcher.intercept(a,b)},ga.prototype.connect=function(a,b){return b||(b=a,a=void 0),new D(a,b,this._tree,"connect")},ga.prototype.peek=function(a,c){var d=this;return c=f(c),new Promise(function(e,f){var g={},h=new D(g,{result:a},d._tree,"peek"),i=new b;i.$watch(function(){return h.ready},function(a){a&&(i.$destroy(),c(g.result).then(function(a){h.destroy(),e(a)},function(a){h.destroy(),f(a)}))})})},ia.computedPropertyStats.get=function(){return this._tree.computedPropertyStats},ga.connectWorker=function(b){if(ea)throw new Error("Worker already connected");if(a.isString(b)){var c=window.SharedWorker||window.Worker;if(!c)throw new Error("Browser does not implement Web Workers");b=new c(b)}return ea=new w(b),ea.init(b).then(function(a){var b=a.exposedFunctionNames,c=a.firebaseSdkVersion;ga.FIREBASE_SDK_VERSION=c;for(var d=0,e=b;d<e.length;d+=1){var f=e[d];ga.worker[f]=ea.bindExposedFunction(f)}})},ia.worker.get=function(){return fa},ga.preExpose=function(a){ga.worker[a]=ea.bindExposedFunction(a)},ga.bounceConnection=function(){return ea.bounceConnection()},ga.suspend=function(){return ea.suspend()},ga.debugPermissionDeniedErrors=function(a,b,c){return ea.debugPermissionDeniedErrors(a,b,c)},ga.debounceAngularDigest=function(a){r.debounceDigest(a)},ga.escapeKey=function a(b){return a(b)},ga.unescapeKey=function a(b){return a(b)},ia.SERVER_TIMESTAMP.get=function(){return t},Object.defineProperties(ga.prototype,ha),Object.defineProperties(ga,ia),r.defineModule(ga),ga});
//# sourceMappingURL=firetruss.min.js.map